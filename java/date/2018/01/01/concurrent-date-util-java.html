<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="http://localhost:4000/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/style.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/js/lity.min.css"/>



<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="MINGHU6's Blog" />
<meta 
    property="og:title"
    content="
        
            Java 日期 utils
        
    " 
/>

<meta property="og:url" content="http://localhost:4000//java/date/2018/01/01/concurrent-date-util-java.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        Java 日期 utils
    
</title>
</head>
<body class="index">

    <header class="header">
    <section class="logo">
        <a href="http://localhost:4000/" class="logo__link">
            
                <h1 style="display: none;">MINGHU6's Blog</h1>
                <img class="logo__link__img" src="/minghu6.jpeg" />
            
        </a>
    </section>
    <button id="menuToggle">
        <div></div>
        <div></div>
        <div></div>
    </button>
    <nav class="menu">
        
<ul class="list primary">

    
</ul>
    </nav>
</header>

    <article class="post">

    <div class="post__title">
        <h1 class="post__title__text">Java 日期 utils</h1>
    </div>
    <div class="post__meta"> 
        <div class="post__meta__category">
            
                <p class="post__meta__category__title" style="background: "></p>
            
                <p class="post__meta__category__title" style="background: "></p>
            
        </div>
        <p class="post__meta__divider">·</p>
        <div class="post__meta__date">
            January 01, 2018
        </div>
        
    </div>

    

    <div class="post__content">
        <p><em>Java &gt;= 8 推荐使用　DateTimeFormatter</em>
总是可以使用更强大的<code class="language-plaintext highlighter-rouge">Joda-Time</code></p>

<p>缺点都是 <code class="language-plaintext highlighter-rouge">date_format</code>是固定的，非常不灵话</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ThreadLocalDateUtil.java</span>
<span class="kn">import</span> <span class="nn">java.text.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalDateUtil</span> <span class="o">{</span>

    <span class="c1">// "2017-12-20T11:20:47+0800"</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">date_format</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd'T'HH:mm:ssZ"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">DateFormat</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">DateFormat</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DateFormat</span> <span class="nf">getDateFormat</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="k">if</span><span class="o">(</span><span class="n">df</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="n">date_format</span><span class="o">);</span>
            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">df</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">df</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">format</span><span class="o">(</span><span class="nc">Date</span> <span class="n">date</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParseException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getDateFormat</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Date</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">String</span> <span class="n">strDate</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParseException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getDateFormat</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">strDate</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SyncDateUtil.java</span>
<span class="kn">import</span> <span class="nn">java.text.ParseException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SyncDateUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SimpleDateFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd'T'HH:mm:ssZ"</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">format</span><span class="o">(</span><span class="nc">Date</span> <span class="n">date</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParseException</span> <span class="o">{</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="n">sdf</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Date</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">String</span> <span class="n">strDate</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParseException</span> <span class="o">{</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="n">sdf</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">sdf</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">strDate</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ConcurrentDateFormatUtilTest.java</span>

<span class="kn">import</span> <span class="nn">java.text.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.math.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.prefs.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentDateFormatUtilTest</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">AtomicInteger</span> <span class="n">n</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="nc">ConcurrentDateFormatUtil</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ParseException</span><span class="o">,</span> <span class="nc">InterruptedException</span><span class="o">,</span>
            <span class="nc">NoSuchMethodException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span> <span class="o">{</span>
        <span class="nc">Method</span> <span class="n">dateParse</span> <span class="o">=</span> <span class="nc">ConcurrentDateFormatUtil</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"parse"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Method</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="nc">ConcurrentDateFormatUtil</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"format"</span><span class="o">,</span> <span class="nc">Date</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>

        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">dateSet</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">();</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">numberSet</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">();</span>
        <span class="nc">Date</span><span class="o">[]</span> <span class="n">dates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">[</span><span class="mi">100000</span><span class="o">];</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">dates</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Date</span><span class="o">)</span><span class="n">dateParse</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1000</span> <span class="o">+</span> <span class="s">"-11-22T00:00:00+0800"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">t1</span><span class="o">=</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">100000</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                    <span class="nc">String</span> <span class="n">date</span><span class="o">;</span>

                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">dates</span><span class="o">[</span><span class="n">number</span><span class="o">]);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="n">numberSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
                    <span class="n">dateSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
                    <span class="c1">//System.out.println(number+" "+date);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">loop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">do</span> <span class="o">{</span>    <span class="c1">//等待所有任务完成</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="o">!</span><span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>  <span class="c1">//阻塞，直到线程池里所有任务结束</span>
            <span class="o">}</span> <span class="k">while</span><span class="o">(</span><span class="n">loop</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kt">long</span> <span class="n">t2</span><span class="o">=</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dateSet</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">numberSet</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"total %d ms\n"</span><span class="o">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">jsh</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="nc">ConcurrentDateFormatUtil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">run</span><span class="o">(</span><span class="nc">ConcurrentDateFormatUtil</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">jsh</span><span class="o">(</span><span class="nc">ThreadLocalDateUtil</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//jsh(SyncDateUtil.class);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>在 <code class="language-plaintext highlighter-rouge">ConcurrentDateFormatUtilTest</code> 中测试，未发现有什么性能差异．</p>

    </div>
</article>

    
    <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">© minghu6</p>
        </section>
</footer>

    
    
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

</body>
</html>