<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2023-06-03T16:37:49+08:00</updated><id>/feed.xml</id><title type="html">MINGHU6â€™s Blog</title><subtitle>Coding somethings</subtitle><entry><title type="html">0218 - The Skyline Problem</title><link href="/oth/LeetCode0218.html" rel="alternate" type="text/html" title="0218 - The Skyline Problem" /><published>2023-06-01T00:00:00+08:00</published><updated>2023-06-01T00:00:00+08:00</updated><id>/oth/LeetCode0218</id><content type="html" xml:base="/oth/LeetCode0218.html"><![CDATA[<h2 id="é¢˜å¹²">é¢˜å¹²</h2>

<p><a href="https://leetcode.com/problems/the-skyline-problem/description/">é—®é¢˜æè¿°</a></p>

<p><a href="https://github.com/minghu6/leet-code/tree/v0.1.1/0218_the_skyline_problem">æºä»£ç </a></p>

<h2 id="ç ´é¢˜">ç ´é¢˜</h2>

<p>è¿™é“é¢˜çš„å…³é”®æ˜¯èƒ½è§‚å¯Ÿåˆ°ï¼šå…³é”®ç‚¹æ˜¯é¡ºç€ $x$ è½´çš„æ–¹å‘ï¼Œå½“å‰ªå½±çš„é«˜åº¦å‘ç”Ÿå˜åŒ–æ—¶ç¡®å®šçš„ã€‚</p>

<p>è¿™æ ·ï¼Œå¦‚æœèƒ½ç¡®å®šæ¯ä¸ª $x$ åæ ‡å¯¹åº”çš„å»ºç­‘ç‰©çš„æœ€å¤§é«˜åº¦ï¼Œå°±èƒ½æ±‚å‡ºå…³é”®ç‚¹ã€‚</p>

<h2 id="åˆ†æ®µæ ‘æ€è·¯">åˆ†æ®µæ ‘æ€è·¯</h2>

<p>æœ€ç›´æ¥çš„ä¸€ä¸ªæ€è·¯æ˜¯æŠŠå»ºç­‘åˆ—è¡¨é‡Œçš„æ¯æ ‹å»ºç­‘çš„é«˜åº¦åœ¨å®ƒæ‰€å±åŒºé—´ä¸Šæ ‡è¯†å‡ºï¼Œè¿™æ ·å°±å¯ä»¥æŸ¥è¯¢æ¯ä¸ª $x$ åæ ‡çš„æœ€å¤§é«˜åº¦ã€‚</p>

<p>åˆ†æ®µæ ‘ï¼ˆSegment Treeï¼‰å°±é€‚ç”¨äºè¿™ç§æƒ…å†µï¼šè€ƒè™‘åˆ†æ®µæ ‘çš„é‡Œçš„æ‰¹é‡æ›´æ–°ï¼Œæ—¢æ”¯æŒæ‰¹é‡ç´¯åŠ ï¼Œåˆæ”¯æŒæ‰¹é‡èµ‹å€¼ï¼Œè€Œæ‰¹é‡èµ‹å€¼å°±é€‚ç”¨äºå½“å‰è¿™ç§ç»™å®šåŒºé—´æ ‡è®°é«˜åº¦çš„ä»»åŠ¡ã€‚</p>

<p>éœ€è¦æ³¨æ„ï¼š</p>

<ol>
  <li>ç”±äºå»ºç­‘é—´åŒºé—´é‡å ï¼Œå› æ­¤æ‰¹é‡èµ‹å€¼å’ŒæŸ¥è¯¢æ—¶è¦å–ï¼ˆå»ºç­‘é«˜åº¦ï¼‰çš„æœ€å¤§å€¼ï¼Œä½œä¸ºå‰ªå½±çš„ä»£è¡¨ï¼›</li>
  <li>å»ºç­‘çš„å³è¾¹ç¼˜çš„é«˜åº¦æ˜¯æ— æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯å¯¹äºå·¦å³ç«¯çš„åæ ‡åˆ†åˆ«ä¸º $l$ å’Œ $r$ çš„å»ºç­‘ï¼Œå®ƒçš„é«˜åº¦æœ‰æ•ˆèŒƒå›´ä¸º $[l, r)$</li>
</ol>

<h3 id="python-å®ç°">Python å®ç°<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></h3>

<p><strong>åˆ†æ®µæ ‘</strong></p>

<p>ä½¿ç”¨<a href="/algs/SegmentTree.html">DFS å‹çš„åˆ†æ®µæ ‘</a>æ¥èŠ‚çœä¸€åŠçš„å†…å­˜ã€‚</p>

<p>ç”±äºå®é™…ä¸Šæˆ‘ä»¬åªä½¿ç”¨æ‰¹é‡èµ‹å€¼çš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦åŸä¿¡æ¯ï¼Œå› æ­¤ç›´æ¥çœç•¥äº†æ ‘æœ¬èº«ï¼Œåªä¿ç•™æ›´æ–°çš„ç»“æ„ã€‚</p>

<p>æœ‰ä¸€ç‚¹ï¼Œ Python çš„å‡½æ•°è°ƒç”¨æ˜¯çœŸçš„æ¶ˆè€—æ—¶é—´ï¼Œåœ¨ Rust é‡Œé¢ä½ å¯ä»¥éšæ„åœ°ä½¿ç”¨å‡½æ•°åŒ…è£…ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æˆæœ¬å‡ ä¹éƒ½å¯ä»¥è¢«ä¼˜åŒ–æ‰ï¼Œå› æ­¤å¯ä»¥åŸºäº API çš„äººä½“å·¥ç¨‹å­¦è€ƒè™‘ï¼Œç”¨ Cursor ç±»åˆ«å¤„ç†â€œåˆ†æ®µâ€ä¿¡æ¯ï¼Œä½†åœ¨ Python ä¸Šï¼Œè¿™ç§é¢‘ç¹è°ƒç”¨åœ°åŒ…è£…å‡½æ•°ä¼šå¯¼è‡´è¿è¡Œæ—¶é—´å˜ä¸º 3 å€ï¼Œäºæ˜¯æˆ‘ä»¬ä¸ä½¿ç”¨åŒ…è£…ï¼Œè€Œæ˜¯æŠŠå‚æ•°å°±åœ°ç›´æ¥å±•å¼€ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SegmentTree</span><span class="p">():</span>
    <span class="s">"""DFS Layout,
    left: i+1,
    right: 2+2l
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Just ignore self.tree
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_len</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Override the smaller value"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_assign</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tl</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">tl</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">==</span> <span class="n">tr</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl</span> <span class="o">+</span> <span class="n">tr</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">subl</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">tl</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">_assign</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="n">tl</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_assign</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">subl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""query [l, r] -&gt; (x, h)"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_query</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tl</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">tl</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">==</span> <span class="n">tr</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl</span> <span class="o">+</span> <span class="n">tr</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">subl</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">tl</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">subl</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">subl</span><span class="p">],</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="p">.</span><span class="n">assigned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">lv</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_query</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="n">tl</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_query</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">subl</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>æ•°æ®ç¦»æ•£åŒ–</strong></p>

<p>åœ¨æµ‹è¯•é‡Œæœ‰ä¸“é—¨çš„ $x$ åæ ‡å¾ˆå¤§çš„å»ºç­‘ç‰©ï¼Œå¦‚æœç›´æ¥æŒ‰ç…§ $x$ åæ ‡å»ºæ ‘ï¼Œæ€§èƒ½å°†æ˜¯ä¸å¯æ¥å—çš„ï¼Œéœ€è¦è¿›è¡Œç¦»æ•£åŒ–å¤„ç†ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥å–å»ºç­‘ä¸¤ç«¯çš„ $x$ åæ ‡ï¼Œç”¨å®ƒä»¬çš„æ’åå‹ç¼©åæ ‡è½´ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœç”¨å‘é‡å’Œä¸‹æ ‡çš„æ–¹å¼å‚¨å­˜åæ ‡ä¸æ’åçš„å¯¹åº”å…³ç³»ï¼Œéœ€è¦è·³è¿‡é‡å¤çš„å…ƒç´ ï¼Œå¦ä¼šäº§ç”ŸåŒä¸€åæ ‡ä¸åŒæ’åçš„æƒ…å†µï¼Œä»è€Œå¦¨ç¢æ­£ç¡®ç»“æœçš„æ±‚å‡ºã€‚</p>

<p><strong>å®Œæ•´è¿‡ç¨‹</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_right</span>


<span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">getSkyline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># æ•°æ®ç¦»æ•£åŒ– (Discretization)
</span>
    <span class="n">x_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">buildings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">x_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">x_data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="c1"># i != 0 for right x-axis
</span>        <span class="k">if</span> <span class="n">x_data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x_data</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_data</span><span class="p">)}</span>

    <span class="c1"># Build Segment Tree by Batch Update
</span>
    <span class="n">segtree</span> <span class="o">=</span> <span class="n">SegmentTree</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_data</span><span class="p">))</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">x_map</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">x_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
		<span class="c1"># [l, r)
</span>        <span class="n">segtree</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Sweep Line
</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_data</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">segtree</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span>

<span class="c1"># åˆ†æ®µæ ‘å®šä¹‰å¦‚ä¸Š
</span></code></pre></div></div>

<h2 id="æ ‘çŠ¶æ•°ç»„æ€è·¯">æ ‘çŠ¶æ•°ç»„æ€è·¯</h2>

<p>å¦‚æœè¯´å‰é¢å¯¹åˆ†æ®µæ ‘çš„æ”¹åŠ¨è¿˜æ¯”è¾ƒå°<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>ï¼Œé‚£ä¹ˆ<a href="/algs/FenwickTree.html">æ ‘çŠ¶æ•°ç»„</a>çš„æ€è·¯é‡Œé¢å¯¹æ ‘çŠ¶æ•°ç»„çš„æ”¹åŠ¨å°±æ¯”è¾ƒtrickyäº†ï¼Œå› ä¸ºæ™®é€šçš„æ ‘çŠ¶æ•°ç»„ï¼Œä»¥ä¸‹ç®€ç§° BITï¼ˆBinary Indexed Treeï¼‰ï¼Œ ç”¨æŸä¸ªç‚¹çš„å‰ç¼€å’Œè¡¨ç¤ºè¯¥ç‚¹çš„é«˜åº¦ï¼Œé‚£ä¹ˆä»»ä½• $x$ è½´é å‰åæ ‡ä¸Šçš„é«˜åº¦æ›´æ–°éƒ½ä¼šå½±å“åé¢ä½ç½®çš„é«˜åº¦çš„è®¡ç®—ã€‚</p>

<p>å› æ­¤æˆ‘ä»¬å¯¹æ ‘çŠ¶æ•°ç»„çš„æ”¹åŠ¨æ˜¯è®©å®ƒå‰é¢ä½ç½®çš„æ›´æ–°ä¸å½±å“åé¢ä½ç½®å‰ç¼€å’Œçš„è®¡ç®—ï¼Œå‡å¦‚ï¼Œè€ƒè™‘ä¸€ç§æƒ…å†µï¼Œæ‰€æœ‰å»ºç­‘çš„å³è¾¹ç¼˜éƒ½æ˜¯ $\infty$ ï¼Œè€Œæ›´æ–°å’ŒæŸ¥è¯¢å°±åƒå‰é¢åˆ†æ®µæ ‘ä¸€æ ·ï¼Œéƒ½æ˜¯å–æ‰€æœ‰ç›¸å…³ä½ç½®å€¼çš„æœ€å¤§ï¼šä¹Ÿå°±æ˜¯æ›´æ–°çš„æ—¶å€™æ‰«ææ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œå–å…¶ä½ç½®æ—¢æœ‰å€¼å’Œå½“å‰æ›´æ–°å€¼çš„æœ€å¤§ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æ‰«ææ‰€æœ‰å‰ç¼€ä½ç½®ï¼Œå–æœ€å¤§å€¼ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥ç”¨æ ‘çŠ¶æ•°ç»„æ­£ç¡®åœ°æ›´æ–°é«˜åº¦å’Œå•ç‚¹æŸ¥è¯¢ã€‚</p>

<p>å› ä¸ºæ­¤æ—¶çš„æ›´æ–°è¦ä¹ˆä¸å½±å“åé¢ä½ç½®çš„é«˜åº¦ï¼Œè¦ä¹ˆå½±å“å¾—éƒ½æ˜¯å»ºç­‘åŒºé—´é‡å çš„éƒ¨åˆ†ï¼š</p>

<p>å‡è®¾ä¸¤æ ‹å»ºç­‘çš„åŒºé—´åˆ†åˆ«ä¸º $[l_0, \infty)$ å’Œ $[l_1, \infty)$ é«˜åº¦åˆ†åˆ«ä¸º $h_0$ å’Œ $h_1$ ï¼Œå¦‚æœ $l_0 \neq l_1$ ï¼Œä¸å¦¨ä»¤ $l_0 \lt l_1$ ï¼Œé‚£ä¹ˆåœ¨ $[l_0, l_1)$ çš„åŒºé—´ä¸Šï¼Œä¸¤è€…äº’ä¸å½±å“ï¼Œå› ä¸ºè¿™ä¸ªåŒºåŸŸåªæœ‰ $l_0$ çš„æ›´æ–°ï¼Œè€Œåœ¨ $[l_1, \infty)$ çš„åŒºåŸŸï¼Œä¸¤è€…æœ¬æ¥å°±æ˜¯åŒºé—´é‡å ï¼Œç”¨ä¸¤ä¸ªå€¼ä¸­çš„æœ€å¤§å€¼è¦†ç›–å³å¯ã€‚è¿™æ ·åœ¨æŸ¥è¯¢é«˜åº¦çš„æ—¶å€™ï¼Œå¯¹äºä½ç½® $x$ ï¼Œå¦‚æœ $x\in [l_0, l_1)$ ï¼Œé‚£å®ƒçš„é«˜åº¦æ˜¯ $h_0$ ï¼Œå¦‚æœ $x\in [l_1, \infty)$ ï¼Œé‚£å®ƒçš„é«˜åº¦æ˜¯ $\max (h_0, h_1)$ ã€‚</p>

<p>å½“ç„¶ $\infty$ çš„æƒ…å†µæ—¢ä¸å¯èƒ½ï¼Œä¹Ÿæ— æ³•è®¡ç®—ï¼Œä½†æ˜¯å¦‚æœè¯´æ‰€æœ‰å»ºç­‘çš„å³è¾¹ç¼˜éƒ½æ˜¯é‡åˆçš„ï¼Œéƒ½æ˜¯ $r$ ï¼Œè€Œæ‰€æœ‰è¶…è¿‡ $r$ çš„ $x$ è½´ä¸Šçš„ä½ç½®éƒ½ä¸ä¸éœ€è¦æŸ¥è¯¢ï¼Œé‚£ä¹ˆé—®é¢˜ä¹Ÿæ˜¯ç­‰ä»·çš„ã€‚</p>

<p>é‚£ä¹ˆå›åˆ°å½“å‰é—®é¢˜ï¼Œå¦‚æœå»ºç­‘èƒ½å¤ŸæŒ‰ç…§å³è¾¹ç¼˜çš„ $x$ è½´ä½ç½®ä»å³åˆ°å·¦çš„é¡ºåºæ’åˆ—ï¼Œç„¶åæˆ‘ä»¬ä»å³å‘å·¦æ‰«æï¼Œåªåœ¨æ‰«æåˆ°å»ºç­‘çš„å³è¾¹ç¼˜æ—¶æ‰æŠŠè¯¥å»ºç­‘ï¼ˆæ‰€ä»£è¡¨çš„ä¸€ä¸ªåŒºé—´çš„é«˜åº¦ï¼‰æ›´æ–°åˆ°æ ‘çŠ¶æ•°ç»„é‡Œï¼Œç„¶åå¯¹æ‰«æçº¿ä½ç½®è¿›è¡Œé«˜åº¦æŸ¥è¯¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿æ‰€æœ‰å»ºç­‘çš„å³è¾¹ç¼˜éƒ½æ˜¯é‡åˆçš„ï¼Œå¹¶ä¸”ä¸éœ€è¦æŸ¥è¯¢è¶…è¿‡é‡åˆç‚¹ä¹‹åçš„ä½ç½®ã€‚</p>

<p>ä½†æ˜¯ï¼Œä½†æ˜¯ï¼Œä¸”ä¸è¯´æˆ‘ä»¬çš„å»ºç­‘æ˜¯æŒ‰ç…§å·¦è¾¹ç¼˜çš„ä»å·¦åˆ°å³çš„é¡ºåºæ’åˆ—çš„ï¼Œå…³é”®é—®é¢˜æ˜¯é¢˜ç›®è¦æ±‚åœ°å…³é”®ç‚¹æ˜¯æŒ‰ç…§ä»å·¦åˆ°å³æ‰«æçš„é¡ºåºå¾—åˆ°çš„ï¼Œæ ¹æœ¬ä¸èƒ½ä»å³å‘å·¦æ‰«æï¼Œè¿™è¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>

<p>äºæ˜¯æœ‰äº†è¿™é‡Œæ¯”è¾ƒTrickyåœ°æ ‘çŠ¶æ•°ç»„åœ°æ„é€ <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ï¼š</p>

<p>æ—¢ç„¶ä¸€å®šè¦ä»å·¦å‘å³æ‰«æï¼Œæˆ‘â„¢ ğŸ˜¡ç›´æ¥ä»æ•°ç»„çš„å°¾éƒ¨å¼€å§‹å»ºç«‹è¿™ä¸ªæ ‘çŠ¶æ•°ç»„ï¼</p>

<p>è¿™æ ·æŸä¸ªä½ç½®çš„é«˜åº¦å°±æ˜¯å®ƒçš„åç¼€æœ€å¤§å€¼ï¼Œè€Œå®ƒçš„ç¥–å…ˆèŠ‚ç‚¹å°±åœ¨å®ƒçš„å·¦è¾¹ï¼Œä»å·¦å‘å³æ‰«ææ—¶å°±å®Œç¾ç¬¦åˆäº†å‰é¢å‡è®¾å¾—æ ‘çŠ¶æ•°ç»„çš„é€‚åº”æƒ…å†µï¼</p>

<p><strong>åå‘æ ‘çŠ¶æ•°ç»„</strong></p>

<p>å¯¹äº base 1 çš„æ•°ç»„ï¼Œ$x$ æ‰€è¾–åŒºé—´é•¿åº¦æ˜¯ <code class="language-plaintext highlighter-rouge">x &amp; (-x)</code> ï¼Œè€Œå¯¹äº base 0 çš„æ•°ç»„åˆ™æ˜¯ <code class="language-plaintext highlighter-rouge">(x+1) &amp; -(x+1)</code> ï¼Œå¯¹äºä»å°¾éƒ¨å»ºç«‹èµ·æ¥çš„æ ‘çŠ¶æ•°ç»„ï¼Œ$xâ€™ = n - x - 1$ ï¼Œå…¶ä¸­ $n$ ä¸ºæ•°ç»„é•¿åº¦ã€‚</p>

<p>æ ‘çŠ¶æ•°ç»„æ›´æ–°çš„æ—¶å€™å®é™…ä¸Šåªéœ€è¦æ›´æ–°åˆ°æ‰«æçº¿çš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯ä»£ç é‡Œçš„ <code class="language-plaintext highlighter-rouge">until</code> ï¼‰</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RevBIT</span><span class="p">():</span>
    <span class="s">"""Reversed Binary Indexed Tree"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># base 0
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_len</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">until</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">until</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">l</span>

        <span class="k">return</span> <span class="n">acc</span>
</code></pre></div></div>

<p><strong>æ€»ä½“è¿‡ç¨‹</strong></p>

<p>æ€»ä½“è¿‡ç¨‹é¦–å…ˆæ˜¯ $x$ è½´åæ ‡çš„æ’åºå’Œç¦»æ•£åŒ–ï¼Œå’Œå‰é¢åˆ†æ®µæ ‘çš„å¤„ç†ä¸€æ ·ï¼Œåé¢åœ¨æ‰«æè¿‡ç¨‹ä¸­æ›´æ–°å»ºç­‘åˆ°æ ‘çŠ¶æ•°ç»„ä¸Šå’Œå³æ—¶åœ°æŸ¥è¯¢ï¼Œæ˜¾ç„¶å¯¹äºæ¯æ ‹å»ºç­‘ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–°å»ºç­‘çš„å³è¾¹ç¼˜çš„åæ ‡<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>å’Œé«˜åº¦ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_right</span>


<span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">getSkyline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">x_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">buildings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">x_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">x_data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x_data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x_data</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_data</span><span class="p">)}</span>

    <span class="n">bit</span> <span class="o">=</span> <span class="n">RevBIT</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_data</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_data</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">buildings</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="n">buildings</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">buildings</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">bit</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">bit</span><span class="p">.</span><span class="n">suffix</span><span class="p">(</span><span class="n">x_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>

<p>ä½†æ˜¯ï¼Œåœ¨ä»”ç»†è€ƒè™‘ä¸‹æˆ‘ä»¬å¯¹åå‘å»ºæ„çš„æ ‘çŠ¶æ•°ç»„çš„ä½¿ç”¨ğŸ¤”ï¼Œå‘ç°è™½ç„¶æˆ‘ä»¬æ‰«æåç¼€ï¼Œä½†åªè¦ä¸€ä¸ªä½ç½®æ¥ä¿å­˜é«˜åº¦ï¼Œè€Œä¸éœ€è¦çœŸåœ°è®¡ç®—å‰ç¼€å’Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨ä¸€ä¸ªæ™®é€šçš„æ ‘çŠ¶æ•°ç»„çš„ç»“æ„ï¼Œä½†æ˜¯ç”¨çˆ¶èŠ‚ç‚¹ä¿å­˜é«˜åº¦ï¼Œæ›´æ–°çš„æ—¶å€™å‘å‰æ›´æ–°èŠ‚ç‚¹ï¼ˆæŸ¥è¯¢æ‰«æçš„é€†è¿‡ç¨‹ï¼Œæ¯”å¦‚ $7 \rightarrow 6 \rightarrow 4 \rightarrow 2 \rightarrow 1$ï¼‰<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>ï¼ŒæŸ¥è¯¢çš„æ—¶å€™å‘åæ‰«ææ‰€æœ‰çˆ¶èŠ‚ç‚¹ã€‚</p>

<p><strong>å¾’æœ‰å…¶è¡¨åœ°æ ‘çŠ¶æ•°ç»„</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeBIT</span><span class="p">():</span>
    <span class="s">"""Fake Binary Indexed Tree whose prefix for update and suffix for query"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># base 0
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_len</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">until</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">until</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">acc</span>
</code></pre></div></div>

<p>æ€»ä½“è¿‡ç¨‹å’Œåå‘æ ‘çŠ¶æ•°ç»„ä¸€æ ·ï¼Œåªéœ€è¦æŠŠ <code class="language-plaintext highlighter-rouge">bit = RevBIT(len(x_data))</code> æ›¿æ¢ä¸º `    bit = FakeBIT(len(x_data))`</p>

<h2 id="ä¼˜å…ˆçº§é˜Ÿåˆ—æ€è·¯">ä¼˜å…ˆçº§é˜Ÿåˆ—æ€è·¯</h2>

<p>å€Ÿç€ä¸Šæ–‡ï¼Œæˆ‘ä»¬ä»åå‘æ ‘çŠ¶æ•°ç»„æ¨åˆ°å‡æ ‘çŠ¶æ•°ç»„ï¼Œäºæ˜¯å¯ä»¥æƒ³åˆ°ï¼Œä¸ºä»€ä¹ˆä¸å¹²è„†ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»£ä¸Šé¢æ ‘çŠ¶æ•°ç»„çš„ä½œç”¨ï¼Ÿæ¯æ¬¡æ‰«æçš„æ—¶å€™æŠŠæŠŠå»ºç­‘æ›´æ–°åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—é‡Œï¼Œä¿å­˜ä¸€ä¸ªå³è¾¹ç¼˜åæ ‡å’Œé«˜åº¦ï¼ŒæŸ¥è¯¢çš„æ—¶å€™å°±ä»å¯¹é˜Ÿé¦–å¼¹å‡ºæ‰€æœ‰å³è¾¹ç¼˜ä¸ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œç„¶åæ–°çš„é˜Ÿé¦–çš„å…ƒç´ çš„é«˜åº¦å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„è¯¥ä½ç½®çš„æœ€å¤§é«˜åº¦ï¼Œå½“ç„¶å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œå°±æ˜¯é«˜åº¦ä¸º $0$ ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">insort</span>
<span class="kn">from</span> <span class="nn">sortedcontainers</span> <span class="kn">import</span> <span class="n">SortedList</span>


<span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">getSkyline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">buildings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">x_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buildings</span><span class="p">:</span>
        <span class="n">insort</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">queue</span> <span class="o">=</span> <span class="n">SortedList</span><span class="p">([],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_buildings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buildings</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_data</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_buildings</span> <span class="ow">and</span> <span class="n">buildings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">((</span><span class="n">buildings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">buildings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># pop outdated from priority queue
</span>
        <span class="k">while</span> <span class="n">queue</span> <span class="ow">and</span> <span class="n">queue</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">queue</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">or</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sortedcontainers</code> æ˜¯ LeetCode æ‰¿è¯ºåœ°è‡ªåŠ¨åŒ…å«è¿› Python ç¯å¢ƒé‡Œçš„ç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªçº¯ Python ä½†æ˜¯è¶³å¤Ÿé«˜æ•ˆåœ°æœ‰åºé›†åˆçš„åº“ï¼ŒåªåŒ…å«ä¸‰ä¸ªæœ‰åºé›†åˆï¼š<code class="language-plaintext highlighter-rouge">SortedList</code>ï¼Œ<code class="language-plaintext highlighter-rouge">SortedSet</code>ï¼Œ<code class="language-plaintext highlighter-rouge">SortedDict</code> ï¼Œç”¨æ¥è¡¥å……æ ‡å‡†åº“ç¼ºä¹åœ°åŠŸèƒ½ã€‚<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup><sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup><sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">8</a></sup></p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>python 3.10Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>åªæ˜¯åœ¨æ‰¹é‡èµ‹å€¼å’ŒæŸ¥è¯¢çš„æ—¶å€™æœ‰ä¸€ä¸ªé¢å¤–çš„æ±‚å–æœ€å¤§å€¼çš„æ“ä½œï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿é‡å åŒºé—´çš„é«˜åº¦æ˜¯ä¸Šé¢æ‰€æœ‰å»ºç­‘é«˜åº¦çš„æœ€å¤§å€¼Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>æˆ‘å¾ˆæ¬£èµè¿™ç§è®¾è®¡ï¼Œå®ƒå°±æ˜¯éå¸¸æ¸…æ¥šè¿™ä¸ªæ•°æ®ç»“æ„åœ°æ„é€ å’Œå®è´¨ï¼Œç„¶åå°±å¯ä»¥ä¿ç•™å®è´¨ï¼Œæ ¹æ®éœ€è¦éšæ„åœ°è§£æ„ç„¶åé‡æ„ï¼Œè¿™ç§ä½¿ç”¨å¯ä»¥è¯´å·²å…¥åŒ–å¢ƒÂ <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>å½“ç„¶å‡†ç¡®è¯´æ˜¯ $r-1$Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>è®¡ç®—èŠ‚ç‚¹çš„å…³é”®æ˜¯æŠŠæ¡å­åŒºé—´çš„é•¿åº¦Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>ä½†æ˜¯æˆ‘ä¸å¾—ä¸åæ§½å¾—æ˜¯ï¼ŒPython ä½œä¸ºæ›¾ç»åœ°å·ç§°â€œè‡ªå¸¦ç”µæ± â€åœ°æ–¹ä¾¿è¯­è¨€ï¼Œä½†ç°åœ¨å¾ˆå¤šæ–¹é¢å·²ç»éå¸¸è€è¿ˆï¼ˆè™½ç„¶æ­£åœ¨å°è¯•è¿½èµ¶ï¼‰ï¼Œç‰¹åˆ«æ˜¯ç›¸å¯¹äºRustè€Œè¨€ï¼ŒåŸºæœ¬ä¸Šå¦‚æœä¸æ˜¯ä¸ºäº†æ¯”è¾ƒä¸åŒå®ç°çš„æ€§èƒ½ï¼Œå‡ºäºæ–¹ä¾¿è€ƒè™‘æˆ‘å®å¯ç”¨ Rust ï¼ŒRustçš„é—®é¢˜å°±æ˜¯ä¼˜åŒ–å¤ªå¥½ã€è¿è¡Œå¤ªå¿«äº†ï¼Œæµ‹è¯•ç»“æœå‡ ä¹æ€»æ˜¯ 0 ms ï¼Œè€Œ Pythonåœ¨è¿™é‡Œçš„ä¼˜åŠ¿å±…ç„¶æ˜¯è¶³å¤Ÿæ…¢ï¼Œä¾¿äºæµ‹è¯•ä¸­èƒ½å‘ç°æ€§èƒ½ä¸Šçš„é—®é¢˜ğŸ˜…ã€‚Â <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>æˆ‘çœŸçš„ä¸ºäº†å¯»æ‰¾ä¸€ä¸ªæä¾›ä¼˜å…ˆçº§é˜Ÿåˆ—åŠŸèƒ½åœ°å®¹å™¨ï¼ŒèŠ±è´¹äº†ä¸å°‘æ—¶é—´ï¼ŒPython æ ‡å‡†åº“é‡Œé¢æœ‰å‡ ä¸ªçœ‹èµ·æ¥å¾ˆåƒåœ°ï¼Œä½†éƒ½ä¸å¾ˆåˆé€‚ï¼Œä¸€ä¸ªæ˜¯ <code class="language-plaintext highlighter-rouge">queue.PriorityQueue</code> åå­—å°±å«åšä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯ç”¨æ¥åšè¿›çº¿ç¨‹è°ƒåº¦åœ°ğŸ˜…ï¼› å¦ä¸€ä¸ªæ˜¯å®ƒçš„åº•å±‚å®ç° <code class="language-plaintext highlighter-rouge">heapq.[heapify, heappush, heappop]</code> ï¼Œç®€ç›´å°±å’Œ C è¯­è¨€çš„å‡½æ•°ä¸€æ ·ï¼Œå¯ä»¥ä¼ ä¸€ä¸ªåˆ—è¡¨ï¼Œç„¶åæ„å»ºåŸºäºå †åœ°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿ä¸ªè‡ªå®šä¹‰ <code class="language-plaintext highlighter-rouge">key</code> çš„åŠŸèƒ½éƒ½æ²¡æœ‰ï¼Œè¿˜éœ€è¦ä¸“é—¨ç”¨ä¸€ä¸ªæ•°æ®åŒ…è£…ï¼Œæ¥è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œå®åœ¨ç»·ä¸ä½ï¼›è¿˜æœ‰ä¸€ä¸ªæ˜¯ <code class="language-plaintext highlighter-rouge">collections.OrderedDict</code> ä½†å®ƒä¿æŒåœ°æ˜¯æ’å…¥é¡ºåºã€‚Â <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>ä½†æ˜¯ç¬¬ä¸‰æ–¹åœ° <code class="language-plaintext highlighter-rouge">sortedcontainers.SortedList</code> ä¹Ÿä»¤äººä¸å¤ªæ»¡æ„ï¼Œé¦–å…ˆæ–¹æ³•éå¸¸ç®€å•ï¼Œåªä¾›æœ€åŸºæœ¬åœ°ä½¿ç”¨ï¼Œå¦å¤–å®åœ¨ä¸çŸ¥é“å®ƒåŠ ä¸€äº› <code class="language-plaintext highlighter-rouge">not implementedï¼Œuse xxx replace</code> çš„æ–¹æ³•åˆ°å®ç°é‡Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œè°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•æœ¬æ¥å°±ä¼šæŠ¥é”™ï¼Œåˆä¸éœ€è¦å®ƒæ¥åšè­¦æˆ’å“¨ï¼Œè¿™åªæ˜¯åœ¨æ··æ·†ä»£ç çš„é™æ€åˆ†æç¨‹åºï¼Œè®©æ™ºèƒ½æç¤ºé‡Œå‡ºç°é”™è¯¯åœ°é€‰é¡¹ï¼Œè®©æ¯ä¸ªç¬¬ä¸€æ¬¡ä½¿ç”¨å®ƒçš„äººæµªè´¹å‡ åç§’çš„æ—¶é—´ï¼Œå»å‘ç°æ­£ç¡®çš„æ–¹æ³•ğŸ˜¡ã€‚Â <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;oth&quot;]" /><summary type="html"><![CDATA[é¢˜å¹²]]></summary></entry><entry><title type="html">Topological Sort</title><link href="/algs/GraphTarjanDFS2.html" rel="alternate" type="text/html" title="Topological Sort" /><published>2023-05-25T00:00:00+08:00</published><updated>2023-05-25T00:00:00+08:00</updated><id>/algs/GraphTarjanDFS2</id><content type="html" xml:base="/algs/GraphTarjanDFS2.html"><![CDATA[<p>æ˜¯è§£å†³æœ‰å‰ç½®è¯¾ç¨‹é™åˆ¶çš„è¯¾è¡¨å®‰æ’ä¹‹ç±»çš„é—®é¢˜ï¼Œç”¨æœ‰å‘è¾¹ä»£è¡¨ä¸€ä¸ªäº‹ä»¶å’Œå®ƒçš„å‰ç½®äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™æ ·æ„æˆçš„æœ‰å‘å›¾çš„æ‹“æ‰‘æ’åºï¼ˆç»“æœå¹¶ä¸å”¯ä¸€ï¼‰å°±æ˜¯ä¸€ä¸ªè§„åˆ’æ–¹æ¡ˆã€‚</p>

<p>æ‹“æ‰‘æ’åºçš„å¯¹å›¾çš„è¦æ±‚æ˜¯æœ‰å‘æ— ç¯å›¾ï¼ˆDirected Acyclic Graphï¼ŒDAGï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŸºäº DFS çš„æ‹“æ‰‘æ’åºçš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨çº¿æ€§æ—¶é—´é‡Œè¿›è¡Œæ‹“æ‰‘æ’åºï¼Œå¹¶ä¸”èƒ½å¤Ÿæ£€æŸ¥ç¯çš„å­˜åœ¨ã€‚</p>

<p>è¿™ä¸ªåŸºäº DFS çš„çº¿æ€§çš„æ‹“æ‰‘æ’åºçš„ç®—æ³•å¾ˆå¯èƒ½ä¹Ÿæ˜¯æ¥æºäº Tarjan<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>ï¼ŒåŸºæœ¬æ€è·¯å’Œå‰é¢ä»‹ç»çš„<a href="/algs/GraphTarjanDFS.html">TarjanDFS</a>ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œå…³æ³¨è¾¹çš„å›æº¯æƒ…å†µï¼Œéå¸¸ç®€å•ï¼Œç›´æ¥çœ‹å®ç°ã€‚</p>

<h2 id="æ€è·¯">æ€è·¯</h2>

<p>åŒºåˆ«äºå‰é¢ä¸ºæ¯ä¸ªç‚¹ç»´æŠ¤ $\text{index}$ å’Œ $\text{lowpt}$ï¼Œæ¥æ±‚è§£å¯»æ‰¾å¼ºè¿é€šåˆ†é‡ï¼Œæ‹“æ‰‘æ’åºåªéœ€è¦æ£€æµ‹ç¯æ˜¯å¦å­˜åœ¨ï¼Œå› æ­¤å¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªä¸‰å…ƒå€¼ï¼ŒæŒ‡ç¤ºç‚¹çš„æœªè®¿é—®ã€è®¿é—®ä¸­å’Œè®¿é—®ç»“æŸä¸‰ä¸ªçŠ¶æ€ï¼Œå¦‚æœ DFS è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€ä¸ªè®¿é—®ä¸­çš„ç‚¹ï¼Œé‚£ä¹ˆä¸€å®šå­˜åœ¨ç¯ã€‚</p>

<p>å¯¹äºæ‹“æ‰‘æ’åºæœ¬èº«ï¼ŒæŒ‰ç…§ DFS è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰€æœ‰å‡ºè¾¹è®¿é—®ç»“æŸåæŠŠå½“å‰ç‚¹åŠ å…¥å‘é‡ä¸­ï¼Œè¿™å°±å¾—åˆ°äº†ä¸€ä¸ªæ‹“æ‰‘æ’åºçš„ä¸€ä¸ªé€†åºç»“æœï¼Œæœ€åå†æŠŠå‘é‡é€†åºå›æ¥ï¼Œå°±å¾—åˆ°äº†æœ€ç»ˆç»“æœ</p>

<h2 id="å®ç°">å®ç°</h2>

<p><a href="https://github.com/minghu6/rust-minghu6/blob/v0.1.7/coll_graph/src/toposort.rs">æºä»£ç </a></p>

<h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[repr(u8)]</span>
<span class="nd">#[derive(Default,</span> <span class="nd">Clone,</span> <span class="nd">Copy,</span> <span class="nd">PartialEq,</span> <span class="nd">Eq)]</span>
<span class="k">enum</span> <span class="n">DFSMeta</span> <span class="p">{</span>
    <span class="nd">#[default]</span>
    <span class="n">Green</span><span class="p">,</span>
    <span class="n">Yellow</span><span class="p">,</span>
    <span class="n">Red</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">use</span> <span class="nn">DFSMeta</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="æ•´ä½“è¿‡ç¨‹">æ•´ä½“è¿‡ç¨‹</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">toposort_tarjan</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ans</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">max_v</span> <span class="o">=</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span><span class="nf">.max</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">vertexs</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nn">DFSMeta</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">for</span> <span class="n">u</span> <span class="k">in</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">==</span> <span class="n">Green</span> <span class="p">{</span>
            <span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">vertexs</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">ans</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">ans</span><span class="nf">.reverse</span><span class="p">();</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="dfså­è¿‡ç¨‹">DFSå­è¿‡ç¨‹</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">dfs</span><span class="p">(</span>
    <span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">u</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">vertexs</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DFSMeta</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">ans</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yellow</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="nd">get!</span><span class="p">(</span><span class="n">g</span><span class="py">.e</span> <span class="k">=&gt;</span> <span class="n">u</span> <span class="k">=&gt;</span> <span class="nd">vec!</span><span class="p">[])</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">Green</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">,</span> <span class="n">ans</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">Yellow</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Err</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span> <span class="c1">// found edge on cycle</span>
            <span class="p">}</span>
            <span class="n">Red</span> <span class="k">=&gt;</span> <span class="p">(),</span> <span class="c1">// just skip</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">Red</span><span class="p">;</span>
    <span class="n">ans</span><span class="nf">.push</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://scholar.google.com/citations?view_op=view_citation&amp;hl=en&amp;user=lazJixIAAAAJ&amp;cstart=20&amp;pagesize=80&amp;citation_for_view=lazJixIAAAAJ:p2g8aNsByqUC">Edge-disjoint spanning trees and depth-first search</a> RE Tarjan Acta Informatica 6 (2), 171-185Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[æ˜¯è§£å†³æœ‰å‰ç½®è¯¾ç¨‹é™åˆ¶çš„è¯¾è¡¨å®‰æ’ä¹‹ç±»çš„é—®é¢˜ï¼Œç”¨æœ‰å‘è¾¹ä»£è¡¨ä¸€ä¸ªäº‹ä»¶å’Œå®ƒçš„å‰ç½®äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™æ ·æ„æˆçš„æœ‰å‘å›¾çš„æ‹“æ‰‘æ’åºï¼ˆç»“æœå¹¶ä¸å”¯ä¸€ï¼‰å°±æ˜¯ä¸€ä¸ªè§„åˆ’æ–¹æ¡ˆã€‚]]></summary></entry><entry><title type="html">Tarjan DFS</title><link href="/algs/GraphTarjanDFS.html" rel="alternate" type="text/html" title="Tarjan DFS" /><published>2023-05-20T00:00:00+08:00</published><updated>2023-05-20T00:00:00+08:00</updated><id>/algs/GraphTarjanDFS</id><content type="html" xml:base="/algs/GraphTarjanDFS.html"><![CDATA[<p><em>æœ¬æ–‡èµ„æ–™æ¥æºäº<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup><sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></em></p>

<p>Tarjan å…¶å®æ˜¯è€æœ‹å‹äº†ï¼Œä¹‹å‰ä»‹ç»è¿‡çš„<a href="/algs/FibHeap.html">æ–æ³¢é‚£å¥‘å †</a>ï¼ˆ1986ï¼‰ï¼Œä»–å°±æ˜¯å®ƒçš„ä¸¤ä½ä½œè€…ä¹‹ä¸€ï¼Œ ç°åœ¨æ˜¯è¦ä»‹ç»ä»–æ—©æœŸï¼ˆ1972ã€1973ï¼‰å‘è¡¨çš„é€šè¿‡å›¾ä¸Š DFS æ¥çº¿æ€§æ—¶é—´è§£å†³<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">3</a></sup>ï¼š</p>

<ol>
  <li>åœ¨æ— å‘å›¾ä¸Šåˆ’åˆ†åŒè”é€šåˆ†é‡</li>
  <li>æŸ¥æ‰¾å¼ºè¿é€šåˆ†é‡</li>
</ol>

<p>å…¶ä¸­ä¸€äº›æ¦‚å¿µä¹Ÿæ˜¯ï¼ˆå¯èƒ½ï¼‰åç»­ä¸€äº›åŸºäº DFS çš„ç®—æ³•çš„åŸºç¡€ã€‚</p>

<h2 id="æ·±åº¦ä¼˜å…ˆéå†">æ·±åº¦ä¼˜å…ˆéå†</h2>

<p>å¯¹ä¸€ä¸ªè¿é€šæ— å‘ï¼ˆç®€å•ï¼‰å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="/assets/img/tarjandfs/graph.png" alt="å›¾1" /></p>

<p>ï¼ˆ<em>é»˜è®¤æŒ‰ç…§å­—æ¯é¡ºåº</em>ï¼‰è¿›è¡Œæ·±åº¦ä¼˜å…ˆåœ°å›¾ä¸Šéå†ï¼š</p>

\[\begin{array}{l}
\text{A}\rightarrow \text{B}\rightarrow \text{C}\rightarrow \text{D}\rightarrow &amp;\text{E}\rightarrow &amp;\text{F}\curvearrowright \text{A}\\
&amp;&amp; \text{F}\rightarrow&amp;\text{G}\curvearrowright\text{D}\\
&amp;&amp;&amp;\text{G}\curvearrowright\text{B}\\
&amp;\text{E}\rightarrow&amp;\text{H}\curvearrowright \text{A}\\
&amp;&amp;\text{H}\curvearrowright \text{C}
\end{array}\]

<p>å¾—åˆ°ä¸€ä¸ªåŒ…å«ä¸€æ£µç”Ÿæˆæ ‘ $\text{T}$ çš„æœ‰å‘å›¾ $\text{P}$ï¼Œå¹¶æŒ‰ç…§è®¿é—®é¡ºåºï¼Œä» $1$ å¼€å§‹ç»™ $\text{P}$ ä¸Šæ¯ä¸ªç‚¹ç¼–å·ï¼š</p>

<p><img src="/assets/img/tarjandfs/dfs.png" alt="" /></p>

<p>åé¢çš„ç®—æ³•éƒ½ä»¥ DFS æ„å»ºçš„æœ‰å‘å›¾ $\text{P}$ ä¸ºåŸºç¡€ï¼Œè§‚å¯Ÿå®ƒçš„å›æº¯è¾¹çš„æƒ…å†µã€‚</p>

<p><strong>å›æº¯è¾¹</strong>ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>

<ol>
  <li>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»æŸä¸ªç‚¹å›åˆ°å®ƒçš„ä¸€ä¸ªç¥–å…ˆèŠ‚ç‚¹çš„ä¸€æ¡è¾¹ï¼Œæ¯”å¦‚ $\text{G}\curvearrowright\text{D}$ ï¼Œå¯ä»¥å«å®ƒ<strong>å¶è¾¹ï¼ˆfrondï¼‰</strong>ï¼›</li>
  <li>ä¸Šå›¾æ²¡æœ‰çš„ï¼Œä»æŸä¸ªç‚¹å›åˆ°ä¸æ˜¯å®ƒç¥–å…ˆèŠ‚ç‚¹ï¼ˆä½†æ˜¯ä¹Ÿæ¯”å®ƒæ›´æ—©è®¿é—®åˆ°ï¼‰çš„ä¸€æ¡è¾¹ï¼Œæ¯”å¦‚$\text{G}\curvearrowright\text{H}$ ï¼Œå¯ä»¥å«å®ƒ<strong>æ¨ªå‰è¾¹ï¼ˆcross linkï¼‰</strong></li>
</ol>

<p>å¦‚æœ $\text{P}$ çš„æ‰€æœ‰å›æº¯è¾¹éƒ½æ˜¯å¶è¾¹ï¼Œé‚£ä¹ˆå¯ä»¥ç§°å®ƒä¸º<strong>æ£•æ¦ˆæ ‘ï¼ˆpalm treeï¼‰</strong><sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">4</a></sup>ã€‚</p>

<p>å¯ä»¥å‘ç°ï¼Œåœ¨ä»»æ„æ— å‘è¿é€šå›¾ä¸Šåš DFS ï¼Œæ„å»ºçš„æœ‰å‘å›¾ $\text{P}$ ä¸€å®šæ˜¯æ£•æ¦ˆæ ‘ï¼›åä¹‹ä»»æ„æ£•æ¦ˆæ ‘ $\text{P}$ ä¸€å®šå¯ä»¥ç”±ä¸€ä¸ªå®ƒçš„æ— å‘å›¾ç‰ˆæœ¬åš DFS å¾—åˆ°ã€‚</p>

<p>æ¢è¨€ä¹‹ï¼Œæ— å‘å›¾ DFSï¼Œä¸å­˜åœ¨æ¨ªå‰è¾¹ã€‚è¿ç”¨åè¯æ³•ï¼šå› ä¸ºæ˜¯æ— å‘å›¾ï¼Œå¦‚æœå­˜åœ¨æ¨ªå‰è¾¹ï¼Œé‚£ä¹ˆå®ƒå°±åº”è¯¥ä½œä¸º DFS è¿‡ç¨‹ä¸­ç”Ÿæˆæ ‘ä¸Šçš„ä¸€æ¡è¾¹ï¼Œè€Œä¸æ˜¯å›æº¯è¾¹ã€‚</p>

<p>æ ¹æ®æŸä¸ªç‚¹çš„æ‰€æœ‰åä»£çš„å›æº¯è¾¹æ‰€èƒ½åˆ°è¾¾çš„ç¼–å·æœ€å°çš„ç‚¹ï¼Œå¼•å‡ºä¸€ä¸ªå…³é”®æ¦‚å¿µ â€“ <strong>LOWPT</strong><sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">5</a></sup>ï¼š</p>

<p>$\text{lowpt}(v)$ å®šä¹‰ä¸ºä» $v$ å‡ºå‘ï¼Œç»è¿‡é›¶ä¸ªæˆ–æ›´å¤šçš„æ ‘å¼§ï¼Œå’Œæœ€å¤šä¸€æ¡å›æº¯è¾¹ï¼Œæ‰€èƒ½åˆ°è¾¾çš„ç¼–å·æœ€å°çš„ç‚¹ï¼ˆæˆ‘ä»¬ä¸å¦¨ç”¨ $\text{index}(v)$ è¡¨ç¤º $v$ ç‚¹çš„ç¼–å·ï¼‰ã€‚</p>

<h2 id="åŒè”é€šåˆ†é‡">åŒè”é€šåˆ†é‡</h2>

<p>æœ‰äº†å‰é¢çš„çŸ¥è¯†é“ºå«ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ DFS ï¼Œé¦–å…ˆæ¥è§£å†³åœ¨æ— å‘å›¾ä¸Šçš„åŒè¿é€šåˆ†é‡ï¼ˆbiconnected component, bccï¼‰çš„åˆ’åˆ†é—®é¢˜ï¼Œè€Œåœ¨å…·ä½“è®¨è®ºä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆç†æ¸…ä¸‹æ¦‚å¿µï¼š</p>

<h3 id="æ¦‚å¿µ">æ¦‚å¿µ</h3>

<p><strong>2-è¿é€šå›¾</strong></p>

<p>è¯»ä½œ $2$ ç‚¹è¿é€šå›¾ï¼Œæ˜¯ <a href="https://en.wikipedia.org/wiki/K-vertex-connected_graph">$k$ ç‚¹è¿é€šå›¾</a>çš„ä¸€ä¸ªå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿é€šå›¾é‡Œæœ‰åªæœ‰åˆ é™¤ä¸¤ä¸ªç‚¹æ‰èƒ½å¯¼è‡´å›¾ä¸è¿é€šã€‚</p>

<p><strong>åŒè¿é€šå›¾</strong></p>

<p>åŒè”é€šå›¾ï¼ˆbiconnected graphï¼‰å¤§å¤šæ•°æƒ…å†µä¸‹å’Œ 2-è¿é€šå›¾ï¼ˆ2-connected graphï¼‰æ˜¯ç­‰ä»·çš„ï¼Œåªåœ¨ä¸€ä¸ªä¾‹å¤–ï¼Œå°±æ˜¯åªåŒ…å«ä¸€æ¡è¾¹çš„å›¾ä»ç„¶æ˜¯åŒè”é€šå›¾ï¼Œä½†ä¸€èˆ¬ä¸è¢«è§†ä¸º 2-è¿é€šå›¾<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">6</a></sup><sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">7</a></sup>ã€‚</p>

<p>åŒè¿é€šå›¾ä¹‹æ‰€ä»¥æœ‰è¿™ä¹ˆä¸ªç‰¹æ®Šä¾‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æ–¹ä¾¿æŠŠå›¾æŒ‰åŒè¿é€šåˆ†é‡è¿›è¡Œåˆ’åˆ†ï¼Œå¯¹å‰©ä¸‹çš„æ•£ç¢è¾¹ï¼Œæ¯æ¡è¾¹éƒ½å¯ä»¥è§†ä¸ºä¸€ä¸ªæœ€å°çš„åŒè¿é€šåˆ†é‡ã€‚</p>

<h3 id="ç®—æ³•">ç®—æ³•</h3>

<p>åˆ’åˆ†åŒè¿é€šåˆ†é‡çš„å…³é”®åœ¨äºå¯»æ‰¾åˆ†é‡ä¹‹é—´çš„è¡”æ¥ç‚¹ï¼ˆarticulation pointï¼‰<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">8</a></sup>ã€‚</p>

<p>è¡”æ¥ç‚¹å¯ä»¥åˆ©ç”¨è®¡ç®—çš„ $\text{lowpt}$ å¯»æ‰¾ï¼šåœ¨ DFS æ„å»ºçš„æœ‰å‘å›¾ $\text{P}$ ä¸Šï¼Œå¦‚æœä¸€ä¸ªç‚¹çš„ $\text{lowpt}$ ä¸ä½äºå®ƒçš„çˆ¶èŠ‚ç‚¹çš„ç¼–å·ï¼Œé‚£ä¹ˆå®ƒçš„çˆ¶èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªè¡”æ¥ç‚¹ã€‚</p>

<p>æ¯”å¦‚ï¼Œå¯¹äºä¸‹å›¾</p>

<p><img src="/assets/img/tarjandfs/bcc_raw.png" alt="" /></p>

<p>DFS æ„å»ºçš„æœ‰å‘å›¾ï¼š</p>

<p><img src="/assets/img/tarjandfs/bcc_tree.png" alt="" /></p>

<p>ä¸Šå›¾ G ç‚¹çš„ $\text{lowpt}(3)=2=\text{index}(2)$ ï¼Œå› æ­¤ $3$ çš„çˆ¶èŠ‚ç‚¹ $2$ å°±æ˜¯ä¸€ä¸ªè¡”æ¥ç‚¹ï¼Œå¦‚æœæ­¤æ—¶æŠŠä¹‹å‰éå†è¿‡ç¨‹ä¸­å…¥æ ˆçš„è¾¹ $2\rightarrow 3$ ï¼Œ$3\rightarrow 4$ï¼Œ$4\rightarrow2$ ä»æ ˆé¡¶ä¾æ¬¡å¼¹å‡ºï¼Œé‚£ä¹ˆå°±æ”¶é›†äº†ä¸€ä¸ªåŒè”é€šåˆ†é‡çš„åˆ’åˆ†ã€‚</p>

<p>æœ€ç»ˆå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="/assets/img/tarjandfs/bcc_bccs.png" alt="" /></p>

<p>ä¼ªä»£ç æœ‰äº›åƒåŠ›ä¸è®¨å¥½ï¼Œä¸å¦‚ç›´æ¥çœ‹å®ç°</p>

<h3 id="å®ç°">å®ç°</h3>

<p><a href="https://github.com/minghu6/rust-minghu6/blob/v0.1.6/coll_graph/src/bcc.rs">æºä»£ç </a></p>

<h4 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h4>

<p>æ¯ä¸ªç‚¹è¦ä¿å­˜å®ƒçš„ DFS ç¼–å·å’Œ $\text{lowpt}$ ï¼Œç”¨ <code class="language-plaintext highlighter-rouge">Option</code> ç±»å‹æŒ‡ç¤ºè¯¥ç‚¹æ˜¯å¦è¢«è®¿é—®ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Default,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="k">struct</span> <span class="n">DFSMeta</span> <span class="p">{</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">lowpt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ•´ä½“è¿‡ç¨‹">æ•´ä½“è¿‡ç¨‹</h4>

<p>å‡è®¾å›¾ä¸­æ¯ä¸ªç‚¹éƒ½æ˜¯è¿ç»­åœ°ï¼Œå¹¶ä¸”ä» $1$ å¼€å§‹ï¼Œä½¿ç”¨ä¸€ä¸ªæ•°ç»„ä½œä¸º Map ä¿å­˜æ¯ä¸ªç‚¹çš„ä¿¡æ¯ã€‚</p>

<p>å¯¹å›¾ä¸Šæ¯ä¸ªç‚¹éå†ï¼Œå¦‚æœè¯¥ç‚¹æ²¡æœ‰è¢«æ ‡è®°è¿‡ï¼Œå°±æ‰§è¡Œ DFS å­è¿‡ç¨‹ï¼Œè¿™ä¹ˆåšæ˜¯è€ƒè™‘åˆ°ç»™å®šçš„å›¾ä¸ä¸€å®šæ˜¯è¿é€šçš„ï¼Œéœ€è¦åœ¨ä¸åŒåˆ†é‡ä¸Šåˆ†åˆ«è¿›è¡Œ DFSã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">bcc_tarjan</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">bccs</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="k">if</span> <span class="n">g</span><span class="py">.e</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">bccs</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">stack</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[];</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">max_v</span> <span class="o">=</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span><span class="nf">.max</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">vertexs</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nn">DFSMeta</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">for</span> <span class="n">u</span> <span class="k">in</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">dfs_bcc</span><span class="p">(</span>
                <span class="n">g</span><span class="p">,</span>
                <span class="n">u</span><span class="p">,</span>
                <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bccs</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">stack</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">index</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="k">mut</span> <span class="n">vertexs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">bccs</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="dfs-å­è¿‡ç¨‹">DFS å­è¿‡ç¨‹</h4>

<p><strong>éƒ¨åˆ†å‚æ•°è§£é‡Š</strong></p>

<ol>
  <li>$p$ ï¼Œå¯¹äºæ— å‘ï¼ˆç®€å•ï¼‰å›¾ï¼Œéœ€è¦ä¼ ä¸€ä¸ªçˆ¶èŠ‚ç‚¹å‚æ•° $p$ ï¼Œæ¥é¿å…å¯¹è¾¹è¿›è¡Œé‡å¤è®¿é—®ï¼›</li>
  <li>$bccs$ ä¿å­˜åˆ’åˆ†å‡ºçš„åŒè¿é€šåˆ†é‡çš„è¾¹é›†ï¼Œç”¨è¾¹é›†è€Œä¸æ˜¯ç‚¹é›†æ˜¯å› ä¸ºåŒè¿é€šåˆ†é‡ä¹‹é—´æœ‰ç‚¹æ˜¯æœ‰äº¤åˆçš„ï¼ˆå°±æ˜¯è¡”æ¥ç‚¹ï¼‰ï¼Œä½†æ˜¯è¾¹é›†æ˜¯ä¸ç›¸äº¤çš„ï¼›</li>
  <li>$stack$ ä¿å­˜ DFS è¿‡ç¨‹è®¿é—®è¿‡çš„è¾¹ï¼Œç”¨æ¥å‘ç°è¡”æ¥ç‚¹åæ”¶é›†æ–°çš„åŒè¿é€šåˆ†é‡çš„è¾¹</li>
</ol>

<p><strong>è¿‡ç¨‹è§£é‡Š</strong></p>

<p>åˆå§‹åŒ–è¢«è®¿é—®ç‚¹çš„ç¼–å· $\text{index}$ å’Œ $\text{lowpt}$ ï¼Œå…¶ä¸­ $\text{lowpt}$ åˆå§‹åŒ–çš„æ—¶å€™ä¸ç¼–å·ä¸€è‡´ã€‚</p>

<p>éå†è®¿é—®ç‚¹ $u$ æ‰€æœ‰çš„å‡ºè¾¹ï¼Œå¦‚æœå‡ºè¾¹çš„å¤´èŠ‚ç‚¹ $v$ æœªè¢«ç¼–å·ï¼Œå°±æ¨è¾¹å…¥æ ˆï¼Œå¹¶åœ¨ $v$ ä¸Šæ‰§è¡Œ DFS æ“ä½œï¼Œä¹‹ååˆ©ç”¨ $\text{lowpt}(v)$ æ›´æ–° $\text{lowpt}(u)$ ï¼Œå¹¶æ£€æŸ¥ $\text{lowpt}(v)$ æ˜¯å¦ä¸å°äº $\text{index}(u)$ <sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">9</a></sup>ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ”¶é›†æ ˆä¸Šçš„è¾¹ï¼Œç›´åˆ°æ”¶é›†å®Œèµ·ç‚¹ä¸º $u$ çš„è¾¹<sup id="fnref:11" role="doc-noteref"><a href="#fn:11" class="footnote" rel="footnote">10</a></sup>ï¼›</p>

<p>å¦‚æœ $v$ å·²è¢«ç¼–å·ï¼Œå°±ç”¨å®ƒçš„ç¼–å·æ›´æ–° $\text{lowpt}(u)$ ï¼Œå½“ç„¶è¦æ’é™¤çˆ¶èŠ‚ç‚¹çš„æƒ…å†µï¼Œé¿å…é‡å¤è®¿é—®åŒä¸€æ¡è¾¹ã€‚</p>

<p>å¦å¤–å¦‚æœå¯¹è¾¹é›†é‡Œçš„è¾¹å’Œè¾¹é›†çš„é¡ºåºæœ‰è¦æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹è¿˜è¦è¿›è¡Œä¸€ä¸ªæ’å…¥æ’åºã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">dfs_bcc</span><span class="p">(</span>
    <span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">u</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">p</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="k">mut</span> <span class="n">bccs</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">stack</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">vertexs</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DFSMeta</span><span class="o">&gt;</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="o">*</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">DFSMeta</span> <span class="p">{</span>
        <span class="n">index</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">),</span>
        <span class="n">lowpt</span><span class="p">:</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="nd">get!</span><span class="p">(</span><span class="n">g</span><span class="py">.e</span> <span class="k">=&gt;</span> <span class="n">u</span> <span class="k">=&gt;</span> <span class="nd">vec!</span><span class="p">[])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">stack</span><span class="nf">.push</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
            <span class="nf">dfs_bcc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">bccs</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">);</span>

            <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowpt</span> <span class="o">=</span>
            <span class="nf">min</span><span class="p">(</span><span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowpt</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.lowpt</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span><span class="nf">.unwrap</span><span class="p">()</span> <span class="o">==</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowpt</span> <span class="p">{</span>
                <span class="c1">// u is cut point</span>
                <span class="c1">// get biconnected component</span>

                <span class="k">let</span> <span class="k">mut</span> <span class="n">bcc</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[];</span>

                <span class="k">loop</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">=</span> <span class="n">stack</span><span class="nf">.pop</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
                    <span class="nd">ordered_insert!</span><span class="p">(</span>
                        <span class="o">&amp;</span><span class="k">mut</span> <span class="n">bcc</span><span class="p">,</span>
                        <span class="k">if</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="n">v2</span> <span class="p">{</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="p">}</span>
                    <span class="p">);</span>

                    <span class="k">if</span> <span class="n">v1</span> <span class="o">==</span> <span class="n">u</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nd">ordered_insert!</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">bccs</span><span class="p">,</span> <span class="n">bcc</span><span class="p">,</span> <span class="p">|</span><span class="n">bcc</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span><span class="o">&gt;</span><span class="p">|</span> <span class="n">bcc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span> <span class="o">&lt;</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">p</span> <span class="p">{</span>
            <span class="n">stack</span><span class="nf">.push</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
            <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowpt</span> <span class="o">=</span>
            <span class="nf">min</span><span class="p">(</span><span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowpt</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span><span class="nf">.unwrap</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>ordered_insert</strong></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">ordered_insert</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$vec:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">vec</span> <span class="o">=</span> <span class="nv">$vec</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>

        <span class="k">match</span> <span class="n">vec</span><span class="nf">.binary_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">oldidx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="nf">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">vec</span><span class="p">[</span><span class="n">oldidx</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
            <span class="p">},</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">inseridx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="n">vec</span><span class="nf">.insert</span><span class="p">(</span><span class="n">inseridx</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
                <span class="nb">None</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="nv">$vec:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$f:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">vec</span> <span class="o">=</span> <span class="nv">$vec</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="nv">$f</span><span class="p">;</span>

        <span class="k">match</span> <span class="n">vec</span><span class="nf">.binary_search_by_key</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">oldidx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="nf">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">vec</span><span class="p">[</span><span class="n">oldidx</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
            <span class="p">},</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">inseridx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="n">vec</span><span class="nf">.insert</span><span class="p">(</span><span class="n">inseridx</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
                <span class="nb">None</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ—¶é—´å¤æ‚åº¦">æ—¶é—´å¤æ‚åº¦</h3>

<p>ä¸è€ƒè™‘å¯¹ç»“æœçš„æ ‡å‡†åŒ–é—®é¢˜ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶ä¸º $O(V)+O(E)$</p>

<h2 id="å¼ºè¿é€šåˆ†é‡">å¼ºè¿é€šåˆ†é‡</h2>

<p>å‰é¢è®²äº†æ— å‘å›¾ä¸ŠåŒè¿é€šåˆ†é‡çš„åˆ’åˆ†ï¼Œä½†å¯¹äºæœ‰å‘å›¾è€Œè¨€ï¼ŒDFS å°†ä¸ä¼šæ˜¯ä¸€ä¸ªç®€å•çš„æ£•æ¦ˆæ ‘çš„ç»“æ„ï¼Œå› ä¸ºè¾¹çš„æ–¹å‘æ˜¯å›ºå®šçš„ï¼Œè€Œä¸æ˜¯åŒå‘éƒ½å¯ä»¥çš„ï¼Œä½†ï¼ˆæ®ä½œè€…è¯´ï¼šâ€œThe more complicated structure which results in this case is still simple enough to prove useful in at least one application.â€ï¼‰</p>

<p>ä¸è¿‡ä¸ç®¡é‚£äº›ï¼Œè¿˜å¯ä»¥ç”¨ä¸€ä¸ªä¸ä¸Šè¿°ç®—æ³•éå¸¸ç›¸ä¼¼çš„è¿‡ç¨‹è§£å†³æœ‰å¯»æ‰¾<strong>å‘å›¾ä¸Šçš„å¼ºè¿é€šåˆ†é‡é—®é¢˜ï¼ˆstrong connected componentï¼Œsccï¼‰</strong>ã€‚</p>

<h3 id="ç®—æ³•-1">ç®—æ³•</h3>

<p>å¦‚æœä»ä¸€ä¸ªç‚¹å‡ºå‘ï¼Œæœ€ååˆå›åˆ°äº†è¯¥ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹å°±æ˜¯å¼ºè¿é€šåˆ†é‡çš„æ ¹èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåœ¨ $u$ ç‚¹çš„æ‰€æœ‰å‡ºè¾¹ DFS ç»“æŸåï¼Œå‘ç° $\text{index}(u)=\text{lowpt}(u)$ ï¼Œé‚£ä¹ˆ $u$ å°±æ˜¯ä¸€ä¸ªå¼ºè¿é€šåˆ†é‡çš„æ ¹èŠ‚ç‚¹ï¼Œè€Œæ­¤æ—¶æ”¶é›†æ ˆä¸Šæ‰€æœ‰ç¼–å·å¤§äº $u$ çš„ç‚¹ï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªå¼ºè¿é€šåˆ†é‡çš„ç‚¹é›†ã€‚</p>

<h3 id="å®ç°-1">å®ç°</h3>

<p><a href="https://github.com/minghu6/rust-minghu6/blob/v0.1.6/coll_graph/src/scc.rs">æºä»£ç </a></p>

<p>æ•°æ®ç»“æ„</p>

<p>æ–°å­—æ®µ <code class="language-plaintext highlighter-rouge">on_stack</code> ç”¨æ¥æŒ‡ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨æ ˆä¸Šï¼Œè¿™æ ·ç›¸æ¯”ç”¨å•ç‹¬çš„å“ˆå¸Œé›†åˆæ¥ç»´æŠ¤ï¼Œæœ‰æ›´å¥½çš„å±€éƒ¨æ€§ã€‚è€Œä¹‹æ‰€ä»¥è¦æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨æ ˆä¸Šï¼Œåé¢ä¼šè§£é‡Šã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Default,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="k">struct</span> <span class="n">DFSMeta</span> <span class="p">{</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">lowlink</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">on_stack</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ•´ä½“è¿‡ç¨‹-1">æ•´ä½“è¿‡ç¨‹</h4>

<p>å’Œåˆ’åˆ† BCC æ—¶ä¸€æ ·ï¼ŒåŒºåˆ«åªåœ¨äºï¼Œä½¿ç”¨äº†ç‚¹é›†å–ä»£è¾¹é›†ï¼Œè¿™æ˜¯å› ä¸ºåªéœ€è¦å¯»æ‰¾ä» SCC è€Œä¸æ˜¯å¯¹å›¾è¿›è¡Œåˆ’åˆ†ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">scc_tarjan</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">comps</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="k">if</span> <span class="n">g</span><span class="py">.e</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">comps</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">stack</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[];</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">max_v</span> <span class="o">=</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span><span class="nf">.max</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">vertexs</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nn">DFSMeta</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">for</span> <span class="n">u</span> <span class="k">in</span> <span class="n">g</span><span class="nf">.vertexs</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">dfs_scc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">comps</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">vertexs</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">comps</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="dfså­è¿‡ç¨‹">DFSå­è¿‡ç¨‹</h4>

<p>åŒæ ·ç±»ä¼¼äºåˆ’åˆ† BCC ï¼Œéœ€è¦æ³¨æ„å¾—æ˜¯åœ¨ DFS è¿‡ç¨‹ä¸­ï¼Œç”±äºæ˜¯æœ‰å‘å›¾ï¼Œæ‰€ä»¥è¦è€ƒè™‘ $u$ çš„å‡ºè¾¹èŠ‚ç‚¹ $v$ ä¸ä¸å®ƒåœ¨åŒä¸€ SCC çš„æƒ…å†µï¼Œåˆ¤æ–­æ–¹æ³•æ˜¯ï¼šå¦‚æœä¸åœ¨åŒä¸€ SCC ï¼Œé‚£ä¹ˆåœ¨ DFS è¿‡ç¨‹ä¸­å¿…ç„¶å·²ç»åˆ’åˆ†åˆ°å…¶ä»–çš„ SCC ä¸­å»äº†ï¼Œå› æ­¤å·²ç»ä»æ ˆä¸Šå¼¹å‡ºäº†ï¼Œæ‰€ä»¥åªéœ€è¦æ£€æŸ¥è¯¥ç‚¹æ˜¯å¦è¿˜åœ¨æ ˆä¸Šå°±å¯ä»¥ï¼Œè¿™å°±æ˜¯ <code class="language-plaintext highlighter-rouge">on_stack</code> å­—æ®µçš„ä½œç”¨ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">dfs_scc</span><span class="p">(</span>
    <span class="n">g</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">u</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">comps</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">stack</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">vertexs</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DFSMeta</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">DFSMeta</span> <span class="p">{</span>
        <span class="n">index</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">),</span>
        <span class="n">lowlink</span><span class="p">:</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>
        <span class="n">on_stack</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="o">*</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stack</span><span class="nf">.push</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="nd">get!</span><span class="p">(</span><span class="n">g</span><span class="py">.e</span> <span class="k">=&gt;</span> <span class="n">u</span> <span class="k">=&gt;</span> <span class="nd">vec!</span><span class="p">[])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">dfs_scc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">comps</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">);</span>

            <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowlink</span> <span class="o">=</span>
            <span class="nf">min</span><span class="p">(</span><span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowlink</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.lowlink</span><span class="p">);</span>
        <span class="p">}</span> 
        <span class="k">else</span> <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span> <span class="o">&lt;</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span> <span class="o">&amp;&amp;</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.on_stack</span>
        <span class="p">{</span>
            <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowlink</span> <span class="o">=</span>
            <span class="nf">min</span><span class="p">(</span><span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowlink</span><span class="p">,</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="py">.index</span><span class="nf">.unwrap</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* start a new scc */</span>

    <span class="k">if</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.lowlink</span> <span class="o">==</span> <span class="n">vertexs</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="py">.index</span><span class="nf">.unwrap</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">new_comp</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

        <span class="k">while</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">stack</span><span class="nf">.pop</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">ordered_insert!</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">new_comp</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
            <span class="n">vertexs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="py">.on_stack</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">u</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">ordered_insert!</span><span class="p">(</span><span class="n">comps</span><span class="p">,</span> <span class="n">new_comp</span><span class="p">,</span> <span class="p">|</span><span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">|</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ—¶é—´å¤æ‚åº¦-1">æ—¶é—´å¤æ‚åº¦</h3>

<p>ä¸è€ƒè™‘å¯¹ç»“æœçš„æ ‡å‡†åŒ–é—®é¢˜ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶ä¸º $O(V)+O(E)$</p>

<h3 id="æ— å‘å›¾">æ— å‘å›¾</h3>

<p>æ˜¾ç„¶ä¸Šè¿°æ±‚å–æœ‰å‘å›¾ä¸Š SCC çš„ç®—æ³•ä¹Ÿå®Œå…¨é€‚åº”äºæ±‚å–æ— å‘å›¾ä¸Šçš„è¿é€šåˆ†é‡é—®é¢˜ã€‚ä¸€èˆ¬ä½¿ç”¨å¹¶æŸ¥é›†ï¼ˆmultiset union, disjoint set union, union find, etc.ï¼‰ç›´æ¥è®¡ç®—çš„è¯ï¼Œæ¯æ¡è¾¹éœ€è¦é¢å¤–ä»˜å‡ºå¹¶æŸ¥é›†çš„ $O(\text{log}(V))$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œè¡¨ç°è¦å·®äº Tarjan ç®—æ³•ã€‚</p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://scholar.google.com/scholar?oi=bibs&amp;cluster=15533190727229683002&amp;btnI=1&amp;hl=en">Depth-first search and linear graph algorithms</a> R Tarjan - SIAM journal on computing, 1972Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://scholar.google.com/scholar?oi=bibs&amp;cluster=15317103615758324241&amp;btnI=1&amp;hl=en">Algorithm 447: efficient algorithms for graph manipulation</a> J Hopcroft, R Tarjan - Communications of the ACM, 1973Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>ç¬¬äºŒç¯‡è®ºæ–‡è¿˜æåˆ°äº†åœ¨åŒè”é€šåˆ†é‡ä¸Šçš„ç®€å•è·¯å¾„åˆ’åˆ†ï¼Œä½†æ˜¯æ—¢ç¼ºä¹å…·ä½“è§£é‡Šï¼Œæµç¨‹å›¾ä¹Ÿæ¨¡ç³Šä¸æ¸…ï¼Œä¼ªä»£ç è¿˜æ˜¯ goto ç»“æ„çš„ï¼Œä»¤äººå®åœ¨æ²¡æœ‰æ—¶é—´å»çœ‹äº†Â <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>â€œæ£•æ¦ˆæ ‘â€å’Œâ€œå¶è¾¹â€éƒ½æ˜¯ä½œè€…åœ¨è®ºæ–‡<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>é‡Œèµ·çš„å½¢è±¡åå­—Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>æ›¾ç»ï¼Œåœ¨ç¬¬ä¸€ç¯‡è®ºæ–‡é‡Œï¼Œä½œè€…æå‡ºçš„<strong>LOWPT</strong>çš„å®šä¹‰æ˜¯ï¼šâ€œThat is, LOWPT(v) is the smallest vertex reachable from v by traversing zero or more tree arcs followed by at most one frond. â€ï¼›è¿˜æå‡ºäº†å¦å¤–ä¸€ä¸ªç›¸ä¼¼çš„æ¦‚å¿µ <strong>LOWLINK</strong>ï¼šâ€œThat is, LOWLINK (v) is the smallest vertex which is in the same component as v and is reachable by traversing zero or more tree arcs followed by at most one frond or cross-link.â€ ã€‚è¿™ä¸¤è€…çš„æœ¬è´¨ä¸Šæ˜¾ç„¶æ˜¯ç›¸åŒçš„ï¼ŒåŒºåˆ«åªåœ¨äºä¸€ä¸ªæ˜¯åº”ç”¨åœ¨æ— å‘å›¾ä¸Šï¼ˆåˆ’åˆ†bccï¼‰æ‰€ä»¥å›æº¯è¾¹åªç»è¿‡å¶è¾¹ï¼Œè€Œå¦ä¸€ä¸ªæ˜¯åº”ç”¨åœ¨æœ‰å‘å›¾ä¸Šï¼ˆåˆ’åˆ†sccï¼‰æ‰€ä»¥å›æº¯è¾¹å¯èƒ½ç»è¿‡å¶è¾¹æˆ–è€…æ¨ªå‰è¾¹ï¼Œè‡³äºâ€œåœ¨åŒä¸€ä¸ªåˆ†é‡é‡Œâ€çš„è¯´æ³•ï¼Œåªèƒ½è¯´æ˜¯å›æº¯çš„å¿…ç„¶ç»“æœï¼Œè€Œä¸æ˜¯é™åˆ¶ã€‚è€Œåœ¨ç¬¬äºŒç¯‡è®ºæ–‡é‡Œï¼Œä½œè€…ä¹Ÿä¸å†åŒºåˆ†ï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨äº†LOWPTã€‚Â <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>https://en.wikipedia.org/wiki/Biconnected_graph#Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>å½“ç„¶å•ç‚¹å›¾ï¼Œä¹Ÿå°±æ˜¯ä¸å«è¾¹çš„å›¾æ—¢ä¸æ˜¯åŒè¿é€šå›¾ä¹Ÿä¸æ˜¯2-è¿é€šå›¾Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>ä¹Ÿå°±æ˜¯å‰²ç‚¹ï¼ˆcut pointï¼‰ï¼Œä½†æ˜¯å‰²ç‚¹æœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸ä¼šè¿›å…¥é‚£ä¸ªé¢†åŸŸÂ <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p>è¿™é‡Œç›´æ¥æ£€æŸ¥äº† $\text{lowpt}(u)$ æ˜¯å¦è¢«æ›´æ–°å¾—æ›´å°Â <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:11" role="doc-endnote">
      <p>æ³¨æ„æ ˆä¸Šçš„é¡ºåºä¸è®¿é—®çš„é¡ºåºæ˜¯åå‘çš„Â <a href="#fnref:11" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[æœ¬æ–‡èµ„æ–™æ¥æºäº12 Depth-first search and linear graph algorithms R Tarjan - SIAM journal on computing, 1972Â &#8617; Algorithm 447: efficient algorithms for graph manipulation J Hopcroft, R Tarjan - Communications of the ACM, 1973Â &#8617;]]></summary></entry><entry><title type="html">æ ‘çŠ¶æ•°ç»„</title><link href="/algs/FenwickTree.html" rel="alternate" type="text/html" title="æ ‘çŠ¶æ•°ç»„" /><published>2023-04-24T00:00:00+08:00</published><updated>2023-04-24T00:00:00+08:00</updated><id>/algs/FenwickTree</id><content type="html" xml:base="/algs/FenwickTree.html"><![CDATA[<p><em>æœ¬æ–‡ä¸»è¦å‚è€ƒ <a href="https://oi-wiki.org/ds/fenwick">OI-wiki</a> ä»¥åŠ <a href="https://cp-algorithms.com/data_structures/fenwick.html">cp-algorithms.com</a> ç›¸å…³é¡µé¢</em><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p>

<p>æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, Fenwick Treeï¼‰<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>ï¼Œä»¥ä¸‹ç®€ç§° BITï¼Œå…¶å‘½åæ˜¯ç”±äº <a href="https://en.wikipedia.org/w/index.php?title=Peter_Fenwick_(computer_scientist)&amp;action=edit&amp;redlink=1">Peter Fenwick</a> åœ¨ 1994 å¹´å‘è¡¨çš„æ–‡ç« é‡Œæè¿°äº†è¿™ä¸€ç»“æ„ï¼Œ<strong>å®ƒçš„æœ¬è´¨æ˜¯é€šè¿‡é«˜æ•ˆåœ°è®¡ç®—æ•°ç»„çš„å‰ç¼€å’Œæ¥è§£å†³ç›¸å…³çš„é—®é¢˜</strong>ã€‚</p>

<h2 id="vs-åˆ†æ®µæ ‘">VS åˆ†æ®µæ ‘</h2>

<p>å› æ­¤æ ‘çŠ¶æ•°ç»„ä¹Ÿèƒ½è§£å†³è¯¸å¦‚ç»™å®šåŒºé—´çš„å’Œä¹‹ç±»çš„é—®é¢˜ï¼Œ<strong>åªè¦è¿™ç±»é—®é¢˜å¯ä»¥è½¬æ¢ä¸ºå‡ ä¸ªå‰ç¼€å’Œçš„è¿ç®—</strong>ã€‚</p>

<p>è€Œå‰é¢ä»‹ç»è¿‡çš„<a href="/algs/SegmentTree.html">åˆ†æ®µæ ‘</a>ä¹Ÿå¯ä»¥è§£å†³è¿™ç±»é—®é¢˜ï¼ŒåŒºåˆ«æ˜¯ï¼š</p>

<p><strong>æ—¶é—´å¤æ‚åº¦ï¼š</strong></p>

<p>éƒ½æ˜¯ $O(\text{log}n)$ï¼Œä½†æ ‘çŠ¶æ•°ç»„çš„æ€§èƒ½è¿œå¥½äºåˆ†æ®µæ ‘ï¼Œæµ‹ç®—å¯èƒ½å·®äº† 10 å€</p>

<p><strong>ç©ºé—´å¤æ‚åº¦ï¼š</strong></p>

<p>éƒ½æ˜¯ $O(n)$ ï¼Œä½†æ ‘çŠ¶æ•°ç»„ç©ºé—´å’Œæºæ•°ç»„å¤§å°ç›¸ç­‰ï¼Œæ˜¯ $1n$ ï¼Œè€Œåˆ†æ®µæ ‘ DFS å‹éœ€è¦ $2n$ ï¼ŒBFS å‹æ›´æ˜¯éœ€è¦ $4n$</p>

<p><strong>ä»£ç å¤æ‚åº¦</strong></p>

<p>æ ‘çŠ¶æ•°ç»„çš„ä»£ç æ›´ç®€å•</p>

<p>å› æ­¤åªè¦èƒ½ç”¨æ ‘çŠ¶æ•°ç»„è§£å†³çš„é—®é¢˜ï¼Œéƒ½ä¼˜å…ˆä½¿ç”¨æ ‘çŠ¶æ•°ç»„<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ã€‚</p>

<h2 id="æ¦‚å¿µ">æ¦‚å¿µ</h2>

<p>å¯ä»¥é€šè¿‡ä¸€ä¸ªå›¾ç›´æ¥çœ‹ä¸€ä¸‹æ ‘çŠ¶æ•°ç»„çš„ç»“æ„<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>ï¼Œä¸‹å›¾æ˜¯æ•°ç»„ $a[1..16]$ çš„ BIT ç»“æ„ï¼š</p>

<p><img src="/assets/img/bit/bit.svg" alt="" /></p>

<p>å›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨ä¸€æ®µé•¿åº¦è‡³å°‘ä¸º $1$ çš„åŒºé—´ï¼Œæ¯”å¦‚ $2$ åŒ…å«åŒºé—´ $[1..2]$ ï¼Œ$4$ åŒ…å«åŒºé—´ $[1..4]$ ï¼Œ$6$ åŒ…å«åŒºé—´ $[5..6]$ ã€‚</p>

<p>è®©æˆ‘ä»¬çœç•¥æ‰é‡å¤çš„å…ƒç´ ï¼Œä¼šå¯¹ç»“æ„çœ‹å¾—æ›´æ¸…æ™°ï¼š</p>

<p><img src="/assets/img/bit/bit2.png" alt="" /></p>

<p>æˆ‘ä»¬å‘ç° BIT å®é™…ä¸Šå°±æ˜¯ç”±æˆ‘ä»¬å‰é¢ä»‹ç»<a href="/algs/FibHeap.html">æ–æ³¢é‚£å¥‘å †</a>æ—¶æè¿‡çš„äºŒé¡¹æ ‘ç»„æˆã€‚</p>

<p>æ¯”å¦‚ $8$ æ˜¯ä¸€æ£µ $\text{rank}=3$ çš„äºŒé¡¹æ ‘ï¼Œ$12$ æ˜¯ä¸€æ£µ $\text{rank}=2$ çš„äºŒé¡¹æ ‘ã€‚</p>

<p>äºŒé¡¹å †æ˜¯è¯´æ¯ä¸ªå­©å­éƒ½æ˜¯ $\text{rank}$ ç‹¬ç‰¹çš„äºŒé¡¹æ ‘ï¼ŒåŒæ—¶æ»¡è¶³å°é¡¶å †çš„æ€§è´¨ï¼Œè€Œ BIT è‡ªç„¶ä¸éœ€è¦æ»¡è¶³å †çš„æ€§è´¨ï¼Œä½†æ˜¯ä¹Ÿè¦æ±‚ $\text{rank}$ ç‹¬ç‰¹ï¼Œå¹¶ä¸” rank æ˜¯è¿ç»­çš„å¹¶ä¸”ä¸¥æ ¼é€’å‡çš„ï¼Œæ¯”å¦‚ä¸Šè¿° BIT åˆ†åˆ«æ˜¯ç”± $\text{rank}= 3ï¼Œ2ï¼Œ1ï¼Œ0$ çš„äºŒé¡¹æ ‘ç»„æˆã€‚</p>

<p>æ ‘çŠ¶æ•°ç»„å°±æ˜¯åœ¨æ¯ä¸ªä½ç½®å­˜å‚¨æ‰€ä»£è¡¨çš„åŒºé—´çš„å…ƒç´ çš„å’Œã€‚</p>

<h3 id="åˆ†ç‰‡é•¿åº¦">åˆ†ç‰‡é•¿åº¦</h3>

<p><strong>é‚£ä¹ˆå¦‚ä½•è®¡ç®—æŸä¸ªç´¢å¼•ä½ç½®ä»£è¡¨çš„åŒºé—´çš„é•¿åº¦å‘¢ï¼Ÿ</strong></p>

<p>è§‚å¯Ÿå‘ç°ï¼Œä¸€ä¸ªåºå·è¶Šæ˜¯èƒ½è¢«æ›´å¤§çš„ $2$ çš„å¹‚æ•´é™¤ï¼Œä»£è¡¨çš„åŒºé—´å°±è¶Šå¤§ ã€‚</p>

<p>å®é™…ä¸Šï¼ŒåŒºé—´é•¿åº¦ï¼Œæˆ–è€…è¯´åŒºé—´çš„å…ƒç´ æ•°ï¼Œå°±æ˜¯ç”±åºå·çš„äºŒè¿›åˆ¶çš„æœ€ä½æœ‰æ•ˆä½<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>ä¸åé¢ $0$ æ„æˆçš„æ•°å­—å†³å®šçš„ã€‚</p>

<p>æ¯”å¦‚ $12 = (1100)_2$ ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯ $3$ ï¼Œä¸åé¢çš„ $0$ æ„æˆçš„æ•°å­—æ˜¯ $(100)_2=4$ ï¼Œä»£è¡¨ 4 ï¼›</p>

<p>æ¯”å¦‚ $15 = (1111)_2$ ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯ $1$ ï¼Œä¸åé¢çš„ $0$ æ„æˆçš„æ•°å­—æ˜¯ $(1)_2=1$ ï¼Œä»£è¡¨ 1</p>

<p>é‚£ä¹ˆå¦‚ä½•æ±‚å–ä¸€ä¸ªåºå·çš„æœ€ä½æœ‰æ•ˆä½æ„æˆçš„æ•°å­—å‘¢ï¼Ÿ</p>

<p>å‡è®¾åºå·ä¸º xï¼Œé‚£ä¹ˆå¯¹ x æŒ‰ä½å–åå†åŠ  1 ï¼Œå†æŒ‰ä½ä¸åŸå€¼ï¼Œå°±å¯ä»¥æ±‚å‡º x çš„æœ€ä½æœ‰æ•ˆä½çš„æ„æˆæ•°å­—ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·å‘¢ï¼Ÿ</strong></p>

<p>ä»”ç»†è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹å°±æ¸…æ¥šäº†ï¼š</p>

<ol>
  <li>æ ¹æ®å®šä¹‰ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯ $1$ ï¼Œåé¢æ›´ä½ä½å…¨éƒ½æ˜¯ $0$ ï¼Œæ¯”å¦‚ $(100)_2$ ï¼Œ$x$ å–ååï¼Œå˜ä¸º $(011)_2$ ï¼ŒåŠ ä¸€åï¼Œåˆå˜å› $(100)_2$ ï¼Œå› æ­¤æŒ‰ä½ä¸æ—¶æœ€ä½æœ‰æ•ˆä½çš„ $1$ ä»¥åŠåé¢çš„æ›´ä½ä½çš„ $0$ è¢«åŸå°ä¸åŠ¨åœ°ä¿ç•™ä¸‹æ¥ï¼›</li>
  <li>ç”±äºè¿›ä½å·²ç»åœåœ¨æœ€ä½æœ‰æ•ˆä½ä¸Šï¼Œå› æ­¤æ›´é«˜çš„ä½åªæ˜¯å–åï¼ŒæŒ‰ä½ä¸åå°±è¢«æ¸…é™¤æ‰äº†</li>
</ol>

<p>è¿™æ ·å°±å¾—åˆ°äº†æœ€ä½æœ‰æ•ˆä½å’Œåé¢çš„ $0$ æ„æˆçš„æ•°å­—ã€‚</p>

<p>äºæ˜¯æˆ‘ä»¬è¯æ˜äº† <code class="language-plaintext highlighter-rouge">x &amp; (!x+1)</code> å¯ä»¥å¾—åˆ°åŒºé—´çš„é•¿åº¦ã€‚</p>

<p><strong>ä½†æ˜¯è¿™ä¸ªä¹¦å†™å½¢å¼è¿˜å¯ä»¥ç®€åŒ–</strong></p>

<p>å› ä¸ºæ•´å‹æ•°å­—åœ¨è®¡ç®—æœºä¸­çš„å­˜å‚¨å½¢å¼æ˜¯ 2 çš„è¡¥ç ï¼ˆtwoâ€™s complementï¼‰ï¼ŒæŒ‰ç…§å®šä¹‰ï¼Œå¯¹äºä¸€ä¸ªæ•°å–ååŠ ä¸€å°±å¾—åˆ°äº†å®ƒå¯¹åº”çš„è´Ÿå€¼ã€‚</p>

<p>å› æ­¤åŒºé—´é•¿åº¦å¯ä»¥ç®€åŒ–ä¸º <code class="language-plaintext highlighter-rouge">x &amp; -x</code> ã€‚</p>

<h2 id="å®ç°">å®ç°</h2>

<p>å®šä¹‰ä¸‹ç»“æ„ï¼Œè¿™é‡Œç»§ç»­ä½¿ç”¨äº†å‰é¢åˆ†æ®µæ ‘é‡Œå®šä¹‰çš„æŠ½è±¡ç»„ä»¶ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span> <span class="o">=</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_note</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å»ºæ ‘">å»ºæ ‘</h3>

<p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥é€šè¿‡è§‚å¯Ÿä¸Šè¿°çš„å›¾ï¼Œå‘ç°ä¸¤ä¸ª BIT çš„æ€§è´¨ï¼š</p>

<ol>
  <li>æ¯ä¸ªä½ç½®ï¼Œéƒ½å¯ä»¥ç”±å®ƒè‡ªèº«å’Œå®ƒçš„ç›´æ¥å­©å­æ±‚å’Œå¾—åˆ°ï¼Œæ¯”å¦‚ $t[4] = a[4] + t[3] + t[2]$ ï¼›</li>
  <li>æ¯ä¸ªä½ç½®ï¼Œå®ƒåˆ°ç›´æ¥çˆ¶æ¯çš„è·ç¦»å°±æ˜¯å®ƒæ‰€ä»£è¡¨çš„åŒºé—´çš„å¤§å°ï¼Œæˆ–è€…è¯´å®ƒä»£è¡¨äº†çˆ¶èŠ‚ç‚¹æ‰€è¾–åœ°ä¸€åŠçš„å…ƒç´ æ•°ï¼Œæ¯”å¦‚ $4$ åˆ°ç›´æ¥çˆ¶æ¯ $8$ çš„è·ç¦»å°±æ˜¯ $4$ æ‰€ä»£è¡¨åŒºé—´ $[1..4]$ çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ $4$</li>
</ol>

<p>åˆ©ç”¨ä¸Šè¿°æ€§è´¨ï¼Œå¯ä»¥ç›´æ¥åœ¨ $O(n)$ çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆçš„æ ‘çš„æ„é€ ï¼š</p>

<p>ç”¨ $0$ åˆå§‹åŒ– BITï¼Œéå†åŸæ•°ç»„ $a[..]$ ï¼ŒæŠŠå®ƒçš„æ¯ä¸ªå€¼åŠ åˆ° BIT å¯¹åº”ä½ç½®ï¼Œç„¶åå†ç”¨ BIT è¿™ä¸ªä½ç½®çš„æ•°å€¼æ¯æ¬¡æ›´æ–°å®ƒçš„ç›´æ¥çˆ¶æ¯ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">range_len</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$i:ident</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="p">((</span><span class="nv">$i</span> <span class="k">as</span> <span class="nb">isize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="nv">$i</span> <span class="k">as</span> <span class="nb">isize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">as</span> <span class="nb">usize</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">new</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">U</span><span class="p">:</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">raw</span><span class="nf">.is_empty</span><span class="p">());</span>

        <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">build</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>

        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">_note</span><span class="p">:</span> <span class="nn">PhantomData</span><span class="p">::</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">build</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">U</span><span class="p">:</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span> <span class="n">raw</span><span class="nf">.len</span><span class="p">()];</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">raw</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.clone</span><span class="p">()</span><span class="nf">.raw_into_stats</span><span class="p">());</span>

            <span class="c1">// direct parent</span>
            <span class="k">let</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nd">range_len!</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">raw</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">data</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è®¡ç®—åŒºé—´é•¿åº¦çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯åŸºäº $0$ çš„æ•°ç»„ï¼Œæ³¨æ„éœ€è¦æŠŠç´¢å¼•ä½ç½®åŠ ä¸€ï¼Œå¾—åˆ°å‰é¢è®¨è®ºçš„ä»£è¡¨æ•°é‡çš„ç¼–å·ã€‚</p>

<h3 id="å‰ç¼€å’Œ">å‰ç¼€å’Œ</h3>

<p>è®¡ç®—å‰ç¼€å’Œä¹Ÿåªéœ€ç»Ÿè®¡æŸ¥è¯¢ä½ç½®å‰é¢çš„åŒºé—´ï¼Œæ–¹æ³•æ˜¯æ¯æ¬¡å‘å‰è·³ç´¢å¼•ä»£è¡¨çš„ä¸€ä¸ªåŒºé—´çš„é•¿åº¦ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>    
	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="k">mut</span> <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">cmp</span><span class="p">::</span><span class="nf">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">acc</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span>

        <span class="k">loop</span> <span class="p">{</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acc</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nd">range_len!</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">i</span> <span class="o">-=</span> <span class="nd">range_len!</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">acc</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è®¡ç®—ä¸¤ä¸ªç«¯ç‚¹çš„å‰ç¼€å’Œï¼Œå°±å¯ä»¥æ±‚å‡ºç»™å®šåŒºé—´çš„åŒºé—´å’Œï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>        
	<span class="k">pub</span> <span class="k">fn</span> <span class="n">query</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Sub</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">self</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="k">self</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å® <code class="language-plaintext highlighter-rouge">parse_range</code> æ¥æºäºå‰é¢åˆ†æ®µæ ‘é‡Œé¢å®šä¹‰çš„å®ï¼Œç»™å‡º $[l, r]$ çš„ä¸¤ä¸ªç«¯ç‚¹ $l$ å’Œ $r$ ã€‚</p>

<h2 id="æ‰¹é‡æ›´æ–°">æ‰¹é‡æ›´æ–°</h2>

<p>é™¤äº†æŸ¥è¯¢åŒºé—´å’Œä¹‹ç±»çš„é—®é¢˜ï¼Œæ ‘çŠ¶æ•°ç»„ä¹Ÿå¯ä»¥å¤„ç†å¯¹åŸæ•°ç»„çš„æ‰¹é‡æ›´æ–°çš„é—®é¢˜ã€‚</p>

<h3 id="å•ç‚¹æŸ¥è¯¢">å•ç‚¹æŸ¥è¯¢</h3>

<p>æœ€ç®€å•çš„æƒ…å†µæ˜¯æ‰¹é‡æ›´æ–°åï¼Œåªè¦æ±‚å¯¹æŸä¸€ä¸ªç‚¹è¿›è¡ŒæŸ¥è¯¢ã€‚</p>

<p>è¿™æ—¶ï¼Œç”¨ä¸€ä¸ª BIT ä¿å­˜æ¯ä¸ªä½ç½®æ›´æ–°çš„ç´¯åŠ å€¼ï¼Œåˆå§‹åŒ–ä¸º 0 ã€‚</p>

<p>å½“æŸ¥è¯¢åŸæ•°ç»„æŸä¸ªç‚¹çš„å€¼æ—¶ï¼Œå°±æ˜¯æ±‚å– BIT ä¸Šè¯¥ç‚¹çš„å‰ç¼€å’Œï¼Œå†åŠ ä¸ŠåŸå€¼ ã€‚</p>

<p><strong>é‚£ä¹ˆå¦‚ä½•æ›´æ–° BIT çš„ç´¯åŠ å€¼ï¼Ÿ</strong></p>

<p>å½“å¯¹ç»™å®šåŒºé—´ $[l, r]$ ç´¯åŠ  $x$ æ—¶ï¼Œå°±åœ¨ $l$ ç‚¹å¤„å¢åŠ  $x$ ï¼Œå¹¶åœ¨ $r+1$ ç‚¹å¤„å‡å°‘ $x$ ï¼Œæ¥å–æ¶ˆå¯¹åé¢ç‚¹çš„å‰ç¼€å’Œçš„å½±å“ã€‚</p>

<p><em>ä¸ºäº†çœäº‹å„¿ï¼Œæˆ‘ä»¬ä¸å†å¯¹æ­¤æ¦‚å¿µè¿›è¡ŒæŠ½è±¡ï¼Œè€Œæ˜¯ç›´æ¥å‡å®šæ“ä½œå¯¹è±¡å°±æ˜¯æ•°å­—ç±»å‹</em></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="nb">i32</span><span class="p">,</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">range_add_for_origin</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="n">addend</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">self</span><span class="nf">.add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">addend</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.add</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">addend</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¯¹ BIT æŸç‚¹ä¸Šè¿›è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œéœ€è¦è¿å¸¦æ›´æ–°å®ƒçš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>            
	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="k">mut</span> <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">addend</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addend</span><span class="p">);</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="nd">range_len!</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åŒºé—´å’ŒæŸ¥è¯¢">åŒºé—´å’ŒæŸ¥è¯¢</h3>

<p>å¦‚æœæ‰¹é‡æ›´æ–°åè¿˜è¦æŸ¥è¯¢åŒºé—´å’Œï¼ˆçš„æ›´æ–°ï¼‰ï¼Œé‚£ä¹ˆå‰é¢ï¼ˆé€šè¿‡å‰ç¼€å’Œçš„æ–¹å¼ï¼‰ä»…å¯¹æŸä¸€ä¸ªç‚¹çš„æ›´æ–°å€¼çš„è®°å½•å°±ä¸å¤Ÿäº†ã€‚</p>

<p>æ€ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>è§£å†³æ–¹æ³•å¹¶ä¸é‚£ä¹ˆç›´è§‚ï¼Œä¸å¦¨å…ˆä¸€æ­¥ä¸€æ­¥åœ°è€ƒè™‘ï¼š</p>

<p>å¦‚æœç»™å®šåŒºé—´ $[l, r]$ ä¸Šæ‰¹é‡åŠ ä¸Š $x$ ï¼Œé‚£ä¹ˆåŠ å€¼çš„å‰ç¼€å’Œåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>

\[\text{sum}[0,i]=
\begin{cases}
0 &amp; i &lt; l \\\\
x \cdot (i-l+1) &amp; l \leqslant i \leqslant r \\\\
x \cdot (r-l+1) &amp; r \lt i \\
\end{cases}\]

<p>è¿™ä¸ªå‰ç¼€å’Œå¯ä»¥æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>

\[\text{sum}[0,i]=
\begin{cases}
0 \cdot i - 0 &amp; i &lt; l \\\\
x\cdot i - x\cdot (l-1) &amp; l \leqslant i \leqslant r \\\\
(x-x)\cdot i - (x \cdot (l-1) - x\cdot r) &amp; r \lt i \\
\end{cases}\]

<p>å¯ä»¥ç”¨å‰é¢åŒºé—´æ›´æ–°åå•ç‚¹æŸ¥è¯¢çš„æ€è·¯ï¼Œç”¨ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ $\text{B}_1$ è¡¨ç¤ºå‰ä¸€éƒ¨åˆ†çš„æ•°å€¼ï¼š</p>

\[\text{sum}(\text{B}_1)[0,i]=
\begin{cases}
0&amp; i &lt; l \\\\
x &amp; l \leqslant i \leqslant r \\\\
x-x &amp; r \lt i \\
\end{cases}\]

<p>ç”¨å¦ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ $\text{B}_2$ ï¼Œè¡¨ç¤ºåä¸€éƒ¨åˆ†çš„å€¼ï¼š</p>

\[\text{sum}(\text{B}_2)[0,i]=
\begin{cases}
0 &amp; i &lt; l \\\\
x\cdot (l-1) &amp; l \leqslant i \leqslant r \\\\
x \cdot (l-1) - x\cdot r &amp; r \lt i \\
\end{cases}\]

<p>è®¡ç®— $\text{B}_1$ï¼š</p>

\[\begin{array}{l}
\text{add}(\text{B}_1,\ l,\ x)\\
\text{add}(\text{B}_1,\ r+1,\ -x)
\end{array}\]

<p>è®¡ç®— $\text{B}_2$ï¼š</p>

\[\begin{array}{l}
\text{add}(\text{B}_2,\ l,\ x\cdot(l-1))\\
\text{add}(\text{B}_2,\ r+1,\ -x\cdot r)
\end{array}\]

<p>å‰ç¼€å’Œï¼š</p>

\[\text{sum}[0,i] = \text{sum}(\text{B}_1)\cdot i - \text{sum}(\text{B}_2)\]

<p>ç»™å®šåŒºé—´ $[l, r]$ çš„ç´¯ç§¯æ›´æ–°çš„å’Œï¼š</p>

\[\text{sum}[l, r] = \text{sum}[0,r] - \text{sum}[0,l-1]\]

<p>å†åŠ ä¸ŠåŸæ•°ç»„çš„åŒºé—´å’Œï¼Œå°±æ˜¯æ›´æ–°åçš„æ•°ç»„çš„åŒºé—´å’Œã€‚</p>

<p><strong>å®ç°</strong></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">RangeAddQuerySum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BIT</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,;</span>

<span class="k">impl</span> <span class="n">BIT</span><span class="o">&lt;</span><span class="nb">i32</span><span class="p">,</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">create_range_add_query_sum_aux</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span>
    <span class="k">-&gt;</span> <span class="n">RangeAddQuerySum</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="nn">RangeAddQuerySum</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">self</span><span class="nf">.len</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">RangeAddQuerySum</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span><span class="p">(</span><span class="n">BIT</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">cap</span><span class="p">],</span>
            <span class="n">_note</span><span class="p">:</span> <span class="n">PhantomData</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">add</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="n">addend</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="k">self</span><span class="na">.0</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">self</span><span class="na">.0</span><span class="nf">.add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">addend</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="k">as</span> <span class="nb">i32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
        <span class="k">self</span><span class="na">.0</span><span class="nf">.add</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">addend</span> <span class="o">*</span> <span class="n">r</span> <span class="k">as</span> <span class="nb">i32</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/// Get update accumulation</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">query</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="n">bit1</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">BIT</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="k">self</span><span class="na">.0</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">self</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bit1</span><span class="p">)</span> <span class="o">-</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="k">self</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bit1</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">bit1</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">BIT</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
        <span class="n">bit1</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span> <span class="k">as</span> <span class="nb">i32</span> <span class="o">-</span> <span class="k">self</span><span class="na">.0</span><span class="nf">.prefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ç§å®ç°å¯ä»¥åˆ©ç”¨ä¹‹å‰ä¸ºæ‰¹é‡æ›´æ–°å•ç‚¹æŸ¥è¯¢å»ºç«‹çš„æ ‘çŠ¶æ•°ç»„ã€‚</p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>æ²¡æœ‰æ‰¾åˆ°è®²å¾—ç‰¹åˆ«æ¸…æ¥šåˆç‰¹åˆ«è¯¦ç»†çš„èµ„æ–™ï¼Œcp-algorithms.com æœ¬ç¯‡çš„ä»é£æ ¼åˆ°è´¨é‡éƒ½æœ‰å¤±æ°´å‡†ï¼Œåè€Œ OI-wiki è¿˜æ¯”è¾ƒè¯¦ç»†ï¼Œæ˜æ˜æ˜¯æ—©å·²æœ‰çš„æ¦‚å¿µï¼Œå´æœ‰ç›¸å½“å¤šçš„å†…å®¹ä¸Šæ˜¯è¿‘æœŸæ›´æ–°çš„Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>æˆ‘å–œæ¬¢è¿™ä¸ªå‘½åï¼Œç®€å•å½¢è±¡ä¸æ•…å¼„ç„è™šÂ <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>ä½†æ˜¯åˆ†æ®µæ ‘èƒ½é€šè¿‡æ‹†åˆ†åŒºé—´ï¼Œå¤„ç†å¾ˆå¤šæ ‘çŠ¶æ•°ç»„å¤„ç†ä¸äº†çš„åœ¨è¿ç»­åŒºé—´ä¸Šçš„æŸ¥è¯¢é—®é¢˜Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>å›¾ç‰‡æ¥æºäº https://www.baeldung.com/cs/fenwick-treeÂ <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>æ•°å­—çš„äºŒè¿›åˆ¶è¡¨ç¤ºé‡Œæœ€ä½çš„ä¸€ä¸ª $1$ çš„ä½ç½®Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[æœ¬æ–‡ä¸»è¦å‚è€ƒ OI-wiki ä»¥åŠ cp-algorithms.com ç›¸å…³é¡µé¢1 æ²¡æœ‰æ‰¾åˆ°è®²å¾—ç‰¹åˆ«æ¸…æ¥šåˆç‰¹åˆ«è¯¦ç»†çš„èµ„æ–™ï¼Œcp-algorithms.com æœ¬ç¯‡çš„ä»é£æ ¼åˆ°è´¨é‡éƒ½æœ‰å¤±æ°´å‡†ï¼Œåè€Œ OI-wiki è¿˜æ¯”è¾ƒè¯¦ç»†ï¼Œæ˜æ˜æ˜¯æ—©å·²æœ‰çš„æ¦‚å¿µï¼Œå´æœ‰ç›¸å½“å¤šçš„å†…å®¹ä¸Šæ˜¯è¿‘æœŸæ›´æ–°çš„Â &#8617;]]></summary></entry><entry><title type="html">åˆ†ç‰‡çº§è”ï¼ˆFractional Cascadingï¼‰</title><link href="/algs/FractionalCascading.html" rel="alternate" type="text/html" title="åˆ†ç‰‡çº§è”ï¼ˆFractional Cascadingï¼‰" /><published>2023-04-17T00:00:00+08:00</published><updated>2023-04-17T00:00:00+08:00</updated><id>/algs/FractionalCascading</id><content type="html" xml:base="/algs/FractionalCascading.html"><![CDATA[<p><em>æœ¬æ–‡ä¸»è¦å‚è€ƒ <a href="https://en.wikipedia.org/wiki/Fractional_cascading">wiki</a> ï¼Œå¯¹å…¶ä¸­ä¸€äº›å†…å®¹è¿›è¡Œäº†æ‹“å±•ï¼Œå¯¹ä¸ªåˆ«é”™è¯¯è¿›è¡Œäº†ä¿®æ­£ã€‚</em></p>

<p>åˆ†ç‰‡çº§è”æ˜¯ä¸€ç§åŒæ—¶å¯¹å¤šä¸ªæœ‰åºåˆ—è¡¨è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾çš„åŠ é€ŸæŠ€æœ¯ã€‚</p>

<p>å‡è®¾æœ‰ $k$ ä¸ªæœ‰åºåˆ—è¡¨ï¼Œç»™å®šä¸€ä¸ªå…ƒç´  $q$ ï¼ŒæŸ¥è¯¢åœ¨æ¯ä¸ªæœ‰åºåˆ—è¡¨ä¸Šçš„ä½ç½®ã€‚</p>

<h2 id="æ€è·¯">æ€è·¯</h2>

<h3 id="åŸå§‹åšæ³•">åŸå§‹åšæ³•</h3>

<p>ä¾æ¬¡åœ¨æ¯ä¸ªæœ‰åºåˆ—è¡¨ä¸Šæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå‡è®¾æ¯ä¸ªåˆ—è¡¨çš„<strong>å¹³å‡é•¿åº¦ä¸º $n$</strong> ï¼Œæ€»é•¿åº¦ $N=kn$ ï¼Œ åˆ™æ—¶é—´å¤æ‚åº¦ä¸º $O(k\ \text{log}\ n)$ ã€‚</p>

<h3 id="æ”¹è¿›çš„åšæ³•">æ”¹è¿›çš„åšæ³•</h3>

<p>å¯ä»¥æå‰å¤„ç†ä¸‹è¿™ $k$ ä¸ªæœ‰åºåˆ—è¡¨ï¼Œä¸ºå…¶ä¸­æ¯ä¸ªå…ƒç´ è®¡ç®—åœ¨æ¯ä¸ªåˆ—è¡¨çš„ä½ç½®ï¼Œç„¶åæŠŠè¿™äº›å…ƒç´ å’Œå¯¹åº”çš„åœ¨æ¯ä¸ªåˆ—è¡¨çš„ä½ç½®åˆæˆä¸€ä¸ªå¤§çš„æœ‰åºåˆ—è¡¨ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™åªéœ€è¦åœ¨è¿™ä¸ªå¤§çš„æœ‰åºåˆ—è¡¨ä¸Šè¿›è¡Œä¸€æ¬¡äºŒåˆ†æŸ¥æ‰¾å°±å¯ä»¥äº†ã€‚</p>

<p>æ ¹æ®æŸ¥æ‰¾åˆ°çš„å…ƒç´ å¯¹åº”çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œç›´æ¥å¾—åˆ°å…¨éƒ¨ $k$ ä¸ªæœ‰åºåˆ—è¡¨ä¸Šçš„ä½ç½®ã€‚</p>

<p>ä¾‹å¦‚å¦‚ä¸‹ $k=4$ ä¸ªæœ‰åºåˆ—è¡¨çš„</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">L\i</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td>24</td>
      <td>64</td>
      <td>65</td>
      <td>80</td>
      <td>93</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td>23</td>
      <td>25</td>
      <td>26</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td>13</td>
      <td>44</td>
      <td>62</td>
      <td>66</td>
      <td>Â </td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td>11</td>
      <td>35</td>
      <td>46</td>
      <td>79</td>
      <td>81</td>
    </tr>
  </tbody>
</table>

<p>å¾—åˆ°</p>

<table>
  <thead>
    <tr>
      <th>L[0,6,12]</th>
      <th>L[1,7,13]</th>
      <th>L[2,8,14]</th>
      <th>L[3,9,15]</th>
      <th>l[4,10,16]</th>
      <th>l[5,11,17]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>11[0,0,0,0]</td>
      <td>13[0,0,0,1]</td>
      <td>23[0,1,1,1]</td>
      <td>24[0,1,1,1]</td>
      <td>25[1,1,1,1]</td>
      <td>26[1,2,1,1]</td>
    </tr>
    <tr>
      <td>35[1,3,1,1]</td>
      <td>44[1,3,1,2]</td>
      <td>46[1,3,2,2]</td>
      <td>62[1,3,2,3]</td>
      <td>64[1,3,3,3]</td>
      <td>65[2,3,3,3]</td>
    </tr>
    <tr>
      <td>66[3,3,3,3]</td>
      <td>79[3,3,4,3]</td>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p>å…·ä½“è¯´æ˜è¿™ä¸ªç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥ $46[1,3,2,2]$ ä¸ºä¾‹ï¼Œè¡¨æ˜ $46$ åœ¨ $L_1$ çš„ä½ç½®ä¸º 1 ï¼Œåœ¨ $L_2$ çš„ä½ç½®ä¸º $3$ ï¼Œåœ¨ $L_3$ çš„ä½ç½®ä¸º $2$ , åœ¨ $L_4$ çš„ä½ç½®ä¸º $2$ ã€‚</p>

<p>è¿™æ ·å¦‚æœæˆ‘ä»¬æŸ¥æ‰¾ $q=45$ ï¼Œå‘ç°è½åˆ° $46$ çš„ä½ç½®ï¼Œå°±ç›´æ¥ä½¿ç”¨ $46$ çš„ç´¢å¼•ç»Ÿè®¡ $q=45$ çš„ç´¢å¼•ç»“æœå³å¯ã€‚</p>

<p>è¿™ç§åšæ³•ï¼ŒèŠ±è´¹ $(k-1)n\text{log}(n)$ çš„é¢„å¤„ç†æ—¶é—´ï¼Œå’Œ $kN$ <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>çš„ç©ºé—´ï¼Œä»¥å®ç° $O(\text{log}N)$ æ—¶é—´å¤æ‚åº¦çš„å•æ¬¡æŸ¥è¯¢ã€‚</p>

<p>è¿™æ ·ï¼Œå•æ¬¡æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ï¼Œä» $O(k\text{log}n)$ å˜ä¸º $O(\text{log}kn)$ , ç›¸å½“äºæŠŠ $k$ æ”¾è¿›äº† log é‡Œï¼Œæ€§èƒ½å¾—åˆ°äº†æå‡ã€‚</p>

<p>ä½†æ˜¯ç©ºé—´ä¸Š $kN$ æ˜¯éå¸¸çš„æ˜‚è´µã€‚</p>

<h3 id="åˆ†ç‰‡çº§è”">åˆ†ç‰‡çº§è”</h3>

<p>é‚£ä¹ˆå¦‚ä½•<em>åœ¨å°½é‡ä¿æŒæ”¹è¿›çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦çš„æƒ…å†µä¸‹</em>é™ä½ç©ºé—´å¤æ‚åº¦å‘¢ï¼Ÿ è¿™æ‰å¼•å‡ºæ¥ï¼Œæˆ‘ä»¬åˆ†ç‰‡çº§è”çš„æŠ€æœ¯ã€‚</p>

<p><strong>åˆ†ç‰‡</strong>æŒ‡å¾—æ˜¯åˆ†ç‰‡å–æ ·ï¼ˆfractional samplingï¼‰ï¼Œ<strong>çº§è”</strong>ï¼ˆcascadingï¼‰æŒ‡å¾—æ˜¯å¹¶ä¸åŒæ—¶ä¿å­˜æ‰€æœ‰kä¸ªåˆ—è¡¨çš„ç´¢å¼•ä¿¡æ¯ï¼Œè€Œåªæ˜¯ä¿å­˜ç´§é‚»ä¸‹ä¸€çº§çš„ç´¢å¼•ä¿¡æ¯ï¼Œç„¶åä¸€å±‚å±‚è¿›è¡Œè¿é”ã€‚<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>

<p>å…·ä½“è¯´å°±æ˜¯ï¼š</p>

<ol>
  <li>æ„å»ºä¸€ä¸ªé¢„å¤„ç†çš„åˆ—è¡¨ $M$ ï¼Œå®ƒçš„æ¯ä¸€çº§ $M_i$ éƒ½æ˜¯ç”±å¯¹åº” $L_i$ å’Œä¸‹ä¸€çº§çš„ $M_{i+1}$ ä¸­çš„å…ƒç´ æ„æˆï¼Œ$M_i$ å­˜å‚¨å…ƒç´ æœ¬èº«ä»¥åŠæ¯ä¸ªå…ƒç´ åœ¨ $L_i$ ä¸Šçš„ç´¢å¼•ä½ç½®å’Œ $M_{i+1}$ ä¸Šç´¢å¼•ä½ç½®ï¼Œè¿™æ ·ä¸€ç›´åˆ°æœ€åä¸€çº§ $M_k$ ï¼Œå› ä¸ºæ²¡æœ‰ä¸‹ä¸€çº§ï¼Œæ‰€ä»¥åªä¿å­˜ $L_k$ çš„å…ƒç´ ï¼Œè¿™ä½“ç°äº†çº§è”ï¼›</li>
  <li>æ¬¡ä¸€çº§çš„ $M_{i+1}$ é‡Œé¢ä¸æ˜¯æ¯ä¸ªå…ƒç´ éƒ½æå‡åˆ° $M_i$ é‡Œï¼Œè€Œæ˜¯ä¸¤ä¸¤å–æ ·<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ï¼Œ</li>
</ol>

<p>ä¾‹å¦‚ä¸Šè¿°ä¾‹å­ä¸º</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">M\I</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td>24[0,1]</td>
      <td>25[1,1]</td>
      <td>35[1,3]</td>
      <td>64[1,5]</td>
      <td>65[2,5]</td>
      <td>79[3,5]</td>
      <td>80[3,6]</td>
      <td>93[4,6]</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td>23[0,1]</td>
      <td>25[1,1]</td>
      <td>26[2,1]</td>
      <td>35[3,1]</td>
      <td>62[3,3]</td>
      <td>79[3,5]</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td>13[0,1]</td>
      <td>35[1,1]</td>
      <td>44[1,2]</td>
      <td>62[2,3]</td>
      <td>66[3,3]</td>
      <td>79[4,3]</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td>11[0,0]</td>
      <td>35[1,0]</td>
      <td>46[2,0]</td>
      <td>79[3,0]</td>
      <td>81[4,0]</td>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p>å¯¹äºå‰é¢çš„ï¼Œ$q=45$ çš„ä¾‹å­ï¼Œå‡è®¾å–æ ·çš„åˆ†ç‰‡å¤§å°ä¸º $f=2$</p>

<ol>
  <li>
    <p>å¯¹ $M_1$ ï¼Œè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå‘ç°æœ€å°çš„ $\geqslant 45$ çš„æ˜¯ $64[1,5]$ ï¼Œäºæ˜¯å¯¹äº $L_1$ çš„<strong>ç»“æœæ˜¯ $1$</strong>ï¼Œç„¶åä» $M_2[5]$ å¼€å§‹ï¼Œç›´æ¥æ ¹æ®æ‰€å±åˆ†ç‰‡çš„çº§è”çš„ä¿¡æ¯ï¼Œå°±åƒæ‹‰æ‹‰é“¾ä¸€æ ·ï¼Œæœ€å¤šç»è¿‡ $f-1$ æ¬¡æ¯”è¾ƒå°±å¯ä»¥å¾—åˆ°ç»“æœï¼›</p>
  </li>
  <li>
    <p>ç„¶åæ¯”è¾ƒ $M_2[5]$ å’Œå®ƒçš„å‰ä¸€é¡¹ $M_2[4]$ <sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>å‘ç° $M_2[5]=62[3,3]$ æ˜¯æœ€å°çš„ $\geqslant q$ çš„ä¸€é¡¹ï¼Œäºæ˜¯ $L_2$ çš„<strong>ç»“æœæ˜¯ $3$</strong>ï¼›</p>
  </li>
  <li>
    <p>æ¯”è¾ƒ $M_3[3]$ å’Œ $M_3[2]$ï¼Œå‘ç° $M_3[3] =62[2,3]$ æ˜¯æœ€å°çš„ $\geqslant q$ çš„é¡¹ï¼Œäºæ˜¯ $L_3$ çš„<strong>ç»“æœæ˜¯ $2$</strong>ï¼›</p>
  </li>
  <li>
    <p>æ¯”è¾ƒ $M_4[3]$ å’Œ $M_4[2]$ ï¼Œå‘ç° $M_4[2]=46[2,0]$ æ˜¯æœ€å°çš„ $\geqslant q$ çš„é¡¹ï¼Œäºæ˜¯ $L_4$ çš„<strong>ç»“æœæ˜¯ $4$</strong>ï¼›</p>
  </li>
</ol>

<p>åˆ©ç”¨åˆå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨çš„æ–¹æ³•å¤„ç†æ¯ä¸ª $L_i$ å’Œ $M_{i+1}$ çš„åˆ†ç‰‡ï¼Œä½¿ç”¨ $(k-1)n$ çš„é¢„å¤„ç†æ—¶é—´ï¼Œæ¶ˆè€—çš„å†…å­˜å°äº $2N$ ä¸ªå•å…ƒï¼Œå¯¹äºæ•°å­—ç±»å‹æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ $3 * 2N = 6N$ çš„ç©ºé—´å¤æ‚åº¦ã€‚</p>

<h4 id="ç©ºé—´å¤æ‚åº¦è¯æ˜">ç©ºé—´å¤æ‚åº¦è¯æ˜</h4>

<p>é¢„å¤„ç†åˆ—è¡¨ M æ¯ä¸€å±‚çš„ç©ºé—´ï¼ˆå•å…ƒï¼‰ï¼š</p>

\[|M_i| = {\displaystyle n \sum_{j=1}^{k-i+1} (\frac{1}{f})^{j-1}}\]

<p>æ€»å…±ç©ºé—´æ˜¯ï¼ˆå•å…ƒï¼‰ï¼š</p>

\[\begin{array}{l}
{\displaystyle \sum_{i=1}^k|M_i|} &amp;= {\displaystyle n\sum_{i=1}^k \sum_{j=1}^{k-i+1} (\frac{1}{f})^{j-1}}\\
&amp;\lt {\displaystyle n \sum_{i=1}^k \sum_{j=1}^{k+1} (\frac{1}{f})^{j-1}}\\
&amp;= {\displaystyle n \sum_{i=1}^k 1 + (\frac{1}{f}) + (\frac{1}{f})^2 ...,+(\frac{1}{f})^k}\\
&amp;\lt 2n{\displaystyle \sum_{i=1}^k 1}\\
&amp;= 2N
\end{array}\]

<h4 id="æ—¶é—´å¤æ‚åº¦åˆ†æ">æ—¶é—´å¤æ‚åº¦åˆ†æ</h4>

<p>ç”±äº $M_1 \lt 2n$ ï¼Œå› æ­¤å•æ¬¡æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(\text{log}n + (f-1)k)$ ã€‚</p>

<p>ç”±äºé™¤äº† log ï¼Œè¿˜å¤šäº†ä¸€ä¸ª $k$ ,  äºæ˜¯æƒ…å†µå°±æ¯”è¾ƒå¾®å¦™äº† ã€‚</p>

<ol>
  <li>
    <p>ä¸€æ–¹é¢ï¼Œå½“ $k \ll n$ æ—¶ï¼Œåˆ†ç‰‡çº§è”çš„æ€§èƒ½å¥½äºåŸå§‹åŠæ³•ã€‚</p>
  </li>
  <li>
    <p>ä½†å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ $k$ ç›¸å¯¹ $n$ è¾ƒå¤§ï¼Œé‚£åˆ†ç‰‡çº§è”ç›¸æ¯”äºåŸå§‹ç®—æ³•å°±æ²¡æœ‰ä¼˜åŠ¿ï¼Œç”šè‡³æ›´æ…¢ã€‚</p>
  </li>
  <li>
    <p>è€Œåœ¨å‡ ä¹æ‰€æœ‰çš„æƒ…å†µä¸‹ï¼Œåªè¦ $k$ ä¸æ˜¯ç‰¹åˆ«å°ï¼Œæ”¹è¿›ç®—æ³•è¿˜æ˜¯æœ€å¿«çš„ï¼Œæ˜¯å¿«å¥½å‡ å€çš„<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup> ï¼šå¾ˆæ˜æ˜¾ï¼Œå¯¹äº $\text{log}N$ ,å³ä½¿ $N$ å–ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">u64</code> èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äº $k=64$ çš„å¤§å°ï¼Œå› æ­¤åªè¦ç¨å¾®å¤§ä¸€ç‚¹çš„ $k$ éƒ½ä¼šä½¿å¾—æŸ¥è¯¢æ€§èƒ½ä¸å¦‚æ”¹è¿›ç®—æ³•</p>
  </li>
</ol>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå›¾è¡¨æŠŠè¿™ä¸ªé—®é¢˜çœ‹å¾—æ›´æ¸…æ¥šï¼Œå–ä¸€ä¸ªå›ºå®šçš„ $N$ ï¼Œè®© $k$ å¢é•¿ï¼Œè§‚å¯Ÿ</p>

<ol>
  <li>åŸå§‹åšæ³•-raw</li>
  <li>æ”¹è¿›åšæ³•-best</li>
  <li>$f=2$ çš„åˆ†ç‰‡çº§è”-fc2</li>
  <li>$f=4$ çš„åˆ†ç‰‡çº§è”-fc4</li>
</ol>

<p>çš„è¿è¡Œæ—¶é—´çš„å˜åŒ–ï¼š</p>

<p><img src="/assets/img/fc/time_stats1.svg" alt="" /></p>

<p>æˆ‘ä»¬å‘ç°å½“ $k$ ä»ä¸€ä¸ªè¾ƒå°çš„å€¼å¢é•¿çš„æ—¶å€™ï¼ŒåŸå§‹ç®—æ³•çš„æ€§èƒ½ä¼šå˜å¾—æœ‰äº›ä¼˜äº $f=4$ çš„åˆ†ç‰‡çº§è”ã€‚</p>

<p><img src="/assets/img/fc/time_stats2.svg" alt="" /></p>

<p>ä½†å¦‚æœæ‹‰é•¿ $k$ çš„å–å€¼è¯ï¼Œå‘ç°åˆ†ç‰‡çº§è”è¿˜æ˜¯æ˜æ˜¾ä¼˜äºåŸå§‹åšæ³•ã€‚</p>

<h2 id="å®ç°">å®ç°</h2>

<p><a href="https://github.com/minghu6/rust-minghu6/blob/v0.1.3/coll/src/frac_casc.rs">æºä»£ç </a></p>

<h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">FractionalCascading</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">F</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">m</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">METype</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
    <span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">T</span><span class="p">]],</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">METype</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">);</span>
</code></pre></div></div>

<p>å¯¹äº $q$ çš„äºŒåˆ†æŸ¥æ‰¾è¿”å›çš„ç»“æœæ˜¯,  $\text{min}({x \in L,\ x &gt;= q})$</p>

<h3 id="æ„å»º">æ„å»º</h3>

<p>åˆ†ç‰‡çº§è”ï¼Œå¯¹äºè¾“å…¥æœ‰ä¸€äº›åŠ¨æ€æ—¶æ‰èƒ½æ£€æŸ¥çš„æ¡ä»¶ï¼š</p>

<ol>
  <li>$k &gt; 0$ï¼›</li>
  <li>è¾“å…¥çš„ $k$ ä¸ªåˆ—è¡¨æ¯ä¸ªåˆ—è¡¨éƒ½ä¸ä¸ºç©ºä¸”éƒ½æ˜¯æœ‰åºçš„ï¼›</li>
  <li>åˆ†ç‰‡å¤§å° $f &gt; 0$</li>
</ol>

<p>æ„å»º M æ—¶ï¼š</p>

<ol>
  <li>é‡‡ç”¨ merge-sort é‡Œé¢çš„ merge æ“ä½œåˆå¹¶ $L_i$ å’Œ $M_{i+1}$ ï¼›</li>
  <li>å¯¹äºåˆ—è¡¨ä¸­é‡å¤çš„å…ƒç´ åªä¿ç•™ä¸€ä»½ï¼Œå› ä¸ºæ ‡å‡†çš„äºŒåˆ†æœç´¢ä¸ä¼šåŒºåˆ†ä¸åŒä½ç½®çš„é‡å¤å…ƒç´ ï¼Œç•™ç€ä¹Ÿæ²¡ç”¨ï¼›</li>
  <li>åŒæ—¶æ³¨æ„å¦‚æœ $M_{i+1}$ çš„é•¿åº¦ä¸èƒ½æ°å¥½è¢«åˆ†ç‰‡ $f$ æ•´é™¤ï¼Œéœ€è¦æŠŠæœ€åçš„å°¾å…ƒç´ è¡¥ä¸Šï¼Œè¿™æ ·ä½¿å¾—æ‰€æœ‰çš„å®Œæ•´çš„æˆ–è€…ä¸å®Œæ•´çš„åˆ†ç‰‡éƒ½æœ‰ä¸€ä¸ªä»£è¡¨ï¼Œå°±æ˜¯åˆ†ç‰‡çš„æœ€å¤§å€¼ï¼Œç®€åŒ–äº†æ¯”è¾ƒé€»è¾‘</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Ord</span><span class="p">,</span> <span class="k">const</span> <span class="n">F</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="n">FractionalCascading</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">[</span><span class="n">T</span><span class="p">]])</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="n">l</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="n">l</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.all</span><span class="p">(|</span><span class="n">i</span><span class="p">|</span> <span class="n">i</span><span class="nf">.is_sorted</span><span class="p">()));</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">l</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.all</span><span class="p">(|</span><span class="n">i</span><span class="p">|</span> <span class="o">!</span><span class="n">i</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="nf">.is_sorted</span><span class="p">()));</span>

        <span class="k">let</span> <span class="n">m</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">build_m</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">build_m</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="p">[</span><span class="n">T</span><span class="p">]])</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">METype</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="n">l</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">m</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nd">vec!</span><span class="p">[];</span> <span class="n">k</span><span class="p">];</span>

        <span class="cm">/* Init m_k*/</span>

        <span class="k">let</span> <span class="n">l_k</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="k">let</span> <span class="n">m_k</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">m</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">l_k</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.cloned</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">m_k</span><span class="nf">.push</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="cm">/* on guard */</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">m_i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..=</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">m_i</span><span class="p">];</span>
            <span class="k">let</span> <span class="n">m2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">[</span><span class="n">m_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">m1</span> <span class="o">=</span>
                <span class="nn">Vec</span><span class="p">::</span><span class="nf">with_capacity</span><span class="p">(</span><span class="n">l1</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span><span class="nf">.div_ceil</span><span class="p">(</span><span class="n">F</span><span class="p">));</span>

            <span class="cm">/* merge two sorted vec */</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="nd">macro_rules!</span> <span class="n">nxt_j</span> <span class="p">{</span>
                <span class="p">(</span><span class="nv">$j:ident</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                    <span class="c1">// end</span>
                    <span class="k">if</span> <span class="nv">$j</span> <span class="o">==</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                        <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nv">$j</span> <span class="o">+</span> <span class="n">F</span> <span class="o">&gt;</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                        <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$j</span> <span class="o">+</span> <span class="n">F</span>
                    <span class="p">}</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l1</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">match</span> <span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Less</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="n">m1</span><span class="nf">.push</span><span class="p">((</span><span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.clone</span><span class="p">(),</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">j</span><span class="p">));</span>

                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">Equal</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="n">m1</span><span class="nf">.push</span><span class="p">((</span><span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.clone</span><span class="p">(),</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">j</span><span class="p">));</span>

                        <span class="cm">/* skip dup */</span>

                        <span class="k">let</span> <span class="n">dup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

                        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l1</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">&amp;</span><span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">dup</span> <span class="p">{</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span> <span class="o">==</span> <span class="n">dup</span> <span class="p">{</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="nd">nxt_j!</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">Greater</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="n">m1</span><span class="nf">.push</span><span class="p">((</span><span class="n">m2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">(),</span> <span class="nf">Err</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">j</span><span class="p">));</span>

                        <span class="n">j</span> <span class="o">=</span> <span class="nd">nxt_j!</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l1</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">m1</span><span class="nf">.push</span><span class="p">((</span><span class="n">l1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.clone</span><span class="p">(),</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()));</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m2</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">m1</span><span class="nf">.push</span><span class="p">((</span><span class="n">m2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">(),</span> <span class="nf">Err</span><span class="p">(</span><span class="n">l1</span><span class="nf">.len</span><span class="p">()),</span> <span class="n">j</span><span class="p">));</span>

                <span class="n">j</span> <span class="o">=</span> <span class="nd">nxt_j!</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">m</span><span class="p">[</span><span class="n">m_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">m</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>

<p>æŒ‰ç…§ Rust çš„ API é£æ ¼ï¼ŒæŸ¥æ‰¾å…ƒç´ æ—¶ç”¨ <code class="language-plaintext highlighter-rouge">Result&lt;usize, usize&gt;</code> ç±»å‹åŒºåˆ†ç›¸ç­‰çš„æƒ…å†µå’Œæœ€å°å¤§äºçš„æƒ…å†µã€‚</p>

<h4 id="æŸ¥è¯¢-1">æŸ¥è¯¢</h4>

<p>ä¸»æµç¨‹ï¼š</p>

<ol>
  <li>åœ¨ <code class="language-plaintext highlighter-rouge">m[0]</code> ä¸Šæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°â€œæ‹‰é“¾å¤´â€ï¼›</li>
  <li>ç„¶ååœ¨åç»­çš„ <code class="language-plaintext highlighter-rouge">m[1..m.len()]</code> ä¸Šâ€œæ‹‰æ‹‰é“¾â€ï¼Œåœ¨æ¯ä¸€çº§ä¸Šï¼Œéƒ½ä¼šåœ¨åˆ†ç‰‡å¤§å°çš„èŒƒå›´å†…æ‰¾åˆ°ç»“æœ</li>
</ol>

<p>è€ƒè™‘é‡å¤å…ƒç´ çš„æƒ…å†µï¼Œå®é™…ä¸Šå‰é¢è®²çš„â€œåŒºåˆ†ç›¸ç­‰çš„æƒ…å†µå’Œæœ€å°å¤§äºçš„æƒ…å†µâ€çš„è¯´æ³•å¹¶ä¸ä¸¥è°¨ï¼Œå®é™… API è¿”å›å€¼çš„è¦æ±‚åº”è¯¥æ˜¯<strong>ç›¸ç­‰å’Œæ’å…¥åä¿æŒæœ‰åºä¸¤ç§æƒ…å†µ</strong> ï¼Œè¿™æ„å‘³ç€ï¼š</p>

<ol>
  <li>å¦‚æœå­˜åœ¨é‡å¤çš„æœ€å°å¤§äºçš„å…ƒç´ ï¼Œä¸èƒ½éšä¾¿é€‰ä¸€ä¸ªè¿”å›å®ƒçš„ç´¢å¼•ä½ç½®ï¼Œè€Œæ˜¯åº”è¯¥è¿”å›æœ€å·¦è¾¹çš„é‚£ä¸€ä¸ªï¼›</li>
  <li>åœ¨æç«¯çš„æœ€åæƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šæ‹–ç´¯æ€§èƒ½åˆ°çº¿æ€§</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Ord</span><span class="p">,</span> <span class="k">const</span> <span class="n">F</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="n">FractionalCascading</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="p">{</span>    
	<span class="k">pub</span> <span class="k">fn</span> <span class="n">find</span><span class="o">&lt;</span><span class="n">Q</span><span class="p">:</span> <span class="n">Borrow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Q</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.find_</span><span class="p">(</span><span class="n">k</span><span class="nf">.borrow</span><span class="p">(),</span> <span class="k">Self</span><span class="p">::</span><span class="n">find_handle_approx_result</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">fn</span> <span class="nf">find_</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">FindHandler</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">res</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nf">Err</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="k">self</span><span class="py">.m</span><span class="nf">.len</span><span class="p">()];</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span><span class="p">;</span>

        <span class="c1">// 1. assign res[0]</span>
        <span class="c1">//</span>
        <span class="c1">// 2. m_idx</span>
        <span class="c1">//</span>
        <span class="k">match</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="nf">.binary_search_by_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="nf">.borrow</span><span class="p">(),</span> <span class="p">|</span><span class="n">x</span><span class="p">|</span> <span class="o">&amp;</span><span class="n">x</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="na">.1</span><span class="p">;</span>
                <span class="n">j</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="na">.2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">Err</span><span class="p">(</span><span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="nf">.len</span><span class="p">());</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="na">.2</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="na">.1</span><span class="nf">.and_then</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="nf">Err</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="na">.2</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="k">self</span><span class="py">.m</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">elected</span><span class="p">;</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="n">elected</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">cand</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

                <span class="k">while</span> <span class="n">cand</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="nf">.borrow</span><span class="p">()</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cand</span><span class="p">]</span><span class="na">.0</span> <span class="p">{</span>
                    <span class="n">cand</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="nf">.borrow</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cand</span><span class="p">]</span><span class="na">.0</span> <span class="p">{</span>
                    <span class="n">cand</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">elected</span> <span class="o">=</span> <span class="n">cand</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">elected</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">handler</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">elected</span><span class="p">);</span>

            <span class="n">j</span> <span class="o">=</span> <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">elected</span><span class="p">]</span><span class="na">.2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">res</span>
    <span class="p">}</span>
    
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">find_handle_approx_result</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
        <span class="n">j</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">dup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="p">;</span>

        <span class="k">match</span> <span class="n">k</span><span class="nf">.borrow</span><span class="p">()</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Less</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">idx</span> <span class="o">=</span> <span class="nd">unpack_result!</span><span class="p">(</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span><span class="p">);</span>

                <span class="c1">// go back (the worst case down to O(nk))</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">dup</span> <span class="p">{</span>
                    <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nf">Err</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">Equal</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span>
            <span class="p">}</span>
            <span class="n">Greater</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">idx</span> <span class="o">=</span> <span class="nd">unpack_result!</span><span class="p">(</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span><span class="p">);</span>

                <span class="c1">// go forward (the worst case down to O(nk))</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">dup</span> <span class="p">{</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dup</span> <span class="o">==</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.l</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="p">{</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nf">Err</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">FindHandler</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">N</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">fn</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="n">FractionalCascading</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
    <span class="nb">usize</span><span class="p">,</span>
    <span class="nb">usize</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="å¿«é€ŸæŸ¥è¯¢">å¿«é€ŸæŸ¥è¯¢</h4>

<p>å¦‚æœä¸è€ƒè™‘å¯¹é‡å¤å…ƒç´ çš„æ’å…¥é¡ºåºçš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥è¿™æ ·å†™ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Ord</span><span class="p">,</span> <span class="k">const</span> <span class="n">F</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="n">FractionalCascading</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cd">/// Ignore duplicated case</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">quick_find</span><span class="o">&lt;</span><span class="n">Q</span><span class="p">:</span> <span class="n">Borrow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Q</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.find_</span><span class="p">(</span><span class="n">k</span><span class="nf">.borrow</span><span class="p">(),</span> <span class="k">Self</span><span class="p">::</span><span class="n">quick_find_handle_approx_result</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">quick_find_handle_approx_result</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
        <span class="n">j</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="k">match</span> <span class="n">k</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Less</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span><span class="nf">.and_then</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="nf">Err</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="n">Equal</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span>
            <span class="p">}</span>
            <span class="n">Greater</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="na">.1</span><span class="nf">.and_then</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="nf">Err</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div></div>

<h2 id="åç»­">åç»­</h2>

<h3 id="åŠ¨æ€">åŠ¨æ€</h3>

<p>å…³äºåŠ¨æ€åˆ†ç‰‡çº§è”çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡æ•°ç»„è¢«ä¿®æ”¹æ—¶çš„æ›´æ–°ã€‚</p>

<p>è¿™å°†å®Œå…¨æŠ›å¼ƒæ•°ç»„ç»“æ„è€Œé‡‡ç”¨ç»å…¸åœ°é‡‡ç”¨æ ‘å‹ç»“æ„ï¼Œå°±åƒå‰æ–‡ä»‹ç»è¿‡çš„åœ¨ B+ æ ‘çš„æ•°ç»„å®ç°æ˜æ˜¾åŒºåˆ«äºå’Œ TreeMap å®ç°ä¸€æ ·ï¼Œå®ç°çš„å…·ä½“ç»†èŠ‚å°†å®Œå…¨ä¸åŒã€‚</p>

<p>ç”±äº<a href="https://en.wikipedia.org/wiki/Fractional_cascading#Dynamic_fractional_cascading">ä»‹ç»</a>çš„ç»†èŠ‚ç¹æ‚ï¼Œä¹Ÿæ²¡æœ‰è¯¦ç»†çš„ç¤ºä¾‹ï¼Œæ·±å…¥ä¸‹å»å¿…ç„¶è€—è´¹å¤§é‡æ—¶é—´ï¼Œä¸”å·²ç»åç¦»äº†ä¸»è¦ä»‹ç»çš„å†…å®¹ï¼Œå› æ­¤ç­‰éœ€è¦çš„æ—¶å€™å†æ¥å›é¡¾å§ã€‚</p>

<h3 id="åº”ç”¨">åº”ç”¨</h3>

<p><a href="https://en.wikipedia.org/wiki/Fractional_cascading#Applications">è®¡ç®—å‡ ä½•æ–¹é¢çš„é—®é¢˜</a></p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>å‡è®¾å…ƒç´ ç±»å‹ä¹Ÿæ˜¯å’Œç´¢å¼•ä½ç½®ä¸€æ ·çš„ç±»å‹Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>æ€»æ„Ÿè§‰åˆ†ç‰‡çº§è”å°±åƒæ–æ³¢é‚£å¥‘å †ä¸€æ ·ï¼Œå¯¹å¤æ‚åº¦é‡‡å–é€çº§æŠµæŠ—çš„åŠæ³•ï¼Œåº”è¯¥è¿›è¡Œå¯ä»¥ä¸€äº›ç±»æ¯”Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>ä¸¤ä¸¤å–æ ·ä¹Ÿå°±æ˜¯åˆ†ç‰‡çš„å¤§å°ä¸º $2$ ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„åˆ†ç‰‡å¤§å°Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>å› ä¸ºåˆ†ç‰‡å¤§å°æ˜¯ $2$ ï¼Œæ‰€ä»¥æ¯”è¾ƒä¸¤é¡¹ï¼Œå¦‚æœåˆ†ç‰‡å¤§å°æ˜¯ $4$ é‚£å°±æ¯”è¾ƒ $4$ é¡¹Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>å¯ä»¥è§†ä½œå¯¹åº”åˆ†ç‰‡ $f=1$ çš„æƒ…å†µï¼Œè™½ç„¶æ­¤æ—¶è€—è´¹å¤šä¸€åŠçš„ç©ºé—´Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[æœ¬æ–‡ä¸»è¦å‚è€ƒ wiki ï¼Œå¯¹å…¶ä¸­ä¸€äº›å†…å®¹è¿›è¡Œäº†æ‹“å±•ï¼Œå¯¹ä¸ªåˆ«é”™è¯¯è¿›è¡Œäº†ä¿®æ­£ã€‚]]></summary></entry><entry><title type="html">åˆ†æ®µæ ‘ï¼ˆSegment Treeï¼‰</title><link href="/algs/SegmentTree.html" rel="alternate" type="text/html" title="åˆ†æ®µæ ‘ï¼ˆSegment Treeï¼‰" /><published>2023-04-10T00:00:00+08:00</published><updated>2023-04-10T00:00:00+08:00</updated><id>/algs/SegmentTree</id><content type="html" xml:base="/algs/SegmentTree.html"><![CDATA[<p>æ›´å¸¸è§çš„åå­—æ˜¯<strong>çº¿æ®µæ ‘</strong>ï¼Œä½†æ­£å¦‚æˆ‘ä¸å–œæ¬¢â€œå€å¢â€è€Œå®æ„¿ç”¨â€œæŒ‡æ•°æå‡â€ä¸€æ ·ï¼Œâ€œçº¿æ®µâ€è¿™ç§è¿½æ±‚è¾è—»è€Œå¯¼è‡´è¯­ä¹‰å¤±ç„¦<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>çš„ç¿»è¯‘ï¼Œä¹Ÿä¸å¦‚â€œåˆ†æ®µâ€è¿™ç§å¹³ç™½ç›´æ¥çš„ç¿»è¯‘ã€‚æˆ‘ä¸€è´¯ä¸»å¼ ï¼Œç¿»è¯‘ã€ç‰¹åˆ«æ˜¯æŠ€æœ¯æœ¯è¯­çš„ç¿»è¯‘ï¼Œåº”è¯¥ä»¥æœ´å®æ˜“æ‡‚ä¸ºä¸»ï¼Œä½†é•¿æœŸä¸€æ¥çš„ç¿»è¯‘é£æ ¼å®Œå…¨èƒŒé“ç›¸é©°ï¼Œéƒ½æ˜¯åˆ©ç”¨ä¸­æ–‡çš„åšå¤§ç²¾æ·±ï¼ŒæŠŠä¸€ä¸ªç®€å•çš„æ¦‚å¿µç¿»è¯‘å¾—ç„é‡Œç„å¹»ï¼Œè®©äººä¸ä»…æ‘¸ä¸ç€å¤´è„‘ï¼Œè€Œä¸”æœ›è€Œç”Ÿç•ï¼Œéš¾é“ä»–ä»¬çš„ç›®çš„å°±åœ¨äºæ­¤ï¼Ÿ</p>

<p>æœ¬æ–‡åŸºæœ¬ç®—æ˜¯å¯¹ <a href="https://cp-algorithms.com/data_structures/segment_tree.html">cp-algorithms - Segment Tree</a> çš„ä¸€ä¸ª Rust å®ç°ç‰ˆæœ¬çš„ä»‹ç»ã€‚</p>

<h2 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</h2>

<p>åˆ†æ®µæ ‘æ˜¯ç”¨æ¥è§£å†³æ•°ç»„ä¸ŠåŒºé—´æŸ¥è¯¢é—®é¢˜çš„æ•°æ®ç»“æ„ã€‚</p>

<p>å®ƒæŠŠæ•°ç»„ä»£è¡¨çš„åŒºé—´ä¸æ–­äºŒåˆ†ï¼Œç›´åˆ°åŒºé—´å°åˆ°åªå«æœ‰å•ä¸ªå…ƒç´ ï¼ŒæŠŠå®ƒä»¬ç”¨äºŒå‰æ ‘çš„ç»“æ„ç»„ç»‡èµ·æ¥ï¼Œé¡¶ç‚¹ä»£è¡¨æ•´ä¸ªåŒºé—´ï¼Œå®ƒçš„å·¦å­©å­å’Œå³å­©å­åˆ†åˆ«ä»£è¡¨æ•´ä¸ªåŒºé—´çš„å·¦å³ä¸¤åŠï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¶å­èŠ‚ç‚¹ã€‚</p>

<p>å¦‚<a href="https://cp-algorithms.com/data_structures/segment_tree.html#structure-of-the-segment-tree">åŸæ–‡è¿™é‡Œ</a>æ‰€ç¤ºã€‚</p>

<p>å®ƒéå¸¸å¥½åœ°ä½“ç°äº†åˆ†æ²»<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>æ€æƒ³ï¼Œæœ‰äº†è¿™æ ·çš„æ•°æ®ç»“æ„åï¼Œå½“é¢å¯¹ä¸€ä¸ªåŒºé—´æŸ¥è¯¢æ—¶ï¼Œåªéœ€è¦åœ¨ä»æ ¹åˆ°å¶å­å¯¹æ ‘é€’å½’æ—¶æŠŠå·²æœ‰çš„å±€éƒ¨åŒºé—´çš„ç­”æ¡ˆè¿›è¡Œç»„åˆï¼Œå°±èƒ½å¾—åˆ°æœ€ç»ˆç­”æ¡ˆã€‚</p>

<h3 id="æŸ¥è¯¢çš„å¤æ‚åº¦">æŸ¥è¯¢çš„å¤æ‚åº¦</h3>

<p>å¯ä»¥è¯æ˜æŸ¥è¯¢è¿‡ç¨‹ä¸­æ¯ä¸€å±‚æœ€å¤šè®¿é—® $4$ ä¸ªèŠ‚ç‚¹ã€‚</p>

<p>ä½¿ç”¨å½’çº³æ³•è¯æ˜ï¼Œåˆå§‹æ¡ä»¶æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¬¦åˆã€‚</p>

<p>å‡è®¾ä¸Šä¸€å±‚è®¿é—®ä¸è¶…è¿‡ $4$ ä¸ªèŠ‚ç‚¹ï¼š</p>

<ol>
  <li>å¦‚æœä¸Šä¸€å±‚åªè®¿é—®äº†ä¸¤ä¸ªæˆ–æ›´å°‘çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸€å±‚æœ€å¤šè®¿é—® $4$ ä¸ªï¼›</li>
  <li>å¦‚æœä¸Šä¸€å±‚è®¿é—® $3$ ä¸ªæˆ– $4$ ä¸ªèŠ‚ç‚¹ï¼Œç”±äºè®¿é—®çš„åŒºé—´æ˜¯è¿ç»­çš„ï¼Œä¸­é—´éƒ¨åˆ†æ­£å¥½å¯¹åº”åˆ†æ®µæ ‘çš„åŒºé—´ï¼Œä¼šç›´æ¥è¿”å›ï¼Œå› æ­¤åªæœ‰è¾¹ç¼˜çš„å·¦å³ä¸¤ä¸ªèŠ‚ç‚¹å¯èƒ½ä¼šå‘ä¸‹è®¿é—®ï¼Œè¿™ä¸€å±‚ä»ç„¶æœ€å¤šè®¿é—® $4$ ä¸ª</li>
</ol>

<p>è¯æ¯•ã€‚</p>

<p>å› æ­¤æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ç”±æ ‘é«˜å†³å®šï¼Œæ˜¯ $O(\text{log}n)$ ã€‚</p>

<h2 id="å®ç°å‰ç»">å®ç°å‰ç»</h2>

<p>ä½œä¸ºæ ‘å‹ç»“æ„è‡ªç„¶å°±æœ‰æ•°ç»„å’ŒæŒ‡é’ˆä¸¤ç§å®ç°ï¼Œè€Œåˆ†æ®µæ ‘å¯ä»¥å¾ˆå®¹æ˜“åœ°ä½¿ç”¨æ•°ç»„å®ç°<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ï¼Œè¿™è®©å®ƒçœ‹èµ·æ¥éå¸¸é è°±ï¼</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦è®¨è®ºçš„å°±æ˜¯çº¿æ®µæ ‘çš„<a href="https://github.com/minghu6/rust-minghu6/tree/v0.1.4/coll/src/segment_tree">æ•°ç»„å®ç°</a>ã€‚</p>

<h2 id="æ ‘çš„å¸ƒå±€">æ ‘çš„å¸ƒå±€</h2>

<p>æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æ°´å¹³å¸ƒå±€ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œä¾æ¬¡æ”¾ç½®æ¯ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º BFS å‹å¸ƒå±€ã€‚</p>

<h3 id="bfs-å‹">BFS å‹</h3>

<p>BFS å‹æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ€§è´¨å°±æ˜¯è®¡ç®—èŠ‚ç‚¹çš„å·¦å³å­©å­çš„ä½ç½®éå¸¸ç®€å•ï¼Œå¦‚æœæˆ‘ä»¬çš„æ•°ç»„ç¼–å·ä» $1$ å¼€å§‹ï¼Œé‚£ä¹ˆæ ¹æ®å®Œå…¨äºŒå‰æ ‘çš„æ€§è´¨ï¼Œ $t[i]$ èŠ‚ç‚¹çš„å·¦å­©å­å’Œå³å­©å­åˆ†åˆ«ä¸º $t[2\cdot i]$ å’Œ $t[2\cdot i+1]$ ã€‚</p>

<p>å¯ä»¥å¾ˆå®¹æ˜“åœ°è¯æ˜è¿™ä¸€ç‚¹ï¼š</p>

<p>é¦–å…ˆï¼Œå·²çŸ¥é«˜åº¦ä¸º $h$ çš„æ»¡çš„å®Œå…¨äºŒå‰æ ‘æœ‰ $2^h - 1$ ä¸ªèŠ‚ç‚¹<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>ï¼Œé«˜åº¦ä¸º $h$ çš„å±‚æœ‰ $2^{h-1}$ ä¸ªèŠ‚ç‚¹ã€‚</p>

<p>å‡è®¾ $t[i]$ èŠ‚ç‚¹åœ¨æ ‘çš„ $h$ å±‚ï¼ŒåŒä¸€å±‚çš„å‰é¢åŒ…æ‹¬å®ƒåœ¨å†…ï¼Œæœ‰ $x$ ä¸ªèŠ‚ç‚¹ï¼Œåé¢æœ‰ $y$ ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ˜¾ç„¶æœ‰:</p>

\[\begin{array}{l}
i &amp;= 2^{h-1} - 1 + x &amp;\quad(1)\\
x+y &amp;= 2^{h-1} &amp;\quad (2)\\
\end{array}\]

<p>è€Œå®ƒä¸å·¦å­©å­çš„è·ç¦» $d$ æœ‰ $d=y+2(x-1)+1$ ï¼Œåˆ©ç”¨ $(2)$ å¼æ¶ˆè§£æ‰ $y$ ï¼Œå¾—åˆ° $d=2^{h-1} + x - 1 = i$ ï¼Œä¹Ÿå°±æ˜¯ $t[i]$ èŠ‚ç‚¹çš„å·¦å­©å­è·ç¦»ä¸º $i$ ï¼Œå³å­©å­ç´§é‚»å·¦å­©å­ï¼Œè·ç¦»ä¸º $i+1$ ï¼Œè¯æ¯•ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬çš„ç¼–å·ä¸ä» 1 å¼€å§‹ï¼Œè€Œæ˜¯ä» 0 å¼€å§‹ï¼Œé‚£ä¹ˆæœ‰ $iâ€™ = i-1$ ï¼Œå¸¦å…¥ ${\large i_{\text{left}}} = 2i$ ï¼Œæœ‰ ${\large i â€™_{\text{left}}}+1=2(iâ€™+1)$  ï¼Œäºæ˜¯ï¼š</p>

\[\begin{array}{l}
{\large i â€™_{\text{left}}} &amp;=2i'+1\\
{\large i â€™_{\text{right}}} &amp;=2iâ€™+2
\end{array}\]

<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬æŒ‰ç…§å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„æ’åˆ—èŠ‚ç‚¹ï¼Œä½†<strong>åˆ†æ®µæ ‘æœ¬èº«å¹¶ä¸ä¸€å®šæ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œæœ€åä¸€å±‚çš„èŠ‚ç‚¹å¹¶ä¸æ˜¯è§„å¾‹åœ°ä»å·¦å¼€å§‹åˆ†å¸ƒ</strong><sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>ï¼Œè€Œæ˜¯æŒ‰ç…§æœ¬èº«çš„å¥‡å¶æ€§è§„å¾‹æ’å¸ƒï¼Œæ¯”å¦‚è€ƒè™‘ $6$ ä¸ªå…ƒç´ çš„åˆ†æ®µæ ‘ï¼š$(6)-(3, 3)-(2, 1, 2, 1)$ ã€‚</p>

<p>æŒ‰ç…§æ°´å¹³å¸ƒå±€ï¼Œåˆ†æ®µæ ‘æ•°ç»„éœ€è¦çš„èŠ‚ç‚¹æ•°æŒ‰ç…§æ»¡çš„å®Œå…¨äºŒå‰æ ‘æ¥è¯´æ˜¯ $2^h -1 = 2^{\lceil \text{log}_2 n \rceil} - 1 &lt; 2^{\lceil \text{log}_2 n\rceil} \leqslant 4n$ ï¼Œå› æ­¤å³ä½¿ä»¥ $1$ ä¸ºåŸºï¼Œä¹Ÿåªéœ€è¦åˆ†é… $4n$ å¤§å°çš„ç©ºé—´ã€‚</p>

<h3 id="dfs-å‹">DFS å‹</h3>

<p>ä»”ç»†è€ƒè™‘ä¸€ä¸‹åˆ†æ®µæ ‘çš„å½¢çŠ¶ï¼Œå‘ç°å®ƒå‡†ç¡®è¯´åº”è¯¥æ˜¯ä¸€æ£µ<a href="https://en.wikipedia.org/wiki/Binary_tree#Types_of_binary_trees">æ»¡äºŒå‰æ ‘ï¼ˆfull binary treeï¼‰</a>ï¼Œè€Œæ»¡äºŒå‰æ ‘æœ‰è¿™æ ·çš„æ€§è´¨ï¼Œå°±æ˜¯å¦‚æœå¶å­èŠ‚ç‚¹æ•°ä¸º $i$ ï¼Œé‚£ä¹ˆä¸­é—´èŠ‚ç‚¹æ•°å°±æ˜¯ $i-1$ ï¼Œæ•´æ£µæ ‘çš„èŠ‚ç‚¹æ•°å°±æ˜¯ $2\cdot i-1$ ã€‚</p>

<p>è¿™ä¸ªæ€§è´¨ä¸éœ€è¦ç‰¹åˆ«è¯æ˜ï¼Œå®ƒç›´æ¥å°±æ˜¯å®šä¹‰ç»™å‡ºçš„ï¼šæ»¡äºŒå‰æ ‘çš„ç›´æ¥å®šä¹‰æ˜¯èŠ‚ç‚¹è¦ä¹ˆæ²¡æœ‰å­©å­ï¼Œè¦ä¹ˆæœ‰ä¸¤ä¸ªå­©å­ï¼Œä½†å®ƒè¿˜æœ‰ä¸€ä¸ªé€’å½’å®šä¹‰ï¼š</p>

<ol>
  <li>å•èŠ‚ç‚¹æ˜¯æ»¡äºŒå‰æ ‘ï¼›</li>
  <li>æ ¹çš„ä¸¤ä¸ªå­©å­éƒ½æ˜¯æ»¡äºŒå‰æ ‘çš„äºŒå‰æ ‘æ˜¯æ»¡äºŒå‰æ ‘</li>
</ol>

<p>è¿™ä¸ªé€’å½’å®šä¹‰ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯±å¯¼æ¨ç†çš„è¿‡ç¨‹ï¼š</p>

<ol>
  <li>å•èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¶å­èŠ‚ç‚¹æ¯”ä¸­é—´èŠ‚ç‚¹æ•°å¤š $1$ ï¼›</li>
  <li>å‡è®¾æ ¹çš„ä¸¤ä¸ªå­©å­éƒ½æ˜¯æ»¡äºŒå‰æ ‘ï¼Œé‚£ä¹ˆå·¦å³å­©å­ä¸Šçš„å¶å­èŠ‚ç‚¹æ•°ä¹‹å’Œæ¯”ä¸­é—´ç»“ç‚¹æ•°ä¹‹å’Œå¤š $2$ ï¼ŒåŠ ä¸Šä½œä¸ºä¸­é—´èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹ï¼Œäºæ˜¯æ•´æ£µæ ‘çš„å¶å­èŠ‚ç‚¹ä»ç„¶æ¯”ä¸­é—´èŠ‚ç‚¹å¤š $1$</li>
</ol>

<p>è¯æ¯•ã€‚</p>

<p>æ ¹æ®æ»¡äºŒå‰æ ‘è¿™ä¸ªæ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<strong>ä¸ºé•¿åº¦ä¸º $n$ çš„æ•°ç»„å»ºç«‹çš„åˆ†æ®µæ ‘ç¡®å®šåœ°å«æœ‰ $2n-1$ ä¸ªèŠ‚ç‚¹</strong> ï¼Œè¿™ä¹ˆä¸€çœ‹ï¼ŒBFS å‹ç”³è¯·çš„ $4n$ çš„ç©ºé—´å®åœ¨æœ‰äº›æµªè´¹ï¼Œäºæ˜¯æœ‰äº†å†…å­˜èŠ‚çœå¸ƒå±€çš„ DFS å‹ã€‚</p>

<p>DFS é¡¾åæ€ä¹‰æ˜¯å‚ç›´å¸ƒå±€ï¼Œæ”¾ç½®æ ¹èŠ‚ç‚¹åï¼Œå…ˆæ”¾ç½®æ•´æ£µå·¦æ ‘ï¼Œå†æ”¾ç½®æ•´æ£µå³æ ‘ã€‚ä¸è¿‡å•çº¯åœ°å‚ç›´å¸ƒå±€å¹¶ä¸ä¼šèŠ‚çœç©ºé—´ï¼ŒçœŸæ­£å…³é”®çš„æ˜¯åœ¨å‚ç›´åˆ†å¸ƒä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æ»¡äºŒå‰æ ‘çš„å¸ƒå±€è€Œä¸æ˜¯å®Œå…¨äºŒå‰æ ‘çš„å¸ƒå±€ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ ‘ä¸Šéå†çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“èŠ‚ç‚¹æ‰€ä»£è¡¨çš„èŒƒå›´åŒºé—´ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹æ‰€ä»£è¡¨çš„å­æ ‘çš„å¶å­èŠ‚ç‚¹æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºæ•´æ£µå­æ ‘çš„å¤§å°ã€‚</p>

<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è®¡ç®—å‡ºå·¦å³å­©å­çš„ä½ç½®ï¼Œå¯¹èŠ‚ç‚¹ $t[i]$ ï¼Œè®¾å·¦å­©å­å¯¹åº”åŒºé—´é•¿åº¦ä¸º $l$ ï¼Œåˆ™å®ƒçš„å·¦å³å­©å­åˆ†åˆ«ä¸º $t[i+1]$ å’Œ $t[i+2\cdot l-1 + 1]=t[i+2\cdot l]$ ã€‚</p>

<p>è¿™æ ·å³ä½¿ä»ç„¶åŸº $1$ ï¼Œä¹Ÿåªéœ€è¦ç”³è¯· $2n$ å¤§å°çš„ç©ºé—´ï¼Œæ¯”èµ· BFS å‹æ•´æ•´èŠ‚çœäº†ä¸€åŠçš„ç©ºé—´ï¼</p>

<p>å…¨é¢åœ°æ¯”è¾ƒè¿™ä¸¤å‹å¸ƒå±€ï¼š</p>

<p>æ—¶é—´æ€§èƒ½ä¸Šï¼Œç”±äºæˆ‘ä»¬çš„è®¿é—®æ˜¯é€å±‚è¿›è¡Œçš„ï¼ŒBFS çš„åˆ†å±‚å¸ƒå±€ä½¿å¾—å·¦å³ä¸¤ä¸ªå­©å­ç´§é‚»ï¼Œæœ‰æ›´å¥½åœ°å±€éƒ¨æ€§ï¼Œä½†æ¯•ç«Ÿä»ç„¶æ˜¯åœ¨åŒä¸€ä¸ªæ•°ç»„ä¸Šè®¿é—®ï¼Œå·®è·ä¹Ÿå¤§ä¸åˆ°å“ªå„¿å»ï¼Œäº‹å®ä¸Šç»è¿‡ä¸€ä¸ªç®€å•æµ‹è¯•ï¼Œå‘ç°ä¸¤å‹çš„æ€§èƒ½å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼›</p>

<p>ç©ºé—´æ€§èƒ½ä¸Šï¼ŒDFS å‹å®Œèƒœï¼ŒBFS double äº†ç©ºé—´å ç”¨ï¼Œå¤ªå·®äº†ï¼›</p>

<p>æ˜“ç”¨æ€§ä¸Šï¼ŒBFS æ˜¯æ™®é€šäººéƒ½èƒ½æƒ³åˆ°çš„ï¼Œå·¦å³å­©å­çš„ä½ç½®ä¹Ÿå¾ˆç®€å•ï¼Œä¸è¿‡ DFS å‹ç»è¿‡æˆ‘çš„è®²è§£ä¹Ÿæ˜¯éå¸¸çš„ç®€å•æ˜“æ‡‚ï¼Œä¸¤è€…æ²¡æœ‰æ˜æ˜¾å·®åˆ«ã€‚</p>

<p>ç»¼åˆä»¥ä¸Šæ¯”è¾ƒï¼Œæ›´æ¨è DFS å‹ä½œä¸ºé»˜è®¤åœ°æ•°ç»„ä¸Šçš„é»˜è®¤å¸ƒå±€ã€‚</p>

<h2 id="èŒƒå¼çš„æè¿°">èŒƒå¼çš„æè¿°</h2>

<p>æˆ‘ä»¬å°è¯•å°½é‡ç”¨ Rust çš„æŠ½è±¡æœºåˆ¶æŠŠæœ¬ç¯‡æ¶‰åŠçš„æ‰€æœ‰æ¦‚å¿µè¿™äº›å¯é€‰é¡¹æ‰åˆ°ä¸€èµ·ã€‚</p>

<h3 id="å¸ƒå±€å’Œæ¸¸æ ‡">å¸ƒå±€å’Œæ¸¸æ ‡</h3>

<p>ä¸ºäº†æè¿°åˆ†æ®µæ ‘çš„å¸ƒå±€ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªç»“æ„ç»Ÿä¸€ä¿å­˜æ ‘ä¸Šéå†éœ€è¦çš„ç´¢å¼•ä¿¡æ¯ï¼šåˆ†æ®µæ•°ç»„çš„ç´¢å¼• <code class="language-plaintext highlighter-rouge">i</code> å’Œå¯¹åº”åŸæ•°ç»„çš„åŒºé—´<code class="language-plaintext highlighter-rouge">[tl, tr]</code> ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/// (i, tl, tr)</span>
<span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Cursor</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">tl</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">tr</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>äºæ˜¯å¯ä»¥å®šä¹‰æ ‘å½¢å¸ƒå±€çš„æŠ½è±¡ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">TreeLayout</span><span class="p">:</span> <span class="nn">private</span><span class="p">::</span><span class="n">Sealed</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">left_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">right_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">mod</span> <span class="n">private</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">trait</span> <span class="n">Sealed</span> <span class="p">{}</span>

    <span class="k">impl</span> <span class="n">Sealed</span> <span class="k">for</span> <span class="k">super</span><span class="p">::</span><span class="n">BFS</span> <span class="p">{}</span>
    <span class="k">impl</span> <span class="n">Sealed</span> <span class="k">for</span> <span class="k">super</span><span class="p">::</span><span class="n">DFS</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œä½¿ç”¨äº†ç»§æ‰¿ç§æœ‰æ¨¡å—çš„å…¬å…± Trait æ¥å°è£…æš´éœ²ç»™ä¸‹æ¸¸çš„å…¬å…± Trait çš„æŠ€å·§ï¼Œå› ä¸ºæˆ‘ä»¬å®šä¹‰å¹¶æš´éœ²å‡º <code class="language-plaintext highlighter-rouge">TreeLayout</code> åªæ˜¯ä¸ºäº†å…è®¸ç”¨æˆ·è‡ªç”±é€‰æ‹©ä»–ä»¬éœ€è¦çš„çº¿æ®µæ ‘å¸ƒå±€ï¼Œè€Œå¹¶ä¸æœŸæœ›ç”¨æˆ·å®ç°å®ƒã€‚</p>

<p>å¯¹äº BFS å’Œ DFS ä¸¤å‹ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span> <span class="n">TreeLayout</span> <span class="k">for</span> <span class="n">BFS</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">left_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="n">c</span><span class="py">.i</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">right_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="n">c</span><span class="py">.i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="mi">4</span> <span class="o">*</span> <span class="n">cap</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">TreeLayout</span> <span class="k">for</span> <span class="n">DFS</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">left_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="n">c</span><span class="py">.i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">right_i</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="c1">// i + 2(n(left))</span>
        <span class="n">c</span><span class="py">.i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nd">tm!</span><span class="p">(</span><span class="n">c</span><span class="py">.tl</span><span class="p">,</span> <span class="n">c</span><span class="py">.tr</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="py">.tl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åˆ†æ®µæ ‘">åˆ†æ®µæ ‘</h3>

<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥åˆæ­¥åœ°å¼•å‡ºæˆ‘ä»¬åˆ†æ®µæ ‘çš„ç»“æ„ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span> <span class="o">=</span> <span class="n">DFS</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="n">_note</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">trait</span> <span class="n">Count</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span><span class="p">;</span>

    <span class="k">fn</span> <span class="n">combine</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">;</span>
    <span class="cd">/// identity element: any stats combine with e results itself</span>
    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ³›å‹ <code class="language-plaintext highlighter-rouge">T</code> ä»£è¡¨äº†åˆ†æ®µæ ‘å‚¨å­˜çš„å¯¹æ•°ç»„åŒºé—´çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ³›å‹ <code class="language-plaintext highlighter-rouge">C</code> ä»£è¡¨äº†ç»Ÿè®¡æ–¹æ³•ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå½’å¹¶ä¸¤ä¸ªç»Ÿè®¡æ•°æ®çš„æ–¹æ³•å’Œä¸€ä¸ªè¿”å›å¹ºå…ƒçš„æ–¹æ³•ã€‚</p>

<p>å€Ÿç€æ˜¯åˆ†æ®µæ ‘çš„åˆ›å»ºï¼Œå¯ä¸€çª¥æ ‘ä¸Šéå†çš„åŸºæœ¬æ–¹æ³•ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">new</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">U</span><span class="p">:</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">raw</span><span class="nf">.is_empty</span><span class="p">());</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span> <span class="nn">L</span><span class="p">::</span><span class="nf">size</span><span class="p">(</span><span class="n">raw</span><span class="nf">.len</span><span class="p">())];</span>

        <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="nn">Cursor</span><span class="p">::</span><span class="nf">init</span><span class="p">(</span><span class="n">raw</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">Self</span><span class="p">::</span><span class="nf">build</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">data</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>

        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">root</span><span class="p">,</span>
            <span class="n">_note</span><span class="p">:</span> <span class="nn">PhantomData</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">fn</span> <span class="n">build</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">arr</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">U</span><span class="p">],</span> <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span>
    <span class="k">where</span>
        <span class="n">U</span><span class="p">:</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_end</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="py">.i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">c</span><span class="py">.tl</span><span class="p">]</span><span class="nf">.clone</span><span class="p">()</span><span class="nf">.raw_into_stats</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">build</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">build</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

            <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="py">.i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.i</span><span class="p">])</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span> <span class="n">Cursor</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">raw_len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">tl</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">tr</span><span class="p">:</span> <span class="n">raw_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">is_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.tl</span> <span class="o">==</span> <span class="k">self</span><span class="py">.tr</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">is_matched</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">))</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.tl</span> <span class="o">==</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="k">self</span><span class="py">.tr</span> <span class="o">==</span> <span class="n">r</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="n">godown_left</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="nn">L</span><span class="p">::</span><span class="nf">left_i</span><span class="p">(</span><span class="k">self</span><span class="p">),</span>
            <span class="n">tl</span><span class="p">:</span> <span class="k">self</span><span class="py">.tl</span><span class="p">,</span>
            <span class="n">tr</span><span class="p">:</span> <span class="nd">tm!</span><span class="p">(</span><span class="k">self</span><span class="py">.tl</span><span class="p">,</span> <span class="k">self</span><span class="py">.tr</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="n">godown_right</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="nn">L</span><span class="p">::</span><span class="nf">right_i</span><span class="p">(</span><span class="k">self</span><span class="p">),</span>
            <span class="n">tl</span><span class="p">:</span> <span class="nd">tm!</span><span class="p">(</span><span class="k">self</span><span class="py">.tl</span><span class="p">,</span> <span class="k">self</span><span class="py">.tr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">tr</span><span class="p">:</span> <span class="k">self</span><span class="py">.tr</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">tm</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$tl:expr</span><span class="p">,</span> <span class="nv">$tr:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="p">(</span><span class="nv">$tl</span> <span class="o">+</span> <span class="nv">$tr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nd">macro_rules!</span> <span class="n">left</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$c:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nv">$c</span><span class="py">.godown_left</span><span class="p">::</span><span class="o">&lt;</span><span class="n">L</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nd">macro_rules!</span> <span class="n">right</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$c:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nv">$c</span><span class="py">.godown_right</span><span class="p">::</span><span class="o">&lt;</span><span class="n">L</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæ¶‰åŠäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">RawIntoStats</code> çš„ Trait ï¼Œå®ƒæä¾›äº†åŸå§‹æ•°ç»„ä¸Šçš„å…ƒç´ é’ˆå¯¹æŸç§ç»Ÿè®¡æ–¹æ³•éœ€è¦çš„æŸä¸ªç»Ÿè®¡ç±»å‹è¿›è¡Œè½¬æ¢çš„æŠ½è±¡ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="n">S</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>

<p>å°è¯•åˆ’åˆ†æŒ‰ç…§åˆ†æ®µæ ‘çš„åŒºé—´è¿›è¡Œåˆ’åˆ†ï¼Œç›´åˆ°ä¸€ä¸ªé”™è¯¯çš„åŒºé—´èŒƒå›´ï¼Œè¿™æ—¶ç›´æ¥è¿”å›å¹ºå…ƒï¼Œæ¯”èµ·æ£€æŸ¥è¿”å›å€¼è¦ç®€æ´å¾ˆå¤š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span> <span class="p">{</span>    
	<span class="k">pub</span> <span class="k">fn</span> <span class="n">query</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.query_</span><span class="p">(</span><span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="k">self</span><span class="py">.root</span><span class="p">),</span> <span class="k">self</span><span class="py">.root</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">query_</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span> <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_matched</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span>
                <span class="o">&amp;</span><span class="k">self</span><span class="nf">.query_</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tr</span><span class="p">,</span> <span class="n">r</span><span class="p">)),</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span>
                <span class="o">&amp;</span><span class="k">self</span><span class="nf">.query_</span><span class="p">((</span><span class="nf">max</span><span class="p">(</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tl</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">r</span><span class="p">),</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cd">/// -&gt; (l, r)</span>
<span class="nd">macro_rules!</span> <span class="n">parse_range</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$range:expr</span><span class="p">,</span> <span class="nv">$root:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">ops</span><span class="p">::</span><span class="nn">Bound</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">range</span> <span class="o">=</span> <span class="nv">$range</span><span class="p">;</span>
		<span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="nv">$root</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">l</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">r</span><span class="p">;</span>

        <span class="k">match</span> <span class="n">range</span><span class="nf">.start_bound</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Included</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
            <span class="nf">Excluded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">Unbounded</span> <span class="k">=&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">root</span><span class="py">.tl</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">match</span> <span class="n">range</span><span class="nf">.end_bound</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Included</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
            <span class="nf">Excluded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">assert!</span><span class="p">(</span><span class="o">*</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"range upper is invalid (=0)"</span><span class="p">);</span>
                <span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">}</span>
            <span class="n">Unbounded</span> <span class="k">=&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">root</span><span class="py">.tr</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ›´æ–°">æ›´æ–°</h3>

<p>å¦‚æœåŸæ•°ç»„çš„æŸä¸ªå€¼å‘ç”Ÿäº†æ›´æ–°ï¼Œé‚£ä¹ˆå¯¹åº”åœ°ï¼Œä»åˆ†æ®µæ ‘çš„æ ¹ä¸€ç›´åˆ°è¯¥å€¼æ‰€åœ¨çš„å¶å­ï¼Œæ•´æ¡è·¯å¾„ä¹Ÿéœ€è¦æ›´æ–°ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span> <span class="p">{</span>        
	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">assoc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="k">self</span><span class="py">.root.tr</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span><span class="k">self</span><span class="py">.root</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">assoc_</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">ti</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_end</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">c</span><span class="py">.i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">clf</span> <span class="o">=</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
            <span class="k">let</span> <span class="n">crh</span> <span class="o">=</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;=</span> <span class="n">clf</span><span class="py">.tr</span> <span class="p">{</span>
                <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">new_val</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span><span class="n">crh</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">new_val</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">c</span><span class="py">.i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">clf</span><span class="py">.i</span><span class="p">],</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">crh</span><span class="py">.i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç»å…¸é—®é¢˜">ç»å…¸é—®é¢˜</h2>

<p>æˆ‘ä»¬å°†ä¼šå±‚å±‚é€’è¿›åœ°ä»‹ç»ä¸€äº›é€‚ç”¨äºä¸Šè¿°åˆ†æ®µæ ‘èŒƒå¼çš„ç»å…¸é—®é¢˜ã€‚</p>

<p>ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸‹ä¸€ä¸ªæ–¹ä¾¿å¯¹ä¸ºæ•°å­—ç±»å‹æ‰¹é‡å®ç° <code class="language-plaintext highlighter-rouge">RawIntoStats</code> çš„è¾…åŠ©å®ã€‚å‡ºäºä¸€äº›è€ƒè™‘ï¼ŒRust å¹¶æ²¡æœ‰æŠŠæ•°å­—ï¼ŒåŒ…æ‹¬æ•´å‹å’Œæµ®ç‚¹æ•°å‹å•ç‹¬æŠ½è±¡å‡ºæ¥ï¼Œè€Œæ˜¯é’ˆå¯¹å…·ä½“åœ°å®ç±»å‹å•ç‹¬å®ç°æ–¹æ³•ã€‚ä¸è¿‡å®ƒä»¬ä¹Ÿæ²¡æœ‰çœŸçš„æ‰‹å†™è¿™äº›ä»£ç ï¼Œä¹Ÿæ˜¯ç”¨å®æ¥æ‰¹é‡å®ç°çš„<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup>ï¼Œæ­£å¦‚æˆ‘å‰é¢æŸç¯‡åšæ–‡é‡Œåæ§½è¿‡çš„ï¼Œå‡¡æ˜¯ Rust è‡ªå·±éƒ½è§‰å¾—ä¸æ–¹ä¾¿è€Œå¼€å‘å†…éƒ¨è¾…åŠ©ç»“æ„çš„ï¼Œä¸‹æ¸¸ç”¨æˆ·ä¸€å®šä¼šé‡æ–°é€ è½®å­ï¼Œä¸€ä¸ªå®ƒå†…éƒ¨å·¥å…·çš„å¤åˆ¶å“ã€‚</p>

<h3 id="è¾…åŠ©å®">è¾…åŠ©å®</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">impl_raw_into_stats</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">monomorphic</span> <span class="p">|</span> <span class="nv">$struct:ident</span><span class="p">,</span> <span class="nv">$for_ty:ty</span><span class="p">,</span> <span class="nv">$stats_ty:ty</span> <span class="p">{</span> <span class="nv">$fn:item</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">impl</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="nv">$struct</span><span class="o">&gt;</span> <span class="k">for</span> <span class="nv">$for_ty</span> <span class="p">{</span>
            <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="nv">$stats_ty</span><span class="p">;</span>

            <span class="nv">$fn</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$struct:ident</span><span class="p">,</span> <span class="nv">$for_ty:ty</span><span class="p">,</span> <span class="nv">$stats_ty:ty</span> <span class="p">{</span> <span class="nv">$fn:item</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">impl</span> <span class="n">RawIntoStats</span><span class="o">&lt;</span><span class="nv">$struct</span><span class="o">&lt;</span><span class="nv">$for_ty</span><span class="o">&gt;&gt;</span> <span class="k">for</span> <span class="nv">$for_ty</span> <span class="p">{</span>
            <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="nv">$stats_ty</span><span class="p">;</span>

            <span class="nv">$fn</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$name:ident</span><span class="p">|</span><span class="n">all</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">int</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">float</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$name:ident</span><span class="p">|</span><span class="nb">int</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="n">sint</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">uint</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$name:ident</span><span class="p">|</span><span class="nb">float</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">f32</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">f64</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$name:ident</span><span class="p">|</span><span class="nb">uint</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">u128</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">u64</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">usize</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">u32</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">u16</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">u8</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$name:ident</span><span class="p">|</span><span class="n">sint</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">i128</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">i64</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">isize</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">i32</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">i16</span><span class="p">);</span>
        <span class="nd">impl_for_num!</span><span class="p">(</span><span class="nv">$name</span><span class="p">|</span><span class="nb">i8</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªç”¨äºæ•°å­—ç±»å‹æ‰¹é‡å®ç°çš„è¾…åŠ©å®èµ·å§‹å¯ä»¥å¹¿æ³›åœ°ä½¿ç”¨ã€‚</p>

<h3 id="ç®€å•å•å€¼">ç®€å•å•å€¼</h3>

<p>æœ€ç®€å•çš„æƒ…å†µï¼Œå°±æ˜¯ç»Ÿè®¡ç±»å‹å’ŒåŸæ•°ç»„å€¼ç±»å‹ä¸€è‡´ã€‚</p>

<p>æ¯”å¦‚ï¼ŒæŸ¥è¯¢åŸæ•°ç»„ä¸Šç»™å®šåŒºé—´èŒƒå›´çš„å…ƒç´ å’Œã€‚</p>

<p>è¿™éå¸¸ç®€å•ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Count</span> <span class="k">for</span> <span class="n">Sum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">combine</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="n">l</span><span class="nf">.borrow</span><span class="p">()</span> <span class="o">+</span> <span class="n">r</span><span class="nf">.borrow</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="nn">T</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="p">(</span><span class="n">sum_stats</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_raw_into_stats!</span><span class="p">(</span><span class="n">Sum</span><span class="p">,</span> <span class="nv">$for_ty</span><span class="p">,</span> <span class="nv">$for_ty</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
                <span class="k">self</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nd">impl_for_num!</span><span class="p">(</span><span class="n">sum_stats</span> <span class="p">|</span> <span class="n">all</span><span class="p">);</span>
</code></pre></div></div>

<p>ç±»ä¼¼åœ°ï¼Œæ±‚è§£æœ€å¤§å€¼ï¼Œæœ€å¤§å…¬çº¦æ•°ï¼Œæœ€å°å…¬å€æ•°ç­‰ç­‰ï¼Œéƒ½æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>

<h3 id="å¤åˆç±»å‹">å¤åˆç±»å‹</h3>

<p>ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œç»Ÿè®¡ç»™å®šåŒºé—´çš„æœ€å¤§å€¼å’Œå‡ºç°æ¬¡æ•°ã€‚</p>

<p>è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">Min&lt;T&gt;</code> Trait æ˜¯ä¸ºæ‰€æœ‰æ•°å­—ç±»å‹å®ç°çš„è·å–å…¶æœ€å°å€¼çš„æŠ½è±¡ï¼Œç›¸å½“äº <code class="language-plaintext highlighter-rouge">T::MIN</code> ,</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">MaxStats</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Count</span> <span class="k">for</span> <span class="n">MaxStats</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="n">Min</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="nb">usize</span><span class="p">);</span>

    <span class="k">fn</span> <span class="nf">combine</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">l</span><span class="na">.0</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Less</span> <span class="k">=&gt;</span> <span class="n">r</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">Equal</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">l</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">(),</span> <span class="n">l</span><span class="na">.1</span> <span class="o">+</span> <span class="n">r</span><span class="na">.1</span><span class="p">),</span>
            <span class="n">Greater</span> <span class="k">=&gt;</span> <span class="n">l</span><span class="nf">.clone</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">as</span> <span class="n">Min</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">min</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">trait</span> <span class="n">Min</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">min</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">T</span><span class="p">;</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="p">(</span><span class="n">max_stats_stats</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_raw_into_stats!</span><span class="p">(</span><span class="n">MaxStats</span><span class="p">,</span> <span class="nv">$for_ty</span><span class="p">,</span> <span class="p">(</span><span class="nv">$for_ty</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
                <span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="p">(</span><span class="n">min</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">impl</span> <span class="n">Min</span><span class="o">&lt;</span><span class="nv">$for_ty</span><span class="o">&gt;</span> <span class="k">for</span> <span class="nv">$for_ty</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">min</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nv">$for_ty</span> <span class="p">{</span>
                <span class="o">&lt;</span><span class="nv">$for_ty</span><span class="o">&gt;</span><span class="p">::</span><span class="n">MIN</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nd">impl_for_num!</span><span class="p">(</span><span class="n">min</span> <span class="p">|</span> <span class="n">all</span><span class="p">);</span>
<span class="nd">impl_for_num!</span><span class="p">(</span><span class="n">max_stats_stats</span> <span class="p">|</span> <span class="nb">int</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="æ’åä½ç½®">æ’åä½ç½®</h3>

<p>æ¯”å¦‚ï¼Œç»Ÿè®¡ $0$ çš„ä¸ªæ•°ï¼Œå¹¶æŸ¥æ‰¾ç¬¬ $k$ ä¸ª $0$ çš„ä½ç½®</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">ZeroStats</span><span class="p">;</span>


<span class="k">impl</span> <span class="n">Count</span> <span class="k">for</span> <span class="n">ZeroStats</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="nb">usize</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">combine</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">l</span> <span class="o">+</span> <span class="o">*</span><span class="n">r</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">(</span><span class="n">zero_stats</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_raw_into_stats!</span><span class="p">(</span><span class="n">monomorphic</span><span class="p">|</span><span class="n">ZeroStats</span><span class="p">,</span> <span class="nv">$for_ty</span><span class="p">,</span> <span class="nb">usize</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">self</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è®¾è®¡ä¸Šï¼Œç‰¹æ®Šçš„æ–¹æ³•æ”¾åˆ°å…·ä½“ Trait ä¸Šï¼Œä¸‹åŒã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span> <span class="n">ZeroStats</span> <span class="p">{</span>
    <span class="cd">/// Start from 0</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">find_nth</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SegmentTree</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="k">Self</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="py">.root</span><span class="p">]</span> <span class="p">{</span>
            <span class="nb">None</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">Some</span><span class="p">(</span><span class="k">Self</span><span class="p">::</span><span class="nf">find_nth_</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tree</span><span class="py">.root</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">find_nth_</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SegmentTree</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="k">Self</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_end</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">c</span><span class="py">.tl</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">clf</span> <span class="o">=</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
            <span class="k">let</span> <span class="n">crh</span> <span class="o">=</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="n">clf</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">n</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">::</span><span class="nf">find_nth_</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">clf</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">::</span><span class="nf">find_nth_</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">tree</span><span class="p">[</span><span class="n">clf</span><span class="p">],</span> <span class="n">crh</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç±»ä¼¼åœ°è¿˜æœ‰æŸ¥æ‰¾ç»™å®šåŒºé—´é‡Œçš„å…ƒç´ ä½ç½®ï¼Œä½¿å¾—å®ƒçš„å‰ç¼€å’Œä¸å°äºç»™å®šå€¼ã€‚</p>

<h3 id="findfirst">FindFirst</h3>

<p>æŸ¥æ‰¾ç»™å®šåŒºé—´é‡Œç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„å…ƒç´ çš„ä½ç½®ã€‚</p>

<p>æ¯”å¦‚ï¼ŒæŸ¥æ‰¾ç»™å®šåŒºé—´é‡Œç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äºç»™å®šå€¼çš„å€¼çš„ä½ç½®ã€‚</p>

<p>é¦–å…ˆæ„å»ºä¸€ä¸ªç»Ÿè®¡æœ€å¤§å€¼çš„åˆ†æ®µæ ‘ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">Max</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Count</span> <span class="k">for</span> <span class="n">Max</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">combine</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">l</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Less</span> <span class="k">=&gt;</span> <span class="n">r</span><span class="p">,</span>
            <span class="n">Equal</span> <span class="k">=&gt;</span> <span class="n">l</span><span class="p">,</span>
            <span class="n">Greater</span> <span class="k">=&gt;</span> <span class="n">l</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nf">.clone</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">(</span><span class="n">max_stats</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_raw_into_stats!</span><span class="p">(</span><span class="n">Max</span><span class="p">,</span> <span class="nv">$for_ty</span><span class="p">,</span> <span class="nv">$for_ty</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
                <span class="k">self</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nd">impl_for_num!</span><span class="p">(</span><span class="n">max_stats</span> <span class="p">|</span> <span class="nb">int</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨æ­¤åŸºç¡€ä¸Šå®ç° findfirst ç±»å‹çš„é—®é¢˜ï¼š</p>

<p>ä»æ ¹å¼€å§‹ä¸‹é™ï¼Œç›´åˆ°åŒºé—´èŒƒå›´åœ¨ç»™å®šçš„èŒƒå›´ä¹‹å†…ï¼Œè¿™æ˜¯ <code class="language-plaintext highlighter-rouge">query_first_gt_1</code> åšçš„äº‹æƒ…ï¼Œç„¶ååœ¨è¿™ä¸ªåŒºé—´é‡Œåš<a href="#æŸ¥æ‰¾æ’åä½ç½®">å‰ä¸€ä¸ªå°èŠ‚</a>é‡Œé‚£æ ·çš„æŸ¥è¯¢ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Max</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span><span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">query_first_gt</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">Self</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_1</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">tree</span><span class="py">.root</span><span class="p">),</span>
            <span class="n">tree</span><span class="py">.root</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">query_first_gt_1</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">Self</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
        <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// left or right</span>
        <span class="k">if</span> <span class="n">c</span><span class="py">.tl</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="p">||</span> <span class="n">c</span><span class="py">.tr</span> <span class="o">&lt;</span> <span class="n">l</span> <span class="p">{</span>
            <span class="nb">None</span>
        <span class="p">}</span>
        <span class="c1">// inner</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="py">.tr</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="py">.tl</span> <span class="o">&gt;=</span> <span class="n">l</span> <span class="p">{</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// cross</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// avoid bound overflow</span>
            <span class="k">let</span> <span class="n">left_res</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_1</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

            <span class="k">if</span> <span class="n">left_res</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">left_res</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_1</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">query_first_gt_2</span><span class="o">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">Self</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">&amp;</span><span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">None</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_end</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Some</span><span class="p">(</span><span class="n">c</span><span class="py">.tl</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="o">&amp;</span><span class="n">tree</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">::</span><span class="nf">query_first_gt_2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æœ€å¤§å’Œçš„å­åˆ†æ®µ">æœ€å¤§å’Œçš„å­åˆ†æ®µ</h3>

<p>è¿™æ˜¯ä¸€ä¸ªç‰¹å®šçš„ï¼Œä½†æ˜¯å¤æ‚çš„é—®é¢˜ï¼šæŸ¥æ‰¾ç»™å®šåŒºé—´èŒƒå›´å†…çš„ä¸€ä¸ªå­åŒºé—´ï¼Œä½¿å¾—æœ‰åŒºé—´é‡Œæ‰€æœ‰å…ƒç´ ä¹‹å’Œæœ€å¤§ã€‚</p>

<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ„æ€è¿˜æ˜¯æ¯”è¾ƒå·§å¦™çš„ï¼Œåˆ©ç”¨ä¸€ä¸ªå¤æ‚çš„ç»Ÿè®¡ç»“æ„ï¼Œåˆ†è€Œæ²»ä¹‹åœ°åˆ†è€Œæ²»ä¹‹ï¼Œè¿™ä¸ªç»“æ„åŒ…å« 4 ä¸ªæˆå‘˜ï¼š</p>

<ol>
  <li>prefï¼Œæœ€å¤§å‰ç¼€å’Œï¼›</li>
  <li>suffï¼Œæœ€å¤§åç¼€å’Œï¼›</li>
  <li>sumï¼ŒåŒºé—´å…ƒç´ ä¹‹å’Œï¼›</li>
  <li>ansï¼ŒåŒºé—´ç­”æ¡ˆï¼Œä¹Ÿå°±æ˜¯æœ€å¤§çš„å­åŒºé—´å’Œ</li>
</ol>

<p>åŒºé—´ç­”æ¡ˆå°±æ˜¯ç”±ä¸‰ä¸ªåé€‰å€¼ï¼š</p>

<ol>
  <li>å·¦åŒºé—´çš„ç­”æ¡ˆï¼›</li>
  <li>å³åŒºé—´çš„ç­”æ¡ˆï¼›</li>
  <li>å·¦åŒºé—´æœ€å¤§åç¼€å’Œ + å³åŒºé—´æœ€å¤§å‰ç¼€å’Œ</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Clone,</span> <span class="nd">Copy,</span> <span class="nd">Debug,</span> <span class="nd">Default)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">SubSegMaxSumStats</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cd">/// total sum of the segment</span>
    <span class="k">pub</span> <span class="n">sum</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
    <span class="cd">/// max prefix sum</span>
    <span class="k">pub</span> <span class="n">pref</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
    <span class="cd">/// max suffix sum</span>
    <span class="k">pub</span> <span class="n">suff</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
    <span class="cd">/// query answer of max sum of the segment</span>
    <span class="k">pub</span> <span class="n">ans</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Count</span> <span class="k">for</span> <span class="n">SubSegMaxSum</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">type</span> <span class="n">Stats</span> <span class="o">=</span> <span class="n">SubSegMaxSumStats</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">combine</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Stats</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="n">SubSegMaxSumStats</span> <span class="p">{</span>
            <span class="n">sum</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">l</span><span class="py">.sum</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.sum</span><span class="p">,</span>
            <span class="n">pref</span><span class="p">:</span> <span class="nf">max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="py">.pref</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="py">.sum</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.pref</span><span class="p">))</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">suff</span><span class="p">:</span> <span class="nf">max</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="py">.suff</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.sum</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.suff</span><span class="p">)</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">ans</span><span class="p">:</span> <span class="nd">max!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="py">.ans</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.ans</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="py">.suff</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">r</span><span class="py">.pref</span><span class="p">))</span><span class="nf">.clone</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">e</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
        <span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">macro_rules!</span> <span class="n">max</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$val:expr</span><span class="p">),</span><span class="o">+</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="p">{</span>
            <span class="p">[</span><span class="nv">$</span><span class="p">(</span><span class="nv">$val</span><span class="p">),</span><span class="o">+</span><span class="p">]</span><span class="nf">.into_iter</span><span class="p">()</span><span class="nf">.max</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">macro_rules!</span> <span class="n">impl_for_num</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">(</span><span class="n">sub_seg_max_sum_stats</span><span class="p">|</span> <span class="nv">$for_ty:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_raw_into_stats!</span><span class="p">(</span><span class="n">SubSegMaxSum</span><span class="p">,</span> <span class="nv">$for_ty</span><span class="p">,</span> <span class="n">SubSegMaxSumStats</span><span class="o">&lt;</span><span class="nv">$for_ty</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">raw_into_stats</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Stats</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">non_neg</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">self</span><span class="p">);</span>

                <span class="n">SubSegMaxSumStats</span> <span class="p">{</span>
                    <span class="n">sum</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span>
                    <span class="n">pref</span><span class="p">:</span> <span class="n">non_neg</span><span class="p">,</span>
                    <span class="n">suff</span><span class="p">:</span> <span class="n">non_neg</span><span class="p">,</span>
                    <span class="n">ans</span><span class="p">:</span> <span class="n">non_neg</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="nd">impl_for_num!</span><span class="p">(</span><span class="n">sub_seg_max_sum_stats</span> <span class="p">|</span> <span class="n">sint</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="ä¿å­˜æ•´ä¸ªå­æ•°ç»„">ä¿å­˜æ•´ä¸ªå­æ•°ç»„</h2>

<p>æœ‰ä¸€ç§åˆ†æ®µæ ‘æ˜¯åœ¨æ¯ä¸ªç‚¹ä¸Šä¿å­˜åŸæ•°ç»„å¯¹åº”åŒºé—´é‡Œçš„æ‰€æœ‰å€¼ã€‚</p>

<p>å¦‚æœä¿å­˜çš„å­æ•°ç»„æ˜¯ç”¨æœ‰åºå‘é‡å­˜å‚¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†æ®µæ ‘å®é™…ä¸Šæ˜¯åœ¨ç©ºé—´ä¸Šè¿˜åŸäº†å½’å¹¶æ’åºçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå› æ­¤å®ƒä¹Ÿå¯ä»¥å«åš â€œ<strong>Merge Sort Tree</strong>â€ ï¼Œå¯ä»¥åœ¨ä¸Šé¢æ‰§è¡Œä¸€ç³»åˆ—æŸ¥è¯¢çš„æ“ä½œã€‚</p>

<p>å­˜å‚¨æœ‰åºå‘é‡å¯¹åŸæ•°ç»„çš„å…ƒç´ ä¿®æ”¹æ—¶æˆæœ¬è¾ƒé«˜ï¼Œå¯ä»¥æ”¹ä¸ºç»å…¸çš„ä»¥ TreeMap ä¸ºåŸºç¡€çš„ multiset <sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup>ï¼Œ</p>

<h3 id="findfirst-1">FindFirst</h3>

<p>åˆ†æ®µæ ‘æœ¬èº«çš„æŸ¥è¯¢å¤æ‚åº¦æ˜¯ $O(\text{log}n)$ ï¼Œæœ‰åºå‘é‡æˆ–è€… multiset ä¸ŠæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ $O(\text{log}n)$ ï¼Œå› æ­¤æ€»çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(\text{log}^2n)$ ã€‚</p>

<h3 id="åˆ†ç‰‡çº§è”">åˆ†ç‰‡çº§è”</h3>

<p>å¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="/algs/FractionalCascading.html">åˆ†ç‰‡çº§è”</a> çš„æ€æƒ³æ¥åŠ é€Ÿå¯¹ findfirst é—®é¢˜æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚</p>

<p>è¿™æ ·çš„è¯ï¼Œåœ¨æ ‘çš„æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¸åªæ˜¯å­˜å‚¨æ•´ä¸ªå­æ•°ç»„ï¼Œè€Œæ˜¯åˆ†ç‰‡çº§è”é‡Œé¢çš„ $M$  åˆ—è¡¨ï¼ŒåŒºåˆ«æ˜¯åŸæ¥æ˜¯çº§è”ä¸‹ä¸€çº§ï¼Œæ‰€ä»¥å­˜å‚¨ä¸‹ä¸€çº§çš„ç´¢å¼•ï¼Œè€Œç°åœ¨è¦çº§è”å·¦å³å­©å­ï¼Œéœ€è¦å­˜å‚¨å·¦å³å­©å­ä¸Šçš„ç´¢å¼•ã€‚</p>

<p>å¦å¤–ï¼Œç”±äºéœ€è¦ä¿å­˜æ•´ä¸ªå­æ•°ç»„ï¼Œæ‰€ä»¥åªçº§è”ï¼Œä¸åˆ†ç‰‡<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">8</a></sup> ã€‚</p>

<p>äºæ˜¯æŸ¥è¯¢çš„è¿‡ç¨‹å°±å˜ä¸ºï¼Œåœ¨æ ¹èŠ‚ç‚¹ä¸Šè¿›è¡Œä¸€æ¬¡äºŒåˆ†æŸ¥æ‰¾ï¼Œç„¶ååšæœ€å¤šæ ‘é«˜åº¦çš„æ‹‰é“¾ã€‚</p>

<p>ä»¥ $3$ å€çš„ç©ºé—´ä¸ºä»£ä»·ï¼Œè®©æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦é™åˆ°äº† $O(\text{log}n)$ ã€‚</p>

<h2 id="åŒºé—´æ›´æ–°">åŒºé—´æ›´æ–°</h2>

<p>åˆ†æ®µæ ‘æ”¯æŒä¸€ç§åœ¨ç»™å®šåŒºé—´ä¸Šå¿«é€Ÿåœ°æ‰¹é‡æ›´æ–°å…ƒç´ <sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">9</a></sup>çš„æ–¹æ³•ã€‚</p>

<p>è¿™ä¸ªåŒºé—´æ›´æ–°çš„æ–¹æ³•åˆ©ç”¨äº†â€œæƒ°æ€§æ›´æ–°â€çš„æ€æƒ³ï¼Œä¸å¦¨ä»¥ update-add ï¼Œä¹Ÿå°±æ˜¯æ‰¹é‡å¢åŠ ä¸€ä¸ªå›ºå®šå€¼ä¸ºä¾‹ï¼š</p>

<h3 id="æƒ°æ€§æ–¹æ³•">æƒ°æ€§æ–¹æ³•<sup id="fnref:11" role="doc-noteref"><a href="#fn:11" class="footnote" rel="footnote">10</a></sup></h3>

<p>åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œåªæ›´æ–°åˆ°ç»™å®šåŒºé—´è¦†ç›–åˆ°çš„åˆ†æ®µæ ‘ä¸Šçš„åŒºé—´ã€‚</p>

<p>æ¯”å¦‚å¯¹äºåˆ†æ®µæ ‘ $t[0..7]$ ï¼Œæ›´æ–°åŒºé—´ $[3..7]$ ï¼Œåˆ™æƒ°æ€§æ›´æ–°çš„è·¯å¾„ä¸ºï¼š</p>

\[\begin{array}{l}
t[0..7] &amp; \rightarrow [0..3] \rightarrow [2..3] \rightarrow [3]\\
        &amp; \rightarrow [4..7]
\end{array}\]

<p>è¿™å°±éœ€è¦åœ¨åˆ†æ®µæ ‘çš„åŒºé—´ä¸Šé¢å¤–å­˜å‚¨æƒ°æ€§æ›´æ–°çš„å€¼ï¼Œä¸ºäº†ä¸å½±å“æ—¢æœ‰ç»“æ„ï¼Œæˆ‘ä»¬ç”¨é¢å¤–çš„ä¸€ä¸ªè¾…åŠ©æ•°ç»„æ¥å­˜å‚¨å®ƒï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">UpdaterAdd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">);</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">create_updater</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">UpdaterAdd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nf">UpdaterAdd</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">()],</span> <span class="n">PhantomData</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æƒ°æ€§æ›´æ–°çš„è¿‡ç¨‹ä¸ä¸€èˆ¬å¾—åˆ†æ®µæ ‘çš„æŸ¥è¯¢è¿‡ç¨‹ä¸€æ ·ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">UpdaterAdd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="nb">Add</span><span class="o">&lt;</span><span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="n">AddAssign</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">assoc</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
        <span class="n">addend</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">tree</span><span class="py">.root</span><span class="p">),</span>
            <span class="n">addend</span><span class="p">,</span>
            <span class="n">tree</span><span class="py">.root</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">fn</span> <span class="nf">assoc_</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
        <span class="n">addend</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_matched</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">addend</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">addend</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.propagate</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

            <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span>
                <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tr</span><span class="p">)),</span>
                <span class="n">addend</span><span class="nf">.clone</span><span class="p">(),</span>
                <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
            <span class="p">);</span>
            <span class="k">self</span><span class="nf">.assoc_</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span>
                <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tl</span><span class="p">),</span> <span class="n">r</span><span class="p">),</span>
                <span class="n">addend</span><span class="p">,</span>
                <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
            <span class="p">);</span>

            <span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span> <span class="o">&amp;</span><span class="n">tree</span><span class="p">[</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">fn</span> <span class="nf">is_marked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">true</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">false</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/// Lazy propagation</span>
    <span class="k">fn</span> <span class="nf">propagate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="nf">.is_marked</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tree</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">+=</span> <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="k">self</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">self</span><span class="p">[</span><span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">+</span> <span class="o">&amp;</span><span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>

            <span class="n">tree</span><span class="p">[</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">+=</span> <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="k">self</span><span class="p">[</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">self</span><span class="p">[</span><span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">+</span> <span class="o">&amp;</span><span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>

            <span class="k">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æƒ°æ€§æ›´æ–°åªæœ‰å½“æŸ¥è¯¢åˆ°æŸä¸€å±‚æ—¶ï¼Œæ‰ä¼šæŠŠæ›´æ–°æ¨åˆ°åˆ†æ®µæ ‘çš„ä¸‹ä¸€å±‚ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">Count</span><span class="o">&lt;</span><span class="n">Stats</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L</span><span class="p">:</span> <span class="n">TreeLayout</span><span class="o">&gt;</span> <span class="n">UpdaterAdd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="nb">Default</span> <span class="o">+</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="nb">Add</span><span class="o">&lt;</span><span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="n">AddAssign</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">:</span> <span class="nb">Ord</span> <span class="o">+</span> <span class="nb">Add</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="n">T</span><span class="p">,</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">,</span>
    <span class="k">for</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="nv">'a</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">query</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">RangeBounds</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">range</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span>
    <span class="p">{</span>
        <span class="k">self</span><span class="nf">.query_</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="nd">parse_range!</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">tree</span><span class="py">.root</span><span class="p">),</span>
            <span class="n">tree</span><span class="py">.root</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">query_</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">SegmentTree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">),</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">Cursor</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nn">C</span><span class="p">::</span><span class="nf">e</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">c</span><span class="nf">.is_matched</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.propagate</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

            <span class="nn">C</span><span class="p">::</span><span class="nf">combine</span><span class="p">(</span>
                <span class="o">&amp;</span><span class="k">self</span><span class="nf">.query_</span><span class="p">(</span>
                    <span class="n">tree</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tr</span><span class="p">)),</span>
                    <span class="nd">left!</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="o">&amp;</span><span class="k">self</span><span class="nf">.query_</span><span class="p">(</span>
                    <span class="n">tree</span><span class="p">,</span>
                    <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="py">.tl</span><span class="p">),</span> <span class="n">r</span><span class="p">),</span>
                    <span class="nd">right!</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å…¶ä»–æ›´æ–°">å…¶ä»–æ›´æ–°</h3>

<p>å¯¹äºç»™å®šåŒºé—´çš„æ‰¹é‡èµ‹å€¼ï¼Œæ›´åŠ ç®€å•ï¼Œåªéœ€è¦æ¯ä¸ªéœ€è¦æ›´æ–°çš„åŒºé—´å­˜å‚¨ä¸€ä¸ªæ ‡è®°ä½ã€‚å½“ç„¶å¦‚æœæ˜¯å¤šä¸ªæ‰¹é‡èµ‹å€¼ï¼Œè¿˜æ˜¯è¦ä¸€ä¸ªå®Œæ•´çš„å€¼çš„è¾…åŠ©æ•°ç»„ã€‚</p>

<h2 id="æ¨å¹¿åˆ°æ›´é«˜ç»´åº¦">æ¨å¹¿åˆ°æ›´é«˜ç»´åº¦<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">11</a></sup></h2>

<p>ç®€å•çš„äºŒç»´åˆ†æ®µæ ‘åŸºæœ¬æŒ‰ç…§å…ˆæ„å»ºç¬¬ä¸€ä¸ªç»´åº¦ï¼Œç„¶ååœ¨ç¬¬ä¸€ä¸ªç»´åº¦ä¸‹é™åˆ°å¶å­æ—¶å†æ„å»ºç¬¬äºŒä¸ªç»´åº¦ã€‚</p>

<h2 id="æŒä¹…åŒ–ç‰ˆæœ¬">æŒä¹…åŒ–ç‰ˆæœ¬</h2>

<p>è°ˆåˆ°æŒä¹…åŒ–ç‰ˆæœ¬ï¼Œå°±æ˜¯æ ‘å‹ç»“æ„ï¼Œè€Œä¸”æ˜¯æŒ‡é’ˆæ„é€ çš„æ ‘å‹ç»“æ„ã€‚</p>

<p>åˆ†æ®µæ ‘è‡ªç„¶å¾ˆå®¹æ˜“åšæˆæŒä¹…åŒ–ç‰ˆæœ¬ï¼Œæ›´æ–°çš„æ—¶å€™ç›´æ¥å¤åˆ¶æ›´æ–°è·¯å¾„å°±å¯ä»¥ã€‚</p>

<p>ä½†æ˜¯éœ€è¦ä»æœ¬æ¥çš„æ•°ç»„å®ç°è½¬ä¸ºæŒ‡é’ˆå®ç°ï¼Œè¿™è®©è¿™ä¸ªé—®é¢˜å˜å¾—æœ‰ç‚¹å„¿é¸¡è‚‹ï¼Œå› ä¸ºæ€§èƒ½æŸå¤±å®åœ¨æœ‰äº›ä¸å¯æ¥å—ã€‚</p>

<h2 id="åŠ¨æ€åˆ†æ®µ">åŠ¨æ€åˆ†æ®µ</h2>

<p>å¦‚æœä¸èƒ½ä¸€æ¬¡æ€§åœ°æ„å»ºå®Œæ•´æ£µåˆ†æ®µæ ‘ï¼Œå¯ä»¥è¿›è¡ŒåŠ¨æ€åˆ†æ®µï¼Œåªæœ‰å½“æŸ¥è¯¢åˆ°æŸä¸ªåŒºé—´çš„èŠ‚ç‚¹æ—¶å†è¿›è¡Œåˆ›å»ºã€‚</p>

<p>ä½†æ˜¯è¿™ä¹Ÿå‡è®¾äº†æŒ‡é’ˆå®ç°ç‰ˆæœ¬çš„åˆ†æ®µæ ‘ï¼ŒåŒæ ·é¸¡è‚‹ã€‚</p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>ä½ ä¸çŸ¥é“ä¸»è¯­ä¹‰æ˜¯<strong>çº¿</strong>çŠ¶è¿˜æ˜¯åˆ†<strong>æ®µ</strong>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>divide and ruleÂ <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>å¦‚æœåŸæ•°ç»„çš„é•¿åº¦æ˜¯ç¡®å®šçš„ï¼Œé‚£ä¹ˆå¯¹åº”çš„çº¿æ®µæ ‘ä¹Ÿæ˜¯ç¡®å®šçš„Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>ç”±ç­‰æ¯”æ•°åˆ—å‰é¡¹å’Œ $S_n = a_1{\Large \frac{1-q^n}{1-q}} = 1Â·{\Large \frac{1-2^n}{1-2}} = 2^n - 1$ å¯æ¨Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>åªè¦æ•°ç»„çš„å¤§å°ä¸æ˜¯ $2$ çš„å¹‚Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>è¿™å®åœ¨æœ‰äº›ï¼Œè¯´å¥æ–‡è¨€ï¼Œè„±è£¤å­æ”¾å±ï¼Œè¿˜ä¸å¦‚æƒ³åŠæ³•ç”¨ Trait æ•°å­—ç±»å‹ç»™æŠ½è±¡å‡ºæ¥Â <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>bagÂ <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>æˆ–è€…è¯´åˆ†ç‰‡å¤§å°ä¸º $1$Â <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p>æ¯”å¦‚æ‰¹é‡åœ°å¢åŠ ä¸€ä¸ªå€¼ï¼Œæˆ–è€…æ‰¹é‡åœ°èµ‹äºˆä¸€ä¸ªå€¼Â <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:11" role="doc-endnote">
      <p>Lazy propagationÂ <a href="#fnref:11" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>æ ‘å¥—æ ‘Â <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[æ›´å¸¸è§çš„åå­—æ˜¯çº¿æ®µæ ‘ï¼Œä½†æ­£å¦‚æˆ‘ä¸å–œæ¬¢â€œå€å¢â€è€Œå®æ„¿ç”¨â€œæŒ‡æ•°æå‡â€ä¸€æ ·ï¼Œâ€œçº¿æ®µâ€è¿™ç§è¿½æ±‚è¾è—»è€Œå¯¼è‡´è¯­ä¹‰å¤±ç„¦1çš„ç¿»è¯‘ï¼Œä¹Ÿä¸å¦‚â€œåˆ†æ®µâ€è¿™ç§å¹³ç™½ç›´æ¥çš„ç¿»è¯‘ã€‚æˆ‘ä¸€è´¯ä¸»å¼ ï¼Œç¿»è¯‘ã€ç‰¹åˆ«æ˜¯æŠ€æœ¯æœ¯è¯­çš„ç¿»è¯‘ï¼Œåº”è¯¥ä»¥æœ´å®æ˜“æ‡‚ä¸ºä¸»ï¼Œä½†é•¿æœŸä¸€æ¥çš„ç¿»è¯‘é£æ ¼å®Œå…¨èƒŒé“ç›¸é©°ï¼Œéƒ½æ˜¯åˆ©ç”¨ä¸­æ–‡çš„åšå¤§ç²¾æ·±ï¼ŒæŠŠä¸€ä¸ªç®€å•çš„æ¦‚å¿µç¿»è¯‘å¾—ç„é‡Œç„å¹»ï¼Œè®©äººä¸ä»…æ‘¸ä¸ç€å¤´è„‘ï¼Œè€Œä¸”æœ›è€Œç”Ÿç•ï¼Œéš¾é“ä»–ä»¬çš„ç›®çš„å°±åœ¨äºæ­¤ï¼Ÿ ä½ ä¸çŸ¥é“ä¸»è¯­ä¹‰æ˜¯çº¿çŠ¶è¿˜æ˜¯åˆ†æ®µÂ &#8617;]]></summary></entry><entry><title type="html">æœ€å¤§å…¬çº¦æ•°ï¼ˆGreat Common Divisorï¼‰</title><link href="/algs/GCD.html" rel="alternate" type="text/html" title="æœ€å¤§å…¬çº¦æ•°ï¼ˆGreat Common Divisorï¼‰" /><published>2023-04-06T00:00:00+08:00</published><updated>2023-04-06T00:00:00+08:00</updated><id>/algs/GCD</id><content type="html" xml:base="/algs/GCD.html"><![CDATA[<p>å‡è®¾å¯¹äºéè´Ÿæ•´æ•°ï¼Œ$a$ ,  $b$ ï¼Œæ±‚å®ƒä»¬çš„æœ€å¤§å…¬çº¦æ•° $\text{gcd}(a, b)$ ï¼Œä»¥ä¸‹ç®€å†™ä½œ $g$ ã€‚</p>

<p>æ•°å­¦ä¸Šï¼Œæœ€å¤§å…¬çº¦æ•°åªæœ‰å¯¹ä¸¤ä¸ªéé›¶æ•´æ•°æ‰æœ‰æ„ä¹‰ï¼Œä½†æ˜¯ä¸€èˆ¬ä»å®ç°çš„æ–¹é¢ï¼Œè§„å®šï¼š</p>

<ol>
  <li>$\text{gcd}(0, b) = a$ ,  $\text{gcd}(a, 0) = a$</li>
  <li>$\text{gcd}(0, 0) = 0$</li>
</ol>

<h2 id="è¾—è½¬ç›¸å‡">è¾—è½¬ç›¸å‡</h2>

<p>ä¹Ÿæ˜¯åŸå§‹çš„æ¬§å‡ é‡Œå¾—ï¼ˆEuclideanï¼‰ç®—æ³•ã€‚</p>

<p>æ ¹æ®å®šä¹‰æœ‰ï¼š</p>

\[\begin{array}{l}
a &amp;= ng \\
b &amp;= mg
\end{array}\]

<p>$\text{n}$ ,  $\text{m}$ äº’è´¨ï¼Œå¯¹äº $a \neq b$ çš„æƒ…å†µï¼Œä¸å¤±ä¸€èˆ¬æ€§åœ°å‡è®¾ $a &gt; b$ ï¼Œä¹Ÿå°±æ˜¯ $n &gt; m$ ï¼Œè¿™æ ·çš„è¯ï¼Œ$a-b = (n - m) g$ ï¼Œ$b=mg$ ä¹Ÿæœ‰å…¬çº¦æ•° $g$<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> ã€‚</p>

<p>è¿™æ ·å– $a=\text{max}(a-b, b)$ ,  $b=\text{min}(a-b,b)$ ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ $n-m &gt; m$ ä»ç„¶æˆç«‹å°±ç»§ç»­å‡ï¼Œå¦åˆ™å°±æ˜¯äº¤æ¢ $a$ ,  $b$ çš„ä½ç½®ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­  $n &gt; \text{max}(n-m,m) = \text{max}(n, m) &gt; \text{max}(n-m, m)$ ç³»æ•°çš„ä¸Šé™ä¸æ–­ä¸‹é™ï¼Œç›´åˆ° $a=b$ ã€‚</p>

<p>æ­¤æ—¶ä¹Ÿæœ‰ $a=g$ ï¼Œ$b=g$ï¼Œæ­¤æ—¶å°±å¾—å‡ºäº†æœ€å¤§å…¬çº¦æ•° $g$ ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">while</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
            <span class="n">a</span> <span class="o">-=</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>
</code></pre></div></div>

<h2 id="è¾—è½¬å–ä½™">è¾—è½¬å–ä½™</h2>

<p>è¾—è½¬å–ä½™æ˜¯åŸå§‹æ¬§å‡ é‡Œå¾—ç®—æ³•çš„å˜ç§ã€‚</p>

<p>å›è¿‡å»è§‚å¯Ÿç›¸å‡çš„è¿‡ç¨‹ï¼Œå¦‚æœ $a=qb+r, (q \geqslant 0,\ r &lt; b)$ ,  æ¯æ¬¡ $a-b$ å°±æ˜¯ $q-1$ ï¼Œç›´åˆ° $q=0$ ï¼Œå› ä¸º $a=r&lt;b$ ç„¶åå°±äº¤æ¢ $a,b$ ä½ç½®ï¼Œå¯ä»¥é€šè¿‡å–ä½™çš„æ“ä½œä¸€æ­¥åˆ°ä½çš„å®Œæˆï¼Œ$a \% b$ ç›´æ¥å¾—åˆ° $r$ , ç„¶åå’Œ $b$ ï¼Œå³ä½¿å¼€å§‹æ—¶ $a &lt; b$ , ä¹Ÿä¸å½±å“ $a\%b$ çš„ç»“æœã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>
</code></pre></div></div>

<p>ä»å®è·µä¸Šçœ‹ï¼Œä¸è€ƒè™‘ç‰¹æ®ŠæŒ‡ä»¤ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•çš„æ•ˆç‡æ˜¯æœ€ä½³çš„ã€‚</p>

<h2 id="æ‹“å±•-gcd">æ‹“å±• GCD</h2>

<p>æ‹“å±• gcd æ˜¯åœ¨æ±‚è§£æœ€å¤§å…¬çº¦æ•°çš„åŒæ—¶æ±‚è§£å‡ºä¸€ç»„è§£ $(x,y)$ ä½¿å¾— $ax+by = \text{gcd}(a,b)$ <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>

<h3 id="é€’å½’">é€’å½’</h3>

<p>é€šè¿‡é€’å½’çš„æ–¹å¼(è¾—è½¬å–ä½™)æ±‚è§£æ˜¯æœ€å®¹æ˜“ç†è§£çš„å®ç°ï¼š</p>

\[\begin{array}{l}
g &amp;= a_0x_0 + b_0y_0 \\
  &amp;= a_1x_1+b_1y_1   \\
  &amp;= b_0x_1 + (a_0-\lfloor \frac{a_0}{b_0} \rfloor b_0) y_1\\
  &amp;= a_0y_1 + b_0(x_1 - \lfloor \frac{a_0}{b_0} \rfloor y1)
\end{array}\]

<p>æŒ‰ç…§å¯¹åº”é¡¹ç³»æ•°ç›¸ç­‰çš„æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ç»„è§£ï¼š</p>

\[\begin{array}{l}
x_0 &amp;= y_1 \\
y_0 &amp;= x_1-\lfloor \frac{a_0}{b_0} \rfloor b_0y_1\\
    &amp;= x_1-\lfloor \frac{a_0}{b_0} \rfloor b_0x_0
\end{array}\]

<p>æœ€åæ¨åˆ° $a_n=b, b_n=0$ æ—¶ï¼Œ$g = b = 0x + 1b$ , ä¹Ÿå°±æ˜¯å– $x_n = 0, y_n=1$ ï¼Œ</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ext_gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ext_gcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="å±•å¼€">å±•å¼€</h2>

<p>å±•å¼€ç‰ˆæœ¬æ¥æºäº <a href="https://cp-algorithms.com/algebra/extended-euclid-algorithm.html#algorithm">cp-algorithms</a> ï¼Œä½ è¯´æˆ‘å®Œå…¨ç†è§£ï¼Œæˆ‘è¯´æˆ‘å®Œå…¨ä¸ç†è§£ï¼</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ext_gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>  
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    
    <span class="k">while</span> <span class="n">b1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">/</span> <span class="n">b1</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">x1</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span><span class="n">q</span> <span class="o">*</span> <span class="n">y1</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span><span class="p">,</span> <span class="n">a1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">b1</span>
    
    <span class="k">return</span> <span class="n">a1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div></div>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>ä½†æ˜¯åé¢å¯ä»¥å‘ç°ï¼Œå®é™…ä¸Šåº”è¯¥æœ‰ $\text{gcd}(a-b, b)=\text{gcd}(a,b)$ ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è¯æ˜å®ƒÂ <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>æ˜¾ç„¶å¯¹äºéé›¶çš„$a,b$ï¼Œ$x, y$ åº”è¯¥æ˜¯ä¸€æ­£ä¸€è´Ÿä¸¤ä¸ªæ•´æ•°Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[å‡è®¾å¯¹äºéè´Ÿæ•´æ•°ï¼Œ$a$ , $b$ ï¼Œæ±‚å®ƒä»¬çš„æœ€å¤§å…¬çº¦æ•° $\text{gcd}(a, b)$ ï¼Œä»¥ä¸‹ç®€å†™ä½œ $g$ ã€‚]]></summary></entry><entry><title type="html">0685 - Redundant Connection II</title><link href="/algs/LeetCode0685.html" rel="alternate" type="text/html" title="0685 - Redundant Connection II" /><published>2023-03-31T00:00:00+08:00</published><updated>2023-03-31T00:00:00+08:00</updated><id>/algs/LeetCode0685</id><content type="html" xml:base="/algs/LeetCode0685.html"><![CDATA[<h2 id="é¢˜å¹²">é¢˜å¹²</h2>

<p><a href="https://leetcode.com/problems/redundant-connection-ii/description/">é—®é¢˜æè¿°</a></p>

<h2 id="ç ´é¢˜">ç ´é¢˜</h2>

<p>è¿™é¢˜è¯´éš¾ä¸éš¾ï¼Œæ²¡æœ‰å¤æ‚çš„æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œä½†æ˜¯æƒ…å†µæ¯”è¾ƒç¹çç»†è‡´ï¼Œå¯ä»¥è¯´éå¸¸è´´è¿‘å®é™…æƒ…å†µäº†ã€‚</p>

<p>å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªé¢˜çš„ç ´é¢˜çš„å…³é”®åœ¨äºææ¸…æ¥šä¸€æ£µæœ‰å‘æ ‘ï¼Œå¤šäº†ä¸€æ¡è¾¹åï¼Œä¼šå½¢æˆä»€ä¹ˆæ ·çš„æƒ…å†µã€‚è¿™ä¸æ˜¯ä¸€æ¬¡å°±èƒ½å…¨æƒ³æ¸…æ¥šçš„ ï¼Œåœ¨ä»£ç å¤±è´¥äº†å‡ æ¬¡åï¼Œæˆ‘ä»¬æ€»ç»“å‡ºä¸‰ç§æƒ…å†µï¼š</p>

<ol>
  <li>å½¢æˆåŒå¤´èŠ‚ç‚¹ï¼ˆa-&gt;b, c-&gt;b, bå°±æ˜¯åŒå¤´èŠ‚ç‚¹ï¼‰</li>
  <li>å½¢æˆå¾ªç¯ï¼ˆa-&gt;b, b-&gt;c, c-&gt;aï¼‰</li>
  <li>å½¢æˆå¸¦åŒå¤´èŠ‚ç‚¹çš„ç¯ï¼ˆa-&gt;b, b-&gt;c, c-&gt;a, d-&gt;bï¼‰</li>
</ol>

<p>åŒå¤´èŠ‚ç‚¹å®¹æ˜“æ£€æµ‹å‡ºæ¥ï¼Œå¾ªç¯ä¹Ÿå¯ä»¥æ£€æµ‹å‡ºæ¥ï¼Œä½†æ˜¯å¦‚ä½•é€‰æ‹©åˆ é™¤çš„è¾¹å€¼å¾—è€ƒè™‘ï¼šå‰ä¸¤ç§æƒ…å†µéƒ½æ˜¯åˆ é™¤æœ€åçš„è¾¹å³å¯ï¼Œä½†ç¬¬ä¸‰ç§æƒ…å†µå¿…é¡»åˆ é™¤åŒå¤´èŠ‚ç‚¹åœ¨ç¯ä¸Šçš„è¾¹ï¼Œè€Œä¸ç®¡å®ƒçš„é¡ºåºï¼Œè¿™æ ·æ‰èƒ½åŒæ—¶æ¶ˆé™¤ç¯å’ŒåŒå¤´èŠ‚ç‚¹ã€‚è¿™æ˜¯æœ¬é¢˜ç¹ççš„åœ°æ–¹ã€‚</p>

<h2 id="è§£1-ä¸€èˆ¬å›¾">è§£1ï¼š ä¸€èˆ¬å›¾</h2>

<h3 id="æ€è·¯">æ€è·¯</h3>

<p>æŒ‰ç…§ä¸€èˆ¬å›¾çš„åšæ³•ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå…ˆæ ¹æ®è¾“å…¥å»ºç«‹é‚»æ¥è¡¨ï¼Œä»¥åŠåå‘å¼•ç”¨çš„è¡¨ã€‚</p>

<p>è¿™æ ·çš„è¯ï¼Œé¦–å…ˆåœ¨åå‘å¼•ç”¨è¡¨å»ºç«‹çš„è¿‡ç¨‹ï¼Œå°±èƒ½æ£€å‡ºåŒå¤´èŠ‚ç‚¹ï¼Œå¦‚æœå®ƒå­˜åœ¨çš„è¯ï¼›</p>

<p>ç„¶åå¯ä»¥æ ¹æ®å‡ºåº¦ä¸å…¥åº¦ï¼Œåˆ¤æ–­åŒå¤´èŠ‚ç‚¹æ˜¯å¦æœ‰åœ¨ç¯ä¸Šçš„è¾¹ï¼Œåœ¨æ£€æµ‹å‡ºåº¦å…¥åº¦çš„æ—¶å€™è¦å•ç‹¬è€ƒè™‘ä¸¤ä¸ªç‚¹çš„ç¯çš„æƒ…å†µï¼›</p>

<p>æœ€åæ£€å‡ºç¯ä¸Šè¾¹ï¼Œè¿”å›æœ€åä¸€æ¡ã€‚</p>

<h3 id="python-å®ç°">Python å®ç°</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="c1"># O(n)
</span><span class="k">def</span> <span class="nf">findRedundantDirectedConnection</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">vmap</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># vertice map
</span>    <span class="n">rvmap</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># recersed vertice map
</span>
    <span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
    <span class="k">class</span> <span class="nc">Mode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">Ein1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Ein2</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">.</span><span class="n">Ein1</span>
    <span class="n">start</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">end</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># O(E)
</span>    <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">vmap</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

        <span class="k">if</span> <span class="n">rvmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">.</span><span class="n">Ein2</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rvmap</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">Mode</span><span class="p">.</span><span class="n">Ein2</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">outd</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">def</span> <span class="nf">ind</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">rvmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="n">start2</span> <span class="o">=</span> <span class="n">rvmap</span><span class="p">[</span><span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">vmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">start2</span> <span class="ow">in</span> <span class="n">vmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">start2</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ind</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outd</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">start2</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ind</span><span class="p">(</span><span class="n">start2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outd</span><span class="p">(</span><span class="n">start2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

        <span class="c1"># then anyway, use the latter (no cycle)
</span>        <span class="k">return</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

    <span class="c1"># Exact one circle structure
</span>    <span class="n">cirset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_circle_v</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">visset</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">cirset</span>

        <span class="n">visset</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Noncircle
</span>            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">visset</span><span class="p">:</span>
                    <span class="n">cirset</span> <span class="o">=</span> <span class="n">visset</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_circle_v</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">visset</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">True</span>

            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vmap</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_circle_v</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
            <span class="k">break</span>

    <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">cirset</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cirset</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">]]),</span>
        <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]]),</span>
        <span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]]),</span>
        <span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">output</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">findRedundantDirectedConnection</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">raise</span> <span class="sa">f</span><span class="s">'expect </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s"> found </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s">'</span>

    <span class="n">findRedundantDirectedConnection</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
</code></pre></div></div>

<h2 id="è§£2-å¹¶æŸ¥é›†åå¼•ç”¨è¡¨">è§£2ï¼š å¹¶æŸ¥é›†<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>+åå¼•ç”¨è¡¨</h2>

<h3 id="æ€è·¯-1">æ€è·¯</h3>

<p>ä½¿ç”¨å¹¶æŸ¥é›†è¾…åŠ©æ˜¯ä¸€ä¸ªæ›´æ™®éçš„ï¼Œæ›´è§„æ•´åŒ–çš„æ€è·¯ï¼Œä½†å¯¹äºæœ‰å‘æ ‘æ¥è¯´ï¼Œå•é å¹¶æŸ¥é›†ä¹Ÿä¸èƒ½ç›´æ¥æ‰¾åˆ°ç¯ï¼Œè€Œå¹¶æŸ¥é›†çš„è·¯å¾„å‹ç¼©ä¹Ÿä¼šå¹²æ‰°å¯¹åŒå¤´èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå•ç‹¬çš„åå‘å¼•ç”¨çš„è¡¨æ¥ç»´æŠ¤ç›´æ¥çˆ¶èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå·§å¦™çš„æ„æ€ï¼Œå¯ä»¥ One Pass åœ°æ±‚å‡ºéœ€è¦çš„åŒå¤´èŠ‚ç‚¹å’Œç¯çš„ä¿¡æ¯ï¼š</p>

<ol>
  <li>
    <p>åªéœ€è¦å½“å‘ç°åŒå¤´èŠ‚ç‚¹çš„æ—¶å€™ï¼Œè·³è¿‡å»ï¼Œä¸è¿›è¡Œ Union ï¼Œç›¸å½“äºåˆ é™¤åŒå¤´èŠ‚ç‚¹<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>çš„ä¸¤æ¡è¾¹é‡Œé¡ºåºé åçš„é‚£ä¸€æ¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¦‚æœä»ç„¶å‘ç°æœ‰ä¸€æ¡è¾¹çš„ä¸¤ä¸ªç‚¹åœ¨å¹¶æŸ¥é›†é‡Œæœ‰ä¸€æ ·çš„æ ¹ï¼Œé‚£ä¹ˆè¿™æ¡è¾¹å°±æ˜¯ç¯ä¸Šçš„ä¸€æ¡è¾¹ï¼Œè€Œä¸”æ˜¯ç¯ä¸Šé¡ºåºæœ€åçš„ä¸€æ¡è¾¹<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>ï¼›</p>
  </li>
  <li>
    <p>è¿™æ ·å½“æˆ‘ä»¬é€šè¿‡åå¼•ç”¨è¡¨æ‰¾åˆ°äº†åŒå¤´èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡åå¼•ç”¨è¡¨ä¸å¹¶æŸ¥é›†çš„é…åˆæ‰¾åˆ°äº†ç¯ä¸Šæœ€åçš„è¾¹çš„æ—¶å€™ï¼Œç”šè‡³å¯ä»¥æå‰é€€å‡ºå¾ªç¯ï¼Œéƒ½ä¸éœ€è¦è¯»å®Œå…¨éƒ¨çš„è¾¹</p>
  </li>
</ol>

<p>æ ¹æ®åŒå¤´èŠ‚ç‚¹å’Œç¯çš„ä¿¡æ¯æœ€åè¾“å‡ºï¼š</p>

<ol>
  <li>æ²¡å‘ç°åŒå¤´èŠ‚ç‚¹ã€‚é‚£å¿…ç„¶åªæœ‰ç¯ï¼Œç›´æ¥è¾“å‡ºç¯ä¸Šæœ€åä¸€æ¡è¾¹å³å¯ï¼›</li>
  <li>æ²¡å‘ç°ç¯ã€‚å¯èƒ½æœ‰ä¸¤ç§ï¼Œéƒ½æ˜¯è¾“å‡ºæˆ‘ä»¬ä¿å­˜çš„åŒå¤´èŠ‚ç‚¹é¡ºåºé åçš„è¾¹å³å¯ï¼š
    <ol>
      <li>æœ‰ä¸€ä¸ªç¯ï¼Œä½†æ˜¯ä¹Ÿæ˜¯åŒå¤´èŠ‚ç‚¹é¡ºåºé åçš„ä¸€æ¡è¾¹ï¼Œå› ä¸ºè·³è¿‡ï¼Œæ‰€ä»¥æ²¡å‘ç°</li>
      <li>æ ¹æœ¬æ²¡æœ‰ç¯</li>
    </ol>
  </li>
  <li>æœ‰åŒå¤´èŠ‚ç‚¹ä½†ä¹Ÿå‘ç°äº†ç¯ã€‚è¿™è¯´æ˜åŒå¤´èŠ‚ç‚¹é¡ºåºé åçš„è¾¹ä¸åœ¨ç¯ä¸Šï¼Œå› æ­¤æˆ‘ä»¬ä»åå¼•ç”¨è¡¨é‡Œå°±å¯ä»¥å¾—åˆ°åŒå¤´èŠ‚ç‚¹åœ¨ç¯ä¸Šçš„è¾¹ã€‚</li>
</ol>

<h3 id="rust-å®ç°">Rust å®ç°</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/// improved edition after read other solutions</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">resolve_better</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Aux</span> <span class="p">{</span>
        <span class="n">ds</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">p</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span>
    <span class="p">}</span>

    <span class="k">impl</span> <span class="n">Aux</span> <span class="p">{</span>
        <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
            <span class="k">Self</span> <span class="p">{</span>
                <span class="n">ds</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">cap</span><span class="p">],</span>
                <span class="n">p</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">cap</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">fn</span> <span class="nf">find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="k">self</span><span class="py">.ds</span><span class="p">[</span><span class="n">v</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">];</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="n">v</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.ds</span><span class="p">[</span><span class="n">v</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.find</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

                <span class="k">self</span><span class="py">.ds</span><span class="p">[</span><span class="n">v</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cd">/// Ignore rank/height compare to save space as we have compressed the path.</span>
        <span class="nd">#[inline(always)]</span>
        <span class="k">fn</span> <span class="k">union</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">u_root</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.find</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
            <span class="k">let</span> <span class="n">v_root</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.find</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">u_root</span> <span class="o">==</span> <span class="n">v_root</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Err</span><span class="p">(());</span>
            <span class="p">}</span>

            <span class="k">self</span><span class="py">.ds</span><span class="p">[</span><span class="n">v_root</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_root</span><span class="p">;</span>
            <span class="nf">Ok</span><span class="p">(())</span>
        <span class="p">}</span>

        <span class="nd">#[inline(always)]</span>
        <span class="k">fn</span> <span class="nf">direct_find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.p</span><span class="p">[</span><span class="n">v</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="nd">#[inline(always)]</span>
        <span class="k">fn</span> <span class="nf">direct_union</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.p</span><span class="p">[</span><span class="n">v</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">aux</span> <span class="o">=</span> <span class="nn">Aux</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">edges</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">double_head_cand</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">cycle_cand</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">e</span> <span class="k">in</span> <span class="n">edges</span><span class="nf">.iter</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">u</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="c1">// found double head</span>
        <span class="k">if</span> <span class="n">aux</span><span class="nf">.direct_find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">double_head_cand</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">aux</span><span class="nf">.direct_union</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

        <span class="c1">// found cycle (double head case has been excluded)</span>
        <span class="k">if</span> <span class="n">aux</span><span class="nf">.union</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="nf">.is_err</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">cycle_cand</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">double_head_cand</span><span class="nf">.is_some</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">cycle_cand</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span> <span class="k">break</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">double_head_cand</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">=</span> <span class="n">cycle_cand</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 1. the last double head edge cover the cycle edge.</span>
    <span class="c1">// 2. no cycle edge.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">cycle_cand</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">=</span> <span class="n">double_head_cand</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">((</span><span class="n">_u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">=</span> <span class="n">double_head_cand</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">aux</span><span class="nf">.direct_find</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">v</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">unreachable!</span><span class="p">()</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">sample</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span>
        <span class="p">(</span><span class="nd">vec!</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
        <span class="p">(</span><span class="nd">vec!</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="nd">vec!</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="nd">vec!</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">];</span>

    <span class="k">let</span> <span class="n">norm_sample</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">from_iter</span><span class="p">(</span><span class="n">sample</span>
    <span class="nf">.into_iter</span><span class="p">()</span>
    <span class="nf">.map</span><span class="p">(|(</span><span class="n">input</span><span class="p">,</span> <span class="n">expect</span><span class="p">)|</span>
        <span class="p">(</span>
            <span class="n">input</span>
            <span class="nf">.into_iter</span><span class="p">()</span>
            <span class="nf">.map</span><span class="p">(|</span><span class="n">arr</span><span class="p">|</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">from_iter</span><span class="p">(</span><span class="n">arr</span><span class="nf">.into_iter</span><span class="p">()))</span>
            <span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;&gt;&gt;</span><span class="p">(),</span>

            <span class="nn">Vec</span><span class="p">::</span><span class="nf">from_iter</span><span class="p">(</span>
                <span class="n">expect</span>
                <span class="nf">.into_iter</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">expect</span><span class="p">)</span> <span class="k">in</span> <span class="n">norm_sample</span> <span class="p">{</span>
        <span class="nd">assert_eq!</span><span class="p">(</span><span class="nf">resolve_better</span><span class="p">(</span><span class="n">edges</span><span class="nf">.clone</span><span class="p">()),</span> <span class="n">expect</span><span class="p">,);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œå¯¹å¹¶æŸ¥é›†çš„ç»´æŠ¤æ²¡æœ‰æ ¹æ®æ ‘çš„å¤§å°æˆ–è€…æ ‘é«˜æ¥é€‰æ‹©åˆå¹¶çš„é¡ºåºï¼Œè¿™ä¸»è¦æ˜¯è€ƒè™‘åˆ°è·¯å¾„å‹ç¼©å·²ç»è¶³å¤Ÿä¼˜åŒ–ï¼ŒæŒ‰ç…§ç»éªŒï¼Œå†ç»´æŠ¤å¹¶æŸ¥é›†æ ‘çš„å¹³è¡¡æœªå¿…æœ‰æ˜æ˜¾çš„å¥½å¤„ï¼Œç›¸æ¯”èŠ±è´¹é¢å¤–çš„ $O(\text{n})$ çš„ç©ºé—´<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> ï¼Œå¹¶ä¸å€¼å½“ã€‚</p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>æœ‰å¾ˆå¤šåˆ«åï¼šUnionFind, MergeFind, Disjoint Set, Disjoint Set Union â€¦Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>å¦‚æœæœ‰åŒå¤´èŠ‚ç‚¹çš„è¯Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>æ’é™¤äº†åŒå¤´èŠ‚ç‚¹çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ç¯ä¸Šæœ€åä¸€æ¡è¾¹ä¸€å®šæ˜¯ç¬¦åˆæœ‰å‘ç¯çš„é¡ºåºçš„Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>ç›¸å½“äºåŸæ¥ä¸€åŠçš„ç©ºé—´èŠ±è´¹Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[é¢˜å¹²]]></summary></entry><entry><title type="html">åŠ é€Ÿ Rust æ„å»º</title><link href="/lang/SpeedupRustBuilding.html" rel="alternate" type="text/html" title="åŠ é€Ÿ Rust æ„å»º" /><published>2023-03-22T00:00:00+08:00</published><updated>2023-03-22T00:00:00+08:00</updated><id>/lang/SpeedupRustBuilding</id><content type="html" xml:base="/lang/SpeedupRustBuilding.html"><![CDATA[<p>é˜…è¯»äº† https://fasterthanli.me/articles/why-is-my-rust-build-so-slow</p>

<p>æ€»ç»“äº†åŠ é€Ÿçš„æ³¨æ„äº‹é¡¹ï¼š</p>

<ol>
  <li>æ‹†åˆ†è¿‡å¤§çš„ crate ï¼Œä¸€ä¸ªåŸºæœ¬ç¼–è¯‘å•å…ƒè‡³å°‘æ˜¯ä¸€ä¸ª crateï¼Œæ‹†åˆ† crate å¯ä»¥åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿</li>
  <li>æ£€æŸ¥ä¸å¿…è¦çš„ä¾èµ–ï¼ŒæŸäº›ä¾èµ–å¯èƒ½ä¼šå¤§å¹…æ‹–æ…¢ç¼–è¯‘æ—¶é—´</li>
  <li>é¿å…ä¸å¿…è¦çš„å¤šæ€ï¼Œç¼©å‡ç¼–è¯‘æ—¶é—´</li>
  <li>ä¸º release ä¹Ÿå¼€å¯å¢é‡ç¼–è¯‘ <code class="language-plaintext highlighter-rouge">incremental = true</code> ï¼Œè¿™ä¼šè®©cold build æ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯å¤§å¹…åŠ é€Ÿ hot buildï¼Œ</li>
  <li>æ˜¯å¯¹äºè¢«å·¥å…·å‹ç¼©çš„ crateï¼Œdebug ç­–ç•¥ä¼šéå¸¸æ…¢ï¼Œéœ€è¦å¯¹è¿™äº›åŒ…<a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides">å•ç‹¬è®¾ç½® debug ç­–ç•¥</a></li>
</ol>

<p>â€‹</p>]]></content><author><name></name></author><category term="[&quot;lang&quot;]" /><summary type="html"><![CDATA[é˜…è¯»äº† https://fasterthanli.me/articles/why-is-my-rust-build-so-slow]]></summary></entry><entry><title type="html">åŸºäºå‰ç¼€æ ‘çš„æŒä¹…åŒ–å‘é‡ï¼ˆTrieVecï¼‰</title><link href="/algs/TrieVec.html" rel="alternate" type="text/html" title="åŸºäºå‰ç¼€æ ‘çš„æŒä¹…åŒ–å‘é‡ï¼ˆTrieVecï¼‰" /><published>2023-03-17T00:00:00+08:00</published><updated>2023-03-17T00:00:00+08:00</updated><id>/algs/TrieVec</id><content type="html" xml:base="/algs/TrieVec.html"><![CDATA[<p>åœ¨å‰é¢ä»‹ç»äº†ä» Fibonacci å †ã€Dary å †ï¼Œåˆ°å›¾ä¸Šçš„è¯¸å¤šç®—æ³•ï¼Œä» BST åˆ° BT çš„ä¸€ç³»åˆ—æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œå¹¶æä¾›äº†å®ƒä»¬çš„ Rust å®ç°ï¼Œå¦‚æœæŠŠè¿™äº›ä»£ç éƒ½é›†æˆèµ·æ¥ï¼Œå¯èƒ½å°±ä¼šå‘ç°è¿™ä¸ªç¼–è¯‘çš„è¿‡ç¨‹æ€ä¹ˆè¿™ä¹ˆç†¬äººï¼Œä¼¼ä¹è¶Šæ¥è¶Šè®©äººéš¾ä»¥å¿å—ï¼Œè¿™æ—¶å¯ä»¥å‚è€ƒä¸€ä¸‹<a href="./SpeedupRustBuilding">å¦ç¯‡å…³äºé™ä½æ„å»ºæ—¶é—´çš„ç¬”è®°</a>ã€‚</p>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>æœ¬ç¯‡ä½œä¸ºä¸€ä¸ªé˜¶æ®µæ€§çš„æ€»ç»“ç¯‡ï¼Œä»‹ç»ä¸€ä¸ªåŸºäºå‰ç¼€æ ‘ï¼ˆTrieï¼‰çš„æŒä¹…åŒ–å‘é‡ï¼ˆVectorï¼‰çš„å®ç°<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> ï¼Œä»¥ä¸‹ç”¨ TrieVec ç®€ç§°ã€‚</p>

<p>ä¸€æ–¹é¢ï¼ŒVector ä½œä¸ºå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€é‡Œçš„å…è®¸éšæœºè¯»å†™çš„æ•°æ®ç»“æ„ï¼Œæœ¬èº«æœ‰å¾ˆé‡è¦çš„æ„ä¹‰ï¼Œæ²¡æœ‰å®ƒï¼Œä¼ ç»Ÿçš„ç”¨ç±» C æè¿°çš„ç®—æ³•å°±æ— æ³•è½åœ°ï¼›</p>

<p>å¦ä¸€æ–¹é¢ï¼Œè®²åˆ°æŒä¹…åŒ–æ•°æ®ç»“æ„ï¼Œå…¶å®å¤§éƒ¨åˆ†éƒ½å·²æ¶‰åŠï¼Œåªæœ‰æŒä¹…åŒ–å‘é‡æ¯”è¾ƒé™Œç”Ÿå¹¶ä¸”æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¿…è¦ä¸“é—¨çœ‹ä¸€ä¸‹ï¼›</p>

<p>æœ€åï¼Œåœ¨çœ‹è¿™ä¸ªå®ç°çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç°è¿™æ˜¯ä¸€ä¸ªæ€»ä½“æ¦‚å¿µé™Œç”Ÿä½†å±€éƒ¨ç»†èŠ‚ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥ä¸²èµ·ä¹‹å‰ä»‹ç»è¿‡çš„è¯¸å¤šæ•°æ®ç»“æ„ï¼Œä¸ç®¡æ˜¯ç»“æ„ç‰¹ç‚¹ã€è®¾è®¡æ–¹æ¡ˆè¿˜æ˜¯å®ç°æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªåˆé€‚çš„é˜¶æ®µå°¾å£°ã€‚</p>

<h2 id="æ¦‚å¿µåŸºç¡€">æ¦‚å¿µåŸºç¡€</h2>

<p>TrieVec æœ¬è´¨ä¸Šå°±åƒæˆ‘ä»¬åœ¨<a href="/algs/DaryHeap.html">å¤šå‰å †</a>ä¸Šé‚£æ ·çš„åšæ³•ï¼Œåªä¸è¿‡å¤šå‰å †å»ºç«‹åœ¨æ•°ç»„ä¸Šï¼Œè€Œ TrieVec åˆ™ä»¥æ ‘çš„çš„å½¢å¼ç»„ç»‡ã€‚</p>

<p>æ¯”å¦‚å¯¹äºä¸€æ£µèŠ‚ç‚¹æ•°å®½åº¦ä¸º $2$ ï¼Œä¹Ÿå°±æ˜¯ $2^2 = 4$ é˜¶çš„æ ‘ï¼Œè®¿é—® idx = 54</p>

\[\begin{array}{l}
54 &amp;=\underbrace{11}\ \underbrace{01}\ \underbrace{10}\\
&amp;=\ \ \ 3\quad\ \ \ 1\quad\quad 2
\end{array}\]

<p>æƒ…å†µå¦‚ä¸‹å›¾ï¼š</p>

<div class="sx-center">
<img src="/assets/img/trievec/trievec_exp.svg" width="65%" /></div>

<p>è¿™è¦æ±‚æ ‘çš„å®Œå…¨å¹³è¡¡ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå¶å­åˆ°æ ¹çš„é«˜åº¦éƒ½ä¸€æ ·ï¼Œç„¶åæŠŠæ•°æ®å­˜å‚¨åœ¨æ¯ä¸ªå¶å­ä¸Šï¼Œè¿™ä¸€ç‚¹åˆå’Œæˆ‘ä»¬åœ¨<a href="/algs/BT-1-BPT.html">B+ æ ‘</a>ä¸Šçš„æƒ…å†µç›¸ä¼¼ã€‚</p>

<p>è€Œå¯¹æ ‘å±‚çº§çš„å®šä¹‰åˆå’Œ <a href="./BST-2-RB-Tree-2-AA">AA æ ‘</a> æ˜¯ä¸€æ ·ï¼Œç”¨ level çš„æ¦‚å¿µæ¥æè¿°æ˜¯éå¸¸æ°å½“çš„ï¼Œå¶å­å±‚çš„ level æ˜¯ $1$ ï¼Œç©ºæ ‘çš„ level æ˜¯ $0$ ã€‚</p>

<p>å¯¹äºæŒä¹…åŒ–çš„è¦æ±‚æ¥è®²ï¼Œæ¯æ¬¡æ“ä½œï¼ŒPush/Pop/Update etc. åªéœ€è¦å¤åˆ¶ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­ä¸€æ¡è·¯å¾„çš„èŠ‚ç‚¹ï¼Œå¯¹æ•°çº§åˆ«çš„å¼€é”€æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„ä»£ä»·ã€‚</p>

<p>å¦å¤–ï¼Œå¯¹äºæŸäº›æ—¶é—´æ•æ„Ÿçš„ä»»åŠ¡ï¼ŒClojure è¿˜å…è®¸æŠŠæŒä¹…åŒ–çš„ç»“æ„è½¬å˜ä¸ºæ˜“å˜çš„ç»“æ„ï¼ˆTransientï¼‰æ¥åšå°±åœ°ä¿®æ”¹ï¼Œç„¶åå†è½¬å›æŒä¹…æ€§ç»“æ„ï¼Œä»¥é¿å…å¤åˆ¶å¼€é”€ã€‚è¿™æ ·çš„è¯éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåšå‡ºæ ‡è¯†æ¥è¿½è¸ªèŠ‚ç‚¹çš„åˆ›å»ºè€…ï¼Œåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„<a href="#æ ‡è®°">æ ‡è®°</a>ä¸€èŠ‚å…·ä½“è®¨è®ºã€‚</p>

<p>ä¸æ˜“å˜å‘é‡çš„èŠ‚ç‚¹ï¼Œä»¥åŠåŒºåˆ†å†å²ä¸Šç”±ä¸åŒçº¿ç¨‹åˆ›å»ºçš„èŠ‚ç‚¹ã€‚</p>

<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>

<h3 id="æ ‘">æ ‘</h3>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªä¼˜åŒ–çš„å°æ”¹åŠ¨<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">2</a></sup>ï¼Œå°±æ˜¯æŠŠ TrieVec æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆBucketï¼‰ä» Trie ä¸­å•ç‹¬æ‹¿å‡ºæ¥ï¼Œä½œä¸ºå°¾èŠ‚ç‚¹ï¼Œè¿™ä¼šä½¿å¾— Clojure é‡Œåƒ <code class="language-plaintext highlighter-rouge">conj</code> è¿™æ ·ç­‰ä»·äº push çš„æ“ä½œåœ¨å¸¸é‡æ—¶é—´é‡Œå®Œæˆã€‚æˆ‘ä»¬è®¡ç®— TrieVec çš„ç»“æ„æ—¶å€™éœ€è¦æŠŠå°¾éƒ¨èŠ‚ç‚¹çš„é•¿åº¦æ‰£é™¤ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Clone)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">cnt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">tail</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">pub</span> <span class="k">struct</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">cnt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">tail</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å¸¸é‡å®šä¹‰">å¸¸é‡å®šä¹‰</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">BIT_WIDTH</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">const</span> <span class="n">NODE_SIZE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIT_WIDTH</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">;</span>
<span class="k">const</span> <span class="n">MASK</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="n">NODE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="ä»-trie-size-åæ¨-trie-height">ä» Trie size åæ¨ Trie height</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">h</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$self:ident</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nf">trie_height</span><span class="p">(</span><span class="nd">tailoff!</span><span class="p">(</span><span class="nv">$self</span><span class="p">))</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">fn</span> <span class="nf">trie_height</span><span class="p">(</span><span class="n">trie_size</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">trie_size</span> <span class="p">{</span>
        <span class="mi">0</span> <span class="k">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">1</span> <span class="k">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">x</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.ilog2</span><span class="p">()</span> <span class="o">/</span> <span class="n">BIT_WIDTH</span><span class="p">;</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">NODE_SIZE</span><span class="nf">.pow</span><span class="p">(</span><span class="n">h</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">h</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ ¹æ®æ€»ç´¢å¼•å’Œå½“å‰å±‚å¾—åˆ°ç´¢å¼•ä½ç½®">æ ¹æ®æ€»ç´¢å¼•å’Œå½“å‰å±‚å¾—åˆ°ç´¢å¼•ä½ç½®</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">idx</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$idx:expr</span><span class="p">,</span> <span class="nv">$lv:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Precedence: '*' &gt; '&gt;&gt;' &gt; '&amp;'</span>
        <span class="nv">$idx</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nv">$lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">BIT_WIDTH</span> <span class="o">&amp;</span> <span class="n">MASK</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å°¾éƒ¨åç§»é‡">å°¾éƒ¨åç§»é‡</h4>

<p>ä¹Ÿå°±æ˜¯å°¾èŠ‚ç‚¹ä¹‹å‰çš„å…ƒç´ æ•°ï¼Œä¹Ÿå°±æ˜¯å®é™… Trie çš„å¤§å°</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">tailoff</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$self:ident</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nv">$self</span><span class="py">.cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="mi">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">((</span><span class="nv">$self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BIT_WIDTH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">BIT_WIDTH</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ ‡å¿—">æ ‡å¿—</h3>

<p>ç”±äºå­˜åœ¨æŒä¹…ä¸æ˜“å˜ç‰ˆæœ¬é—´çš„è½¬æ¢ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ˜¯æŒä¹…ç‰ˆæœ¬çš„èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯å†å²ä¸Šä¸åŒçº¿ç¨‹åˆ›å»ºçš„æ˜“å˜èŠ‚ç‚¹ã€‚</p>

<p>è¿™é‡Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">u64</code> <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup>è¡¨ç¤ºçš„ Thread id ä½œä¸ºæ ‡å¿—ï¼Œè¡¨ç¤ºå†å²ä¸Šåˆ›å»ºæ˜“å˜èŠ‚ç‚¹çš„çº¿ç¨‹ï¼ŒThread id éƒ½å¤§äº 0 ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ 0 æ¥è¡¨ç¤ºæŒä¹…ç‰ˆæœ¬çš„èŠ‚ç‚¹ã€‚</p>

<p>è¿™æ ·å¯¹äºå¯ç¼–è¾‘èŠ‚ç‚¹éœ€è¦æ»¡è¶³ï¼š</p>

<ol>
  <li>ä¸æ˜¯æŒä¹…åŒ–èŠ‚ç‚¹</li>
  <li>ä¸æ˜¯å†å²ä¸Šå…¶ä»–çº¿ç¨‹åˆ›å»ºçš„èŠ‚ç‚¹</li>
</ol>

<p>ä¸æ»¡è¶³æ¡ä»¶å°±éœ€è¦å¤åˆ¶èŠ‚ç‚¹ï¼Œåˆ›é€ å±äºå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">edit</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nn">std</span><span class="p">::</span><span class="nn">thread</span><span class="p">::</span><span class="nf">current</span><span class="p">()</span><span class="nf">.id</span><span class="p">()</span><span class="nf">.as_u64</span><span class="p">()</span><span class="nf">.get</span><span class="p">()</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nd">macro_rules!</span> <span class="n">no_edit</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="mi">0</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">type</span> <span class="n">ID</span> <span class="o">=</span> <span class="nb">u64</span><span class="p">;</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ID</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="mi">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nd">id!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å†…éƒ¨èŠ‚ç‚¹">å†…éƒ¨èŠ‚ç‚¹</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">Node_</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">Internal</span> <span class="p">{</span> <span class="n">id</span><span class="p">:</span> <span class="n">ID</span><span class="p">,</span> <span class="n">children</span><span class="p">:</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="p">},</span>
    <span class="n">Leaf</span> <span class="p">{</span> <span class="n">id</span><span class="p">:</span> <span class="n">ID</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">},</span>
<span class="p">}</span>
<span class="k">use</span> <span class="nn">Node_</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Node_</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="nd">matches!</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">Leaf</span> <span class="p">{</span> <span class="o">..</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="nd">def_node__heap_access!</span><span class="p">(</span><span class="n">both</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ID</span><span class="p">);</span>
    <span class="nd">def_node__heap_access!</span><span class="p">(</span><span class="n">internal</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">);</span>
    <span class="nd">def_node__heap_access!</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">Array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Array</code> ä½¿ç”¨çš„æ˜¯å‰é¢ <code class="language-plaintext highlighter-rouge">DaryHeap</code> ä½¿ç”¨è¿‡çš„åˆ†é…åœ¨å †ä¸Šçš„é™æ€æ•°ç»„ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">def_node__heap_access</code> å®ä½¿ç”¨çš„ä¹‹å‰ B+ æ ‘é‡Œé¢ä½¿ç”¨è¿‡çš„å®</li>
</ol>

<h3 id="èŠ‚ç‚¹åŒ…è£…">èŠ‚ç‚¹åŒ…è£…</h3>

<p>è€ƒè™‘åˆ°æŒä¹…åŒ–æ•°æ®ç»“æ„çš„è·¨çº¿ç¨‹ä½¿ç”¨çš„æƒ…å†µï¼ŒèŠ‚ç‚¹åŒ…è£…é‡Œé¢çš„å¼•ç”¨è®¡æ•°å™¨å°†ä¸å†é‡‡ç”¨ä¹‹å‰çš„ <code class="language-plaintext highlighter-rouge">std::rc::Rc</code> ï¼Œè€Œæ”¹ç”¨åŒæ­¥ç‰ˆæœ¬çš„ <code class="language-plaintext highlighter-rouge">std::sync::Arc</code> <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">4</a></sup> ã€‚</p>

<p>ä½†å³ä½¿å¦‚æ­¤ï¼Œç”±äº Rust çš„ä¸¥æ ¼é™åˆ¶ï¼Œæˆ‘ä»¬ä»ç„¶ä¸èƒ½æŠŠ <code class="language-plaintext highlighter-rouge">Node</code> è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œå³ä½¿æˆ‘ä»¬ç¡®ä¿¡ä½œä¸ºæŒä¹…åŒ–çš„ç»“æ„æ—¶ï¼Œæ˜¯å¯ä»¥è¿™æ ·å®‰å…¨ä½¿ç”¨çš„ã€‚åœ¨ <code class="language-plaintext highlighter-rouge">std::sync</code> çš„åŒ…é‡Œæœ‰å„ç§å„æ ·çš„åŒæ­¥æ‰‹æ®µï¼š</p>

<ol>
  <li>ä¸´ç•ŒåŒºï¼ˆExclusiveï¼‰</li>
  <li>æƒ°æ€§é”ï¼ˆLazyLockï¼‰</li>
  <li>å•å†™é”ï¼ˆOnceLockï¼‰</li>
  <li>æ …æ ï¼ˆBarrierï¼‰</li>
  <li>æ¡ä»¶å˜é‡ï¼ˆCondVarï¼‰</li>
  <li>é”ï¼ˆMutexï¼‰</li>
  <li>å•æ¬¡é” ï¼ˆOnceï¼‰</li>
  <li>è¯»å†™é” ï¼ˆRwLockï¼‰</li>
</ol>

<p>çœ‹äº†è®©äººç›´å‘¼å¥½å®¶ä¼™ï¼Œä¸Šä¸–çºªçš„é‚£ç‚¹å„¿å¤è‘£ç©æ„å„¿éƒ½è®©å®ƒç»™å¤æ´»äº†ğŸ˜…ï¼Œä½†æ˜¯è¿™é‡Œé¢æ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„ï¼Œæˆ‘ä»¬çš„æŒä¹…åŒ–ç»“æ„å®é™…é¿å…äº†åŒæ­¥çš„éœ€æ±‚ï¼Œä½†æ˜¯éœ€è¦æœ‰ä¸€ç§æœºåˆ¶è®©ç¼–è¯‘å™¨çŸ¥é“è¿™ä¸ªæƒ…å†µä»¥ä¾¿èƒ½é€šè¿‡ Trait æ£€æŸ¥ï¼Œè€Œæ˜¾ç„¶æ ‡å‡†åº“é‡Œæ²¡æœ‰æä¾›è¿™ç§æ‰‹æ®µã€‚</p>

<p>ä¸è¿‡æˆ‘ä»¬è‡ªå·±å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªæ–°çš„åŒ…è£…ç»“æ„ï¼Œä¸ºå®ƒå®ç° <code class="language-plaintext highlighter-rouge">Sync</code> å’Œ <code class="language-plaintext highlighter-rouge">Send</code> ä¸¤ä¸ª Trait æ¥å®ç°æŒä¹…åŒ–ç»“æ„éœ€è¦çš„ Trait è¯­ä¹‰ï¼Œ<a href="https://github.com/bamidev/unsafe-send-sync">å·²ç»æœ‰äººå¹²å¾—å¾ˆå¥½äº†</a>ï¼Œæˆ‘ä»¬åœ¨å®ƒçš„åŸºç¡€ä¸ŠæŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚æ”¹è¿›ï¼Œå¾—åˆ°ä¸€ä¸ªå‘ŠçŸ¥ç¼–è¯‘å™¨é€šè¿‡åŒæ­¥æ£€æŸ¥çš„åŒ…è£…ç»“æ„ï¼Œ<code class="language-plaintext highlighter-rouge">UnsafeSendSync</code></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Default,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>

<span class="cd">/// ä¸€ä¸ªè‡ªåŠ¨å®ç°Traitçš„å®ï¼Œç»†èŠ‚ä¸å±•å¼€äº†</span>
<span class="nd">impl_unpack!</span><span class="p">(</span><span class="n">UnsafeSendSync</span> <span class="p">|</span> <span class="nb">AsRef</span><span class="p">,</span> <span class="nb">AsMut</span><span class="p">,</span> <span class="n">Deref</span><span class="p">,</span> <span class="n">DerefMut</span><span class="p">,</span> <span class="nb">From</span><span class="p">);</span>

<span class="k">unsafe</span> <span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nb">Send</span> <span class="k">for</span> <span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="k">unsafe</span> <span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nb">Sync</span> <span class="k">for</span> <span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">unwrap</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="na">.0</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">const</span> <span class="n">T</span> <span class="p">{</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="na">.0</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">as_ref_mut_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="na">.0</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">_</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">_</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>äºæ˜¯æˆ‘ä»¬é‡æ–°ä¿®æ”¹äº†å‰é¢å®šä¹‰èŠ‚ç‚¹åŒ…è£…å™¨çš„ <code class="language-plaintext highlighter-rouge">impl_node</code> çš„å®ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">impl_node</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_node!</span><span class="p">(</span><span class="k">pub</span><span class="p">(</span><span class="k">self</span><span class="p">));</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$vis:vis</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_node!</span><span class="p">(</span><span class="nv">$vis</span> <span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$vis:vis</span> <span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g:ident</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_node!</span><span class="p">(</span>
            <span class="nv">$vis</span> <span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">,</span>
            <span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nb">Rc</span><span class="o">&lt;</span><span class="nn">std</span><span class="p">::</span><span class="nn">cell</span><span class="p">::</span><span class="n">RefCell</span><span class="o">&lt;</span><span class="n">Node_</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;&gt;&gt;</span><span class="p">,</span>
            <span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="n">Weak</span><span class="o">&lt;</span><span class="nn">std</span><span class="p">::</span><span class="nn">cell</span><span class="p">::</span><span class="n">RefCell</span><span class="o">&lt;</span><span class="n">Node_</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;&gt;&gt;</span>
        <span class="p">);</span>

        <span class="nd">#[allow(unused)]</span>
        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">as_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="n">Node_</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
                <span class="k">match</span> <span class="k">self</span><span class="na">.0</span> <span class="p">{</span>
                    <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="n">rc</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">rc</span><span class="nf">.as_ptr</span><span class="p">(),</span>
                    <span class="nb">None</span> <span class="k">=&gt;</span> <span class="nn">std</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">null_mut</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">#[allow(unused)]</span>
        <span class="nd">macro_rules!</span> <span class="n">aux_node</span> <span class="p">{</span>
            <span class="p">({</span> <span class="nv">$$</span><span class="p">(</span><span class="nv">$attr:ident</span> <span class="p">:</span> <span class="nv">$attr_val:expr</span><span class="p">),</span><span class="o">*</span> <span class="nv">$$</span><span class="p">(,)</span><span class="o">?</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Node</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nn">Rc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">cell</span><span class="p">::</span><span class="nn">RefCell</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">Node_</span> <span class="p">{</span>
                    <span class="nv">$$</span><span class="p">(</span>
                        <span class="nv">$attr</span><span class="p">:</span> <span class="nv">$attr_val</span>
                    <span class="p">),</span><span class="o">*</span>
                <span class="p">}))))</span>
            <span class="p">};</span>
            <span class="p">(</span><span class="n">ENUM</span> <span class="nv">$ty:ident</span> <span class="p">{</span> <span class="nv">$$</span><span class="p">(</span><span class="nv">$attr:ident</span> <span class="p">:</span> <span class="nv">$attr_val:expr</span><span class="p">),</span><span class="o">*</span> <span class="nv">$$</span><span class="p">(,)</span><span class="o">?</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Node</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nn">Rc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">cell</span><span class="p">::</span><span class="nn">RefCell</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Node_</span><span class="p">::</span><span class="nv">$ty</span> <span class="p">{</span>
                    <span class="nv">$$</span><span class="p">(</span>
                        <span class="nv">$attr</span><span class="p">:</span> <span class="nv">$attr_val</span>
                    <span class="p">),</span><span class="o">*</span>
                <span class="p">}))))</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="nd">#[allow(unused)]</span>
        <span class="nd">macro_rules!</span> <span class="n">unwrap_into</span> <span class="p">{</span>
            <span class="p">(</span><span class="nv">$node:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nn">Rc</span><span class="p">::</span><span class="nf">try_unwrap</span><span class="p">(</span><span class="nv">$node</span><span class="na">.0</span><span class="nf">.unwrap</span><span class="p">())</span>
                    <span class="nf">.unwrap</span><span class="p">()</span>
                    <span class="nf">.into_inner</span><span class="p">()</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$vis:vis</span> <span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g:ident</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">,</span> <span class="n">arc</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">impl_node!</span><span class="p">(</span>
            <span class="nv">$vis</span> <span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">,</span>
            <span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="nb">Arc</span><span class="o">&lt;</span><span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">Node_</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;&gt;&gt;</span><span class="p">,</span>
            <span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="n">Weak</span><span class="o">&lt;</span><span class="n">UnsafeSendSync</span><span class="o">&lt;</span><span class="n">Node_</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;&gt;&gt;</span>
        <span class="p">);</span>
        <span class="nd">macro_rules!</span> <span class="n">aux_node</span> <span class="p">{</span>
            <span class="p">({</span> <span class="nv">$$</span><span class="p">(</span><span class="nv">$attr:ident</span> <span class="p">:</span> <span class="nv">$attr_val:expr</span><span class="p">),</span><span class="o">*</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Node</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">UnsafeSendSync</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">Node_</span> <span class="p">{</span>
                    <span class="nv">$$</span><span class="p">(</span>
                        <span class="nv">$attr</span><span class="p">:</span> <span class="nv">$attr_val</span>
                    <span class="p">),</span><span class="o">*</span>
                <span class="p">}))))</span>
            <span class="p">};</span>
            <span class="p">(</span><span class="n">ENUM</span> <span class="nv">$ty:ident</span> <span class="p">{</span> <span class="nv">$$</span><span class="p">(</span><span class="nv">$attr:ident</span> <span class="p">:</span> <span class="nv">$attr_val:expr</span><span class="p">),</span><span class="o">*</span> <span class="p">})</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nf">Node</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">UnsafeSendSync</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Node_</span><span class="p">::</span><span class="nv">$ty</span> <span class="p">{</span>
                    <span class="nv">$$</span><span class="p">(</span>
                        <span class="nv">$attr</span><span class="p">:</span> <span class="nv">$attr_val</span>
                    <span class="p">),</span><span class="o">*</span>
                <span class="p">}))))</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="p">(</span><span class="nv">$vis:vis</span> <span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g:ident</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">,</span> <span class="nv">$rc:ty</span><span class="p">,</span> <span class="nv">$wk:ty</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nv">$vis</span> <span class="k">struct</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">(</span>
            <span class="nb">Option</span><span class="o">&lt;</span><span class="nv">$rc</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="cd">/// Used for reverse reference to avoid circular-reference</span>
        <span class="cd">///</span>
        <span class="cd">/// So we can easy auto drop</span>
        <span class="k">struct</span> <span class="n">WeakNode</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span><span class="p">(</span>
            <span class="nb">Option</span><span class="o">&lt;</span><span class="nv">$wk</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="nd">#[allow(unused)]</span>
        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">downgrade</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">WeakNode</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
                <span class="nf">WeakNode</span><span class="p">(</span>
                    <span class="k">self</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="k">ref</span> <span class="n">rc</span><span class="p">|</span> <span class="o">&lt;</span><span class="nv">$rc</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">downgrade</span><span class="p">(</span><span class="n">rc</span><span class="p">)),</span>
                <span class="p">)</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">none</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">is_some</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
                <span class="k">self</span><span class="na">.0</span><span class="nf">.is_some</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">is_none</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
                <span class="k">self</span><span class="na">.0</span><span class="nf">.is_none</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">rc_eq</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
                <span class="k">match</span> <span class="k">self</span><span class="na">.0</span> <span class="p">{</span>
                    <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="n">rc1</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="n">rc2</span><span class="p">)</span> <span class="o">=</span> <span class="n">other</span><span class="na">.0</span> <span class="p">{</span>
                            <span class="o">&lt;</span><span class="nv">$rc</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">ptr_eq</span><span class="p">(</span><span class="n">rc1</span><span class="p">,</span> <span class="n">rc2</span><span class="p">)</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kc">false</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nb">None</span> <span class="k">=&gt;</span> <span class="n">other</span><span class="nf">.is_none</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>


        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="nb">Default</span> <span class="k">for</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">default</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">::</span><span class="nf">none</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>


        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="nb">Clone</span> <span class="k">for</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">(</span><span class="k">self</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>


        <span class="nd">#[allow(unused)]</span>
        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="n">WeakNode</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">upgrade</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
                <span class="nf">Node</span><span class="p">(</span><span class="k">self</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="n">weak</span><span class="p">|</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">strong</span><span class="p">)</span> <span class="o">=</span> <span class="n">weak</span><span class="nf">.upgrade</span><span class="p">()</span> <span class="p">{</span>
                        <span class="n">strong</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nd">unreachable!</span><span class="p">(</span><span class="s">"weak node upgrade failed"</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}))</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">none</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">is_none</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
                <span class="k">self</span><span class="na">.0</span><span class="nf">.is_none</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">is_some</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
                <span class="k">self</span><span class="na">.0</span><span class="nf">.is_some</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">fn</span> <span class="nf">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">oth</span><span class="p">:</span> <span class="k">Self</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="na">.0</span> <span class="o">=</span> <span class="n">oth</span><span class="na">.0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>


        <span class="k">impl</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="nb">Clone</span> <span class="k">for</span> <span class="n">WeakNode</span><span class="o">&lt;</span><span class="nv">$</span><span class="p">(</span><span class="nv">$g</span><span class="p">),</span><span class="o">+&gt;</span> <span class="p">{</span>
            <span class="k">fn</span> <span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
                <span class="k">Self</span><span class="p">(</span><span class="k">self</span><span class="na">.0</span><span class="nf">.clone</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¹¶æ›´æ–°èŠ‚ç‚¹åŒ…è£…çš„è®¿é—®å®ï¼Œå¢åŠ æ–°çš„ç”¨ä¾‹ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">def_attr_macro</span> <span class="p">{</span>
	<span class="c1">// ...</span>
    <span class="p">(</span><span class="n">call_unsafe_sync</span> <span class="p">|</span> <span class="nv">$</span><span class="p">(</span><span class="nv">$name:ident</span><span class="p">),</span><span class="o">+</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nv">$</span><span class="p">(</span>
            <span class="nn">coll</span><span class="p">::</span><span class="nd">paste!</span><span class="p">(</span>
                <span class="nd">macro_rules!</span> <span class="nv">$name</span> <span class="p">{</span>
                    <span class="p">(</span><span class="nv">$node:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="nd">attr!</span><span class="p">(</span><span class="n">self_unsafe_sync</span> <span class="p">|</span> <span class="nv">$$node</span><span class="p">)</span>.<span class="nv">$name</span><span class="p">()</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">);</span>

            <span class="nn">coll</span><span class="p">::</span><span class="nd">paste!</span><span class="p">(</span>
                <span class="nd">#[allow(unused)]</span>
                <span class="nd">macro_rules!</span> <span class="p">[</span><span class="o">&lt;</span><span class="nv">$name</span> <span class="n">_mut</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">{</span>
                    <span class="p">(</span><span class="nv">$node:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                        <span class="nd">attr!</span><span class="p">(</span><span class="n">self_unsafe_sync_mut</span> <span class="p">|</span> <span class="nv">$$node</span><span class="p">)</span>.<span class="p">[</span><span class="o">&lt;</span><span class="nv">$name</span> <span class="n">_mut</span><span class="o">&gt;</span><span class="p">]()</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">)</span><span class="o">+</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">attr</span> <span class="p">{</span>
	<span class="c1">// ...</span>
    <span class="p">(</span><span class="n">self_unsafe_sync</span> <span class="p">|</span> <span class="nv">$node:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="n">_unr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$node</span><span class="na">.0</span> <span class="p">{</span>
            <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span> <span class="n">_unr</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nd">panic!</span><span class="p">(</span><span class="s">"Call {} on None"</span><span class="p">,</span> <span class="nd">stringify!</span><span class="p">(</span><span class="nv">$attr</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">self_unsafe_sync_mut</span> <span class="p">|</span> <span class="nv">$node:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="n">_unr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$node</span><span class="na">.0</span> <span class="p">{</span>
            <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span><span class="o">*</span> <span class="n">_unr</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.as_ref_mut_ptr</span><span class="p">()</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nd">panic!</span><span class="p">(</span><span class="s">"MAccess {} on None"</span><span class="p">,</span> <span class="nd">stringify!</span><span class="p">(</span><span class="nv">$attr</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>äºæ˜¯å¾—åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„èŠ‚ç‚¹çš„è®¿é—®å®ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">impl_node!</span><span class="p">(</span><span class="k">pub</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">arc</span><span class="p">);</span>

<span class="nd">def_attr_macro!</span><span class="p">(</span><span class="n">call_unsafe_sync</span> <span class="p">|</span> <span class="n">id</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
</code></pre></div></div>

<p>å¹¶ç”¨å®ƒä»¬å®šä¹‰ä¸€äº›èŠ‚ç‚¹åŒ…è£…ä¸Šçš„æ–¹æ³•ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.is_some</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nd">attr!</span><span class="p">(</span><span class="n">self_unsafe_sync</span> <span class="p">|</span> <span class="k">self</span><span class="p">)</span><span class="nf">.is_leaf</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">is_internal</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.is_some</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nd">attr!</span><span class="p">(</span><span class="n">self_unsafe_sync</span> <span class="p">|</span> <span class="k">self</span><span class="p">)</span><span class="nf">.is_leaf</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="nf">.is_some</span><span class="p">());</span>

        <span class="k">if</span> <span class="k">self</span><span class="nf">.is_internal</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">children!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="nf">.len</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nd">values!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="nf">.len</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ID</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="mi">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nd">id!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç®€å•æ–¹æ³•">ç®€å•æ–¹æ³•</h2>

<p>é¦–å…ˆå®šä¹‰ä¸‹å‘é‡çš„æŒä¹…åŒ–ç‰ˆæœ¬å’Œæ˜“å˜ç‰ˆæœ¬å…±é€šçš„ä¸€äº›æ–¹æ³•ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">impl_trie_common</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
            <span class="k">Self</span> <span class="p">{</span>
                <span class="n">cnt</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">root</span><span class="p">:</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">(),</span>
                <span class="n">tail</span><span class="p">:</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.cnt</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ID</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.tail</span><span class="nf">.id</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">pub</span> <span class="k">fn</span> <span class="nf">nth</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">T</span> <span class="p">{</span>
            <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">);</span>

            <span class="k">let</span> <span class="n">leaf</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.down_to_leaf</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

            <span class="o">&amp;</span><span class="nd">values!</span><span class="p">(</span><span class="n">leaf</span><span class="p">)[</span><span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="p">}</span>

        <span class="c1">// Alias as search to leaf, array_for, etc</span>
        <span class="k">fn</span> <span class="nf">down_to_leaf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">);</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">;</span>

            <span class="k">while</span> <span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">cur</span><span class="p">)[</span><span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lv</span><span class="p">)];</span>
                <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">cur</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>ä¸åŒäº Clojure é‡Œé¢çš„å®ç°ï¼Œæˆ‘ä»¬æ£€æŸ¥å°¾èŠ‚ç‚¹çš„ <code class="language-plaintext highlighter-rouge">id</code> è€Œä¸æ˜¯æ ¹èŠ‚ç‚¹çš„ï¼Œå› ä¸ºå°¾èŠ‚ç‚¹æ‰æ˜¯é¦–å…ˆè¢«æ’å…¥çš„èŠ‚ç‚¹</li>
</ol>

<h2 id="åˆ›å»ºèŠ‚ç‚¹">åˆ›å»ºèŠ‚ç‚¹</h2>

<p>å®šä¹‰ä¸€ä¸ªåˆ›å»ºèŠ‚ç‚¹çš„å®å¯ä»¥æå¤§åœ°æ–¹ä¾¿æˆ‘ä»¬åç»­æŒä¹…æ€§ä»¥åŠæ˜“å˜æ€§æ•°æ®ç»“æ„æ¨å…¥æˆ–å¼¹å‡ºèŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚</p>

<h3 id="åŸºç¡€åˆ›å»º">åŸºç¡€åˆ›å»º</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">node</span> <span class="p">{</span>
	<span class="c1">// ...</span>
    <span class="p">(</span><span class="n">single</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$v:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$cap</span><span class="p">);</span>
        <span class="nd">values_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
        <span class="n">node</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="nd">aux_node!</span><span class="p">(</span><span class="n">ENUM</span> <span class="n">Leaf</span> <span class="p">{</span>
            <span class="n">id</span><span class="p">:</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="n">values</span><span class="p">:</span> <span class="nn">Array</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nv">$cap</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="nd">aux_node!</span><span class="p">(</span><span class="n">ENUM</span> <span class="n">Internal</span> <span class="p">{</span>
            <span class="n">id</span><span class="p">:</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="n">children</span><span class="p">:</span> <span class="nn">Array</span><span class="p">::</span><span class="nf">new_with_clone</span><span class="p">(</span><span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">(),</span> <span class="nv">$cap</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¸¦æœ‰å®¹ç§¯å‚æ•°çš„å¤åˆ¶">å¸¦æœ‰å®¹ç§¯å‚æ•°çš„å¤åˆ¶</h3>

<p>åˆ›å»ºä¸€ä¸ªæŒ‡å®šå¤§å°çš„æ•°ç»„ï¼Œå¹¶åœ¨å…è®¸èŒƒå›´å†…å¤åˆ¶ä¸€ä¸ªæ—¢æœ‰èŠ‚ç‚¹ã€‚è¿™æ—¢å¯ä»¥ç”¨åœ¨ <code class="language-plaintext highlighter-rouge">push</code> æ—¶åˆ›å»ºä¸€ä¸ªæ‰©å®¹çš„æ–°èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ <code class="language-plaintext highlighter-rouge">pop</code> æ—¶åˆ›å»ºä¸€ä¸ªç¼©å®¹çš„æ–°èŠ‚ç‚¹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŸå°ä¸åŠ¨åœ°å¤åˆ¶èŠ‚ç‚¹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">node</span> <span class="p">{</span>
	<span class="c1">// ...    </span>
   <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">x</span><span class="nf">.is_leaf</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nv">$cap</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nv">$cap</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">cap</span> <span class="o">=</span> <span class="nv">$cap</span><span class="p">;</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&lt;=</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="nf">.len</span><span class="p">(),</span> <span class="n">cap</span><span class="p">);</span>

        <span class="nd">values_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="o">..</span><span class="n">n</span><span class="p">]</span><span class="nf">.clone_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">values!</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">..</span><span class="n">n</span><span class="p">]);</span>

        <span class="n">node</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$cap:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">cap</span> <span class="o">=</span> <span class="nv">$cap</span><span class="p">;</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&lt;=</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="nf">.len</span><span class="p">(),</span> <span class="n">cap</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="o">..</span><span class="n">n</span><span class="p">]</span><span class="nf">.clone_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">..</span><span class="n">n</span><span class="p">]);</span>

        <span class="n">nod</span>
    <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>       
</code></pre></div></div>

<h3 id="å¤åˆ¶æ—¶å®¹é‡-1-1">å¤åˆ¶æ—¶å®¹é‡ +1/-1</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">node</span> <span class="p">{</span>
	<span class="c1">// ...        </span>
    <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">inc</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$v:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">x</span><span class="nf">.is_leaf</span><span class="p">());</span>

        <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

        <span class="nd">values_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="n">x</span><span class="nf">.len</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>

        <span class="n">node</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">inc</span><span class="o">-</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">,</span> <span class="nv">$v:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
		
        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">x</span><span class="nf">.is_internal</span><span class="p">());</span>

        <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="n">x</span><span class="nf">.len</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>

        <span class="n">node</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">dec</span><span class="p">|</span> <span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">x</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">x</span><span class="nf">.is_leaf</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">leaf</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">internal</span><span class="p">|</span> <span class="nv">$id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
</code></pre></div></div>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹ +1 å¤åˆ¶ä¸ -1 å¤åˆ¶çš„å®ç°è¡Œä¸ºæœ‰äº›ä¸åŒï¼Œ+1 å¤åˆ¶è¦å•ç‹¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè¿™æ˜¯å› ä¸ºå®ƒæœ‰ä¸€ä¸ªé¢å¤–çš„å‚æ•° <code class="language-plaintext highlighter-rouge">$v</code> ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ’å…¥èŠ‚ç‚¹çš„å€¼ï¼Œè€Œå€¼çš„ç±»å‹æ˜¯å¼‚æ„çš„ï¼Œä¸èƒ½åŠ¨æ€åœ°åˆ†å‘ï¼Œåªèƒ½æ‰‹åŠ¨é™æ€åœ°åˆ†å‘ã€‚</p>

<h2 id="push">Push</h2>

<h3 id="ä¸»æµç¨‹">ä¸»æµç¨‹</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">push</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">cnt</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">tail</span><span class="p">;</span>

        <span class="c1">// trie is empty</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">single</span> <span class="o">-</span> <span class="n">leaf</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// tail is available</span>
        <span class="k">else</span> <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NODE_SIZE</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="o">-</span> <span class="n">inc</span> <span class="o">-</span> <span class="n">leaf</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// tail is full</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">single</span> <span class="o">-</span> <span class="n">leaf</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

            <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.push_tail_into_trie</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tail</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºæ–°è·¯å¾„">åˆ›å»ºæ–°è·¯å¾„</h3>

<p>åˆ›å»ºä¸€æ¡ä»æŸ $\text{lv}$ å¼€å§‹ç›´åˆ°å¶å­( $\text{lv}=1$ )çš„æ–°è·¯å¾„ï¼š</p>

<div class="sx-center">
<img src="/assets/img/trievec/trievec_new_path.svg" width="40%" /></div>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/// Top-down clone new path from lv (1..h)</span>
<span class="k">fn</span> <span class="n">new_path</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">ID</span><span class="p">,</span> <span class="n">lv</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">cap</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">x</span><span class="nf">.clone</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">internal</span> <span class="p">|</span> <span class="n">id</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

    <span class="nd">children_mut!</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">new_path</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

    <span class="n">node</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œä½¿ç”¨äº†é€’å½’çš„å®ç°ï¼Œåœ¨åŸç‰ˆçš„ä½œä¸º Clojure æ ‡å‡†åº“çš„ Java å®ç°é‡Œæ‰€æœ‰ Trie ä¸Šçš„æ“ä½œéƒ½é‡‡ç”¨äº†ç±»ä¼¼ç»“æ„çš„é€’å½’çš„å®ç°ï¼Œè¿™æˆ–è®¸èƒ½ç®€åŒ–ä¸€äº›ä»£ç ï¼Œä½†æ˜¯ä¸¥é‡ç‰ºç‰²äº†ä»£ç çš„å¯è¯»æ€§ï¼šä¸€æ–¹é¢æ¥å£ä¸‘é™‹ï¼Œä½œä¸ºé€’å½’å‡½æ•°çš„ä»£ä»·ï¼ŒåŒ…å«äº†è¿‡å¤šä¸åº”è¯¥å±äºæ¥å£è€Œæ˜¯æ ˆä¸Šä¸´æ—¶çš„å‚æ•°ï¼›å¦ä¸€æ–¹é¢é€’å½’æœ¬èº«åˆéšè—äº†ç»†èŠ‚ï¼Œè®©äººéš¾ä»¥çœ‹æ¸…æ¥šåˆ°åº•è¿™ä¸ªè¿‡ç¨‹åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚å› æ­¤åé¢æˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„å±•å¼€ç‰ˆæœ¬çš„å®ç°ä½œä¸ºæ›¿ä»£ã€‚</p>

<h3 id="æ¨å…¥å°¾èŠ‚ç‚¹">æ¨å…¥å°¾èŠ‚ç‚¹</h3>

<p>å½“ <code class="language-plaintext highlighter-rouge">push</code> æ—¶å‘ç°å°¾èŠ‚ç‚¹å·²æ»¡æ—¶ï¼Œéœ€è¦æŠŠæ—§çš„å°¾èŠ‚ç‚¹æ¨å…¥ Trie é‡Œé¢ï¼ŒæŒ‰ç…§ Trie æ ‘é«˜å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>

<ol>
  <li>$\text{lv}=0$ ï¼Œä¹Ÿå°±æ˜¯ Trie ä¸ºç©ºçš„æƒ…å†µï¼ŒæŠŠæ—§å°¾èŠ‚ç‚¹ä½œä¸º Trie çš„æ ¹ï¼›</li>
  <li>$\text{lv}=1$ ï¼Œæ­¤æ—¶å‘ç°æ ¹æº¢å‡ºï¼Œäºæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹åŒ…å«åŸæ¥çš„æ—§æ ¹å’Œæ¨å…¥çš„å°¾èŠ‚ç‚¹ã€‚ä½†æ˜¯æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¯ä»¥æ¨å¹¿åˆ°åŒ…å« $\text{lv}=1$ åœ¨å†…çš„å…¨éƒ¨æ ¹æº¢å‡ºçš„æƒ…å†µï¼Œæ­¤æ—¶æ–°æ ¹æ’å…¥çš„ä¸æ˜¯åŸæ¥çš„å°¾èŠ‚ç‚¹ï¼Œè€Œæ˜¯ <code class="language-plaintext highlighter-rouge">new_path</code> åˆ›å»ºçš„åŒ…å«å°¾èŠ‚ç‚¹çš„ä¸€æ•´æ¡è·¯å¾„ï¼›</li>
  <li>$\text{lv} \ge 2$ ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹å¤åˆ¶ï¼Œæ³¨æ„é€‰æ‹©åˆé€‚çš„æ•°ç»„å®¹é‡ï¼Œå½“ä¸­é—´èŠ‚ç‚¹è¶…è¿‡ä¸€å±‚æ—¶ï¼Œè‡ªé¡¶å‘ä¸‹åœ°å¤åˆ¶æ¯ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œå¹¶æŠŠä¸Šä¸€å±‚ä¸­é—´èŠ‚ç‚¹é‡Œå¯¹æœ¬å±‚èŠ‚ç‚¹çš„å¼•ç”¨æ›´æ–°ä¸ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹ï¼Œå½“å‘ç°æ–°çš„èŠ‚ç‚¹åœ¨ä¸€ä¸ªè¿˜æœªåˆ›å»ºçš„è·¯å¾„æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">new_path</code> åˆ›å»ºåˆ°å¶å­çš„æ–°è·¯å¾„ï¼Œç„¶åæ’å…¥åˆ°ä¸Šä¸€å±‚èŠ‚ç‚¹ã€‚</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">push_tail_into_trie</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">debug_assert_eq!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="nf">.len</span><span class="p">(),</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">leaf_i</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">root</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Complete trie including case lv == 1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">NODE_SIZE</span><span class="nf">.pow</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">root</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">internal</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>

            <span class="nd">children_mut!</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="nd">children_mut!</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">new_path</span><span class="p">(</span><span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">lv</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span><span class="p">;</span>

        <span class="k">if</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p_i</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span>
                <span class="n">dup</span> <span class="o">-</span> <span class="n">inc</span> <span class="o">-</span> <span class="n">internal</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span>
                <span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">,</span>
                <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">};</span>

        <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="c1">// Go down through the branch</span>
        <span class="k">while</span> <span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">{</span>
            <span class="c1">// at p's level</span>

            <span class="k">if</span> <span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">old_cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">];</span>
                <span class="k">let</span> <span class="n">cur</span><span class="p">;</span>
                <span class="k">let</span> <span class="n">cur_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

                <span class="k">if</span> <span class="n">old_cur</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cur_i</span> <span class="p">{</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">old_cur</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span>
                        <span class="n">dup</span> <span class="o">-</span> <span class="n">inc</span> <span class="o">-</span> <span class="n">internal</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span>
                        <span class="n">old_cur</span><span class="p">,</span>
                        <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">()</span>
                    <span class="p">);</span>
                <span class="p">}</span>

                <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="nf">.clone</span><span class="p">();</span>

                <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="n">p_i</span> <span class="o">=</span> <span class="n">cur_i</span><span class="p">;</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span>
                    <span class="nf">new_path</span><span class="p">(</span><span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">debug_assert_eq!</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="n">root</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="assoc">Assoc</h2>

<p>æŒ‰ç…§ç´¢å¼•æ›´æ–°å‘é‡ï¼Œå¦‚æœç´¢å¼•å’Œé•¿åº¦ç›¸ç­‰ï¼Œå°±é¡ºåŠ¿æ’å…¥ã€‚</p>

<p>å’Œå‰é¢ <code class="language-plaintext highlighter-rouge">push_tail_into_trie</code> åŒæ ·è‡ªé¡¶å‘ä¸‹åœ°å¤åˆ¶ä¸€æ¡åªåˆ°å¶å­çš„è·¯å¾„ï¼Œåªä¸è¿‡å‰è€…ç›¸å½“äºè®¿é—®çš„ç´¢å¼•æ˜¯ <code class="language-plaintext highlighter-rouge">self.cnt - 1</code> ï¼Œè€Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¼ å…¥çš„ç´¢å¼•ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>    
	<span class="cd">/// idx in `[0, self.len()]` (update or push)</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">assoc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;=</span> <span class="n">idx</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="k">self</span><span class="py">.cnt</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">self</span><span class="nf">.push</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">cnt</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">root</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">tail</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="n">tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">);</span>
            <span class="nd">values_mut!</span><span class="p">(</span><span class="n">tail</span><span class="p">)[</span><span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>

            <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">);</span>

            <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="k">if</span> <span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="c1">// at p's level</span>

                <span class="k">loop</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">old_cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">];</span>
                    <span class="k">let</span> <span class="n">cur</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">old_cur</span><span class="p">);</span>

                    <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="nf">.clone</span><span class="p">();</span>

                    <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>

                    <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nd">values_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

            <span class="n">tail</span> <span class="o">=</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tail</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="pop">Pop</h2>

<h3 id="ä¸»æµç¨‹-1">ä¸»æµç¨‹</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>       
	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">pop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Can't pop empty vector"</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">cnt</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">tail</span><span class="p">;</span>

        <span class="c1">// Get empty vec</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// Get non-empty tail</span>
        <span class="k">else</span> <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="o">-</span> <span class="n">dec</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// the last two idx</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.down_to_leaf</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

            <span class="n">root</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.pop_tail_from_trie</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tail</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¼¹å‡ºå°¾èŠ‚ç‚¹">å¼¹å‡ºå°¾èŠ‚ç‚¹</h3>

<p>ä¸ <code class="language-plaintext highlighter-rouge">push</code> çš„æ“ä½œç›¸å¯¹çš„ï¼Œå½“å¼¹å‡ºå°¾éƒ¨å…ƒç´ åå‘ç°å°¾èŠ‚ç‚¹ä¸ºç©ºæ—¶ï¼Œéœ€è¦æŠŠ Trie æœ€åä¸€ä¸ªèŠ‚ç‚¹å¼¹å‡ºæ¥ä½œä¸ºå°¾èŠ‚ç‚¹ã€‚</p>

<p>æœ‰ä¸¤ç‚¹å€¼å¾—ä¸€è®²ï¼š</p>

<ol>
  <li>
    <p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">self.cnt - 2</code> ä½œä¸ºå¯¹ Trie ä¸Šæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„è®¿é—®ç´¢å¼•ï¼Œå› ä¸ºæ­¤æ—¶åŸå°¾èŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå› æ­¤ Trie ä¸Šæœ‰ <code class="language-plaintext highlighter-rouge">self.cnt - 1</code> ä¸ªå…ƒç´ ï¼›</p>
  </li>
  <li>
    <p>å¼¹å‡ºå°¾èŠ‚ç‚¹å¯èƒ½ä¼šäº§ç”Ÿç©ºè·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å”¯ä¸€çš„å­èŠ‚ç‚¹ä¸ºç©ºçš„èŠ‚ç‚¹ï¼Œç©ºè·¯å¾„å¯èƒ½ä¼šä¸€è·¯å‘ä¸Šå»¶ä¼¸ï¼Œç›´åˆ°æ ¹èŠ‚ç‚¹<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>ã€‚å¯¹åº”æ¨å…¥å°¾èŠ‚ç‚¹æ—¶æœ‰æ ¹æº¢å‡ºçš„æƒ…å†µï¼Œè¿™æ—¶åº”è¯¥å«åšæ ¹ä¸è¶³å§ğŸ˜€ã€‚</p>

    <p>ä»ç»“æ„ä¸Šè¿›è¡Œåˆ¤æ–­çš„è¯ï¼Œéœ€è¦ä»å°¾éƒ¨å†å›æº¯åˆ°æ ¹ï¼Œç”±äº Trie èŠ‚ç‚¹æ²¡æœ‰å¯¹çˆ¶èŠ‚ç‚¹çš„åå‘å¼•ç”¨ï¼Œæ‰€ä»¥åœ¨è‡ªé¡¶å‘ä¸‹è¿‡ç¨‹ä¸­è¿˜è¦ä¿å­˜ä¸€ä¸‹æ•´æ¡èŠ‚ç‚¹è·¯å¾„ï¼Œç„¶åè¿›è¡Œæ£€æŸ¥ã€‚</p>

    <p>ä¸è¿‡æœ‰æ›´ç®€å•çš„ï¼Œå°±æ˜¯ç›´æ¥æ£€æŸ¥ Trie çš„å¤§å°ï¼Œæ˜¯å¦å¼¹å‡ºå°¾èŠ‚ç‚¹ååé«˜åº¦ä¼šä¸‹é™</p>
  </li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>       
	<span class="k">fn</span> <span class="nf">pop_tail_from_trie</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">debug_assert_eq!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Get empty tail</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">leaf_i</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// tail size 1</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="k">while</span> <span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">cur</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]);</span>

            <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>
        
        <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">NODE_SIZE</span> <span class="o">==</span> <span class="n">NODE_SIZE</span><span class="nf">.pow</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* pop root */</span>
            <span class="n">root</span> <span class="o">=</span> <span class="nd">children!</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">root</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="æ˜“å˜ç‰ˆæœ¬å®ç°">æ˜“å˜ç‰ˆæœ¬å®ç°</h2>

<h3 id="æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">cnt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">tail</span><span class="p">:</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">!</span><span class="nb">Send</span> <span class="k">for</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">!</span><span class="nb">Sync</span> <span class="k">for</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>
</code></pre></div></div>

<p>ç”±äº <code class="language-plaintext highlighter-rouge">Sync</code> å’Œ <code class="language-plaintext highlighter-rouge">Send</code> æ˜¯è‡ªåŠ¨ Traitï¼Œç”±äº Node å› ä¸ºæˆ‘ä»¬å®šä¹‰çš„ <code class="language-plaintext highlighter-rouge">UnsafeSendSync</code> è‡ªåŠ¨å®ç°äº†è¿™ä¸¤ä¸ª Trait ï¼Œå› æ­¤ <code class="language-plaintext highlighter-rouge">PTrieVec</code> å’Œ <code class="language-plaintext highlighter-rouge">TTrieVec</code> ä¹Ÿéƒ½è‡ªåŠ¨å®ç°äº†è¿™ä¸¤ä¸ª Trait ï¼Œä½†æˆ‘ä»¬ä¸å–œæ¬¢è®© <code class="language-plaintext highlighter-rouge">TTrieVec</code> èƒ½åè¢«è·¨çº¿ç¨‹çš„åˆ†å‘ä¸è®¿é—®ï¼Œäºæ˜¯é€šè¿‡â€œè´Ÿå®ç°â€å–æ¶ˆè¿™ä¸¤ä¸ª Trait çš„è‡ªåŠ¨å®ç°ã€‚</p>

<h3 id="transient">transient</h3>

<p>æŠŠæŒä¹…å‘é‡å˜ä¸ºå±äºå½“å‰çº¿ç¨‹çš„å¯å˜å‘é‡ã€‚</p>

<p>ä¸ä¼šé©¬ä¸Šå¤åˆ¶æ•´æ£µæ ‘çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè€Œåªæ˜¯ TrieVec çš„æ ¹èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ã€‚</p>

<p>ä½¿ç”¨å® <code class="language-plaintext highlighter-rouge">ensure_editable</code> ä½œä¸ºè­¦æˆ’å“¨ï¼Œç¡®ä¿æœ€åå¾—åˆ°ä¸€ä¸ªå±äºå½“å‰çº¿ç¨‹çš„å¯å˜çš„èŠ‚ç‚¹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">macro_rules!</span> <span class="n">ensure_editable</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$id:expr</span><span class="p">,</span> <span class="nv">$x:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">x</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">x</span><span class="nf">.id</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">x</span><span class="nf">.clone</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="o">-</span> <span class="n">with</span> <span class="p">|</span> <span class="n">id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">};</span>
    <span class="p">(</span><span class="nv">$x:expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">ensure_editable!</span><span class="p">(</span><span class="nd">edit!</span><span class="p">(),</span> <span class="nv">$x</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>    
	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">transient</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="n">TTrieVec</span> <span class="p">{</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">,</span>
            <span class="n">root</span><span class="p">:</span> <span class="nd">ensure_editable!</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">),</span>
            <span class="n">tail</span><span class="p">:</span> <span class="nd">ensure_editable!</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="push-1">push</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">is_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">||</span> <span class="k">self</span><span class="nf">.id</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">}</span>

	<span class="k">pub</span> <span class="k">fn</span> <span class="nf">push</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="nf">.is_editable</span><span class="p">());</span>

        <span class="c1">// trie is empty</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">single</span> <span class="o">-</span> <span class="n">leaf</span> <span class="p">|</span> <span class="nd">edit!</span><span class="p">(),</span> <span class="n">v</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// tail is available</span>
        <span class="c1">// WARNING: neq `tail.len` for it's array capcity</span>
        <span class="k">else</span> <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NODE_SIZE</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">leaf_i</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>

            <span class="k">if</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">leaf_i</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.tail</span> <span class="o">=</span>
                    <span class="nd">node!</span><span class="p">(</span><span class="n">dup</span> <span class="o">-</span> <span class="n">with</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nd">values_mut!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="p">)[</span><span class="n">leaf_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// tail is full</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.push_tail_into_trie</span><span class="p">();</span>
            <span class="k">self</span><span class="py">.tail</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">single</span> <span class="o">-</span> <span class="n">leaf</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">v</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">self</span><span class="py">.cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>


        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">,</span>
            <span class="n">root</span><span class="p">:</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">tail</span><span class="p">:</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
   	<span class="k">fn</span> <span class="nf">push_tail_into_trie</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">debug_assert_eq!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="nf">.len</span><span class="p">(),</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">leaf_i</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.root</span> <span class="o">=</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">NODE_SIZE</span><span class="nf">.pow</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="nd">node!</span><span class="p">(</span><span class="n">internal</span> <span class="p">|</span> <span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

            <span class="nd">children_mut!</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>
            <span class="nd">children_mut!</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
                <span class="nf">new_path</span><span class="p">(</span><span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">lv</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

            <span class="k">self</span><span class="py">.root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.ensure_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">);</span>

        <span class="k">self</span><span class="py">.root</span> <span class="o">=</span> <span class="n">p</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="k">while</span> <span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">{</span>
            <span class="c1">// at p's level</span>

            <span class="k">if</span> <span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">cur</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.ensure_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]);</span>
                <span class="k">let</span> <span class="n">cur_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

                <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="nf">.clone</span><span class="p">();</span>

                <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

                <span class="n">p_i</span> <span class="o">=</span> <span class="n">cur_i</span><span class="p">;</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span>
                    <span class="nf">new_path</span><span class="p">(</span><span class="k">self</span><span class="nf">.id</span><span class="p">(),</span> <span class="n">lv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">,</span> <span class="n">NODE_SIZE</span><span class="p">);</span>

                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åŸºæœ¬è¿‡ç¨‹å’ŒæŒä¹…åŒ–ç‰ˆæœ¬é«˜åº¦ä¸€è‡´ï¼Œæœ‰ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼š</p>

<ol>
  <li>æŒä¹…åŒ–ç‰ˆæœ¬æ‰©å®¹æ—¶å®¹é‡æœ€å¤šå¢åŠ  $1$ ï¼Œè€Œæ˜“å˜ç‰ˆæœ¬ç›´æ¥åˆ†é…æ»¡é¢çš„èŠ‚ç‚¹ï¼›</li>
  <li>ç›´æ¥ä¿®æ”¹ TrieVec å¤´ï¼Œ<code class="language-plaintext highlighter-rouge">self.root</code>, <code class="language-plaintext highlighter-rouge">self.tail</code></li>
</ol>

<h3 id="assoc-1">assoc</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>      
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">assoc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;=</span> <span class="n">idx</span><span class="p">);</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="nf">.is_editable</span><span class="p">());</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="k">self</span><span class="py">.cnt</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">self</span><span class="nf">.push</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>


        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span>
            <span class="nd">debug_assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="nf">.id</span><span class="p">()</span> <span class="o">==</span> <span class="k">self</span><span class="nf">.id</span><span class="p">());</span>
            <span class="nd">values_mut!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="p">)[</span><span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>

            <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>

            <span class="k">if</span> <span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="c1">// at p's level</span>

                <span class="k">loop</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">cur</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.ensure_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]);</span>
                    <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="nf">.clone</span><span class="p">();</span>

                    <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>

                    <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nd">values_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">,</span>
            <span class="n">root</span><span class="p">:</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">tail</span><span class="p">:</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="pop-1">pop</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>   
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">pop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span> <span class="o">+</span> <span class="nb">Default</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Can't pop empty vector"</span><span class="p">);</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="nf">.is_editable</span><span class="p">());</span>

        <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.tail</span> <span class="o">=</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="nd">values_mut!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="p">)[</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="nd">tailoff!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
                <span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">tail</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.ensure_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="nf">.down_to_leaf</span><span class="p">(</span><span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>

            <span class="k">self</span><span class="nf">.pop_tail_from_trie</span><span class="p">();</span>

            <span class="k">self</span><span class="py">.tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="k">self</span><span class="py">.cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">,</span>
            <span class="n">root</span><span class="p">:</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">tail</span><span class="p">:</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.clone</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">fn</span> <span class="nf">pop_tail_from_trie</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">lv</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.root</span> <span class="o">=</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">lv</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">leaf_i</span> <span class="o">=</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">p</span> <span class="o">=</span> <span class="k">self</span><span class="py">.root</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="k">while</span> <span class="n">lv</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">cur</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.ensure_editable</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">children!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]);</span>

            <span class="n">lv</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">p_i</span> <span class="o">=</span> <span class="nd">idx!</span><span class="p">(</span><span class="n">leaf_i</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">children_mut!</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">=</span> <span class="nn">Node</span><span class="p">::</span><span class="nf">none</span><span class="p">();</span>

        <span class="k">if</span> <span class="k">self</span><span class="py">.cnt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">NODE_SIZE</span> <span class="o">==</span> <span class="n">NODE_SIZE</span><span class="nf">.pow</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.root</span> <span class="o">=</span> <span class="nd">children!</span><span class="p">(</span><span class="k">self</span><span class="py">.root</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="persistent">persistent</h3>

<p>æŠŠæ˜“å˜ç‰ˆæœ¬è½¬æ¢å›æŒä¹…åŒ–ç‰ˆæœ¬ã€‚æ”¹ä¸€ä¸‹å¤´å°¾èŠ‚ç‚¹çš„æ ‡è®°å°±å¯ä»¥ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">TTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>       
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">persistent</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">PTrieVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">Clone</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="k">self</span><span class="nf">.is_editable</span><span class="p">());</span>

        <span class="k">if</span> <span class="k">self</span><span class="py">.tail</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
            <span class="o">*</span><span class="nd">id_mut!</span><span class="p">(</span><span class="k">self</span><span class="py">.tail</span><span class="p">)</span> <span class="o">=</span> <span class="nd">no_edit!</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">PTrieVec</span> <span class="p">{</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="k">self</span><span class="py">.cnt</span><span class="p">,</span>
            <span class="n">root</span><span class="p">:</span> <span class="k">self</span><span class="py">.root</span><span class="p">,</span>
            <span class="n">tail</span><span class="p">:</span> <span class="k">self</span><span class="py">.tail</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç”±äº Rust çš„ç¼–ç¨‹æ¨¡å‹ï¼Œæ˜“å˜ç‰ˆæœ¬æŒä¹…åŒ–ååŸæ¥çš„æ˜“å˜ç‰ˆæœ¬ä¿è¯æ— æ³•è®¿é—®ï¼Œç›¸æ¯” Clojure çš„ Java å®ç°ä¼šç®€åŒ–å¾ˆå¤šè¿‡ç¨‹ã€‚</p>

<h2 id="è°ƒè¯•æ–¹æ³•">è°ƒè¯•æ–¹æ³•</h2>

<h3 id="æ‰“å°æ–¹æ³•">æ‰“å°æ–¹æ³•</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">#[cfg(test)]</span>
<span class="nd">macro_rules!</span> <span class="n">impl_trie_test_common</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">#[allow(unused)]</span>
        <span class="k">fn</span> <span class="nf">debug_print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span>
        <span class="k">where</span>
            <span class="n">T</span><span class="p">:</span> <span class="n">Debug</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="nf">debug_print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.root</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.tail</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="nd">#[cfg(test)]</span>
<span class="k">fn</span> <span class="n">debug_print</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">tail</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">T</span><span class="p">:</span> <span class="n">Debug</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nn">common</span><span class="p">::</span><span class="n">vecdeq</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">lv</span> <span class="o">=</span> <span class="mi">1usize</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">cur_q</span> <span class="o">=</span> <span class="nd">vecdeq!</span><span class="p">[];</span>

    <span class="nd">println!</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"MAIN TRIE:"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">();</span>

    <span class="k">if</span> <span class="n">root</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">cur_q</span><span class="nf">.push_back</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="n">root</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"empty.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="o">!</span><span class="n">cur_q</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"############ Level: {} #############</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lv</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">nxt_q</span> <span class="o">=</span> <span class="nd">vecdeq!</span><span class="p">[];</span>

        <span class="k">while</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">=</span> <span class="n">cur_q</span><span class="nf">.pop_front</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="k">in</span> <span class="n">group</span><span class="nf">.into_iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"{i:02}. {child:?}"</span><span class="p">);</span>

                <span class="k">if</span> <span class="n">child</span><span class="nf">.is_internal</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">child_group</span> <span class="o">=</span> <span class="nd">children!</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                        <span class="nf">.iter</span><span class="p">()</span>
                        <span class="nf">.filter</span><span class="p">(|</span><span class="o">&amp;</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span><span class="nf">.is_some</span><span class="p">())</span>
                        <span class="nf">.collect</span><span class="p">();</span>
                    <span class="n">nxt_q</span><span class="nf">.push_back</span><span class="p">(</span><span class="n">child_group</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nd">println!</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">cur_q</span> <span class="o">=</span> <span class="n">nxt_q</span><span class="p">;</span>
        <span class="n">lv</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// print tail</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"###################################</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"TAIL: </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">if</span> <span class="n">tail</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"empty."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"------------- end --------------"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="å°¾å£°">å°¾å£°</h2>

<p><a href="">ä»£ç å‚è€ƒ</a></p>

<h2 id="æ³¨è§£">æ³¨è§£</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>å‚è€ƒè‡ª <a href="https://hypirion.com/musings/understanding-persistent-vector-pt-1">hyPiRion ä»‹ç»çš„ç³»åˆ—åšæ–‡</a> å’Œ <a href="https://github.com/clojure/clojure/blob/clojure-1.11.0-alpha2/src/jvm/clojure/lang/PersistentVector.java">Clojure æºä»£ç </a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>https://hypirion.com/musings/understanding-persistent-vector-pt-3#the-rationale-for-tailsÂ <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>åœ¨åŸç‰ˆ Clojure çš„ Java é‡Œï¼Œæ ‡å¿—ä½¿ç”¨äº†åŸå­ç±»å‹ï¼Œè¿™ä¸»è¦æ˜¯æ‹…å¿ƒæ˜“å˜ç±»å‹åœ¨è·¨çº¿ç¨‹ä½¿ç”¨æ—¶é‡æ–°å˜ä¸ºæŒä¹…ç±»å‹æ—¶çš„ç«äº‰é—®é¢˜ï¼Œä½†æ˜¯ç”±äº Rust çš„ç¼–ç¨‹æ¨¡å‹é™åˆ¶äº†æ˜“å˜ç±»å‹ä¸å…è®¸è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œå› æ­¤å°±ä¸éœ€è¦å˜ä¸ºåŸå­ç±»å‹Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>Atomic RcÂ <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>å¯¹äºæ ‘é«˜è‡³å°‘ä¸º $2$ ä½œä¸ºçš„ Trie æ¥è®²ï¼Œç©ºè·¯å¾„åº”è¯¥æ˜¯æ ¹èŠ‚ç‚¹çš„ç¬¬äºŒä¸ªå­©å­ï¼ŒÂ <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name></name></author><category term="[&quot;algs&quot;]" /><summary type="html"><![CDATA[åœ¨å‰é¢ä»‹ç»äº†ä» Fibonacci å †ã€Dary å †ï¼Œåˆ°å›¾ä¸Šçš„è¯¸å¤šç®—æ³•ï¼Œä» BST åˆ° BT çš„ä¸€ç³»åˆ—æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œå¹¶æä¾›äº†å®ƒä»¬çš„ Rust å®ç°ï¼Œå¦‚æœæŠŠè¿™äº›ä»£ç éƒ½é›†æˆèµ·æ¥ï¼Œå¯èƒ½å°±ä¼šå‘ç°è¿™ä¸ªç¼–è¯‘çš„è¿‡ç¨‹æ€ä¹ˆè¿™ä¹ˆç†¬äººï¼Œä¼¼ä¹è¶Šæ¥è¶Šè®©äººéš¾ä»¥å¿å—ï¼Œè¿™æ—¶å¯ä»¥å‚è€ƒä¸€ä¸‹å¦ç¯‡å…³äºé™ä½æ„å»ºæ—¶é—´çš„ç¬”è®°ã€‚]]></summary></entry></feed>