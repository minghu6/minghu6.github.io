<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="/assets/style.css"/>
<link rel="stylesheet" href="/assets/js/lity.min.css"/>



<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="MINGHU6's Blog" />
<meta 
    property="og:title"
    content="
        
            最优原地后缀排序算法
        
    " 
/>

<meta property="og:url" content="//algs/sa_2016.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        最优原地后缀排序算法
    
</title>
</head>
<body class="index" data-spy="scroll" data-target="#toc" tabindex="0">

    <div class="header">
    <div id="topbar" class="d-flex align-items-center justify-content-between h-100">
  <span id="breadcrumb">

    

    

    

    
    <span>
      <a href="/">
        Home
      </a>
    </span>
    

    

    

    

    

    

    
  </span><!-- endof #breadcrumb -->

  <section class="logo">
    <a href="/" class="logo__link">
      
      <img class="logo__link__img" src="/minghu6.jpeg" />
      
    </a>
  </section>

  <span id="search-wrapper" class="align-items-center">
    <i class="fas fa-search fa-fw"></i>
    <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off"
      placeholder="Search...">
  </span>
  <span id="search-cancel">Cancel</span>

</div>


    <button id="menuToggle" class="">
        <div></div>
        <div></div>
        <div></div>
    </button>

    <nav class="menu">
        
    </nav>
</div>


    <div class="page main">
    <main class="page__main" id="core-wrapper">
        <article class="post">

  <div class="post__title">
    <h1 class="post__title__text">最优原地后缀排序算法</h1>
  </div>
  <div class="post__meta">
    <div class="post__meta__category">
      
        
        <a href="/category/algs.html">
          <p class="post__meta__category__title" style="background: var(--c-themeHueOrange)">
            Algorithm
          </p>
        </a>
      
    </div>
    <p class="post__meta__divider">·</p>
    <div class="post__meta__date">
      December 01, 2020
    </div>
    
  </div>

  

  <div class="post__content_container">
    <div class="post__content"><p>本章介绍线性时间复杂度的后缀排序的就地算法<sup id="fnref:in-place-sa-sort" role="doc-noteref"><a href="#fn:in-place-sa-sort" class="footnote" rel="footnote">1</a></sup>（Optimal In-Place Suffix Sorting）。</p>

<p>本章<strong>只建议</strong>在<strong>非常非常熟悉</strong>SA-IS<sup id="fnref:nzc09a" role="doc-noteref"><a href="#fn:nzc09a" class="footnote" rel="footnote">2</a></sup><sup id="fnref:sa-is" role="doc-noteref"><a href="#fn:sa-is" class="footnote" rel="footnote">3</a></sup>的前提下阅读。</p>

<h2 id="全局设定">全局设定</h2>

<p>目标字符串 $\texttt{Pat}$，后缀数组 $\texttt{SA}$，串的序号从 0 开始，结尾字符是警戒哨，不妨设为 0 。</p>

<h2 id="在整形字母表上的后缀排序">在整形字母表上的后缀排序</h2>

<p>事实上这一部分可以看成是原地版本的 SA-IS 算法。</p>

<p>因为是原文中细节相对最清楚，实现也较为简单的算法，也是了解后续算法的基础，是本文介绍的重点。</p>

<p>原地化的原理是用重命名的 $\texttt{Pat}$ 代替S、L桶，用额外 $O(n)$  的操作代替类型桶。</p>

<h3 id="重命名目标串pat">重命名目标串Pat</h3>

<p>简单来说，我们会在不改变后缀大小的相对顺序的前提下，重命名 $\texttt{Pat}$ ，用重命名后的 $\texttt{Pat}$ 来取代原来 S、L 桶，来指明桶头或者桶尾。</p>

<p>重命名的方法是将 $\texttt{Pat}$ 中的 S 型字符替换为所在桶的桶尾索引，L  型字符替换为所在桶的桶头索引。</p>

<p>如图所示：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_01.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\
\
\qquad&\texttt{ 0 }\texttt{ 1 }\texttt{ 2 }\texttt{ 3 }\texttt{ 4 }\
\texttt{ 5 }\texttt{ 6 }\texttt{ 7 }\texttt{ 8 }\texttt{ 9 }\
\texttt{10 }\texttt{11 }\texttt{12 } \\
\
\texttt{Pat}:\
\qquad&\texttt{ 2 }\texttt{ 1 }\texttt{ 1 }\texttt{ 3 }\texttt{ 3 }\
\texttt{ 1 }\texttt{ 1 }\texttt{ 3 }\texttt{ 3 }\texttt{ 1 }\
\texttt{  }\texttt{2 }\texttt{  }\texttt{1 }\texttt{  }\texttt{0 } \\
\
\texttt{Type}:\
\qquad&\texttt{ L }\texttt{ L }\texttt{ L }\texttt{ L }\texttt{ L }\
\texttt{ L }\texttt{ L }\texttt{ L } \texttt{ L }\texttt{ L }\
\texttt{  }\texttt{L }\texttt{  }\texttt{L }\texttt{  }\texttt{L } \\
\
\texttt{Bucket}:\
\qquad&\texttt{(0)}\
\texttt{(1 }\texttt{ 1 }\texttt{ 1 }\texttt{ 1 }\texttt{ 1 }\texttt{ }\texttt{1)}\
\texttt{(2 }\texttt{ 2)}\
\texttt{(3}\texttt{ }\texttt{ 3 }\texttt{ 3 }\texttt{ 3)}\\
\end{aligned}
$$ -->

<p>重命名后的 $\texttt{Pat’}$  （之后直接将重命名后的 $\texttt{Pat’}$ 称做 $\texttt{Pat}$ ）：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_02.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{Pat'}:\qquad&\texttt{ 7   6   6   9   9   6   6   9   9   6   7   1   0}
\end{aligned}
$$ -->

<p>由于桶内的字符，L 型字符后缀小，作为桶头；而 S 型字符后缀大，作为桶尾，因此保持了后缀大小的相对顺序。</p>

<p>描述一下重命名的具体步骤：</p>

<ol>
  <li>和 SA-IS 一样，对 $\texttt{Pat}$ 中每个字符计数，计算其前缀和（计数排序），来构建 S/L 桶，只不过这里用 $\texttt{SA}$ 盛放这个前缀和；</li>
  <li>从尾到头，扫描 $\texttt{Pat}$ 的每个字符，这样只需记录上一个字符的类型，就可以动态地判断每个字符的类型，然后依据前缀和将其重命名。</li>
</ol>

<p><em>显然这里将同一个桶的字符根据其S、L类型重命名为桶头或者桶尾，虽然仍保持后缀的大小关系，但破坏了字符的大小关系。</em></p>

<p><em>所以如果想之后还原字符的大小关系，可以只重命名为桶尾，区别只是在诱导排序部分有些改动，详情见论文APPENDIX C 。</em></p>

<h3 id="对lms字符排序">对LMS字符排序</h3>

<p>这里重点是使用了一个内部计数器的技巧。</p>

<h4 id="初始化">初始化</h4>

<p>初始的时候将 $\texttt{SA}$ 每一项设为 E（EMPTY）。</p>

<p>从尾到头扫描 $\texttt{Pat}$ ，如果发现是 LMS 字符，$\texttt{Pat[i]}$ ，那么就设置 $\texttt{SA[Pat[i]]}$ 的标记：</p>

<p>如果 $\texttt{SA[Pat[i]]}$ 是 E，就将其设为 U（UNIQUE）；</p>

<p>如果 $\texttt{SA[Pat[i]]}$ 是 U，就将其设为 M（MULTIPLE）；</p>

<p>其他情况，不做处理。</p>

<p>结果如图所示：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_03.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{Pat}:\qquad&\texttt{ 7   6   6   9   9   6   6   9   9   6   7   1   0} \\
\texttt{LMS}:\qquad&\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ ∗ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ * }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ * }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ * }\\
\texttt{SA}:\qquad&\texttt{(}\underline{\color{red}{\texttt{U}}}\texttt{) }\texttt{(E)}\texttt{ }\texttt{(E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }\underline{\color{red}{\texttt{M}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\end{aligned}
$$ -->

<h4 id="把lms字符的索引放入sa">把LMS字符的索引放入SA</h4>

<p>从尾到头扫描 $\texttt{Pat}$ ，对于 LMS 字符 $\texttt{Pat[i]}$ ，根据 $\texttt{SA[Pat[i]]}$ 的符号进行分类讨论：</p>

<p>U：直接让 $\texttt{SA[Pat[i]] = i}$</p>

<p>M：意味着桶中有至少两个 LMS 字符。</p>

<ol>
  <li>
    <p>如果桶中有至少三个字符 LMS 字符：</p>

    <p>就把桶中倒数第二个位置作为临时计数器，标志桶中已填充的 LMS 字符数（桶中倒数第一位就是标志 M ）</p>

    <p>将新的 LMS 字符从倒数第三个位置开始插入，让临时计数器自增 1 。</p>

    <p>如果发现桶已经满了，就把桶中从桶头到倒数第三个的所有元素向右平移 2 个位置，然后把新元素插入到桶中第二个位置（桶中第一个位置填为 E ）</p>
  </li>
  <li>
    <p>如果桶中有且只有 2 个LMS字符，显然不需要计数器，直接从右到左顺序插入即可。</p>
  </li>
</ol>

<p>正常的值：</p>

<p>​    根据我们之前的讨论，此时不管桶中有两个还是两个以上的 LMS 字符，这都意味着 $\texttt{i}$ 是桶中最后一个待插入的LMS字符的位置，</p>

<p>​    只需要从桶头开始向左扫描，找到第一个标记为E的位置，将其设为 $\texttt{i}$ 。</p>

<p>最后要从尾到头扫描一遍 $\texttt{SA}$ ，清除可能残余的特殊符号 M （桶中未被填满，所以M和计数器未被覆盖）。</p>

<p>方法是将桶中 LMS 字符如上述步骤一样向右平移 2 位，将左边空出来的位置填为 E 。</p>

<p>如图所示：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_04.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{Pat}:\qquad&\texttt{ }\texttt{ 7   6   6   9   9   6   6   9   9   6   7   1   0} \\
\texttt{SA}:\qquad&\texttt{(}\underline{\color{red}{\texttt{12}}}\texttt{)}\texttt{ (E)}\texttt{ (E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ M}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\texttt{SA}:\qquad&\texttt{(12) }\texttt{(E)}\texttt{ (E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }\underline{\color{red}\texttt{9}}\texttt{ }\texttt{ }{\color{red}\texttt{ 1 }}\texttt{ }\texttt{ }{\color{red}{\texttt{M}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\texttt{SA}:\qquad&\texttt{(12) }\texttt{(E)}\texttt{ (E }\texttt{ }\texttt{ }\underline{\color{red}{\texttt{5}}}\texttt{ }\texttt{ }\texttt{ }{\texttt{9}}\texttt{ }\texttt{ }{\color{red}\texttt{ 2 }}\texttt{ }\texttt{ }{\color{red}{\texttt{M}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\texttt{SA}:\qquad&\texttt{(12) }\texttt{(E)}\texttt{ (}\underline{\color{red}\texttt{1}}\texttt{ }\texttt{ }{\texttt{ 5}}\texttt{ }\texttt{ }\texttt{ }{\texttt{9}}\texttt{ }\texttt{ }{\color{red}\texttt{ 3 }}\texttt{ }\texttt{ }{\color{red}{\texttt{M}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\texttt{SA}:\qquad&\texttt{(12) }\texttt{(E)}\texttt{ (}\texttt{E }\texttt{ }\texttt{ E }\texttt{ }{\color{red}\texttt{ 1 }\texttt{ }{\texttt{ 5 }}\texttt{ }\texttt{ }{\texttt{9}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}
\end{aligned}
$$ -->

<p>这个阶段，由于每个桶只需要被移动和扫描一次，所以时间复杂度是 $O(n)$ 。</p>

<h3 id="诱导排序lms子串">诱导排序LMS子串</h3>

<h4 id="诱导排序lms前缀">诱导排序LMS前缀</h4>

<p>将 LMS 前缀进行诱导排序，同 SA-IS 一样，这部分同后面对后缀的诱导排序完全一样（使用同一个函数），因此这里直接跳过。</p>

<p>给出结果：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_05.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{(}\texttt{12}\texttt{)}\texttt{(11)}\texttt{ (1 }\texttt{ }\texttt{ 5 }\texttt{ }\texttt{ 9 }\texttt{ }\texttt{ 2 }\texttt{ }\texttt{ 6}\texttt{) }\texttt{(10 }\texttt{ }\texttt{ 0) }\texttt{(4}\texttt{ }\texttt{ }\texttt{ 8 }\texttt{ }\texttt{ 3 }\texttt{ }\texttt{ 7)}
\end{aligned}
$$ -->

<h4 id="将已排序的lms子串放到sa尾部">将已排序的LMS子串放到SA尾部</h4>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_06.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{ }\texttt{E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }{\underline{\color{red}\texttt{12}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{5}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{9}}}
\end{aligned}
$$ -->

<h3 id="构建规模缩减的子目标串pat1">构建规模缩减的子目标串Pat1</h3>

<p>从左到右扫描 $\texttt{SA}$ 尾部的LMS子串，确定其大小关系“重命名”，将 $\texttt{SA[i]}$ 重命名的值存储在 $\texttt{SA}[\large\lfloor\frac{\texttt{SA}[i]}{2} \rfloor]$ 。</p>

<p>因为 LMS 字符并不相邻，所以不会有冲突，这样做是将重命名后的值按照所代表的子串在 $\texttt{Pat}$ 中的原顺序放置：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_07.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{ }\underline{\color{red}\texttt{1}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }\underline{\color{red}\texttt{1}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }\underline{\color{red}\texttt{2}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }\underline{\color{red}\texttt{0}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ 12 }\texttt{ }\texttt{ 1 }\texttt{ }\texttt{ 5 }\texttt{ }\texttt{ 9 }
\end{aligned}
$$ -->

<p>然后扫描 $\texttt{SA}$ ，收集这些重命名的值到 $\texttt{SA}$ 头部：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_08.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{ }\underline{\color{red}\texttt{1}}\texttt{ }\underline{\color{red}\texttt{1}}\texttt{ }\underline{\color{red}\texttt{2}}\texttt{ }\underline{\color{red}\texttt{0}}\texttt{ E }\texttt{ E }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ E }\texttt{ 12 }\texttt{ }\texttt{ 1 }\texttt{ }\texttt{ 5 }\texttt{ 9 }
\end{aligned}
$$ -->

<h3 id="通过递归解决pat1完成对lms后缀的排序">通过递归解决Pat1，完成对LMS后缀的排序</h3>

<p>同 SA-IS 一样，递归解决 $\texttt{SA}$ 头部的规模缩减的 $\texttt{Pat1}$ 的后缀排序，结果存到 $\texttt{SA}$ 尾部：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_09.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{ }\texttt{1 }\texttt{ }\texttt{ 1 }\texttt{ }\texttt{ 2 }\texttt{ }\texttt{ 0 }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{3}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{0}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{2}}}
\end{aligned}
$$ -->

<p>将 $\texttt{SA}$ 尾部的 $\texttt{SA1}$ 挪到 $\texttt{SA}$ 头部，重新从尾到头扫描 $\texttt{Pat}$ ，将其中 LMS 字符按照在 $\texttt{Pat}$ 中的顺序放到 $\texttt{SA}$ 尾部：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_10.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{ }{\underline{\color{red}\texttt{3}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{0}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{2}}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{5}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{9}}}\texttt{ }\texttt{ }{\underline{\color{red}\texttt{12}}}
\end{aligned}
$$ -->

<p>依照 $\texttt{SA}$ 尾部的“对照表”，将 $\texttt{SA1}$ 头部的 $\texttt{SA}$ 还原为 $\texttt{Pat}$ 中对应的 LMS 后缀的索引位置：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_11.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&{\underline{\color{red}\texttt{12}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{5}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{9}}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ 1 }\texttt{ }\texttt{ 5 }\texttt{ }\texttt{ 9 }\texttt{ 12 }
\end{aligned}
$$ -->

<p>将 $\texttt{SA}$ 头部的排好序的 LMS 后缀按顺序放入到对应的桶中（从尾部开始放）：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_12.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{(}{\underline{\color{red}\texttt{12}}}\texttt{)}\texttt{ }\texttt{(E)}\texttt{ (}\texttt{E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{1}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{5}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{9}}}\texttt{)}\texttt{ }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}
\end{aligned}
$$ -->

<h3 id="对pat1中所有的后缀进行诱导排序">对Pat1中所有的后缀进行诱导排序</h3>

<p>这一部分就是利用前面用过的内部计数器技巧，进行原地版的诱导排序。</p>

<p>假如我们已经有排好序的LMS后缀（在桶尾），来诱导L型后缀<sup id="fnref:induced-sort" role="doc-noteref"><a href="#fn:induced-sort" class="footnote" rel="footnote">4</a></sup>：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_13.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{Pat}:\qquad&\texttt{ }\texttt{ 7   6   6   9   9   6   6   9   9   6   7   1   0} \\
\texttt{SA}:\qquad&\texttt{(12) }\texttt{(E)}\texttt{ (}\texttt{E }\texttt{ }\texttt{ E }\texttt{ }{\texttt{ 1 }\texttt{ }{\texttt{ 5 }}\texttt{ }\texttt{ }{\texttt{9}}}\texttt{) }\texttt{(E }\texttt{ }\texttt{ E) }\texttt{(E}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}
\end{aligned}
$$ -->

<p>如同排序LMS字符一样，先对L型字符用特殊符号计数：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_14.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{Pat}:\qquad&\texttt{ }\texttt{ 7   6   6   9   9   6   6   9   9   6   7   1   0} \\
\texttt{SA}:\qquad&\texttt{(}{\texttt{12}}\texttt{)}\texttt{ }\texttt{(}{\underline{\color{red}\texttt{U}}}\texttt{)}\texttt{ }\texttt{(E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ 1 }\texttt{ }\texttt{ 5 }\texttt{ }{\texttt{ 9}}\texttt{) }\texttt{(}{\underline{\color{red}\texttt{M}}}\texttt{ }\texttt{ }\texttt{ E) }\texttt{(}{\underline{\color{red}\texttt{M}}}\texttt{ }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E }\texttt{ }\texttt{ E)}\\
\end{aligned}
$$ -->

<p>从左到右扫描SA，同对 LMS 字符排序一样，复杂一点的是判断 $\texttt{suf[SA[i] - 1]}$ 的类型，需要分类讨论（参考代码）：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_15.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{(}{\overrightarrow{\color{red}{\texttt{12}}}\texttt{)}\texttt{(}{\underline{\color{red}\texttt{11}}}}\texttt{)}\texttt{  (E   E   1   5   9) (M   E) (M   E   E   E)}\\
\texttt{SA}:\qquad&\texttt{(}\texttt{12}\texttt{)}\texttt{(}{\overrightarrow{\color{red}\texttt{11}}}\texttt{)}\texttt{  (E   E   1   5   9)}\texttt{(}{\underline{\color{red}\texttt{10}}}\texttt{ }\texttt{ }\texttt{ E)}\texttt{ (M   E   E   E)}\\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E  }\texttt{ }\texttt{ } {\overrightarrow{\color{red}{\texttt{1}}}}\texttt{ }\texttt{  5   9)}\texttt{(10 }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{0}}}\texttt{)}\texttt{ (M   E   E   E)}\\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E   1 }\texttt{ }\texttt{ } {\overrightarrow{\color{red}{\texttt{5}}}}\texttt{ }\texttt{  9)}\texttt{(10   0)}\texttt{ (}{\color{red}\texttt{M   1}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{4}}}\texttt{ }\texttt{ }\texttt{ E)}\\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E   1   5}\texttt{ }\texttt{ } {\overrightarrow{\color{red}{\texttt{9}}}}\texttt{)}\texttt{(10   0)}\texttt{ (}{\color{red}\texttt{M   2}}\texttt{ }\texttt{ }\texttt{ 4 }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{8}}}\texttt{)}\\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E   1   5   9)(10   0)}\texttt{ (}{\overrightarrow{\color{red}{\texttt{4}}}}\texttt{ }\texttt{ 8 }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{3}}}\texttt{ }\texttt{ }\texttt{ E}\texttt{)}\\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E   1   5   9)(10   0)}\texttt{ (4 }\texttt{ }\texttt{ }{\overrightarrow{\color{red}{\texttt{8}}}}\texttt{ }\texttt{ 3 }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{7}}}\texttt{)}\\
\end{aligned}
$$ -->

<p>区别于 SA-IS 的是，对一个类型字符诱导排序后，需要清理LMS字符以免对后面的原地诱导排序：</p>

<div class="sx-center"><img src="/../assets/img/sa16/sa16_16.png" title="" /></div>
<!-- $$
\begin{aligned}
\texttt{Index}:\qquad&\texttt{ }\texttt{ 0   1   2   3   4   5   6   7   8   9  10  11  12} \\
\texttt{SA}:\qquad&\texttt{(12)(11)}\texttt{  (E   E  }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{E}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{E}}}\texttt{ }\texttt{ }\texttt{ }{\underline{\color{red}\texttt{E}}}\texttt{)}\texttt{(10   0)}\texttt{ (4   8   3   7)}\\
\end{aligned}
$$ -->

<p>至于从 L 后缀诱导 S 后缀与从 LMS 后缀诱导 L 后缀完全对称，这里就不做多余介绍。</p>

<p>到这儿为止，诱导排序就完成了。</p>

<h4 id="实现">实现</h4>

<p>时间性能上和 SA-IS 没有显著差别，空间占用变为不到原来的 $\large\frac{1}{3}$ （代码量多 1 倍），算是不愧为原文 Optimal In-Place Suffix Sorting <sup id="fnref:in-place-sa-sort:1" role="doc-noteref"><a href="#fn:in-place-sa-sort" class="footnote" rel="footnote">1</a></sup>的标题。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">cmp</span><span class="p">::</span><span class="n">max</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">cmp</span><span class="p">::</span><span class="n">Ordering</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">slice</span><span class="p">::</span><span class="n">from_raw_parts_mut</span><span class="p">;</span>


<span class="k">const</span> <span class="n">LTYPE</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="k">const</span> <span class="n">STYPE</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="k">const</span> <span class="n">MAX_SA_VALUE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">const</span> <span class="n">EMPTY</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="n">MAX_SA_VALUE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">const</span> <span class="n">UNIQUE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="n">MAX_SA_VALUE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">const</span> <span class="n">MULTI</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="n">MAX_SA_VALUE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>  <span class="c1">// &gt;= 258</span>


<span class="k">fn</span> <span class="n">lms_str_cmp</span><span class="o">&lt;</span><span class="n">E</span><span class="p">:</span> <span class="nb">Ord</span><span class="o">&gt;</span><span class="p">(</span><span class="n">l1</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">E</span><span class="p">],</span> <span class="n">l2</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">E</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="n">Ordering</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">in</span> <span class="n">l1</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.zip</span><span class="p">(</span><span class="n">l2</span><span class="nf">.iter</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">cmp_res</span> <span class="o">=</span> <span class="n">x</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">cmp_res</span> <span class="o">!=</span> <span class="nn">Ordering</span><span class="p">::</span><span class="n">Equal</span> <span class="p">{</span> <span class="k">return</span> <span class="n">cmp_res</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="nn">Ordering</span><span class="p">::</span><span class="n">Equal</span>
<span class="p">}</span>

<span class="nd">#[inline]</span>
<span class="k">fn</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">prev</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">last_scanned_type</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">cur</span> <span class="o">&lt;</span> <span class="n">prev</span> <span class="p">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span> <span class="n">STYPE</span> <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> <span class="n">LTYPE</span> <span class="p">}</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">rename_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">patlastpos</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// 全部刷成bucket head</span>
    <span class="c1">//sa.fill(0);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">sa</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">sa</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1">// 将L-suffix刷成bucket head</span>
    <span class="c1">//sa.fill(0);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">sa</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="n">pat</span><span class="p">[</span><span class="n">patlastpos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="k">fn</span> <span class="nf">sort_lms_char</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
    <span class="c1">//sa.fill(EMPTY);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">sa</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span> <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>  <span class="c1">// pat[i + 1] is LMS type</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">lms_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">e_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">e_i</span><span class="p">];</span>

            <span class="k">if</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>  <span class="c1">// pat[i + 1] is LMS type</span>
                <span class="n">lms_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">UNIQUE</span> <span class="p">{</span>
                    <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// set counter</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// MUL = 2</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>  <span class="c1">// get counter</span>

                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// update counter</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">c</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">e</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">())</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
            <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// 逆序防止前面的覆盖后面的</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">c</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
            <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">lms_cnt</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">sort_lms_substr</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// step 1</span>
    <span class="nf">induced_sort</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>

    <span class="c1">// step 2</span>
    <span class="k">let</span> <span class="n">pat_last_pos</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">lms_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pat_last_pos</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">bucket_tail_ptr</span> <span class="o">=</span> <span class="n">pat_last_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// for renamed bucket ver</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>  <span class="c1">// 可以省略，但是为了书写代码方便</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// S type number of bucket</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">bucket</span> <span class="p">{</span>  <span class="c1">// reach new bucket</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">l</span><span class="p">]]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="p">{</span>  <span class="c1">// 扫描桶来计算桶中S字符数量，根据定义 当l=i时循环必然终止</span>
                <span class="k">let</span> <span class="n">pat_i</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">l</span><span class="p">];</span>             <span class="c1">// l &lt; i, 即 i - l &gt; 0, 0 &lt;= pat_i &lt; patlen - 1</span>
                <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">pat_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pat</span><span class="p">[</span><span class="n">pat_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="k">mut</span> <span class="n">k</span> <span class="o">=</span> <span class="n">pat_i</span><span class="p">;</span>
                    <span class="k">while</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">pat_i</span><span class="p">]</span> <span class="p">{</span> <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">}</span>
                    <span class="n">num</span> <span class="o">+=</span> <span class="n">pat_i</span> <span class="o">-</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>   <span class="c1">// bucket不含S字符，结束扫描</span>
                <span class="p">}</span>

                <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">bucket_tail_ptr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">bucket_tail_ptr</span><span class="p">]];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">bucket_tail_ptr</span> <span class="o">-</span> <span class="n">num</span>
        <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="p">{</span>
            <span class="n">sa</span><span class="p">[</span><span class="n">pat_last_pos</span> <span class="o">-</span> <span class="n">lms_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">lms_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sa</span><span class="p">[</span><span class="n">pat_last_pos</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>  <span class="c1">// i = 0</span>
    <span class="n">lms_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//sa[0..pat_last_pos - lms_cnt + 1].fill(EMPTY);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">pat_last_pos</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// PASS!</span>
<span class="k">fn</span> <span class="nf">construct_pat1</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">lms_cnt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">prev_lms_str_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">[(</span><span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">has_duplicated_char</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="o">..</span><span class="n">patlen</span> <span class="p">{</span>  <span class="c1">// 从警戒哨字符的下一个字符开始</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">while</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1">// 寻找suf(sa[i])右边第一个L字符，因为排除了警戒哨这个LMS后缀，所以必然不会越界</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
        <span class="k">while</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">patlen</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pat</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>  <span class="c1">// 找到suf(sa[i])右边第一个LMS字符</span>
        <span class="k">let</span> <span class="n">cur_lms_str_len</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">let</span> <span class="n">cmp_res</span> <span class="o">=</span> <span class="nf">lms_str_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">..</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cur_lms_str_len</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">..</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">prev_lms_str_len</span><span class="p">]);</span>

        <span class="k">if</span>  <span class="n">cmp_res</span> <span class="o">!=</span> <span class="nn">Ordering</span><span class="p">::</span><span class="n">Equal</span> <span class="p">{</span>
            <span class="n">rank</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">sa</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">has_duplicated_char</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="n">rank_index</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">sa</span><span class="p">[</span><span class="n">rank_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span><span class="p">;</span>  <span class="c1">// 整除</span>

        <span class="n">prev_lms_str_len</span> <span class="o">=</span> <span class="n">cur_lms_str_len</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// move to head of sa</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EMPTY</span> <span class="p">{</span>
            <span class="n">sa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span> <span class="p">{</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//sa[lms_cnt..patlen].fill(EMPTY);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">lms_cnt</span><span class="o">..</span><span class="n">patlen</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span> <span class="p">}</span>

    <span class="n">has_duplicated_char</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">sort_lms_suf</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">lms_cnt</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">has_duplicated_char</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// solve T1 recursively</span>
    <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">salen</span> <span class="o">=</span> <span class="n">sa</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">sa_ptr</span> <span class="o">=</span> <span class="n">sa</span><span class="nf">.as_mut_ptr</span><span class="p">();</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">pat1</span> <span class="o">=</span> <span class="nf">from_raw_parts_mut</span><span class="p">(</span><span class="n">sa_ptr</span><span class="p">,</span> <span class="n">lms_cnt</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">sa1</span> <span class="o">=</span> <span class="nf">from_raw_parts_mut</span><span class="p">(</span><span class="n">sa_ptr</span><span class="nf">.offset</span><span class="p">((</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span><span class="p">)</span> <span class="k">as</span> <span class="nb">isize</span><span class="p">),</span> <span class="n">salen</span> <span class="o">-</span> <span class="p">(</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span><span class="p">));</span>

        <span class="k">if</span> <span class="n">has_duplicated_char</span> <span class="p">{</span>
            <span class="nf">_compute_suffix_array_16_1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">pat1</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">sa1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">lms_cnt</span> <span class="p">{</span> <span class="n">sa1</span><span class="p">[</span><span class="n">pat1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// move SA1 to SA[0...n1-1]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">lms_cnt</span> <span class="p">{</span>
        <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">patlen</span><span class="o">-</span> <span class="n">lms_cnt</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// put all LMS-suffixes in SA tail</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">||</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// backward map the LMS-suffixes rank</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">lms_cnt</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">relative_rank</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="o">+</span> <span class="n">relative_rank</span><span class="p">];</span>
        <span class="n">sa</span><span class="p">[</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">lms_cnt</span> <span class="o">+</span> <span class="n">relative_rank</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">rfp</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="n">lms_cnt</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// sa[0] 保持原位</span>
        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">tail</span> <span class="p">{</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
            <span class="n">rfp</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sa</span><span class="p">[</span><span class="n">rfp</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="n">rfp</span> <span class="o">!=</span> <span class="n">i</span> <span class="p">{</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span> <span class="p">}</span>
        <span class="n">rfp</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// PASS!</span>
<span class="k">fn</span> <span class="nf">induced_sort</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>

    <span class="c1">// place L-suff in SA</span>
    <span class="c1">// init</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">LTYPE</span> <span class="p">{</span>
            <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// &gt;= EMPTY</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//place</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">patlen</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">j</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">is_ltype</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
                <span class="n">is_ltype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span>  <span class="c1">// 判断sa[i]是否是L后缀的编号</span>
                <span class="k">let</span> <span class="n">next_i</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]];</span>
                <span class="k">if</span> <span class="n">next_i</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="p">{</span>
                    <span class="n">is_ltype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">next_i</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">patlen</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="n">is_ltype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="p">{</span>
                            <span class="n">is_ltype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">is_ltype</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">UNIQUE</span> <span class="p">{</span>
                    <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">-</span> <span class="n">EMPTY</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// set counter</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
                    <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="k">let</span> <span class="n">lfp</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="k">if</span>  <span class="n">c</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">-</span> <span class="n">EMPTY</span> <span class="p">{</span>  <span class="c1">// 没到bucket尾部</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">lfp</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// update counter</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                        <span class="p">}</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span>
                            <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">..</span><span class="n">patlen</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="p">{</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// remove LMS-suff form SA, 一个桶里可能有多个LMS后缀</span>
    <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">last_scanned_type</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>  <span class="c1">// pat[i + 1] is LMS type</span>
                <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">UNIQUE</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">EMPTY</span><span class="p">;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">c</span> <span class="p">{</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// place S-suff in SA</span>
    <span class="c1">// init</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">pat_char_type</span><span class="p">(</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">last_scanned_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">STYPE</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">EMPTY</span> <span class="p">{</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">UNIQUE</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">STYPE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">last_scanned_type</span> <span class="o">=</span> <span class="n">LTYPE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">j</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">is_stype</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
                <span class="n">is_stype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">{</span>  <span class="c1">// 判断sa[i]是否是S后缀的编号</span>
                <span class="k">let</span> <span class="n">next_i</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]];</span>
                <span class="k">if</span> <span class="n">next_i</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="p">{</span>
                    <span class="n">is_stype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">next_i</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="n">is_stype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="p">{</span>
                            <span class="n">is_stype</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">is_stype</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">UNIQUE</span> <span class="p">{</span>
                    <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">-</span> <span class="n">EMPTY</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// set counter</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
                    <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">-</span> <span class="n">EMPTY</span><span class="p">;</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="p">{</span>  <span class="c1">// 没到bucket头部</span>
                        <span class="k">let</span> <span class="n">rfp</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">rfp</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                        <span class="p">}</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                        <span class="n">sa</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">;</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">{</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">EMPTY</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="p">{</span>
                            <span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MULTI</span> <span class="p">{</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">_compute_suffix_array_16_1</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">],</span> <span class="n">sa</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="nb">usize</span><span class="p">])</span> <span class="p">{</span>
    <span class="nf">rename_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">lms_cnt</span> <span class="o">=</span> <span class="nf">sort_lms_char</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
    <span class="nf">sort_lms_substr</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">has_duplicated_char</span> <span class="o">=</span> <span class="nf">construct_pat1</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">lms_cnt</span><span class="p">);</span>
    <span class="nf">sort_lms_suf</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">lms_cnt</span><span class="p">,</span> <span class="n">has_duplicated_char</span><span class="p">);</span>
    <span class="nf">induced_sort</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">suffix_array_16</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.into_iter</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="o">*</span><span class="n">x</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span><span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;&gt;</span><span class="p">();</span>
    <span class="n">pat</span><span class="nf">.push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sa</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="nf">max</span><span class="p">(</span><span class="n">pat</span><span class="nf">.len</span><span class="p">(),</span> <span class="mi">256</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">];</span>
    <span class="nf">_compute_suffix_array_16_1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">pat</span><span class="p">[</span><span class="o">..</span><span class="p">],</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">sa</span><span class="p">[</span><span class="o">..</span><span class="p">]);</span>

    <span class="n">sa</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">input</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">io</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">input</span> <span class="o">=</span> <span class="nn">String</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="nn">io</span><span class="p">::</span><span class="nf">stdin</span><span class="p">()</span><span class="nf">.read_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">input</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="nn">String</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">input</span><span class="nf">.trim</span><span class="p">())</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="nf">input</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">sa_16</span> <span class="o">=</span> <span class="nf">suffix_array_16</span><span class="p">(</span><span class="n">pat</span><span class="nf">.as_bytes</span><span class="p">());</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span> <span class="nd">print!</span><span class="p">(</span><span class="s">"{} "</span><span class="p">,</span> <span class="n">sa_16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="在只读的整形字母表上的后缀排序">在只读的整形字母表上的后缀排序</h2>

<p>使用复杂方法解决复杂问题，通过分治，解决空间紧张的问题。</p>

<p>算法实现的难点在于在 $\texttt{SA}$ 上构建BitMaps<sup id="fnref:np12" role="doc-noteref"><a href="#fn:np12" class="footnote" rel="footnote">5</a></sup>，来替代本来由重命名后的T所指示的指示桶尾/桶头的位置。</p>

<p>这里的BitMaps指得是使用比特向量（bit vector）表示的有序字典（multiset），是一种紧凑型结构（compact data structure）。</p>

<p>有兴趣了解的暂时只能阅读原文以及本文引用的BitMaps的有关论文自行了解。</p>

<h2 id="在只读的一般字母表上的后缀排序">在只读的一般字母表上的后缀排序</h2>

<p>前置知识是归并排序和堆排序。</p>

<p>由于笔者对于其中确定字符类型的方法的时间复杂度有疑问，这里也不再介绍，建议阅读原文自行了解。</p>

<h2 id="注解">注解</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:in-place-sa-sort" role="doc-endnote">
      <p>Li, Zhize; Li, Jian; Huo, Hongwei (2016). <em>Optimal In-Place Suffix Sorting</em>. Proceedings of the 25th International Symposium on String Processing and Information Retrieval (SPIRE). Lecture Notes in Computer Science. 11147. Springer. pp. 268–284. arXiv:1610.08305. doi:10.1007/978-3-030-00479-8_22. ISBN:978-3-030-00478-1. <a href="#fnref:in-place-sa-sort" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:in-place-sa-sort:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:nzc09a" role="doc-endnote">
      <p>Ge Nong, Sen Zhang, and Wai Hong Chan. Linear suffix array construction by almost pure induced-sorting. In Data Compression Conference (DCC), pages 193–202. IEEE, 2009. <a href="#fnref:nzc09a" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:sa-is" role="doc-endnote">
      <p>推荐阅读 <a href="https://riteme.site/blog/2016-6-19/sais.html">博文</a> 和它的 <a href="https://github.com/riteme/riteme.github.io/issues/28">issue列表</a> <a href="#fnref:sa-is" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:induced-sort" role="doc-endnote">
      <p>如果是LML后缀，就先诱导S型后缀，唯一区别是计算LML后缀时需要将警戒哨也算进去。 <a href="#fnref:induced-sort" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:np12" role="doc-endnote">
      <p>Gonzalo Navarro and Eliana Providel. Fast, small, simple rank/select on bitmaps. In Proc. 11th International Symposium on Experimental Algorithms (SEA), pages 295–306, 2012. <a href="#fnref:np12" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>

    <div id="toc-wrapper" class="pl-0 pr-4 mb-5 post__toc">
      <nav id="toc" data-toggle="toc"></nav>
    </div>

  </div>

</article>

    </main>

    <div class="page__comment">
        <script src="https://giscus.app/client.js"
            data-repo="minghu6/minghu6.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnkxMTI3NDIxOTA="
            data-category="Announcements"
            data-category-id="DIC_kwDOBrhPLs4CSYaE"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="1"
            data-input-position="top"
            data-theme="preferred_color_scheme"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
        </script>
    </div>
</div>

    <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">© minghu6</p>
                
                <span class="divider">·</span>
                
                <span class="footer__about__theme"><p>theme</p><a id="simplex-logo" href="https://github.com/andreondra/jekyll-theme-simplex" target="_blank"><img alt="Simplex theme logo" src="/assets/img/icons/simplex_logo.svg"/></a><p>by <a href="https://ondrej.golasowski.com/">golas</a></p></span>
        </section>
</footer>

    <script src="/assets/js/jquery.slim.min.js"></script>
<script src="/assets/js/lity.min.js"></script>
<script src="/assets/js/tools.js"></script>


<script type="text/javascript" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>


<!-- <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script> -->
<script>
  MathJax = {
  tex: {
    inlineMath: [
      ['$','$'],
      ['\\(','\\)']
    ],
    displayMath: [
      ['$$', '$$'],
      ['\\[', '\\]']
    ]
  }
}
</script>

<!-- <script>
var navSelector = "#toc";
// only show two levels
$("body").scrollspy({
  target: navSelector,
});
</script> -->


    <!--
Jekyll Simple Search loader
See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->



<script src="/assets/js/simple-jekyll-search.min.js"></script>

<script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: "/assets/search.json",
    searchResultTemplate: '  <div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0 justify-content-center">    <a href="{url}">{title}</a>    <div class="post__meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">      {categories}    </div>    <p>{snippet}</p>  </div>',
    noResultsText: '<p class="mt-5">No result</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }
    }
  });

  $(function() {
    const btnSearchTrigger = $("#search-trigger");
    const btnCancel = $("#search-cancel");
    const main = $(".main");
    const topbarTitle = $("#topbar-title");
    const searchWrapper = $("#search-wrapper");
    const resultWrapper = $("#search-result-wrapper");
    const results = $("#search-results");
    const input = $("#search-input");
    const hints = $("#search-hints");

    const scrollBlocker = (function() {
      let offset = 0;
      return {
        block() {
          offset = window.scrollY;
          $("html,body").scrollTop(0);
        },
        release() {
          $("html,body").scrollTop(offset);
        },
        getOffset() {
          return offset;
        }
      };
    }());

/*--- Actions in mobile screens (Sidebar hidden) ---*/

    const mobileSearchBar = (function() {
      return {
        on() {
          topbarTitle.addClass("unloaded");
          btnSearchTrigger.addClass("unloaded");
          searchWrapper.addClass("d-flex");
          btnCancel.addClass("loaded");
        },
        off() {
          btnCancel.removeClass("loaded");
          searchWrapper.removeClass("d-flex");
          topbarTitle.removeClass("unloaded");
          btnSearchTrigger.removeClass("unloaded");
        }
      };
    }());

    const resultSwitch = (function() {
      let visible = false;

      return {
        on() {
          if (! visible) {
            scrollBlocker.block();
            resultWrapper.removeClass("unloaded");
            main.addClass("unloaded");
            visible = true;
          }
        },
        off() {
          if (visible) {
            results.empty();
            if (hints.hasClass("unloaded")) {
              hints.removeClass("unloaded");
            }
            resultWrapper.addClass("unloaded");
            main.removeClass("unloaded");
            scrollBlocker.release();

            input.val("");
            visible = false;
          }
        },
        isVisible() {
          return visible;
        }
      };

    }());

    function isMobileView() {
      return btnCancel.hasClass("loaded");
    }

    btnSearchTrigger.click(function() {
      mobileSearchBar.on();
      resultSwitch.on();
      input.focus();
    });

    btnCancel.click(function() {
      mobileSearchBar.off();
      resultSwitch.off();
    });

    input.focus(function() {
      searchWrapper.addClass("input-focus");
    });

    input.focusout(function() {
      searchWrapper.removeClass("input-focus");
    });

    input.on("input", () => {
      if (input.val() === "") {
        if (isMobileView()) {
          hints.removeClass("unloaded");
        } else {
          resultSwitch.off();
        }

      } else {
        resultSwitch.on();
        if (isMobileView()) {
          hints.addClass("unloaded");
        }
      }
    });

  });
</script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
<script src="https://kit.fontawesome.com/f1af9f22fa.js" crossorigin="anonymous"></script>


</body>
</html>
