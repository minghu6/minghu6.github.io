<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="/assets/style.css"/>
<link rel="stylesheet" href="/assets/js/lity.min.css"/>


<link rel='shortcut icon' type='image/jpeg' href='/d2.jpg' />


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="MINGHU6's Blog" />
<meta
    property="og:title"
    content="
        
            Boyer-Mooreç®—æ³•
        
    "
/>

<meta property="og:url" content="//algs/BM.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        Boyer-Mooreç®—æ³•
    
</title>

</head>
<body class="index" data-spy="scroll" data-target="#toc" tabindex="0">

    <div class="header">
    <div id="topbar" class="d-flex align-items-center justify-content-between h-100">
  <span id="breadcrumb">

    

    

    

    
    <span>
      <a href="/">
        <img src="/assets/img/icons/home.png">
      </a>
    </span>
    

    

    

    

    

    

    
  </span><!-- endof #breadcrumb -->

  <section class="logo">
    <a href="/" class="logo__link">
      
      <img class="logo__link__img" src="/d3.jpg" />
      
    </a>
  </section>

  <span id="search-wrapper" class="align-items-center">
    <!-- <i class="fas fa-search fa-fw"></i> -->
    <img src="/assets/img/icons/search.png">
    <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off"
      placeholder="Search...">
  </span>
  <span id="search-cancel">Cancel</span>

</div>


    

    <nav class="menu">
        
    </nav>
</div>


    <div class="page main">
    <main class="page__main" id="core-wrapper">
        <article class="post">

  <div class="post__title">
    <h1 class="post__title__text">Boyer-Mooreç®—æ³•</h1>
  </div>
  <div class="post__meta">
    <div class="post__meta__category">
      
        
        <a href="/category/algs.html">
          <p class="post__meta__category__title" style="background: var(--c-themeHueOrange)">
            Algorithm
          </p>
        </a>
      
    </div>
    <p class="post__meta__divider">Â·</p>
    <div class="post__meta__date">
      August 01, 2020
    </div>
    
  </div>

  

  <div class="post__content_container">
    <div class="post__content"><p>author: minghu6</p>

<p><em>(2nd) revised at 2024-10-29</em></p>

<p><em>æœ¬ç« èŠ‚å†…å®¹éœ€è¦ä»¥ã€Šå‰ç¼€å‡½æ•°ä¸KMPç®—æ³•ã€‹ä½œä¸ºå‰ç½®ç« èŠ‚ã€‚</em></p>

<p>ä¹‹å‰çš„KMPç®—æ³•å°†å‰ç¼€åŒ¹é…çš„ä¿¡æ¯ç”¨åˆ°äº†æè‡´ï¼Œ</p>

<p>è€Œ BM ç®—æ³•èƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯é€šè¿‡ <strong>åç¼€åŒ¹é…</strong> è·å¾—æ¯”å‰ç¼€åŒ¹é…æ›´å¤šçš„ä¿¡æ¯æ¥å®ç°æ›´å¿«çš„è·³è½¬ã€‚</p>

<h2 id="åŸºç¡€ä»‹ç»">åŸºç¡€ä»‹ç»</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„çš„æ¨¡å¼å­—ç¬¦ä¸² $\texttt{pat}$ ï¼Œè¢«æ”¾åœ¨æ–‡æœ¬å­—ç¬¦ä¸² $\texttt{string}$ çš„å¤´éƒ¨ï¼Œä½¿å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¯¹é½ã€‚</p>

\[\begin{aligned}
\qquad \texttt{pat}:\qquad &amp;\texttt{EXAMPLE} \\
\texttt{string}:\qquad &amp;\texttt{HERE IS A SIMPLE EXAMPLE} \dots \\
&amp;\qquad\ \ \ \, \Uparrow
\end{aligned}\]

<p>$\texttt{pat}$ çš„é•¿åº¦ä¸º $\texttt{\texttt{patlen}}$</p>

<p>$\texttt{string}$ çš„é•¿åº¦ $\texttt{stringlen}$ã€‚</p>

<p><em>æŒ‰ç…§ç®—æ³•æƒ¯ä¾‹ï¼Œè®¾å®šå­—ç¬¦ä¸²çš„åŸºåº•ä¸º $1$</em></p>

<p>è¿½è¸ªä¸‹ $\texttt{string}$ ä¸Šçš„ç¬¬ $\texttt{patlen}$ ä¸ªå­—ç¬¦ $\texttt{char}$ ï¼Œè€ƒè™‘æˆ‘ä»¬èƒ½å¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼š</p>

<h3 id="è§‚å¯Ÿ-1">è§‚å¯Ÿ 1</h3>

<p>å¦‚æœæˆ‘ä»¬çŸ¥é“ $\texttt{char}$ ä¸åœ¨ $\texttt{pat}$ ä¸­,  å¯ä»¥ç›´æ¥å°† $\texttt{pat}$ å’Œ $\texttt{string}$ æŒ‡é’ˆå‘ä¸‹æ»‘åŠ¨ $\texttt{patlen}$ ä¸ªå­—ç¬¦ï¼ˆç„¶åé‡æ–°å¼€å§‹åç¼€åŒ¹é…ï¼‰ã€‚</p>

<h3 id="è§‚å¯Ÿ-2">è§‚å¯Ÿ 2</h3>

<p>å¦‚æœæˆ‘ä»¬çŸ¥é“ $\texttt{char}$ åœ¨ $\texttt{pat}$ ä¸­ï¼Œå¹¶ä¸”ç¦»å°¾ç«¯è‡³å°‘æœ‰ $\Delta_1$ ä¸ªå­—ç¬¦ï¼Œå¯ä»¥ç›´æ¥å°† $\texttt{pat}$ å’Œ $\texttt{string}$ æŒ‡é’ˆå‘ä¸‹æ»‘åŠ¨ $\Delta_1$ ä¸ªå­—ç¬¦ã€‚</p>

<p>ä»¥å¤±é…å­—ç¬¦ $\texttt{char}$ ä¸ºå‚æ•°ï¼Œåœ¨ $\texttt{pat}$ ä¸Šæ„å»ºè®¡ç®— $\Delta_1$ çš„å‡½æ•°ï¼Œï¼š</p>

\[\begin{array}{ll}
\textbf{int}\ \texttt{delta1} (\textbf{char}\ \texttt{char}) \\
\qquad \textbf{if}\ \texttt{char} \notin \texttt{pat}\\
\qquad\qquad\textbf{return}\ \texttt{patlen} \\
\qquad \textbf{else} \\
\qquad\qquad\textbf{return}\ \texttt{patlen} - i\ \ \text{/* } i = \max\lbrace i\vert\ 
\texttt{pat}[i] = \texttt{char} \rbrace  \text{ */}
\end{array}\]

<h3 id="è§‚å¯Ÿ-3-a">è§‚å¯Ÿ 3-a</h3>

<p>å‡è®¾ä¸æ˜¯åœ¨ $\texttt{pat}$ çš„æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œè€Œæ˜¯å€’æ•°ç¬¬ $m+1$ ä¸ªå­—ç¬¦ä¸Šå¤±é…ï¼Œé‚£ä¹ˆ $\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $k = \Delta_1 - m$ ï¼Œè€Œ $\texttt{string}$ æŒ‡é’ˆä»ç„¶å‘ä¸‹æ»‘åŠ¨ $k + m = \Delta_1$ ï¼ˆå› ä¸ºè¦é‡æ–°ä»å°¾éƒ¨å¼€å§‹åŒ¹é…ï¼‰ã€‚</p>

<h3 id="è§‚å¯Ÿ-3-b">è§‚å¯Ÿ 3-b</h3>

<p>å‡è®¾åœ¨å€’æ•°ç¬¬ $m+1$ ä¸ªå­—ç¬¦ä¸Šå¤±é…ï¼Œå·²åŒ¹é…å®Œçš„ $m$ ä¸ªå­—ç¬¦çš„åç¼€å­ä¸²ä¸º $\texttt{subpat}$ï¼Œä½œè€…æŠŠ $\texttt{pat}$ ä¸Šæ‰€æœ‰ä¸åç¼€å­ä¸² $\texttt{subpat}$ ç›¸ç­‰çš„å­ä¸²ç§°ä¸º plausible reoccurrenceï¼Œå…¶ä¸­æœ€å³è¾¹çš„ $\texttt{subpat}$ ç§°ä¸º rightmost plausible reoccurrence ï¼Œç®€ç§° $\texttt{rpr}$ ã€‚</p>

<p>å®šä¹‰ $\texttt{rpr}(j)$ è¡¨ç¤ºåç¼€å­ä¸² $\texttt{pat}[j+1\dots]$ çš„ $\texttt{rpr}$ çš„èµ·å§‹ä½ç½®ï¼Œå¾—åˆ° $\Delta_2$ ï¼š</p>

\[\begin{array}{ll}
\textbf{int}\ \texttt{delta2}(\textbf{int}\ j) \ \ \text{/* jä¸ºå¤±é…å­—ç¬¦ç´¢å¼• */} \\

\qquad\textbf{return}\ \texttt{patlen} + 1 -\texttt{rpr}(j) \\

\end{array}\]

<p>è¿™æ ·åœ¨å¤±é…æ—¶ï¼Œ $\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $\max(\Delta_1,\Delta_2) - m$ ï¼Œ$\texttt{string}$ ä¸Šçš„æŒ‡é’ˆå‘ä¸‹æ»‘åŠ¨ $\max(\Delta_1,\Delta_2)$  ï¼ˆå…¨éƒ½éœ€è¦é‡æ–°ä»å°¾éƒ¨å¼€å§‹åŒ¹é…ï¼‰ã€‚</p>

<h3 id="å®ä¾‹è¯´æ˜">å®ä¾‹è¯´æ˜</h3>

<p>ç®­å¤´æŒ‡å‘å¤±é…å­—ç¬¦ $\texttt{char}$ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad\ \ \ \Uparrow
\end{aligned}\]

<p>$\texttt{F}$ ä¸åœ¨ $\texttt{pat}$ ä¸­ï¼Œæ ¹æ® <strong>è§‚å¯Ÿ 1</strong> ï¼ŒæŠŠ $\texttt{pat}$ ç›´æ¥å‘ä¸‹æ»‘åŠ¨ $\texttt{patlen}$ ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ $7$ ä¸ªå­—ç¬¦ï¼›</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\quad\ \ \, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad\ \ \, \ \qquad\quad\ \ \ \Uparrow
\end{aligned}\]

<p>æ ¹æ® <strong>è§‚å¯Ÿ 2</strong>ï¼Œæˆ‘ä»¬éœ€è¦å°† $\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $4$ ä¸ªå­—ç¬¦ä½¿å¾— $\texttt{_}$ å­—ç¬¦å¯¹é½ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\qquad\quad\ \ \, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad\ \ \, \qquad\qquad\qquad \Uparrow
\end{aligned}\]

<p>ç°åœ¨$\texttt{char:\ T}$ åŒ¹é…äº†ï¼ŒæŠŠæŒ‡é’ˆå‘å‰ä¸€æ­¥ï¼Œç»§ç»­åŒ¹é…ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\qquad\quad\ \ \, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad \; \qquad\qquad\quad\ \ \ \Uparrow
\end{aligned}\]

<p>åœ¨ $\texttt{L}$ ä¸Šå¤±é…ï¼Œå› ä¸º $\texttt{L}$ ä¸åœ¨ $\texttt{pat}$ ä¸­ï¼Œæ ¹æ® <strong>è§‚å¯Ÿ 3-a</strong> ï¼Œ$\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $k= \Delta_1-m=7-1=6$ ä¸ªå­—ç¬¦ï¼Œè€Œ $\texttt{string}$ ä¸ŠæŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ $\Delta_1=7$ ä¸ªå­—ç¬¦ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\qquad\qquad\qquad\ \ \,\, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad\ \ \ \; \qquad\qquad\qquad\qquad\ \ \ \Uparrow
\end{aligned}\]

<p>è¿™æ—¶ $\texttt{char}$ åˆä¸€æ¬¡åŒ¹é…åˆ°äº† $\texttt{pat}$ çš„æœ€åä¸€ä¸ªå­—ç¬¦ $\texttt{T} $ï¼Œç»§ç»­å‘å‰åŒ¹é…ï¼ŒåŒ¹é…åˆ°äº† $\texttt{A}$ ï¼Œå†å‘å‰åŒ¹é…ï¼Œå‘ç°åœ¨å­—ç¬¦ $\texttt{-}$ å¤±é…ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\qquad\qquad\qquad\ \ \,\, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad\ \, \ \qquad\qquad\qquad\quad\ \ \ \,\, \Uparrow
\end{aligned}\]

<p>æ­¤æ—¶æ ¹æ® <strong>è§‚å¯Ÿ 3-b</strong> ï¼Œ$\Delta_1=4$ï¼Œ$\Delta_2=7-0 = 7$ï¼Œå³ $\texttt{string}$ ä¸ŠæŒ‡é’ˆå‘ä¸‹æ»‘åŠ¨ $\max(\Delta_1,\Delta_2)= 7$ï¼Œ $\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $\max(\Delta_1,\Delta_2)-m= 7-2=5$ï¼Œä½¿å¾—åç¼€ $\texttt{AT}$ å¯¹é½ï¼š</p>

\[\begin{aligned}
\texttt{pat}:\qquad\qquad &amp;\qquad\qquad\qquad\qquad\qquad\quad \;\, \texttt{AT-THAT} \\
\texttt{string}:\ \ \ \dots\ &amp;\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&amp;\qquad \ \, \ \quad\qquad\qquad\qquad\qquad\quad \ \ \; \Uparrow
\end{aligned}\]

<p>ç°åœ¨æˆ‘ä»¬åœ¨ $\texttt{string}$ ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª $\texttt{pat}$ çš„åŒ¹é…ã€‚è€Œæˆ‘ä»¬åªèŠ±è´¹äº†$14$ æ¬¡å¯¹ $\texttt{string}$ çš„å¼•ç”¨ï¼Œå…¶ä¸­ $7$ æ¬¡æ˜¯å®Œæˆä¸€ä¸ªæˆåŠŸçš„åŒ¹é…æ‰€å¿…éœ€çš„æ¯”è¾ƒæ¬¡æ•°ï¼ˆ $\texttt{patlen}=7$ ï¼‰ï¼Œå¦å¤– $7$ æ¬¡è®©æˆ‘ä»¬è·³è¿‡äº† $22$ ä¸ªå­—ç¬¦ï¼</p>

<h2 id="ç®—æ³•è®¾è®¡">ç®—æ³•è®¾è®¡</h2>

<h3 id="åŒ¹é…ç®—æ³•">åŒ¹é…ç®—æ³•</h3>

\[\begin{array}{ll}
i \gets \texttt{patlen}. \\ 
\\
\textbf{loop}\\
\qquad \textbf{if}\ i &gt; \texttt{stringlen} \\
\qquad \qquad \textbf{return}\ \texttt{false} \\
\\
\qquad j \gets \texttt{patlen} \\
\\
\qquad \textbf{loop}
\\
\qquad\qquad \textbf{if}\ j &lt; 1 \\
\qquad\qquad\qquad \textbf{return}\ i+1 \\
\\
\qquad\qquad\textbf{if}\ \texttt{string}[i]=\texttt{pat}[j] \\
\qquad\qquad\qquad j \gets j-1 \\
\qquad\qquad\qquad i \gets i-1 \\
\\
\qquad\qquad\qquad \textbf{continue} \\
\\
\qquad\qquad\textbf{break}\\
\\
\qquad i \gets i+\max(\texttt{delta1}(\texttt{string}[i]), \texttt{delta2}(j)) \\
\\
\end{array}\]

<p>$i$ è¡¨ç¤º $\texttt{string}$ ä¸Šçš„å…¨å±€æŒ‡é’ˆï¼Œ$j$ è¡¨ç¤º $\texttt{pat}$ å±€éƒ¨æŒ‡é’ˆã€‚</p>

<p>$\textbf{return}\ \texttt{false}$ è¡¨ç¤º $\texttt{pat}$ ä¸åœ¨ $\texttt{string}$ ä¸­ï¼Œè¿”å›æ•°å­—è¡¨ç¤º $\texttt{pat}$ åœ¨ $\texttt{string}$ å·¦èµ·ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ã€‚</p>

<h3 id="textttrprj">$\texttt{rpr}(j)$</h3>

<p>è®©æˆ‘ä»¬å®Œæ•´å®šä¹‰ä¸‹ $\texttt{rpr}(j)$ å‡½æ•°ã€‚</p>

<p>æ ¹æ®å‰æ–‡å®šä¹‰ï¼Œ$\texttt{rpr}(j)$ è¡¨ç¤º $\texttt{subpat}=\texttt{pat}[j+1\dots]$ åœ¨ $\texttt{pat}$ ä¸Šæœ€å³è¾¹ç›¸ç­‰å­ä¸²çš„èµ·å§‹ä½ç½®ã€‚</p>

<p>å‡è®¾æ‰¾åˆ°çš„ $\texttt{rpr}$ å­—ä¸²ä¸º $\texttt{pat}[k\dots k+\texttt{patlen}-j-1]=\texttt{subpat}$ï¼Œé¦–å…ˆå…è®¸æ‹“å±• $k$ åˆ° $k \lt 1$ ï¼Œç›¸å½“äºåœ¨ $\texttt{pat}$ å‰é¢è¡¥å……ä¸€æ®µè™šæ‹Ÿå‰ç¼€ï¼Œè¿™å°±å‘ä¸‹å…¼å®¹äº†æ‰€æœ‰å¯èƒ½çš„ plausible reoccurrence æƒ…å†µã€‚</p>

<p>å¦å¤–å½“ $k&gt;1$ æ—¶ï¼Œè€ƒè™‘ä¸€ç§ä¼˜åŒ–ï¼Œå¦‚æœ $\texttt{pat}[k]=\texttt{pat}[j]$ ï¼Œé‚£ä¹ˆæ˜¾ç„¶ $\texttt{pat}[k\dots k+\texttt{patlen}-j-1]$ å°±æ˜¯ä¸€ä¸ªæ— æ•ˆçš„ plausible reoccurrence ï¼Œå› ä¸º $pat[j]$ æœ¬èº«æ˜¯å¤±é…å­—ç¬¦ï¼Œé‚£ä¹ˆå‘ä¸‹æ»‘åŠ¨åé‡æ–°ä»å°¾éƒ¨å¼€å§‹åŒ¹é…ï¼Œåœ¨ $\texttt{pat}[k]$ å¤„è¿˜æ˜¯ä¼šå¤±é…ã€‚</p>

<p>æœ€åè€ƒè™‘åˆ° $\texttt{delta2}(\texttt{patlen}) = 0$ ï¼Œ æ‰€ä»¥è®¾ç½® $\texttt{rpr}(\texttt{patlen}) = \texttt{patlen}$ ã€‚</p>

<h4 id="å®ä¾‹è¯´æ˜-1">å®ä¾‹è¯´æ˜</h4>

\[\begin{aligned}
\textit{j}:&amp; &amp;\texttt{1 2 3 4 5 6 7 8 9} \\
\texttt{pat}:&amp; &amp;\texttt{A B C X X X A B C} \\
\texttt{rpr}(j):&amp; &amp;\texttt{4 3 2 1 0 2 1 0 9} \\
\text{sign}:&amp; &amp;\texttt{- - - - - - - - +}
\end{aligned}\]

<p>$j = 1$ ï¼Œ$\texttt{subpat = BCXXXABC}$ï¼Œ $\texttt{[(BCXXX)ABC]XXXABC}$ï¼Œ$\texttt{rpr}(1)=-4$ï¼›</p>

<p>$j = 6$ ï¼Œ$\texttt{subpat = ABC}$ï¼Œ$\texttt{[ABC]XXXABC}$ï¼Œ$\texttt{rpr}(6)=1$ï¼›</p>

<p>$j = 7$ ï¼Œ$\texttt{subpat = BC}$ï¼Œ$\texttt{A[BC]XXXABC}$ï¼Œåˆå› ä¸º $\texttt{pat}[1]=\texttt{pat}[7]$ï¼Œæ‰€ä»¥æ”¹ä¸º $\texttt{[(BC)]ABCXXXABC}$ ï¼Œæ‰€ä»¥ $\texttt{rpr}(j)=-1$ï¼›</p>

<p>$j = 9 = \texttt{patlen}$ï¼Œæ ¹æ®å®šä¹‰ï¼Œ$\texttt{rpr}(9)= \texttt{patlen}=9$ã€‚</p>

<p>ä»¥åŠå¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p>

\[\begin{aligned}
\textit{j}:&amp; &amp;\texttt{1 2 3 4 5 6 7 8 9} \\
\texttt{pat}:&amp; &amp;\texttt{A B Y X C D E Y X} \\
\texttt{rpr}(j):&amp; &amp;\texttt{7 6 5 4 3 2 3 0 9} \\
\text{sign}:&amp; &amp;\texttt{- - - - - - + - +}
\end{aligned}\]

<h3 id="åŒ¹é…ç®—æ³•çš„æ”¹è¿›">åŒ¹é…ç®—æ³•çš„æ”¹è¿›</h3>

<p>æœ€åï¼Œå®è·µè¿‡ç¨‹ä¸­è€ƒè™‘åˆ°æœç´¢è¿‡ç¨‹ä¸­ä¼°è®¡æœ‰ $80\%$ çš„æ—¶é—´ç”¨åœ¨äº†åŸºäº <strong>è§‚å¯Ÿ 1</strong> å’Œ <strong>è§‚å¯Ÿ 2</strong> çš„è·³è½¬ä¸Šï¼Œä¹Ÿå°±æ˜¯ $\texttt{string}[i]$ å’Œ $\texttt{pat}[\texttt{patlen}]$ ä¸åŒ¹é…ï¼Œç„¶åè·³è¿‡æ•´ä¸ª $\texttt{patlen}$ çš„æƒ…å†µã€‚</p>

<p>ä¸ºæ­¤è¿›è¡Œä¼˜åŒ–ï¼Œå®šä¹‰ä¸€ä¸ª $\texttt{delta0}$ï¼š</p>

\[\begin{array}{ll}
\textbf{int}\ \texttt{delta0}(\textbf{char}\ \texttt{char}) \\
\qquad \textbf{if}\ \texttt{char}=\texttt{pat}[\texttt{patlen}] \\
\qquad\qquad \textbf{return}\ \texttt{large} \\
\qquad \textbf{return}\ \texttt{delta1}(\texttt{char})
\end{array}\]

<p>å…¶ä¸­ $\texttt{large}$ æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°ï¼Œæ»¡è¶³ $\texttt{large} \gt \texttt{stringlen + patlen}$ ï¼Œç”¨ä½œä¿¡å·åŠŸèƒ½ã€‚</p>

<p>ç”¨ $\texttt{delta0}$ ä»£æ›¿ $\texttt{delta1}$ ï¼Œå¾—åˆ°æ”¹è¿›åçš„åŒ¹é…ç®—æ³•ï¼š</p>

\[\begin{array}{ll}
i \gets \texttt{patlen} \\
\\
\textbf{if} \ i &gt; \texttt{stringlen} \\
\qquad\textbf{return}\ \texttt{false}\\
\\
\textbf{loop} \\
\qquad\ \text{/* fast */}\\
\\
\qquad\ \textbf{while}\ i \leqslant \texttt{stringlen} \\
\qquad\qquad i \gets i + \texttt{delta0}(\texttt{string}[i])\\
\\
\qquad\ \text{/* undo */}\\
\\
\qquad\ \textbf{if}\ i \leqslant\ \text{large}\\
\qquad\qquad\textbf{return}\ \texttt{false}\\
\\
\qquad i \gets i-\texttt{large} - 1 \\
\qquad j \gets \texttt{patlen} - 1. \\
\\
\qquad\ \text{/* slow */}\\
\\
\qquad\textbf{loop}\\
\qquad\qquad \textbf{if}\ j &lt; 1 \\
\qquad\qquad \qquad \textbf{return}\ i+1 \\
\\
\qquad\qquad\textbf{if}\ \texttt{string}[i]=\texttt{patlen}[j]\\
\qquad\qquad\qquad j \gets j-1 \\
\qquad\qquad\qquad i \gets i-1 \\
\\
\qquad\qquad\qquad\textbf{continue} \\
\\
\qquad\qquad\textbf{break}\\
\\
\qquad i \gets i + \max(\texttt{delta1}(\texttt{string}[i]), \texttt{delta2}(j)) \\
\\
\end{array}\]

<p>$\text{fastï¼š}$ åªè¦ä¸€ç›´åœ¨ $\texttt{pat}$ å°¾å­—ç¬¦ä¸Šå¤±é…ï¼Œå°±ä¸éœ€è¦è€ƒè™‘ $\Delta_2$ ã€‚</p>

<p>$\text{undoï¼š}$ ä» $\text{fast}$ æ»‘è½æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ­£å¸¸çš„å‘ç°å°¾å­—ç¬¦åŒ¹é…ï¼Œç”±äº $\texttt{+large}$ å¯¼è‡´æ»‘è½ï¼›</p>

<p>è¿˜æœ‰ä¸€ç§æ˜¯ $\texttt{string}$ æŒ‡é’ˆèµ°å®Œäº†ï¼Œäºæ˜¯æ»‘è½ä¸‹æ¥ï¼Œå¯¹äºæ­¤ç§æƒ…å†µ $0\leqslant i \leqslant \texttt{large} $ ï¼Œç›´æ¥è¿”å› $\texttt{false}$ ï¼Œè¡¨æ˜å­ä¸²ä¸å­˜åœ¨ã€‚</p>

<p>åœ¨ç»§ç»­ä¸‹è½å‰åº”è¯¥è¿˜åŸ $i$ æŒ‡é’ˆï¼Œå¹¶æŠŠå®ƒé¢å¤–å‘å‰æ‹¨ $1$ ï¼Œå› ä¸ºå°¾å­—ç¬¦å·²ç»åŒ¹é…äº†ã€‚</p>

<p>$\text{slow:}$ åŸç®—æ³•çš„ä¸»è¦åŒ¹é…ä»£ç ã€‚</p>

<p>ç»è¿‡æ”¹è¿›ï¼Œå¯ä»¥è·³è¿‡ $\Delta_2$ çš„å¤šä½™è®¡ç®—ï¼Œä½¿å¾—åœ¨é€šå¸¸å­—ç¬¦é›†ä¸‹æœç´¢å­—ç¬¦ä¸²çš„æ€§èƒ½æœ‰æ˜æ˜¾çš„æå‡ã€‚</p>

<h2 id="textttdelta2">$\texttt{delta2}$</h2>

<p>æ¢å¯» $\texttt{delta2}$ å®ç°ï¼Œä¹Ÿæ˜¯ä¸æ˜“ï¼Œè¦è¿›è¡Œä¸€ç•ªæŠ€æœ¯å²çš„è€ƒæ®å’Œå¯¹ KMP ç®—æ³•èä¼šè´¯é€šåŸºç¡€ä¸Šè¿›è¡Œé‡æ–°å‘æ˜ã€‚</p>

<h3 id="å†å²ç»†èŠ‚">å†å²ç»†èŠ‚</h3>

<p>å‘è¡¨åœ¨ 1977 å¹´ 10 æœˆçš„ <em>Communications of the ACM</em> ä¸Šçš„åœ¨ Boyerã€Moor çš„è®ºæ–‡<sup id="fnref:1977BM" role="doc-noteref"><a href="#fn:1977BM" class="footnote" rel="footnote">1</a></sup>åªæè¿°äº†ä¸€ä¸ªé™æ€è¡¨ï¼Œå¹¶æ²¡æœ‰è¯´æ˜å¦‚ä½•ç”Ÿæˆå®ƒã€‚</p>

<p>å¯¹ $\texttt{delta2}$ å…·ä½“å®ç°çš„è®¨è®ºåè€Œå‡ºç°åœ¨ 1977 å¹´ 6 æœˆ Knuthã€Morrisã€Pratt åœ¨ <em>SIAM Journal on Computing</em> ä¸Šæ­£å¼è”åˆå‘è¡¨KMPç®—æ³•çš„ <em>Fast Pattern Matching in Strings</em><sup id="fnref:1977KMP" role="doc-noteref"><a href="#fn:1977KMP" class="footnote" rel="footnote">2</a></sup> ï¼ˆé™¤ KMP å¤–ï¼Œè¿˜æœ‰è‹¥å¹²å­—ç¬¦ä¸²åŒ¹é…çš„ç®—æ³•æ„æƒ³å’Œä»‹ç»ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº† BM ç®—æ³•ï¼‰ï¼Œè¿™å¬åŠ›æ¥æœ‰ç‚¹å„¿é­”å¹»ï¼š</p>

<ol>
  <li>
    <p>1969 å¹´å¤å¤© Morris ä¸ºæŸä¸ªå¤§å‹æœºç¼–å†™æ–‡æœ¬ç¼–è¾‘å™¨æ—¶åˆ©ç”¨æœ‰é™è‡ªåŠ¨æœºçš„ç†è®ºå‘æ˜äº†ç­‰ä»·äº KMP ç®—æ³•çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œè€Œä»–çš„ç®—æ³•ç”±äºè¿‡äºå¤æ‚ï¼Œè¢«ä¸ç†è§£ä»–ç®—æ³•çš„åŒäº‹å½“åš bug ä¿®æ”¹å¾—ä¸€å›¢ç³Ÿã€‚</p>
  </li>
  <li>
    <p>1970 å¹´ KMP ä¸­çš„ Kï¼ŒKruth åœ¨ç ”ç©¶ Cook çš„ two-way deterministic pushdown automaton çš„ç†è®ºæ—¶å—åˆ°å¯å‘ï¼Œä¹Ÿç‹¬ç«‹å‘æ˜äº† KMP ç®—æ³•çš„é›å½¢ï¼Œå¹¶æŠŠå®ƒå±•ç¤ºç»™ä»–çš„åŒäº‹ Pï¼ŒPratt ï¼ŒPratt æ”¹è¿›äº†ç®—æ³•çš„æ•°æ®ç»“æ„ã€‚</p>
  </li>
  <li>
    <p>1974 å¹´ Boyerã€Moor å‘ç°é€šè¿‡æ›´å¿«åœ°è·³è¿‡ä¸å¯èƒ½åŒ¹é…çš„æ–‡æœ¬èƒ½å®ç°æ¯” KMP æ›´å¿«çš„å­—ç¬¦ä¸²åŒ¹é…ï¼ˆ Gosper ä¹Ÿç‹¬ç«‹åœ°å‘ç°äº†è¿™ä¸€ç‚¹ï¼‰ï¼Œè€Œä¸€ä¸ªåªæœ‰åŸå§‹ $\texttt{delta1}$ å®šä¹‰çš„åŒ¹é…ç®—æ³•æ˜¯ BM ç®—æ³•çš„æœ€åˆç‰ˆæœ¬ã€‚</p>
  </li>
  <li>
    <p>1975 å¹´ Boyerã€Moor æå‡ºäº†åŸå§‹çš„ $\texttt{delta2}$ è¡¨ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬çš„ $\texttt{delta2}$ è¡¨ä¸ä»…ä¸ä¼šå¯¹æ€§èƒ½æœ‰æ‰€æ”¹å–„ï¼Œè¿˜ä¼šåœ¨å¤„ç†å°å­—ç¬¦è¡¨æ—¶æ‹–ç´¯æ€§èƒ½è¡¨ç°ï¼Œè€ŒåŒå¹´ MIT äººå·¥æ™ºèƒ½å®éªŒå®¤çš„ Kuipers å’Œ Knuth å‘ä»–ä»¬æå‡ºäº†ç±»ä¼¼çš„å…³äº $\texttt{delta2}$ çš„æ”¹è¿›å»ºè®®ï¼Œäºæ˜¯ Boyerã€Moor åœ¨è®ºæ–‡çš„ä¸‹ä¸€æ¬¡ä¿®æ”¹ä¸­æåˆ°äº†è¿™ä¸ªå»ºè®®ï¼Œå¹¶è®¾æƒ³ç”¨ä¸€ä¸ªäºŒç»´è¡¨ä»£æ›¿ $\texttt{delta1}$ å’Œ $\texttt{delta2}$ ã€‚</p>
  </li>
  <li>
    <p>1976 å¹´ 1 æœˆ Knuth è¯æ˜äº†æœ‰å…³  $\texttt{delta2}$ çš„æ”¹è¿›ä¼šå¾—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œäºæ˜¯ Boyerã€Moorä¸¤äººåˆä¸€æ¬¡ä¿®æ”¹äº†è®ºæ–‡ï¼Œå¾—åˆ°äº†ç°åœ¨ç‰ˆæœ¬çš„ $\texttt{delta2}$ å®šä¹‰ã€‚åŒå¹´ 4 æœˆï¼Œæ–¯å¦ç¦çš„ Floyd åˆå‘ç°äº† Boyerã€Moor ä¸¤äººç¬¬ä¸€ç‰ˆæœ¬çš„å…¬å¼ä¸­çš„ä¸¥é‡çš„ç»Ÿè®¡é”™è¯¯ï¼Œå¹¶ç»™å‡ºäº†ç°åœ¨ç‰ˆæœ¬çš„å…¬å¼ã€‚</p>
  </li>
  <li>
    <p>Standish åˆä¸º Boyerã€Moor æä¾›äº†ç°åœ¨çš„åŒ¹é…ç®—æ³•çš„æ”¹è¿›ã€‚</p>
  </li>
  <li>
    <p>1977 å¹´ 6 æœˆ Knuthã€Morrisã€Pratt æ­£å¼è”åˆå‘è¡¨äº† KMP ç®—æ³•çš„è®ºæ–‡ï¼Œå…¶ä¸­åœ¨æåŠæ¯” KMP è¡¨ç°æ›´å¥½çš„ç®—æ³•ä¸­æå‡ºäº† $\texttt{delta2}$ çš„æ„å»ºæ–¹å¼ã€‚ï¼ˆå…¶ä¸­ä¹Ÿæ„Ÿè°¢äº† Boyerã€ Moor å¯¹äºè¯æ˜çº¿æ€§å®šç†ï¼ˆlinearity theoremï¼‰æä¾›çš„å¸®åŠ©ï¼‰</p>
  </li>
</ol>

<p>è¿™æ˜¯ä¸€ä¸ªå›¢ç»“ã€å‹è°Šå’Œåä½œçš„æ•…äº‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¤§ä½¬å¸¦æˆ‘é£çš„æ•…äº‹ã€‚</p>

<h3 id="æœ´ç´ ç®—æ³•">æœ´ç´ ç®—æ³•</h3>

<p>åœ¨ä»‹ç» Knuth çš„ $\texttt{delta2}$ æ„å»ºç®—æ³•ä¹‹å‰ï¼Œæ ¹æ®å®šä¹‰ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ª $O(n^3)$ æœ´ç´ ç®—æ³•ï¼š</p>

<p><em>è™½ç„¶æ—¶é—´å¤æ‚åº¦çœ‹èµ·æ¥ç³Ÿç³•é€äº†ï¼Œä½†è€ƒè™‘åˆ° $\texttt{delta2}$ çš„åªæ„å»ºä¸€æ¬¡è€Œä¸” $\texttt{pat}$ é€šå¸¸é•¿åº¦æœ‰é™ï¼Œ</em></p>

<p><em>å¾ˆå¤šæ—¶å€™è¿™å·²ç»å¤Ÿç”¨äº†ï¼Œé™¤éæ˜¯æœç´¢é•¿åº¦æˆç™¾ä¸Šåƒçš„ä¸åŒ  $\texttt{pat}$ ã€‚</em></p>

<ol>
  <li>å¯¹äºæ¯ä¸ª $j \in 1\dots \texttt{patlen}$ åœ¨ $-\texttt{patlen}-j-1\dots j$ ä¸Šä»å³åˆ°å·¦æš´åŠ›å¯»æ‰¾ç¬¬ä¸€ä¸ªç­‰äº $\texttt{subpat}$ çš„å­ä¸²ï¼›</li>
  <li>é€å­—ç¬¦è¿›è¡Œæ¯”è¾ƒï¼Œå½“æŒ‡é’ˆ $i\lt 1$ æ—¶ç›´æ¥è¿”å›å­—ç¬¦åŒ¹é…æˆåŠŸï¼ˆå› ä¸ºæ˜¯è™šæ‹Ÿå‰ç¼€ï¼‰ï¼›</li>
  <li>å½“å­ä¸²åŒ¹é…æˆåŠŸæ—¶æ£€æŸ¥æ˜¯å¦ $i\lt 1$ æˆ– $\texttt{pat}[i] \neq \texttt{pat}[j] $ï¼›</li>
  <li>æœ€åä»¤ $\texttt{pat}[\texttt{patlen}] = 0 $ ã€‚</li>
</ol>

<p><em>æ³¨æ„å®ç°ä»£ç é‡Œçš„å­—ä¸²çš„åŸºåº•ä¸º $0$</em></p>

<pre><code class="language-Rust">use std::cmp::Eq;

pub fn build_delta2_table_naive(p: &amp;'a [impl Eq]) -&gt; Vec&lt;usize&gt; {
    let patlen = p.len();
    let lastpos = patlen - 1;
    let mut delta2 = vec![];

    for j in 0..patlen {
        let subpatlen = (lastpos - j) as isize;

        if subpatlen == 0 {
            delta2.push(0);
            break;
        }

        for i in (-subpatlen..=j as isize).rev() {
            // subpat åŒ¹é…
            if (i..i + subpatlen)
            .zip(j + 1..patlen)
            .all(|(rpr_index, subpat_index)| {
                if rpr_index &lt; 0 {
                    return true;
                }

                if p[rpr_index as usize] == p[subpat_index] {
                    return true;
                }

                false
            })
            &amp;&amp; (i &lt;= 0 || p[(i - 1) as usize] != p[j])
            {
                delta2.push((lastpos as isize - i) as usize);
                break;
            }
        }
    }

    delta2
}
</code></pre>

<p>ç‰¹åˆ«åœ°ï¼Œå¯¹Rustè¯­è¨€ç‰¹æ€§è¿›è¡Œå¿…è¦åœ°è§£é‡Šï¼Œä¸‹ä¸èµ˜è¿°ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">usize</code> å’Œ <code class="language-plaintext highlighter-rouge">isize</code> æ˜¯å’Œå†…å­˜æŒ‡é’ˆåŒå­—èŠ‚æ•°çš„æ— ç¬¦å·æ•´æ•°å’Œæœ‰ç¬¦å·æ•´æ•°ã€‚</li>
  <li>ç´¢å¼•æ•°ç»„ã€å‘é‡ã€åˆ†ç‰‡æ—¶ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">usize</code> ç±»å‹çš„æ•°å­—ï¼ˆå› ä¸ºåœ¨åšå†…å­˜ä¸Šçš„éšæœºè®¿é—®å¹¶ä¸”ä¸‹æ ‡ä¸èƒ½ä¸ºè´Ÿå€¼ï¼‰ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦å¤„ç†è´Ÿå€¼è¦ç”¨<code class="language-plaintext highlighter-rouge">isize</code>ï¼Œè€Œè¿›è¡Œç´¢å¼•æ—¶åˆè¦ç”¨<code class="language-plaintext highlighter-rouge">usize</code>ï¼Œè¿™å°±çœ‹åˆ°ä½¿ç”¨<code class="language-plaintext highlighter-rouge">as</code>å…³é”®å­—è¿›è¡ŒäºŒè€…ä¹‹é—´çš„æ•°å€¼è½¬æ¢ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">impl PartialEq</code> ç”¨ä½œæ³›å‹ï¼Œè¿™æ ·å¯ä»¥åŒæ—¶æ”¯æŒ<code class="language-plaintext highlighter-rouge">Unicode</code>ç¼–ç çš„<code class="language-plaintext highlighter-rouge">char</code>å’ŒäºŒè¿›åˆ¶çš„<code class="language-plaintext highlighter-rouge">u8</code> å’Œå…¶ä»–æ‰€æœ‰å®ç°äº† <code class="language-plaintext highlighter-rouge">PartialEq</code> çš„æ•°æ®ç±»å‹ã€‚</li>
</ul>

<p>è¿™æ˜¯ä¸ªæ˜¾è§çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n^3)$ çš„æš´åŠ›ç®—æ³•ã€‚</p>

<h3 id="é«˜æ•ˆç®—æ³•">é«˜æ•ˆç®—æ³•</h3>

<p>ä¸‹é¢æˆ‘ä»¬è¦ä»‹ç»çš„æ˜¯æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œä½†æ˜¯éœ€è¦é¢å¤– $O(n)$ ç©ºé—´å¤æ‚åº¦çš„é«˜æ•ˆç®—æ³•ã€‚</p>

<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œè™½ç„¶ 1977 å¹´ Knuth æå‡ºäº†è¿™ä¸ªæ„å»ºæ–¹æ³•ï¼Œç„¶è€Œä»–çš„åŸå§‹ç‰ˆæœ¬çš„æ„å»ºç®—æ³•å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼Œä¼šäº§ç”Ÿä¸å‡ºç¬¦åˆå®šä¹‰çš„ $\texttt{delta2}$ã€‚</p>

<p>Rytter åœ¨ 1980 å¹´ <em>SIAM Journal on Computing</em> ä¸Šå‘è¡¨çš„æ–‡ç«  <sup id="fnref:1980Rytter" role="doc-noteref"><a href="#fn:1980Rytter" class="footnote" rel="footnote">3</a></sup> å¯¹æ­¤æå‡ºäº†ä¿®æ­£ï¼Œä½†æ˜¯ Rytter è¿™ç¯‡æ–‡ç« åœ¨ç»†èŠ‚ä¸Šè¿˜æœ‰ä»¤äººç–‘æƒ‘çš„åœ°æ–¹ï¼ŒåŒ…æ‹¬ä¸é™äº</p>

<ul>
  <li>ç¤ºä¾‹ä¸­å¥‡æ€ªçš„ $\Delta_2$ æ•°å€¼ï¼ˆä¸æ¸…æ¥šä»–ä¾æ®çš„ $\texttt{delta2}$ æ˜¯å¦å’Œæœ€ç»ˆç‰ˆ $\texttt{delta2}$ çš„å®šä¹‰æœ‰å·®åˆ«ï¼Œä½†æˆ‘å®åœ¨ä¸æƒ³å› ä¸ºè¿™äº‹å„¿ç»§ç»­è€ƒå¤äº†ğŸ˜±ï¼‰</li>
  <li>æ˜æ˜¾åœ°å¤è¿° Knuth ç®—æ³•æ—¶çš„ç¬”è¯¯ã€ç®—æ³•ä¸Šé”™è¯¯çš„ç¼©è¿›ï¼ˆå¯èƒ½æ˜¯æ–‡ç« å½•å…¥æ—¶çš„é—®é¢˜ï¼Ÿï¼‰</li>
  <li>å¯è¯»æ€§å¾ˆå·®çš„å˜é‡å‘½åï¼ˆè€ƒè™‘åˆ°é‚£æ˜¯ä¸ª goto è¯­å¥ã€æ±‡ç¼–è¯­è¨€å’Œå¤§å‹æœºçš„æ—¶ä»£ï¼Œéšæ€§çš„å˜é‡å‘½åå€’ä¹Ÿå¾ˆåˆç†ï¼‰</li>
</ul>

<p>æ€»ä¹‹ä½ ç»ä¸æƒ³çœ‹ä»–é‚£ä¸ªä¿®æ­£ç®—æ³•çš„å…·ä½“å®ç°ï¼Œä¸è¿‡å¥½åœ¨ä»–çš„æ–‡å­—æè¿°æ¯”ä¼ªä»£ç æ¸…æ™°å¤šäº†ï¼Œç°åœ¨æˆ‘ä»¬ç”¨æ›´æ¸…æ™°çš„æ€è·¯å’Œä»£ç ç»“æ„å»é‡æ–°å‘æ˜ $\texttt{delta2}$ çš„æ„å»ºç®—æ³•ï¼š</p>

<p>$\texttt{delta2}$ çš„å®šä¹‰æ¯”è¾ƒå¤æ‚ï¼Œé«˜æ•ˆå®ç°çš„å…³é”®ï¼Œæ˜¯æŒ‰ç…§ $\texttt{subpat}$ çš„ plausible reoccurrenceï¼ˆä»¥ä¸‹ç®€ç§° <em>é‡ç°</em> ï¼‰ä½ç½®åˆ†ç±»å¤„ç†ã€‚</p>

<p>æŒ‰ç…§ <em>é‡ç°</em> ä½ç½®ä»å‰åˆ°åï¼Œåˆ†ä¸ºä¸‰ç±»ï¼š</p>

<ol>
  <li>
    <p><em>é‡ç°</em>  å®Œå…¨åœ¨ $\texttt{pat}$ å·¦è¾¹ï¼Œæ¯”å¦‚ $\texttt{[(EYX)]ABYXCDEYX}$ ï¼Œæ­¤æ—¶ $\texttt{rpr}(j) = 1-\texttt{subpatlen}$ ï¼Œè€Œæ ¹æ®å®šä¹‰ $\texttt{subpatlen}=\texttt{patlen} - j$ ï¼Œäºæ˜¯å¾—åˆ° $\texttt{delta2}(j) = \texttt{patlen} - \texttt{rpr}(j) + 1 = 2 \times \texttt{patlen} - j$ï¼›</p>
  </li>
  <li>
    <p><em>é‡ç°</em> æœ‰ä¸€éƒ¨åˆ†åœ¨ $\texttt{pat}$ å·¦è¾¹ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯ $\texttt{pat}$ å‰ç¼€ï¼Œæ¯”å¦‚$\texttt{[(XX)ABC]XXXABC}$ï¼Œæ­¤æ—¶ $\texttt{patlen} &lt; \texttt{delta2}(j) &lt; 2 \times \texttt{patlen} - j$ï¼›</p>
  </li>
  <li>
    <p><em>é‡ç°</em> å®Œå…¨åœ¨ $\texttt{pat}$ ä¸­ï¼Œæ¯”å¦‚ $\texttt{AB[YX]CDEYX} $ ï¼Œæ­¤æ—¶ $\texttt{delta2}(j) \leqslant \texttt{patlen} $ã€‚</p>
  </li>
</ol>

<p>æ¥ä¸‹æ¥è®¨è®ºå¦‚ä½•é«˜æ•ˆåœ°è®¡ç®—è¿™ä¸‰ç§æƒ…å†µï¼š</p>

<h4 id="case-1">case-1</h4>

<p>è¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œ $\texttt{delta2}(j)$  æ˜¯ç¡®å®šå€¼ã€‚</p>

<p>è¿™ä¹Ÿæ˜¯ <em>é‡ç°</em> çš„å…œåº•æƒ…å†µï¼Œè¦é€šè¿‡ä¸€æ¬¡éå†ï¼Œåœ¨è¿™é‡Œå®Œæˆ $\texttt{delta2}$ çš„åˆå§‹åŒ–ï¼Œä¹‹åçœ‹æ˜¯å¦åœ¨ <strong>case-2</strong> , <strong>case-3</strong> ä¸Šæœ‰æ›´æ–°çš„æœºä¼šã€‚</p>

<h4 id="case-2">case-2</h4>

<p>æ­¤æ—¶åº”è¯¥æ˜¯ $\texttt{subpat}$ çš„æŸä¸ªåç¼€å’Œ $\texttt{pat}$ çš„æŸä¸ªå‰ç¼€ç›¸ç­‰ã€‚</p>

<p>æ¯”å¦‚ä¹‹å‰çš„ä¾‹å­ï¼š</p>

\[\begin{aligned}
\textit{j}:&amp; &amp;\texttt{1 2 3 4 5 6 7 8 9} \\
\texttt{pat}:&amp; &amp;\texttt{A B C X X X A B C} \\
\end{aligned}\]

<p>$\texttt{delta2}(4)$ çš„ <em>é‡ç°</em>  $\texttt{[(XX)ABC]XXXABC}$ï¼Œåœ¨ $\texttt{subpat} = \texttt{XXABC}$ çš„åç¼€ä¸ $\texttt{pat}$ çš„å‰ç¼€ä¸­ï¼Œæœ‰ä¸€ä¸ªï¼ˆæœ€é•¿çš„ï¼‰ç›¸ç­‰å­ä¸² $\texttt{ABC}$ã€‚</p>

<p><em>è¿™å°±æ¥åˆ°äº†ã€Šå‰ç¼€å‡½æ•°ä¸KMPç®—æ³•ã€‹æ‰€æ¶‰åŠçš„é¢†åŸŸï¼Œå®é™…ä¸Šå¯¹ç¬¬äºŒå’Œç¬¬ä¸‰ç§æƒ…å†µçš„è®¡ç®—éƒ½ç¦»ä¸å¼€å‰ç¼€å‡½æ•°ï¼Œæˆ–è€…æ›´ä¸€èˆ¬åœ°è®²ï¼ŒDP æ€æƒ³ã€‚</em></p>

<p>è®¡ç®—æ­¤ç§æƒ…å†µä¸‹çš„ $\texttt{delta2}(j)$ï¼š</p>

<p>è®¾ç›¸ç­‰çš„å‰åç¼€é•¿åº¦ä¸º $\texttt{prefixlen}$ã€‚</p>

<p>äºæ˜¯æœ‰ $\texttt{pat}$ å·¦è¾¹éƒ¨åˆ†çš„é•¿åº¦ä¸º $\texttt{subpatlen}-\texttt{prefixlen} = \texttt{patlen} - j - \texttt{prefixlen}$ï¼›</p>

<p>$\texttt{rpr}= \texttt{pat}[1-( \texttt{patlen} - j - \texttt{prefixlen})\dots  \texttt{prefixlen}]$ï¼›</p>

<p>$\texttt{delta2}(j) = \texttt{patlen} - \texttt{rpr}(j) = 2 \times \texttt{patlen} - j - \texttt{prefixlen}$ã€‚</p>

<p>å®é™…ä¸Šè¦è®¡ç®—æ‰€æœ‰é•¿åº¦ä¸åŒçš„ $\texttt{subpat}$ åç¼€ä¸ $\texttt{pat}$ å‰ç¼€ç›¸ç­‰çš„æƒ…å†µã€‚</p>

<p>ä¹Ÿå°±æ˜¯è®¡ç®— $\texttt{pat}$ æ‰€æœ‰çœŸï¼ˆçœŸå°±çœŸåœ¨ä¸åŒ…æ‹¬å®ƒè‡ªå·±ï¼‰åç¼€å’ŒçœŸå‰ç¼€ç›¸ç­‰çš„æƒ…å†µï¼Œç„¶åæŒ‰ç…§é•¿åº¦ä»å¤§åˆ°å°ï¼Œå°† $\texttt{delta2}(j)$ åˆ†åŒºé—´è¿›è¡Œè®¡ç®—ã€‚</p>

<p>å‡å¦‚ $\texttt{pat}$ ä¸Šæœ‰ä¸‰ç»„é•¿åº¦ä¸åŒçš„ç›¸ç­‰å‰åç¼€ï¼Œè®°ä¸º $\texttt{pat}[i_1\dots]$ã€ $\texttt{pat}[i_2\dots]$ å’Œ $ \texttt{pat}[i_3\dots]$ ã€‚</p>

<p>äºæ˜¯æœ‰ï¼š</p>

<ul>
  <li>$1\leqslant j \lt i_1 $ ï¼Œ $\texttt{prefixlen} = \texttt{patlen} - i_1 + 1$</li>
  <li>$i_1\leqslant j \lt i_2 $ ï¼Œ $\texttt{prefixlen} = \texttt{patlen} - i_2 + 1$</li>
  <li>$i_2\leqslant j \lt i_3 $ ï¼Œ $\texttt{prefixlen} = \texttt{patlen} - i_3 + 1$</li>
  <li>$i_3\leqslant j $ ï¼Œ $\texttt{prefixlen} =0$ ï¼Œå®é™…ä¸Šæ˜¯ <strong>case-1</strong> çš„æƒ…å†µ</li>
</ul>

<p>å¦‚ä½•è®¡ç®— $\texttt{pat}$ æ‰€æœ‰ç›¸ç­‰çš„çœŸå‰ç¼€å’ŒçœŸåç¼€ï¼ˆçš„é•¿åº¦ï¼‰å‘¢ï¼Ÿ</p>

<p>å¯ä»¥åˆ©ç”¨ KMP é‡Œçš„å‰ç¼€å‡½æ•°ã€‚</p>

<p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å‰ç¼€å‡½æ•° $\pi[i]$ ï¼Œå®ƒè¡¨ç¤º $\texttt{pat}[\dots i]$ æœ€é•¿çš„é‚£å¯¹å„¿ç›¸ç­‰çœŸå‰ç¼€å’ŒçœŸåç¼€çš„é•¿åº¦ã€‚</p>

<p>$\pi[\texttt{patlen}]$ å°±æ˜¯ $\texttt{pat}$ ä¸Šæœ€é•¿çš„ä¸€å¯¹å„¿ç›¸ç­‰çœŸå‰ç¼€å’ŒçœŸåç¼€ã€‚</p>

<p>é‚£ä¹ˆå¦‚ä½•è®¡ç®—å…¶ä»–æ¬¡é•¿ã€æ¬¡æ¬¡é•¿ã€æ¬¡æ¬¡æ¬¡é•¿â€¦â€¦ çš„ç›¸ç­‰çœŸå‰ç¼€å’ŒçœŸåç¼€é•¿åº¦å‘¢ï¼Ÿ</p>

<p>å›æƒ³ä¸€ä¸‹å‰ç¼€å‡½æ•°çš„è®¡ç®—è¿‡ç¨‹ï¼Œ$\pi[i]$ é¦–å…ˆæ£€æŸ¥ä¸‹ $\texttt{pat}[\pi[i-1] + 1]$ æ˜¯å¦ç­‰äº $\texttt{pat}[\texttt{patlen}]$ ï¼›</p>

<p>å¦åˆ™å†æ£€æŸ¥ $\texttt{pat}[\pi[\pi[i-1]] + 1]$ ï¼Œ$\texttt{pat}[\pi[\pi[\pi[i-1]]] + 1]$ ï¼Œç­‰ç­‰ï¼Œç›´åˆ°ç­‰äº $\texttt{pat}[\texttt{patlen}]$ ï¼Œæˆ–è€…æ»‘è½åˆ° $\texttt{pat}[1]$ ä¸ºæ­¢ã€‚</p>

<p>åˆ©ç”¨åŒæ ·çš„è§„å¾‹ï¼Œåæ¨å›å»ï¼š</p>

<p>$\texttt{prefixlen}_1 = \pi[\texttt{patlen}]$ï¼›</p>

<p>$\texttt{prefixlen}_2 = \pi[\pi[\texttt{patlen}]]$ï¼›</p>

<p>$\texttt{prefixlen}_3 = \pi[\pi[\pi[\texttt{patlen}]]]$ï¼›</p>

<p>ç›´åˆ° $\texttt{prefixlen}_n = 0$ ã€‚</p>

<p>è¿™æ ·å°±å®Œæˆäº†å¯¹  $\texttt{delta2}(j)$ çš„è®¡ç®—</p>

<h4 id="case-3">case-3</h4>

<p><em>é‡ç°</em> å®Œå…¨åœ¨ $\texttt{pat}$ ä¸­ã€‚</p>

<p>éœ€è¦æŒ‰ç…§ä»å³åˆ°å·¦çš„é¡ºåºï¼Œåœ¨ $\texttt{pat}[0\dots \texttt{patlen}-1]$ ä¸­æœç´¢ç¬¦åˆæ¡ä»¶çš„ $\texttt{subpat}$ ã€‚</p>

<p><em>å¼€å¯è„‘æ´ï¼šæ—¢ç„¶æ˜¯ä¸ªå­—ç¬¦ä¸²æœç´¢çš„é—®é¢˜ï¼Œé‚£ä¹ˆå½“ç„¶å¯ä»¥ç”¨ BM ç®—æ³•æœ¬èº«é€’å½’åœ°è§£å†³ï¼Œè®¾ç½®ç»“æŸæ¡ä»¶æ˜¯ $\texttt{patlen} = 1 $ã€‚</em></p>

<p>Knuth å‘ç°å¦‚æœä»å°¾éƒ¨å¼€å§‹å»ºç«‹â€œå‰ç¼€â€å‡½æ•°ï¼Œå¤±é…æ—¶ç›¸ç­‰çš„å­ä¸²æ°å¥½å°±æ˜¯ä¸€ä¸ªä¿è¯ä¸‹ä¸€ä¸ªå­—ç¬¦å’Œä½œä¸º $\texttt{pat}$ åç¼€çš„ $\texttt{subpat}$ çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸ç›¸åŒçš„ï¼ˆå› ä¸ºå¤±é…äº†ï¼‰åˆæ³• <em>é‡ç°</em> ã€‚</p>

<p>è¿™ä¸ªè¿‡ç¨‹ä¸­åªè¦æ£€æŸ¥æ¯ä¸€ä¸ªé‡åˆ°çš„ <em>é‡ç°</em> ï¼Œå°±å¯ä»¥å®Œæˆ <strong>case-3</strong> çš„ $\texttt{delta2}$ æ›´æ–°ã€‚</p>

<h4 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">compute_pi</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="k">impl</span> <span class="nb">Eq</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">pi</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0usize</span><span class="p">;</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()];</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">isize</span><span class="p">;</span>

        <span class="k">while</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">j</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">isize</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pi</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">build_delta2_table_improved_minghu6</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="k">impl</span> <span class="nb">Eq</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">pat</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">delta2</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">with_capacity</span><span class="p">(</span><span class="n">patlen</span><span class="p">);</span>

    <span class="cm">/* case-1: delta2[j] = 2 * lastpos - j */</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">patlen</span> <span class="p">{</span>
        <span class="n">delta2</span><span class="nf">.push</span><span class="p">(</span><span class="n">lastpos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* case-2: lastpos &lt;= delata2[j] &lt; 2 * lastpos - j */</span>

    <span class="k">let</span> <span class="n">pi</span> <span class="o">=</span> <span class="nf">compute_pi</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">prefixlen</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">lastpos</span><span class="p">];</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="n">prefixlen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="n">i</span><span class="o">..</span><span class="p">(</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">prefixlen</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">delta2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="n">prefixlen</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="n">prefixlen</span><span class="p">;</span>
        <span class="n">prefixlen</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">prefixlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/* case-3: delata2[j] &lt; lastpos */</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">suffix</span><span class="p">[</span><span class="n">lastpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">patlen</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lastpos</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="nf">.rev</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">suffix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">patlen</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">delta2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">i</span> <span class="p">{</span>
                <span class="n">delta2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">i</span>
            <span class="p">}</span>

            <span class="n">j</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">delta2</span><span class="p">[</span><span class="n">lastpos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">delta2</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ</h4>

<p><strong>case-1</strong> åˆå§‹åŒ–çš„æ—¶å€™æ˜¯ä¸€ä¸ª $O(N)$ ï¼›</p>

<p><strong>case-2</strong> è®¡ç®—å‰ç¼€å‡½æ•°æ˜¯ä¸€ä¸ª $O(N)$ ï¼Œå’Œéå† $\texttt{prefixlen}$ ä¸è¶…è¿‡ $O(N)$ï¼›</p>

<p><strong>case-3</strong> ä»å°¾éƒ¨è®¡ç®—å‰ç¼€å‡½æ•°æ˜¯ä¸€ä¸ª $O(N)$ ï¼Œå›é€€è¿‡ç¨‹é¡ºå¸¦æ›´æ–°ä¹Ÿä¸è¶…è¿‡ $O(N)$ï¼›</p>

<p>åŠ èµ·æ¥ä¸è¶…è¿‡ $O(5\cdot N)$ ï¼Œå¦å¤–éœ€è¦ä¸€ä¸ªå’Œ $\texttt{pat}$ ç­‰é•¿çš„è¾…åŠ©ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨å‰ç¼€å‡½æ•°ï¼Œ</p>

<p>å› æ­¤è¿™ä¸ªæ„å»ºç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(N)$ ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ $O(N)$ ã€‚</p>

<h2 id="galilè§„åˆ™">Galilè§„åˆ™</h2>

<h3 id="æœ€åæƒ…å†µ">æœ€åæƒ…å†µ</h3>

<p>åœ¨ä¸è¦†ç›–ï¼ˆonoverlappingï¼‰çš„å¤šæ¬¡åŒ¹é…æƒ…å†µä¸‹ï¼Œ</p>

<p>å¦‚æœ $\texttt{string}$ çš„å­—æ¯è¡¨å¾ˆå°ï¼ˆ$\Delta_1$ å¤±æ•ˆï¼‰ï¼Œå¹¶ä¸” $\texttt{pat}$ ç”±éå¸¸çŸ­çš„å­ä¸²å¾ªç¯æ„æˆï¼ˆ$\Delta_2$ å¤±æ•ˆï¼‰ï¼Œæœ€åæ—¶é—´å¤æ‚åº¦ä¼šå›åˆ° $O(m\cdot n) $ ã€‚</p>

<p>ä¸€ä¸ªæç«¯çš„ä¾‹å­æ˜¯ $\texttt{pat} = \texttt{AAA}$ï¼Œ $\texttt{string} = \texttt{AAAAA}\dots$ã€‚</p>

<h3 id="æœ€çŸ­å‘¨æœŸ-k">æœ€çŸ­å‘¨æœŸ $k$</h3>

<p>å‡å®šä¸€ä¸ª $\texttt{pat}$ ï¼Œå®ƒæ˜¯æŸä¸ªå­ä¸² $U$ é‡å¤ $n$ æ¬¡æ„æˆçš„å­—ç¬¦ä¸² $UUUU\dots$ çš„å‰ç¼€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° $U$ ä¸º $\texttt{pat}$ çš„ä¸€ä¸ªå‘¨æœŸã€‚</p>

<p>æ¯”å¦‚ï¼Œå¯¹äº $\texttt{pat} = \texttt{ABCABCAB}$ ï¼Œ$\texttt{ABC}$ å°±æ˜¯è¿™ä¸ªå®ƒçš„ä¸€ä¸ªå‘¨æœŸï¼Œå½“ç„¶ $\texttt{ABCABC}\dots$ ä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªå‘¨æœŸï¼Œä½†æˆ‘ä»¬åªå…³æ³¨æœ€çŸ­çš„é‚£ä¸ªã€‚</p>

<p>æ˜¾ç„¶ï¼Œ$\texttt{pat}$ è‡³å°‘æ‹¥æœ‰ä¸€ä¸ªé•¿åº¦ä¸ºå®ƒè‡ªèº«çš„å‘¨æœŸï¼Œæˆ‘ä»¬è§„å®šå®ƒçš„æœ€çŸ­å‘¨æœŸä¸º $k$ï¼Œ$k\leqslant \texttt{patlen}$ã€‚</p>

<p>åœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼Œå‡å¦‚æˆ‘ä»¬çš„ $\texttt{pat}$ æˆåŠŸåœ°å®Œæˆäº†ä¸€æ¬¡åŒ¹é…ï¼Œé‚£ä¹ˆä¾ç…§å‘¨æœŸçš„ç‰¹ç‚¹ï¼Œå®é™…ä¸Šåªéœ€å°† $\texttt{string}$ ä¸Šçš„æŒ‡é’ˆå‘ä¸‹æ»‘ $k$ ä¸ªå­—ç¬¦ï¼Œæ¯”è¾ƒè¿™ $k$ ä¸ªå­—ç¬¦æ˜¯å¦ç­‰äº $\texttt{pat}[\texttt{patlen} - k + 1\dots ]$ å°±å¯ä»¥ç›´æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ $\texttt{pat}$ çš„åˆä¸€ä¸ªåŒ¹é…ã€‚</p>

<p>è€Œå¦‚ä½•è®¡ç®—è¿™ä¸ªæœ€çŸ­å‘¨æœŸçš„é•¿åº¦å‘¢ï¼Œå‡å¦‚æˆ‘ä»¬çŸ¥é“ $\texttt{pat}$ çš„ç›¸ç­‰çš„ä¸€å¯¹å„¿å‰ç¼€åç¼€ï¼Œè®¾å®ƒä»¬çš„é•¿åº¦ä¸º $\texttt{prefixlen}$ï¼Œé‚£ä¹ˆæœ‰ $\texttt{pat}[i] = \texttt{pat}[i+(patlen-\texttt{prefixlen})]$ã€‚</p>

<p>è€Œä»æ•°å­¦çš„è§’åº¦çœ‹è¿™ä¸ªå…¬å¼ï¼Œæ˜¾ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†é•¿åº¦ä¸º $\texttt{patlen}-\texttt{prefixlen}$ çš„å‘¨æœŸï¼Œè€Œå½“æˆ‘ä»¬çŸ¥é“ $\texttt{pat}$ æœ€é•¿çš„é‚£ä¸€å¯¹ç›¸ç­‰çš„å‰ç¼€åç¼€ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† $\texttt{pat}$ æœ€çŸ­çš„å‘¨æœŸã€‚</p>

<p>è€Œè¿™ä¸ªæœ€é•¿ç›¸ç­‰çš„å‰åç¼€é•¿åº¦ï¼Œå°±æ˜¯ $\pi[\texttt{patlen}]$ ï¼Œåœ¨æˆ‘ä»¬åœ¨æ„å»º $\texttt{delta2}$ çš„æ—¶å€™å·²ç»è®¡ç®—è¿‡äº†ã€‚</p>

<h3 id="å®è·µè¯„ä»·">å®è·µè¯„ä»·</h3>

<p>ä»å®è·µçš„è§’åº¦ä¸Šè¯´ï¼Œç†è®ºä¸Šçš„æœ€åæƒ…å†µå¹¶ä¸å®¹æ˜“å½±å“æ€§èƒ½è¡¨ç°ï¼Œå“ªæ€•æ˜¯å¾ˆå°çš„åªæœ‰ $4$ çš„å­—ç¬¦é›†çš„éšæœºæ–‡æœ¬æµ‹è¯•ä¸‹è¿™ç§æœ€åæƒ…å†µçš„å½±å“ä¹Ÿå°åˆ°éš¾ä»¥è§‚å¯Ÿã€‚</p>

<p>ä¹Ÿå› æ­¤å¦‚æœæ²¡æœ‰å¾ˆå¥½åœ°è®¾è®¡ï¼Œä½¿ç”¨ Galil æ³•åˆ™åè€Œä¼šæ‹–ç´¯ä¸€ç‚¹å¹³å‡çš„æ€§èƒ½è¡¨ç°ï¼Œä½†å¯¹äºä¸€äº›æç«¯ç‰¹æ®Šçš„æ¯”å¦‚ä¸Šè¿°ä¾‹å­ä¸­çš„ Gulil è§„åˆ™çš„åº”ç”¨ç¡®å®ä¼šä½¿å¾—æ€§èƒ½è¡¨ç°æé«˜æ•°å€ã€‚</p>

<h2 id="å…·ä½“å®ç°-1">å…·ä½“å®ç°</h2>

<h3 id="å­—ç¬¦ç±»å‹">å­—ç¬¦ç±»å‹</h3>

<p>ä¸Šä¸–çºª70å¹´ä»£é‚£ä¸ªæ—¶å€™ï¼Œäººä»¬è€ƒè™‘å­—ç¬¦ï¼Œé»˜è®¤çš„å‰ææ˜¯å®ƒæ˜¯ASCIIç ï¼Œä½†ç°åœ¨çš„å¤šå­—èŠ‚ç¼–ç æ–¹æ¡ˆä¸ç®¡æ˜¯ GB18030 è¿˜æ˜¯ Unicode ï¼Œé‡‡ç”¨çš„éƒ½æ˜¯å˜é•¿çš„å­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œä½†æ˜¯ï¼š</p>

<ol>
  <li>å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•é«˜æ•ˆçš„å…³é”®åœ¨äºå­—ç¬¦ç´¢å¼•çš„å¿«é€Ÿè·³è½¬</li>
  <li>å­—ç¬¦ç´¢å¼•ä¸€å®šè¦å»ºç«‹åœ¨ç­‰å®½å­—ç¬¦çš„åŸºç¡€ä¸Šï¼Œ</li>
</ol>

<p>æ‰€ä»¥åŒ¹é…çš„å¯¹è±¡è¦ä¹ˆæ˜¯äºŒè¿›åˆ¶å­—èŠ‚ï¼Œè¦ä¹ˆæ˜¯å›ºå®šç ç‚¹çš„åˆ—è¡¨ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">GetDelta1</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">get_delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">pub</span> <span class="k">trait</span> <span class="n">BMMatch</span><span class="p">:</span> <span class="nb">Sized</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">build_delta1_table</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="k">Self</span><span class="p">],</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">GetDelta1</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="k">Self</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="o">&gt;</span>
    <span class="k">where</span>
        <span class="k">Self</span><span class="p">:</span> <span class="nb">Eq</span> <span class="o">+</span> <span class="n">Hash</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">map</span> <span class="o">=</span> <span class="nn">HashMap</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">pat</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">map</span><span class="nf">.insert</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">HashMapWrapper</span> <span class="p">{</span> <span class="n">patlen</span><span class="p">,</span> <span class="n">map</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span> <span class="n">GetDelta1</span> <span class="k">for</span> <span class="p">[</span><span class="nb">usize</span><span class="p">;</span> <span class="mi">256</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span> <span class="o">=</span> <span class="nb">u8</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">get_delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">self</span><span class="p">[</span><span class="o">*</span><span class="nb">char</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="k">as</span> <span class="n">_</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span> <span class="n">BMMatch</span> <span class="k">for</span> <span class="nb">u8</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">build_delta1_table</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="k">Self</span><span class="p">],</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">GetDelta1</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="k">Self</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">delta1</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span><span class="nf">.len</span><span class="p">();</span> <span class="mi">256</span><span class="p">];</span>
        <span class="k">let</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">lastpos</span> <span class="p">{</span>
            <span class="n">delta1</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">delta1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="nb">From</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">BMPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="nb">u8</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">pat</span><span class="nf">.as_bytes</span><span class="p">()</span><span class="nf">.into</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="nb">From</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">BMPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">BMMatch</span> <span class="o">+</span> <span class="nb">Eq</span> <span class="o">+</span> <span class="n">Hash</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">_delta1</span> <span class="o">=</span> <span class="nn">M</span><span class="p">::</span><span class="nf">build_delta1_table</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">delta2</span> <span class="o">=</span> <span class="nf">build_delta2_table_improved_minghu6</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="nf">compute_k</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>

        <span class="n">BMPattern</span> <span class="p">{</span>
            <span class="n">pat</span><span class="p">,</span>
            <span class="n">_delta1</span><span class="p">,</span>
            <span class="n">delta2</span><span class="p">,</span>
            <span class="n">k</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">BMMatch</span> <span class="o">+</span> <span class="nb">Eq</span><span class="o">&gt;</span> <span class="n">BMPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">delta0</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">char</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.last</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">LARGE</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.delta1</span><span class="p">(</span><span class="nb">char</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">._delta1</span><span class="nf">.get_delta1</span><span class="p">(</span><span class="nb">char</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">string</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">None</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="k">self</span><span class="py">.pat</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">patlastpos</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">stringlastpos</span> <span class="o">=</span> <span class="n">string</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="n">patlastpos</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">patlastpos</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span><span class="nf">.find_map</span><span class="p">(|(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)|</span> <span class="p">{</span>
                <span class="k">if</span> <span class="o">*</span><span class="n">v</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
                    <span class="nf">Some</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nb">None</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">stringlastpos</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">None</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">loop</span> <span class="p">{</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">stringlastpos</span> <span class="p">{</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="k">self</span><span class="nf">.delta0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LARGE</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">None</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">i</span> <span class="o">-=</span> <span class="n">LARGE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">j</span> <span class="o">=</span> <span class="n">patlastpos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">loop</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="nf">max</span><span class="p">(</span><span class="k">self</span><span class="nf">.delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="k">self</span><span class="py">.delta2</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cd">/// Find overlapping</span>
    <span class="k">fn</span> <span class="nf">find_all</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">'a</span> <span class="k">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">impl</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span>
    <span class="k">where</span>
        <span class="n">M</span><span class="p">:</span> <span class="n">Debug</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="nn">std</span><span class="p">::</span><span class="nn">iter</span><span class="p">::</span><span class="nf">from_coroutine</span><span class="p">(</span>
            <span class="nd">#[coroutine]</span>
            <span class="k">move</span> <span class="p">||</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.len</span><span class="p">();</span>
                <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="k">self</span><span class="py">.k</span><span class="p">;</span>

                <span class="k">let</span> <span class="k">mut</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
                <span class="k">let</span> <span class="k">mut</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="k">while</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="k">mut</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.find</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">yield</span> <span class="n">i</span> <span class="o">+</span> <span class="n">base</span><span class="p">;</span>

                    <span class="k">loop</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">suffix</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">patlen</span> <span class="o">+</span> <span class="n">k</span> <span class="p">{</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="n">suffix</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">patlen</span><span class="o">..</span><span class="n">i</span> <span class="o">+</span> <span class="n">patlen</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="p">[</span><span class="n">patlen</span> <span class="o">-</span> <span class="n">k</span><span class="o">..</span><span class="p">]</span> <span class="p">{</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="n">k</span><span class="p">;</span>

                            <span class="k">yield</span> <span class="n">i</span> <span class="o">+</span> <span class="n">base</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">let</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="n">base</span> <span class="o">+=</span> <span class="n">shift</span><span class="p">;</span>

                    <span class="n">suffix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">suffix</span><span class="p">[</span><span class="n">shift</span><span class="o">..</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cd">/// Galil rule shortest period k</span>
<span class="cd">///</span>
<span class="cd">/// k = patlen - prefixlen</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">compute_k</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="k">impl</span> <span class="nb">Eq</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="n">p</span><span class="nf">.len</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">pi</span> <span class="o">=</span> <span class="nf">compute_pi</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="n">patlen</span> <span class="o">-</span> <span class="n">pi</span><span class="p">[</span><span class="n">lastpos</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç®—æ³•å˜ç§">ç®—æ³•å˜ç§</h2>

<p><em>ä¹Ÿå¯ä»¥å«åšåªä½¿ç”¨ $\Delta_1$ çš„ç®—æ³•å˜ç§ã€‚</em></p>

<h3 id="simplified-boyer-moore-ç®—æ³•">Simplified Boyer-Moore ç®—æ³•</h3>

<p>BM ç®—æ³•æœ€å¤æ‚çš„åœ°æ–¹å°±åœ¨äºæ„å»º $\texttt{delta2}$ è¡¨ï¼ˆæœ‰ä¸€ä¸ªé€šä¿—çš„åå­—ï¼Œ<strong>å¥½åç¼€</strong> è¡¨ï¼‰çš„æ„å»ºï¼Œè€Œå®è·µä¸­ä¸€èˆ¬å­—ç¬¦é›†ä¸Šçš„åŒ¹é…æ€§èƒ½åªåœ¨äº $\Delta_1$ ï¼ˆé€šä¿—çš„åå­—æ˜¯ <strong>åå­—ç¬¦</strong> è¡¨ï¼‰ï¼ˆåé¢çš„ç†è®ºè®¡ç®—ä¹Ÿè¯æ˜äº†è¿™ä¸€ç‚¹ï¼‰ï¼Œäºæ˜¯å‡ºç°äº†ä»…ä»…ä½¿ç”¨ $\texttt{delta1}$ è¡¨çš„ç®€åŒ–ç‰ˆBM ç®—æ³•ã€‚</p>

<h3 id="boyer-moore-horspol-ç®—æ³•">Boyer-Moore-Horspol ç®—æ³•</h3>

<p>Horspol ç®—æ³•åŒæ ·æ˜¯åŸºäºåå­—ç¬¦çš„è§„åˆ™ï¼Œä¸è¿‡æ˜¯åœ¨ä¸ $\texttt{pat}$ å°¾éƒ¨å¯¹é½çš„å­—ç¬¦ä¸Šåº”ç”¨ $\Delta_1$ ï¼Œè¿™ä¸ªæ•ˆæœç±»ä¼¼äºå‰æ–‡å¯¹<a href="#åŒ¹é…ç®—æ³•çš„æ”¹è¿›">åŒ¹é…ç®—æ³•çš„æ”¹è¿›</a>ï¼Œæ‰€ä»¥å®ƒçš„é€šå¸¸è¡¨ç°ä¼˜äºåŸå§‹ BMã€å’ŒåŒ¹é…ç®—æ³•æ”¹è¿›åçš„ BM å·®ä¸å¤šã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="nb">From</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">HorspoolPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">BMMatch</span> <span class="o">+</span> <span class="nb">Eq</span> <span class="o">+</span> <span class="n">Hash</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">_delta1</span> <span class="o">=</span> <span class="nn">M</span><span class="p">::</span><span class="nf">build_delta1_table</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">pat</span><span class="p">,</span> <span class="n">_delta1</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">Eq</span><span class="o">&gt;</span> <span class="n">HorspoolPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">._delta1</span><span class="nf">.get_delta1</span><span class="p">(</span><span class="nb">char</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">let</span> <span class="n">stringlen</span> <span class="o">=</span> <span class="n">string</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">patlastpos</span> <span class="o">=</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="n">patlastpos</span><span class="p">;</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stringlen</span> <span class="p">{</span>
            <span class="k">if</span> <span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">patlastpos</span><span class="o">..=</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">patlastpos</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="k">self</span><span class="nf">.delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nb">None</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="boyer-moore-sunday-ç®—æ³•">Boyer-Moore-Sunday ç®—æ³•</h3>

<p>Sunday ç®—æ³•åŒæ ·æ˜¯åˆ©ç”¨åå­—ç¬¦è§„åˆ™ï¼Œåªä¸è¿‡ç›¸æ¯” Horspool æ›´è¿›ä¸€æ­¥ï¼Œå±äºæ˜¯ä¸æ¼”äº†ï¼š</p>

<p>æ—¢ç„¶ç»å¤§å¤šæ•°æƒ…å†µä¸‹åŒ¹é…ç®—æ³•åšçš„å·¥ä½œå°±æ˜¯åœ¨è·³é€‚é…å­—ç¬¦ï¼Œé‚£ä¹ˆåŒ¹é…å¤±è´¥åç›´æ¥å…³æ³¨ $\texttt{pat}$ å°¾éƒ¨å¯¹é½çš„é‚£ä¸ªå­—ç¬¦çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼ˆå› ä¸ºä¸‹ä¸€ä¸ªå­—ç¬¦ä¸€å®šä¹Ÿåœ¨æ¯”è¾ƒçš„åºåˆ—é‡Œï¼‰ï¼Œä»è€Œå¯ä»¥æ›´å¿«åœ°å¤±è´¥ã€‚</p>

<p>éœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ $\texttt{delta1}$ è¡¨ï¼Œ åç§»é‡ $+1$ ï¼Œå¹¶ä¸”å°†è®¡ç®—å°¾å­—ç¬¦ä¹Ÿè®¡ç®—åœ¨å†…ã€‚</p>

<p>Sunday ç®—æ³•é€šå¸¸ç”¨ä½œä¸€èˆ¬æƒ…å†µä¸‹å®ç°æœ€ç®€å•è€Œä¸”å¹³å‡è¡¨ç°æœ€å¥½ä¹‹ä¸€çš„å®ç”¨ç®—æ³•ï¼Œé€šå¸¸è¡¨ç°æ¯” Horspoolã€BM éƒ½è¦å¿«ä¸€ç‚¹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">SundayPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">],</span>
    <span class="n">_delta1</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">GetDelta1</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="n">M</span><span class="o">&gt;</span> <span class="o">+</span> <span class="nv">'a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="nb">From</span><span class="o">&lt;&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">SundayPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span>
<span class="k">where</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">BMMatch</span> <span class="o">+</span> <span class="nb">Eq</span> <span class="o">+</span> <span class="n">Hash</span><span class="p">,</span>
<span class="p">{</span>
    <span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">_delta1</span> <span class="o">=</span> <span class="nn">M</span><span class="p">::</span><span class="nf">build_delta1_table</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>

        <span class="k">Self</span> <span class="p">{</span> <span class="n">pat</span><span class="p">,</span> <span class="n">_delta1</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">Eq</span><span class="o">&gt;</span> <span class="n">SundayPattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">char</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.last</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span> <span class="p">{</span>
            <span class="mi">1</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">._delta1</span><span class="nf">.get_delta1</span><span class="p">(</span><span class="nb">char</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">let</span> <span class="n">stringlen</span> <span class="o">=</span> <span class="n">string</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">patlastpos</span> <span class="o">=</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="n">patlastpos</span><span class="p">;</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stringlen</span> <span class="p">{</span>
            <span class="k">if</span> <span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">patlastpos</span><span class="o">..=</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">patlastpos</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">stringlen</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="k">self</span><span class="nf">.delta1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nb">None</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="bmhbnfs-ç®—æ³•">BMHBNFS ç®—æ³•</h3>

<p><em>æ˜¯ CPython å®ç° <code class="language-plaintext highlighter-rouge">stringlib</code> æ¨¡å—æ—¶ç”¨åˆ°çš„ <code class="language-plaintext highlighter-rouge">find</code> çš„ç®—æ³•<sup id="fnref:B5S" role="doc-noteref"><a href="#fn:B5S" class="footnote" rel="footnote">4</a></sup>ï¼Œä¼¼ä¹å›½å†…æ›´æœ‰åæ°”ï¼Œä¸æ¸…æ¥šä¸ºä½•å«è¿™ä¸ªåå­—ï¼Œæ€ä¹ˆå°±â€œAKAâ€äº†ï¼Œä»¥ä¸‹ç®€ç§° B5Sã€‚</em></p>

<h4 id="æ—¢è¦å¿«">æ—¢è¦å¿«</h4>

<p>è¯¥ç®—æ³•å±äºæ˜¯è¿˜æœ‰é«˜æ‰‹ï¼Œç»“åˆäº† Horspool å’Œ Sunday ï¼Œä¸ä»…è¿½æ±‚å¿«é€Ÿå¤±è´¥ï¼Œè¿˜è¦å°½é‡ä¸€å£æ°”è·³è¿‡æ•´ä¸ª $\texttt{pat}$ ï¼š</p>

<p>å…ˆçœ‹å°¾ç«¯çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœä¸èƒ½é è¿™ä¸ªå­—ç¬¦è·³è¿‡æ•´ä¸ª $\texttt{pat}$ ï¼Œå°±å†è¯•ä¸‹å°¾ç«¯çš„å­—ç¬¦ã€‚</p>

<h4 id="åˆè¦çœ">åˆè¦çœ</h4>

<p>å¯¹äº Horspool åªä¿ç•™å°¾å­—ç¬¦å¤±é…æ—¶çš„ $\Delta_1$ å«åš $\texttt{skip}$ ï¼›</p>

<p>å¯¹äº Sunday åªç”¨ä¸€ä¸ª $\texttt{pat}$ ä¸Šæ„å»ºçš„å­—æ¯è¡¨ï¼Œå­—æ¯è¡¨è¿˜è¦ç”¨ä¸€ä¸ª <em>æ¦‚ç‡æ•°æ®ç»“æ„</em> æ¥å°½å¯èƒ½èŠ‚çœç©ºé—´ï¼Œå½“æœ«å°¾çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸åœ¨å­—æ¯è¡¨é‡Œæ—¶ç›´æ¥è·³è¿‡ $\texttt{patlen} + 1$ ã€‚</p>

<h4 id="bloom-è¿‡æ»¤å™¨"><a href="https://en.wikipedia.org/wiki/Bloom_filter">Bloom è¿‡æ»¤å™¨</a></h4>

<p>Bloom è¿‡æ»¤å™¨æ˜¯ä¸€ç§ <em>æ¦‚ç‡æ•°æ®ç»“æ„</em> ï¼Œæ˜¯é€šè¿‡ç‰ºç‰²å‡†ç¡®ç‡ï¼ˆå’Œè¿è¡Œæ—¶é—´ï¼‰æ¥èŠ‚çœå­˜å‚¨ç©ºé—´çš„ <code class="language-plaintext highlighter-rouge">Set</code> ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå­˜åœ¨å‡é˜³æ€§ï¼ˆFalse Positiveï¼ŒFPï¼‰ï¼Œä¹Ÿå°±æ˜¯é›†åˆä¸­ä¸å­˜åœ¨çš„é¡¹ä¼šè¢«è¯¯åˆ¤ä¸ºå­˜åœ¨ï¼Œä½†ä¸å­˜åœ¨å‡é˜´æ€§ï¼ˆFalse Negativesï¼ŒFNï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæŠŠå­˜åœ¨çš„é¡¹è¯¯åˆ¤ä¸ºä¸å­˜åœ¨ã€‚</p>

<p>è¿™å°±åƒä¸€ä¸ªç­›å­ä¸€æ ·ï¼ŒæŠŠ <strong>ä¸€äº›</strong> ä¸ç¬¦åˆæ¡ä»¶çš„å€¼è¿‡æ»¤å‡ºå»ã€‚</p>

<p>ä¸€ä¸ªæ ‡å‡†çš„ Bloom è¿‡æ»¤å™¨ï¼Œè¦è¾¾åˆ°æœ€ä½³ FP æ¦‚ç‡ï¼Œéœ€è¦ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°åšå¤šæ¬¡æ£€æŸ¥ï¼Œä½†ç”±æ­¤å¸¦æ¥çš„æ—¶é—´å¸¸æ•°æ˜¯ä¸å¯æ¥å—çš„ã€‚</p>

<p>è¿™é‡Œç®€å•åœ°é€šè¿‡ä¸€ä¸ªæ©ç æŠŠä¸€éƒ¨åˆ†äºŒè¿›åˆ¶ä½æ˜ å°„åˆ°æ•°æ®é‡Œï¼Œè€Œç›®å‰å·²çŸ¥æœ€å¿«çš„éåŠ å¯†å“ˆå¸Œç®—æ³• xxHash<sup id="fnref:xxHash" role="doc-noteref"><a href="#fn:xxHash" class="footnote" rel="footnote">5</a></sup>ï¼Œæ‰€éœ€æ—¶é—´éƒ½è¦é«˜ä¸€ä¸ªæ•°é‡çº§ã€‚</p>

<p>è€ƒè™‘åšä¸€ä¸ª $8$ bit æ•°æ®çš„å­—æ¯è¡¨ï¼Œä¸€èˆ¬æƒ…å†µéœ€è¦ $2^8 = 256$ ä¸ª <code class="language-plaintext highlighter-rouge">bool</code> ç©ºé—´ï¼Œç”¨ bit ä»£æ›¿ byte åšå­˜å‚¨ï¼Œå¯ä»¥çœæ‰ $3$ ä¸ªä¿¡æ¯ä½ï¼Œå¦‚æœå†èˆå¼ƒå…¶ä¸­ $2$ ä¸ªä¿¡æ¯ä½ï¼Œé‚£ä¹ˆå°±åªéœ€è¦ $2^{8-5} = 2^3 = 8$ ä¸ªå­—èŠ‚ä¹Ÿå°±æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">u64</code> ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">SimpleBloomFilter</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">impl</span> <span class="n">SimpleBloomFilter</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">SimpleBloomFilter</span> <span class="p">{</span> <span class="n">data</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">#[inline]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="k">self</span><span class="py">.data</span><span class="p">)</span> <span class="p">|</span><span class="o">=</span> <span class="mi">1u64</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">#[inline]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">u8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="p">(</span><span class="k">self</span><span class="py">.data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u64</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œåšå¾—å®é™…å°±æ˜¯å°†ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯æ˜ å°„ä¸ºå®ƒçš„å‰ $6$ ä½ï¼ŒåŸä½œè€…å»ºè®®è‡³å°‘è¦æ˜ å°„ $5$ ä½ã€‚</p>

<h4 id="å…·ä½“å®ç°-2">å…·ä½“å®ç°</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">B5SSpacePattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="n">M</span><span class="p">],</span>
    <span class="n">patalphabet</span><span class="p">:</span> <span class="n">SimpleBloomFilter</span><span class="p">,</span>
    <span class="cd">/// patpatlastpos delta1</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">B5SSpacePattern</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="nb">u8</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">build</span><span class="p">(</span><span class="n">pat</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="n">SimpleBloomFilter</span><span class="p">,</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">patalphabet</span> <span class="o">=</span> <span class="nn">SimpleBloomFilter</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="c1">//let mut alphabet = FastBloomFilter::with_rate(p.len(), 0.15);</span>
        <span class="k">let</span> <span class="n">lastpos</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">pat</span><span class="nf">.len</span><span class="p">();</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">pat</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="n">patalphabet</span><span class="nf">.insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

            <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span><span class="p">[</span><span class="n">lastpos</span><span class="p">]</span> <span class="p">{</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="n">lastpos</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">patalphabet</span><span class="nf">.insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pat</span><span class="p">[</span><span class="n">lastpos</span><span class="p">]);</span>

        <span class="p">(</span><span class="n">patalphabet</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">find</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">let</span> <span class="n">stringlen</span> <span class="o">=</span> <span class="n">string</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">patlen</span> <span class="o">=</span> <span class="k">self</span><span class="py">.pat</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">patlastpos</span> <span class="o">=</span> <span class="n">patlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">i</span> <span class="o">=</span> <span class="n">patlastpos</span><span class="p">;</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stringlen</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="p">[</span><span class="n">patlastpos</span><span class="p">]</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">patlastpos</span><span class="o">..</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pat</span><span class="p">[</span><span class="o">..</span><span class="n">patlastpos</span><span class="p">]</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">patlastpos</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">stringlen</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="o">!</span><span class="k">self</span><span class="py">.patalphabet</span><span class="nf">.contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                    <span class="c1">// sunday</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="n">patlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// horspool</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="k">self</span><span class="py">.skip</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">stringlen</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="o">!</span><span class="k">self</span><span class="py">.patalphabet</span><span class="nf">.contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                    <span class="c1">// sunday</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="n">patlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nb">None</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªç®—æ³•åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ $O(1)$ çš„ç©ºé—´å¤æ‚åº¦ä¸‹å´æœ‰ç€æœ€å¿«çš„æ—¶é—´æ€§èƒ½ï¼Œç®€ç›´ç¥ä¸­ç¥ï¼</p>

<p>åªæ˜¯åœ¨ç‰¹æ®Šçš„å°å­—ç¬¦é›†ä¸Šçš„æ€§èƒ½è¡¨ç°ä¼šå›é€€åˆ° $O(n\cdot m)$ï¼Œè€Œè¿™æ˜¯åŸä½œè€…æ‰€èƒ½æ¥å—çš„ã€‚</p>

<h2 id="ç†è®ºåˆ†æ">ç†è®ºåˆ†æ</h2>

<p>ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¦‚ç‡æ¨¡å‹æ¥åšä¸€äº›ç»ä¸æ¯ç‡¥çš„ç†è®ºåˆ†æï¼Œå€Ÿæ­¤å¯ä»¥å‘ç°ä¸€äº›æœ‰è¶£è€Œæ›´æ·±å…¥çš„äº‹å®ã€‚</p>

<h3 id="å»ºç«‹æ¨¡å‹">å»ºç«‹æ¨¡å‹</h3>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ»‘åŠ¨å­—ç¬¦ä¸² $\texttt{pat}$ åˆ°æŸä¸ªæ–°çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®è¿˜æ²¡æœ‰å®ŒæˆåŒ¹é…ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‘ç°å¤±é…æ‰€éœ€è¦çš„ä»£ä»·ä¸å¤±é…å $\texttt{pat}$ èƒ½å¤Ÿå‘ä¸‹æ»‘åŠ¨çš„è·ç¦»çš„æ¯”å€¼æ¥è¡¡é‡ç®—æ³•çš„å¹³å‡æ€§èƒ½è¡¨ç°ã€‚</p>

<p>å‡å¦‚è¿™ä¸ªä»£ä»·æ˜¯ç”¨å¯¹ $\texttt{string}$ çš„å¼•ç”¨æ¥è¡¡é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å¹³å‡æ¯ä¸ªå­—ç¬¦éœ€è¦å¤šå°‘æ¬¡ $\texttt{string}$ çš„å¼•ç”¨ï¼Œè¿™æ˜¯åœ¨ç†è®ºä¸Šè¡¡é‡ç®—æ³•è¡¨ç°çš„å…³é”®æŒ‡æ ‡ï¼›</p>

<p>è€Œå¦‚æœè¿™ä¸ªä»£ä»·æ˜¯ç”¨æœºå™¨æŒ‡ä»¤è¡¡é‡ï¼Œé‚£æˆ‘ä»¬å¯ä»¥çŸ¥é“å¹³å‡æ¯ä¸ªå­—ç¬¦éœ€è¦å¤šå°‘æ¡æœºå™¨æŒ‡ä»¤ï¼›</p>

<p>å½“ç„¶ä¹Ÿå¯ä»¥æœ‰å…¶ä»–çš„è¡¡é‡æ–¹å¼ï¼Œè¿™å¹¶ä¸å½±å“ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨å¯¹ $\texttt{string}$ çš„å¼•ç”¨è¿›è¡Œç†è®ºåˆ†æã€‚</p>

<p>åŒæ—¶ä¸ºæˆ‘ä»¬çš„æ¦‚ç‡æ¨¡å‹æå‡ºä¸€ä¸ªå‡è®¾ï¼š</p>

<p>$\texttt{pat}$ï¼Œ$\texttt{string}$ ä¸­çš„æ¯ä¸ªå­—ç¬¦æ˜¯ç‹¬ç«‹éšæœºå˜é‡ï¼Œå®ƒä»¬å‡ºç°çš„æ¦‚ç‡ç›¸ç­‰ï¼Œä¸º $p$ ï¼Œ$p$ å–å†³äºå…¨å­—æ¯è¡¨çš„å¤§å°ã€‚</p>

<p>æ˜¾ç„¶ï¼Œå‡å¦‚å…¨å­—æ¯è¡¨çš„å¤§å°ä¸º $q$ ï¼Œåˆ™ $p=\dfrac{1}{q}$ ï¼Œä¾‹å¦‚æˆ‘ä»¬åŸºäºå­—èŠ‚çš„ä¸²åŒ¹é…ç®—æ³•ï¼Œå¯ä»¥è¿‘ä¼¼ä¸º $q=\dfrac{1}{256}$ã€‚</p>

<p>ç°åœ¨å¯ä»¥æ›´å‡†ç¡®åœ°åˆ»ç”»è¿™ä¸ªæ¯”ç‡ï¼Œ$\texttt{rate}(\texttt{patlen}, p)$ï¼š</p>

\[\frac{\sum_{m=0}^{\texttt{patlen}-1} \texttt{cost}(m) \times \texttt{prob}(m)}{\sum_{m=0}^{\texttt{patlen}-1} \texttt{prob}(m) \times \sum_{k=1}^{\texttt{patlen}} \texttt{skip}(m,k) \times k }\]

<p>å…¶ä¸­ï¼Œ$\texttt{cost}(m)$ ä¸ºå‰é¢è®¨è®ºåˆ°çš„åœ¨åŒ¹é…æˆåŠŸäº† $m$ ä¸ªå­—ç¬¦åå¤±é…æ—¶çš„ä»£ä»·ï¼š</p>

\[\texttt{cost}(m) = m+1\]

<p>$\texttt{prob}(m)$ ä¸ºåŒ¹é…æˆåŠŸ $m$ ä¸ªå­—ç¬¦åå¤±é…çš„æ¦‚ç‡ï¼ˆå…¶ä¸­ $1-p^{\texttt{patlen}}$ æ’é™¤æ‰ $\texttt{pat}$ å…¨éƒ¨åŒ¹é…çš„æƒ…å†µï¼‰ï¼š</p>

\[\texttt{prob}(m) = \frac{p^m(1-p)}{1-p^{\texttt{patlen}}}\]

<p>$\texttt{skip}(m,k)$ ä¸ºå‘ç”Ÿå¤±é…æ—¶ $\texttt{pat}$ å‘ä¸‹æ»‘åŠ¨ $k$ ä¸ªå­—ç¬¦çš„æ¦‚ç‡ã€‚</p>

<p>å®é™…ä¸Šæ‰€æœ‰å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯ $\texttt{skip}(m,k)$ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šé€šè¿‡åˆ†æ $\Delta_1$ å’Œ $\Delta_2$ æ¥è®¡ç®— BoyerMoore ç®—æ³•çš„$\texttt{skip}(m,k)$ã€‚</p>

<h3 id="è®¡ç®—-textttskipmk">è®¡ç®— $\texttt{skip}(m,k)$</h3>

<h4 id="delta_1">$\Delta_1$</h4>

<p>é¦–å…ˆè€ƒè™‘ $\Delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å‘ç°å¤±é…å­—ç¬¦åœ¨ $\texttt{pat}$ ä¸Šé‡ç°çš„ä½ç½®åœ¨å·²ç»åŒ¹é…å®Œçš„ $m$ ä¸ªå­—ç¬¦ä¸­ï¼Œè¿™ç§æƒ…å†µçš„æ¦‚ç‡$\texttt{probdelta1-worthless}$ä¸ºï¼š</p>

\[\texttt{probdelta1-worthless}(m) = 1 - (1-p)^m\]

<p>è€Œå¯¹äº $\Delta_1$ èµ·ä½œç”¨çš„æƒ…å†µï¼Œå¯ä»¥æ ¹æ® $k$ çš„èŒƒå›´åˆ†ä¸ºå››ç§æƒ…å†µè¿›è¡Œè®¨è®ºï¼š</p>

<ol>
  <li>
    <p>$k = 1$</p>

    <p>1.1 å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®çš„ä¸‹ä¸€ä¸ªå­—ç¬¦æ°å¥½ç­‰äºå¤±é…å­—ç¬¦ï¼›</p>

    <p>1.2 å¤±é…å­—ç¬¦å·²ç»æ˜¯ $\texttt{pat}$ å³æ‰‹èµ·æœ€åä¸€ä¸ªå­—ç¬¦ã€‚</p>
  </li>
  <li>
    <p>$1 \lt k \lt  \texttt{patlen}-m$ï¼Œ$\texttt{pat}$ åœ¨å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®çš„å·¦è¾¹è¿˜æœ‰ä¸å¤±é…å­—ç¬¦ç›¸ç­‰çš„å­—ç¬¦ï¼Œå¹¶ä¸”ä¸æ»¡è¶³ <em>1.</em>ï¼›</p>
  </li>
  <li>
    <p>$k = \texttt{patlen} - m$ï¼Œåœ¨å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®å·¦è¾¹æ‰¾ä¸åˆ°å¦ä¸€ä¸ªä¸å¤±é…å­—ç¬¦ç›¸ç­‰çš„å­—ç¬¦ï¼Œå¹¶ä¸”ä¸æ»¡è¶³ <em>1.</em> ï¼Œè¿™æ—¶ $\texttt{pat}$ æœ‰æœ€å¤§çš„å‘ä¸‹æ»‘åŠ¨è·ç¦»ï¼›</p>
  </li>
  <li>
    <p>$k \gt \texttt{patlen} - m$ï¼Œå¯¹äº $\Delta_1$ï¼Œè¿™æ˜¯ä¸å¯èƒ½å­˜åœ¨çš„æƒ…å†µã€‚</p>
  </li>
</ol>

<p>äºæ˜¯æœ‰è®¡ç®— $\Delta_1$ çš„æ¦‚ç‡å‡½æ•°ï¼š</p>

\[probdelta1(m,k) =
\left\{ \begin{array}{lcl}
(1-p)^m\times \left\{ \begin{array}{lcl} 1  &amp; \text{for} &amp;m+1=\texttt{patlen} \\ p &amp;\text{for}&amp;m+1\neq \texttt{patlen}  \\\end{array}\right. &amp; \text{for} &amp; k = 1 \\
(1-p)^{m+k-1}\times p &amp; \text{for} &amp; 1 &lt; k &lt; \texttt{patlen} - m\\
(1-p)^{\texttt{patlen}-1} &amp; \text{for} &amp; k = \texttt{patlen} - m\\
0 &amp; \text{for} &amp; \texttt{patlen} - m &lt; k \leqslant \texttt{patlen}
\end{array}\right.\]

<h4 id="delta_2">$\Delta_2$</h4>

<p>å¯¹äº $\Delta_2$ æ¦‚ç‡çš„è®¡ç®—ï¼Œæ ¹æ®å®šä¹‰ï¼Œé¦–å…ˆè®¡ç®—æŸä¸ª $\texttt{subpat}$ çš„ <em>é‡ç°</em> æ¦‚ç‡ï¼Œåªè¦è€ƒè™‘è¯¥ <em>é‡ç°</em> å·¦è¾¹è¿˜æœ‰æ²¡æœ‰å­—ç¬¦æ¥æä¾›é¢å¤–çš„åˆ¤æ–­ä¸å¤±é…å­—ç¬¦æ˜¯å¦ç›¸ç­‰çš„æ£€æŸ¥ï¼š</p>

\[\texttt{probpr}(m,k) =
\left\{ \begin{array}{lcl}
(1-p)\times p^m &amp; \text{for} &amp; 1 \leqslant k &lt; \texttt{patlen} - m\\
p^{\texttt{patlen}-k} &amp; \text{for} &amp; \texttt{patlen} - m \leqslant k \leqslant \texttt{patlen}
\end{array}\right.\]

<p>äºæ˜¯ $\texttt{delta2}(m,k)$ å°±å¯ä»¥é€šè¿‡ä¿è¯ $\texttt{pr}(m,k)$ å­˜åœ¨å¹¶ä¸” $k$ æ›´å°çš„ $\Delta_2$ ä¸å­˜åœ¨ï¼Œæ¥é€’å½’è®¡ç®—ï¼š</p>

\[\texttt{probdelta2}(m,k) = \texttt{probpr}(m,k)(1-\sum_{n=1}^{k-1} \texttt{probdelta2}(m, n))\]

<h4 id="delta_1-cup--delta_2---delta_1-cap--delta_2">$\Delta_1 \cup  \Delta_2 - \Delta_1 \cap  \Delta_2$</h4>

<p>å‰é¢å·²ç»ç‹¬ç«‹è®¨è®ºäº† $\Delta_1$ ï¼Œ$\Delta_2$ çš„æ¦‚ç‡å‡½æ•°ï¼Œä¸è¿‡è¿˜éœ€è¦é¢å¤–è€ƒè™‘ä¸€ä¸‹è¿™ä¸¤ä¸ªæ¦‚ç‡å‡½æ•°ä¹‹é—´ç›¸äº’å½±å“çš„æƒ…å†µï¼Œè™½ç„¶åªæ˜¯ä¸€ä¸ªå¾ˆå°‘æ•°çš„æƒ…å†µï¼š</p>

<p>å½“ $\texttt{delta2}$ è®¡ç®—çš„ $k$ ä¸º $1$ çš„æ—¶å€™ï¼Œæ ¹æ® $\Delta_2$ å®šä¹‰æˆ‘ä»¬å°±çŸ¥é“</p>

<p>$\texttt{pat}[\texttt{patlen}-m] = \texttt{pat}[\texttt{patlen}-m + 1]\dots =\texttt{pat}[\texttt{patlen}]$</p>

<p>è€Œè¿™ç§æƒ…å†µå·²ç»æ’é™¤äº† $\Delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µï¼Œå› ä¸ºå½“å¦‚å‰æ–‡è®¨è®ºçš„ï¼Œ$\Delta_1$ ä¸èµ·ä½œç”¨è¦æ±‚ä¸å¤±é…å­—ç¬¦ $\texttt{pat}[\texttt{patlen}-m]$ ç›¸ç­‰çš„å­—ç¬¦å‡ºç°åœ¨ $\texttt{pat}[\texttt{patlen}-m+1]\dots \texttt{pat}[\texttt{patlen}]$ ä¸­ï¼Œ è¿™å°±äº§ç”Ÿäº†ä¸å¯èƒ½åœ¨å€’æ•° $m+1$ ä¸ªå­—ç¬¦ä¸Šå¤±é…çš„çŸ›ç›¾ã€‚</p>

<p>å› æ­¤é’ˆå¯¹ $\Delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µéœ€è¦ä¸€ä¸ªç¨å¾®ä¿®æ”¹è¿‡çš„ $\Delta_2$ æ¦‚ç‡å‡½æ•° ï¼š</p>

\[\texttt{probdelta2'}(m,k) =
\left\{ \begin{array}{lcl}
0 &amp; \text{for} &amp; k = 1\\
\texttt{probpr}(m,k)(1-\sum_{n=2}^{k-1} \texttt{probdelta2}'(m, n)) &amp; \text{for} &amp; 1 \leqslant k \leqslant \texttt{patlen}
\end{array}\right.\]

<p>äºæ˜¯é€šè¿‡ç»„åˆ $\Delta_1$ å’Œ $\Delta_2$ èµ·ä½œç”¨çš„æƒ…å†µï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† BoyerMoore ç®—æ³•çš„ $\texttt{skip}$ æ¦‚ç‡å‡½æ•°ï¼š</p>

\[\texttt{skip}(m,k) = \left\{\begin{array}{lcl}
\texttt{probdelta1}(m, 1) \times \texttt{probdelta2}(m, 1) &amp; &amp; k = 1\\
\\
\\
\\
\texttt{prodelta1 - worthless}(m)\times \texttt{probdelta2'}(m, 1)\\
\quad +\ \texttt{probdelta1}(m, k)\times \sum_{n=1}^{k-1} \texttt{probdelta2}(m, n)\\
\quad +\ \texttt{probdelta2}(m, k)\times \sum_{n=1}^{k-1} \texttt{probdelta1}(m,n)\\
\quad +\ \texttt{probdelta1}(m, k)\times \texttt{probdelta2}(m, k)
&amp; &amp; 1 &lt; k \leqslant \texttt{patlen}
\end{array}\right.\]

<h3 id="åˆ†ææ¯”è¾ƒ">åˆ†ææ¯”è¾ƒ</h3>

<p>ä¸ºäº†ç»“æ„æ¸…æ™°ã€ä¹¦å†™ç®€å•ã€æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨ Python å¹³å°çš„ Lisp æ–¹è¨€ Hy (v0.13) æ¥è¿›è¡Œå®é™…è®¡ç®—ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">myprob.hy</code></p>

<pre><code class="language-Hy">(require [hy.contrib.sequences [defseq seq]])

(import [hy.contrib.sequences [Sequence end-sequence]])
(import [hy.models [HySymbol]])


(defmacro simplify-probfn [patlen p probfn-list]
    "(prob-xxx patlen p m k) -&gt; (prob-xxx-s m k)"
    (lfor probfn probfn-list
        [(setv simplified-probfn-symbol (HySymbol (.format "{}-s" (name probfn))))
        `(defn ~simplified-probfn-symbol [&amp;rest args] (~probfn patlen p #*args))]))

(defn map-sum [range-args func]
    (setv [start end] range-args)
    (-&gt; func (map (range start (inc end))) sum))

(defn cost [m] (+ m 1))

(defn prob-m [patlen p m]
    (/
        (* (** p m) (- 1 p))
        (- 1 (** p patlen))))

(defn prob-delta_1 [patlen p m k]
    (cond [(= 1 k) (* (** (- 1 p) m)
                      (if (= (inc m) patlen) 1 p))]
          [(&lt; k (- patlen m)) (* p (** (- 1 p) (dec (+ k m))))]
          [(= k (- patlen m)) (** (- 1 p) (dec patlen))]
          [(&gt; k (- patlen m)) 0]))


(defn prob-delta_1-worthless [p m] (- 1 (** (- 1 p) m)))


(defn prob-pr [patlen p m k] (if (&lt; patlen (+ m k))
                                (* (- 1 p) (** p m))
                                (** p (- patlen k))))


(defn prob-delta_2 [patlen p m]
    "prob-delta_2(_, k) = prob-delta_2-seq[k]"
    (defseq prob-delta_2-seq [n]
        (cond [(&lt; n 1) 0]
              [(= n 1) (prob-pr patlen p m 1)]
              [(&gt; n 1) (* (prob-pr patlen p m n) (- 1 (sum (take n prob-delta_2-seq))))]))
    prob-delta_2-seq)


(defn prob-delta_2-1 [patlen p m]
    (defseq prob-delta_2-1-seq [n]
        (cond [(&lt; n 2) 0]
              [(&gt;= n 2) (* (prob-pr patlen p m n) (- 1 (sum (take n prob-delta_2-1-seq))))]))
    prob-delta_2-1-seq)


(defn skip [patlen p m k prob-delta_2-seq prob-delta_2-1-seq]
    (simplify-probfn patlen p [prob-delta_1])
    (if (= k 1) (* (prob-delta_1-s m 1) (get prob-delta_2-seq 1))
        (sum [(* (prob-delta_1-worthless p m) (get prob-delta_2-1-seq k))
              (* (prob-delta_1-s m k) (sum (take k prob-delta_2-seq)))
              (* (get prob-delta_2-seq k) (map-sum [1 (- k 1)]
                                                  (fn [n] (prob-delta_1-s m n))))
              (* (prob-delta_1-s m k) (get prob-delta_2-seq k))])))


(defn bm-rate [patlen p]
    (simplify-probfn patlen p [prob-m prob-delta_2 prob-delta_2-1 skip])
    (/
        (map-sum [0 (dec patlen)]
            (fn [m] (* (cost m) (prob-m-s m))))

        (map-sum [0 (dec patlen)]
            (fn [m]
                (setv prob-delta_2-seq (prob-delta_2-s m)
                      prob-delta_2-1-seq (prob-delta_2-1-s m))
                (* (prob-m-s m) (map-sum [1 patlen]
                                    (fn [k] (* k (skip-s m k prob-delta_2-seq prob-delta_2-1-seq)))))))))
</code></pre>

<p>å¹¶ä¸”ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè¿˜é¢å¤–è®¡ç®—äº†ç®€åŒ–BMç®—æ³•:</p>

<p><code class="language-plaintext highlighter-rouge">myprob.hy</code></p>

<div class="language-hy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">simplified-bm-skip</span><span class="w"> </span><span class="p">[</span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">simplify-probfn</span><span class="w"> </span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">[</span><span class="n">prob-delta_1</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-delta_1-s</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-delta_1-worthless</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">m</span><span class="p">))</span><span class="w">
        </span><span class="p">(</span><span class="nf">prob-delta_1-s</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">sbm-rate</span><span class="w"> </span><span class="p">[</span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">simplify-probfn</span><span class="w"> </span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">[</span><span class="n">prob-m</span><span class="w"> </span><span class="n">simplified-bm-skip</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nb">/</span><span class="w">
        </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">patlen</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">cost</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-m-s</span><span class="w"> </span><span class="n">m</span><span class="p">))))</span><span class="w">

        </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">patlen</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-m-s</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">patlen</span><span class="p">]</span><span class="w">
                                        </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nf">simplified-bm-skip-s</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)))))))))</span><span class="w">
</span></code></pre></div></div>

<p>å’Œ KMP ç®—æ³•ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">myprob,hy</code></p>

<div class="language-hy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">prob-pi</span><span class="w"> </span><span class="p">[</span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w">
    </span><span class="s">"prob-pi-s(m, l) = prob-pi-seq[m][l]"</span><span class="w">
    </span><span class="p">(</span><span class="nf">defseq</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w">
        </span><span class="p">(</span><span class="nb">cond</span><span class="w"> </span><span class="p">[(</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">[]]</span><span class="w">
              </span><span class="p">[(</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="w">
              </span><span class="p">[(</span><span class="nb">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">[(</span><span class="nb">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="p">]]</span><span class="w">
              </span><span class="p">[(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">lfor</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">
                            </span><span class="p">(</span><span class="nb">+</span><span class="w">
                                </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">getone</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="no">:default</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">p</span><span class="p">))</span><span class="w">
                                </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">i</span><span class="p">)))))]))</span><span class="w">
    </span><span class="n">prob-pi-seq</span><span class="p">)</span><span class="w">


</span><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">at-least-1</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">


</span><span class="p">(</span><span class="nb">defn</span><span class="w"> </span><span class="n">kmp-rate</span><span class="w"> </span><span class="p">[</span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">simplify-probfn</span><span class="w"> </span><span class="n">patlen</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">[</span><span class="n">prob-m</span><span class="w"> </span><span class="n">prob-pi</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nb">setv</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-pi-s</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nb">/</span><span class="w">
        </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">patlen</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">cost</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-m-s</span><span class="w"> </span><span class="n">m</span><span class="p">))))</span><span class="w">

        </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">patlen</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">prob-m-s</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">map-sum</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nf">at-least-1</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">m</span><span class="p">))]</span><span class="w">
                                        </span><span class="p">(</span><span class="nb">fn</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nf">skip</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">prob-pi-seq</span><span class="p">)))))))))</span><span class="w">
</span></code></pre></div></div>

<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Pythonä¸Šçš„<code class="language-plaintext highlighter-rouge">plotnine</code>å›¾å½¢åŒ…çœ‹ä¸€ä¸‹è®¡ç®—çš„æ•°æ®ï¼ˆå¹¶ç”¨é«˜æ–¯è¿‡ç¨‹å›å½’æ‹Ÿåˆæ›²çº¿ï¼‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">hy</span>

<span class="kn">from</span> <span class="nn">my_prob</span> <span class="kn">import</span> <span class="n">bm_rate</span><span class="p">,</span> <span class="n">sbm_rate</span><span class="p">,</span> <span class="n">kmp_rate</span>


<span class="n">theme_update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s">"SimHei"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">model_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'rate'</span><span class="p">:[],</span> <span class="s">'alg'</span><span class="p">:[],</span> <span class="s">'patlen'</span><span class="p">:[]}</span>
    <span class="n">categories_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bm_rate</span><span class="p">,</span> <span class="s">'BoyerMoore'</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">sbm_rate</span><span class="p">,</span> <span class="s">'S BoyerMoore'</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">kmp_rate</span><span class="p">,</span> <span class="s">'KMP'</span><span class="p">),</span>
                       <span class="p">(</span><span class="k">lambda</span> <span class="n">patlen</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="n">patlen</span><span class="p">,</span> <span class="s">'$</span><span class="se">\\</span><span class="s">frac{1}{</span><span class="se">\t</span><span class="s">exttt{patlen}}$'</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">alg_fun</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">categories_list</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'rate'</span><span class="p">].</span><span class="n">extend</span><span class="p">([</span><span class="n">alg_fun</span><span class="p">(</span>\<span class="n">texttt</span><span class="p">{</span><span class="n">patlen</span><span class="p">},</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">patlen</span> <span class="ow">in</span> <span class="n">model_range</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'alg'</span><span class="p">].</span><span class="n">extend</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">model_range</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'patlen'</span><span class="p">].</span><span class="n">extend</span><span class="p">(</span><span class="n">model_range</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'patlen'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'rate'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'alg'</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">geom_point</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">'gpr'</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'Algs'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'$</span><span class="se">\t</span><span class="s">exttt{patlen}$'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'$</span><span class="se">\\</span><span class="s">frac{cost}{skip}$'</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">plot(1/256, '$p= \\frac{1}{256}$')</code>ï¼š</p>

<div class="sx-center">
<img src="/assets/img/bm/bm_plot256.svg" alt="BM_plot256" style="zoom: 200%;" /></div>

<p>è§‚å¯Ÿè¿™ä¸ªå›¾åƒï¼Œä»¤äººå°è±¡æ·±åˆ»çš„é¦–å…ˆå°±æ˜¯æŠ¬å¤´çš„ä¸€æ¡å¤©è“è‰²çº¿ï¼Œå‡ ä¹ç¬”ç›´åœ°ç”»å‡ºäº†ç®—æ³•æ€§èƒ½çš„ä¸‹é™ï¼Œä¸æ„§æ˜¯ KMP ç®—æ³•ï¼Œ$O(n)$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œä¸€çœ‹å°±å¾ˆçœŸå®ã€‚( ï¾Ÿâ–½ï¾Ÿ)/</p>

<p>æ¥ç€ä¼šå‘ç° BoyerMoore ç®—æ³•ä¸ç®€åŒ–ç‰ˆ BoyerMoore ç®—æ³•é«˜åº¦é‡å çš„è¿™æ¡çº¢ç»¿ç´«æ›²çº¿ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ $\dfrac{1}{\texttt{patlen}}$ ï¼Œ</p>

<p>è¿™å°±æ˜¯åœ¨ä¸€èˆ¬å­—ç¬¦é›†ä¸‹éšæœºæ–‡æœ¬æœç´¢èƒ½è¾¾åˆ°çš„$O(\dfrac{n}{m})$çš„å¼ºåŠ›ç®—æ³•å—ï¼Ÿ (ï¾Ÿâ–³ï¾Ÿ;ï¾‰)ï¾‰</p>

<p>å¦å¤–æ­¤æ—¶å¯ä»¥ç»å¤§å¤šæ•°çš„å­—ç¬¦è·³è½¬ä¾é  $\Delta_1$ï¼ˆæ¯” $\Delta_2$ é«˜å‡ ä¸ªæ•°é‡ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯åŸºäº $\texttt{delta1}$ è¡¨çš„ BM å˜ç§ç®—æ³•æœ€ä½³çš„åº”ç”¨åœºæ™¯ï¼</p>

<p>æ¥ç€æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹åœ¨ç»å…¸çš„å°å­—ç¬¦é›†ï¼Œæ¯”å¦‚åœ¨ DNA { A, C, T, G } ç¢±åŸºå¯¹åºåˆ—ä¸­ç®—æ³•çš„æ€§èƒ½è¡¨ç°ï¼ˆ<code class="language-plaintext highlighter-rouge">plot(1/4, '$p= \\frac{1}{4}$')</code>ï¼‰ï¼š</p>

<div class="sx-center">
<img src="/assets/img/bm/bm_plot4.svg" alt="BM_plot4" style="zoom:200%;" /></div>

<p>æ›²çº¿å‡ºç°äº†æ˜æ˜¾çš„åˆ†åŒ–ï¼Œå½“ç„¶ KMP è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€åœ°ç¨³å®šã€‚ ( ï¾Ÿâ–½ï¾Ÿ)/</p>

<p>å¦‚æœæ­¤æ—¶åœ¨æµ‹è¯•ä¸­ç›‘æ§ä¸€ä¸‹ $\texttt{delta1}$ è¡¨å’Œ $\texttt{delta2}$ è¡¨ä½œç”¨æƒ…å†µï¼Œä¼šå‘ç° $\texttt{delta2}$ èµ·ä½œç”¨çš„æ¬¡æ•°è¶…è¿‡äº† $\texttt{delta1}$ ï¼Œè€Œä¸”è´¡çŒ®çš„è·³è¿‡å­—ç¬¦æ•°æ›´æ˜¯è¿œè¶… $\texttt{delta1}$ ï¼Œæ€è€ƒä¸‹ï¼Œè¿™ä»¶äº‹å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œé€šè¿‡æ¦‚ç‡æ¨¡å‹çš„è®¡ç®—ï¼Œä¸€æ–¹é¢çœ‹åˆ°äº†åœ¨è¾ƒå¤§çš„å­—ç¬¦é›†ï¼Œæ¯”å¦‚æ—¥å¸¸æœç´¢çš„è¿‡ç¨‹ä¸­ BoyerMoore ç³»åˆ—ç®—æ³•çš„ä¼˜è¶Šè¡¨ç°ï¼Œå…¶ä¸­ä¸»è¦ä¾èµ– $\texttt{delta1}$ è¡¨å®ç°å­—ç¬¦è·³è½¬ï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨è¾ƒå°çš„å­—ç¬¦é›†é‡Œï¼Œ$\texttt{delta1}$ çš„ä½œç”¨ä¸‹é™ï¼Œè€Œ $\texttt{delta2}$ çš„ä½œç”¨å¾—åˆ°ä½“ç°ã€‚</p>

<p>å¦‚æœæœ‰ä¸€å®šå¯Œè£•ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å®Œæ•´çš„ç©ºé—´å¤æ‚åº¦ä¸º $O(m)$ çš„ BoyerMoore ç®—æ³•åº”è¯¥æ˜¯ä¸€ç§é€‚ç”¨å„ç§æƒ…å†µã€ç»¼åˆè¡¨ç°éƒ½å¾ˆä¼˜å¼‚çš„ç®—æ³•é€‰æ‹©ã€‚</p>

<h2 id="å¼•ç”¨">å¼•ç”¨</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1977BM" role="doc-endnote">
      <p>https://dl.acm.org/doi/10.1145/359842.359859Â <a href="#fnref:1977BM" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1977KMP" role="doc-endnote">
      <p>https://epubs.siam.org/doi/abs/10.1137/0206024Â <a href="#fnref:1977KMP" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1980Rytter" role="doc-endnote">
      <p>https://epubs.siam.org/doi/10.1137/0209037Â <a href="#fnref:1980Rytter" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:B5S" role="doc-endnote">
      <p>https://web.archive.org/web/20040907193754/http://effbot.org/zone/stringlib.htmÂ <a href="#fnref:B5S" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:xxHash" role="doc-endnote">
      <p>https://cyan4973.github.io/xxHash/Â <a href="#fnref:xxHash" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>

    <div id="toc-wrapper" class="pl-0 pr-4 mb-5 post__toc">
      <nav id="toc" data-toggle="toc"></nav>
      <span>
        <a href="/algs/BM.html#">
          <img src="/assets/img/icons/move-up.png" class="pl-0 pr-4 mb-5" >
        </a>
      </span>
    </div>
    <!-- <div id="toc-wrapper" class="pl-0 pr-4 mb-5">

    </div> -->
  </div>

</article>

    </main>

    <div class="page__comment">
        <script src="https://giscus.app/client.js"
            data-repo="minghu6/minghu6.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnkxMTI3NDIxOTA="
            data-category="Announcements"
            data-category-id="DIC_kwDOBrhPLs4CSYaE"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="1"
            data-input-position="top"
            data-theme="preferred_color_scheme"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
        </script>
    </div>
</div>

    <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">Â© minghu6</p>
                
                <span class="divider">Â·</span>
                
                <span class="footer__about__theme"><p>theme</p><a id="simplex-logo" href="https://github.com/andreondra/jekyll-theme-simplex" target="_blank"><img alt="Simplex theme logo" src="/assets/img/icons/simplex_logo.svg"/></a><p>by <a href="https://ondrej.golasowski.com/">golas</a></p></span>
        </section>
</footer>

    <script src="/assets/js/jquery.slim.min.js"></script>
<script src="/assets/js/lity.min.js"></script>
<script src="/assets/js/tools.js"></script>


<script type="text/javascript" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>


<!-- <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script> -->
<script>
  MathJax = {
  tex: {
    inlineMath: [
      ['$','$'],
      ['\\(','\\)']
    ],
    displayMath: [
      ['$$', '$$'],
      ['\\[', '\\]']
    ]
  }
}
</script>

<!-- <script>
var navSelector = "#toc";
// only show two levels
$("body").scrollspy({
  target: navSelector,
});
</script> -->


    <!--
Jekyll Simple Search loader
See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->



<script src="/assets/js/simple-jekyll-search.min.js"></script>

<script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: "/assets/search.json",
    searchResultTemplate: '  <div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0 justify-content-center">    <a href="{url}">{title}</a>    <div class="post__meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">      {categories}    </div>    <p>{snippet}</p>  </div>',
    noResultsText: '<p class="mt-5">No result</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }
    }
  });

  $(function() {
    const btnSearchTrigger = $("#search-trigger");
    const btnCancel = $("#search-cancel");
    const main = $(".main");
    const topbarTitle = $("#topbar-title");
    const searchWrapper = $("#search-wrapper");
    const resultWrapper = $("#search-result-wrapper");
    const results = $("#search-results");
    const input = $("#search-input");
    const hints = $("#search-hints");

    const scrollBlocker = (function() {
      let offset = 0;
      return {
        block() {
          offset = window.scrollY;
          $("html,body").scrollTop(0);
        },
        release() {
          $("html,body").scrollTop(offset);
        },
        getOffset() {
          return offset;
        }
      };
    }());

/*--- Actions in mobile screens (Sidebar hidden) ---*/

    const mobileSearchBar = (function() {
      return {
        on() {
          topbarTitle.addClass("unloaded");
          btnSearchTrigger.addClass("unloaded");
          searchWrapper.addClass("d-flex");
          btnCancel.addClass("loaded");
        },
        off() {
          btnCancel.removeClass("loaded");
          searchWrapper.removeClass("d-flex");
          topbarTitle.removeClass("unloaded");
          btnSearchTrigger.removeClass("unloaded");
        }
      };
    }());

    const resultSwitch = (function() {
      let visible = false;

      return {
        on() {
          if (! visible) {
            scrollBlocker.block();
            resultWrapper.removeClass("unloaded");
            main.addClass("unloaded");
            visible = true;
          }
        },
        off() {
          if (visible) {
            results.empty();
            if (hints.hasClass("unloaded")) {
              hints.removeClass("unloaded");
            }
            resultWrapper.addClass("unloaded");
            main.removeClass("unloaded");
            scrollBlocker.release();

            input.val("");
            visible = false;
          }
        },
        isVisible() {
          return visible;
        }
      };

    }());

    function isMobileView() {
      return btnCancel.hasClass("loaded");
    }

    btnSearchTrigger.click(function() {
      mobileSearchBar.on();
      resultSwitch.on();
      input.focus();
    });

    btnCancel.click(function() {
      mobileSearchBar.off();
      resultSwitch.off();
    });

    input.focus(function() {
      searchWrapper.addClass("input-focus");
    });

    input.focusout(function() {
      searchWrapper.removeClass("input-focus");
    });

    input.on("input", () => {
      if (input.val() === "") {
        if (isMobileView()) {
          hints.removeClass("unloaded");
        } else {
          resultSwitch.off();
        }

      } else {
        resultSwitch.on();
        if (isMobileView()) {
          hints.addClass("unloaded");
        }
      }
    });

  });
</script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">


</body>
</html>
