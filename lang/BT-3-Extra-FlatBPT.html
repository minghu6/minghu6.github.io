<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="/assets/style.css"/>
<link rel="stylesheet" href="/assets/js/lity.min.css"/>


<link rel='shortcut icon' type='image/jpeg' href='/d2.jpg' />


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="MINGHU6's Blog" />
<meta
    property="og:title"
    content="
        
            æ¢è®¨ Rust å®ç°è‡ªå¼•ç”¨ç»“æ„
        
    "
/>

<meta property="og:url" content="//lang/BT-3-Extra-FlatBPT.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        æ¢è®¨ Rust å®ç°è‡ªå¼•ç”¨ç»“æ„
    
</title>

</head>
<body class="index" data-spy="scroll" data-target="#toc" tabindex="0">

    <div class="header">
    <div id="topbar" class="align-items-center justify-content-between h-100">
  <span class="logo" id="topbar-logo">
    <a href="/" class="logo__link">
      
      <img class="logo__link__img" src="/d3.jpg" />
      
    </a>
  </span>

  <span id="search-wrapper" class="align-items-center">
    <!-- <i class="fas fa-search fa-fw"></i> -->
    <img src="/assets/img/icons/search.png">
    <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off"
      placeholder="Search...">
  </span>
  <span id="search-cancel">Cancel</span>
  <span id="breadcrumb">

    

    

    

    
  </span><!-- endof #breadcrumb -->
</div>


    

    <nav class="menu">
        
    </nav>
</div>


    <div class="page main">
    <main class="page__main" id="core-wrapper">
        <article class="post">

  <div class="post__title">
    <h1 class="post__title__text">æ¢è®¨ Rust å®ç°è‡ªå¼•ç”¨ç»“æ„</h1>
  </div>
  <div class="post__meta">
    <div class="post__meta__category">
      
        
        <a href="/category/lang.html">
          <p class="post__meta__category__title" style="background: var(--c-themeHuePurple)">
            Language
          </p>
        </a>
      
    </div>
    <p class="post__meta__divider">Â·</p>
    <div class="post__meta__date">
      December 05, 2024
    </div>
    
  </div>

  

  <div class="post__content_container">
    <div class="post__content"><p><strong>åˆ«åï¼šBT(3-extra) - Flat B+æ ‘ï¼ˆVec likeï¼‰</strong></p>

<p><strong>â€“ æ¢ç´¢ Rust ç¼–ç¨‹æ¨¡å‹ä¸‹ä¼ ç»Ÿè‡ªå¼•ç”¨æ•°æ®ç»“æ„çš„æœ€ä½³å®ç°</strong></p>

<p><strong>â€“ å®éªŒä¸€ç§åŸºäºæ•°ç»„çš„æ‰å¹³åŒ–èŠ‚ç‚¹å’Œé”®å€¼åˆ†ç¦»çš„ B+ æ ‘å®ç°</strong></p>

<h2 id="é—®é¢˜å¼•å…¥">é—®é¢˜å¼•å…¥</h2>

<p><strong>è‡ªå¼•ç”¨æ•°æ®ç»“æ„ï¼ˆSelf Referential Structuresï¼‰</strong>ï¼ŒæŒ‡å­˜åœ¨é€’å½’å®šä¹‰çš„ç»“æ„ä½“ï¼Œæœ€ç®€å•çš„æ¯”å¦‚é“¾è¡¨é‡Œçš„èŠ‚ç‚¹ï¼Œ</p>

<p>åœ¨ C é‡Œä½¿ç”¨<em>æŒ‡é’ˆï¼ˆPointerï¼‰</em>å®ç°è¿™ç§å®šä¹‰</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span>
    <span class="p">..</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡çš„è¯­è¨€æ¯”å¦‚ Java é‡Œï¼Œç›´æ¥ä½¿ç”¨<em>å¼•ç”¨ï¼ˆReferenceï¼‰</em></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Node</span> <span class="o">{</span>
    <span class="nc">Node</span> <span class="n">next</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä½†å¯¹äº Rust è€Œè¨€ï¼Œå¼•å…¥ <em>æŒ‡é’ˆ</em> å°±ç ´åäº†å†…å­˜å®‰å…¨ï¼ˆMemory safetyï¼‰ï¼Œä½¿ç”¨ <em>å¼•ç”¨</em> å°±é¢ä¸´å¯å˜æ€§æ£€æŸ¥ã€‚</p>

<p>å®åœ¨æ˜¯è¿›é€€å¤±æ®ï¼Œä¸çŸ¥å¦‚ä½•æ˜¯å¥½ï¼›æˆ–è€…è¯´ï¼ŒæŒ‰ç…§ Rust å“²å­¦è‡ªå¼•ç”¨æ•°æ®ç»“æ„æ˜¯ä¸€ç§åæ¨¡å¼ï¼Œäº‹å®ä¸Šå®ƒä¹Ÿç¡®å®å­˜åœ¨å†…å­˜å®‰å…¨æˆ–å¹¶å‘ç¼–ç¨‹æ–¹é¢çš„è„†å¼±æ€§ã€‚</p>

<p>ä½†ä¸ç®¡æ€æ ·ï¼Œå› ä¸ºæœ‰å¤§é‡çš„å†å²ç®—æ³•æ²‰æ·€åœ¨è‡ªå¼•ç”¨çš„ç»“æ„é‡Œï¼ˆæ ‘å’Œå›¾ï¼‰ï¼Œæ— è®ºå¦‚ä½•éƒ½è¦æ‰¾åˆ°ä¸€ä¸ªåœ¨ Rust é‡Œåº”ä»˜è¿™ç§æ•°æ®ç»“æ„çš„åŠæ³•ï¼Œå› ä¸ºç¼ºä¹æ¥è‡ªè¯­è¨€æœºåˆ¶ä¸Šçš„å¤§åŠ›æ”¯æŒï¼Œè¿™å¹¶ä¸å®¹æ˜“ï¼Œå®é™…å˜æˆäº†ä¸€ä¸ªè€ƒéªŒå¯¹ Rust ç†Ÿæ‚‰ç¨‹åº¦çš„ä¸€ä¸ªé—¨æ§›ï¼Œåƒæˆ‘è‡ªå·±ç”¨äº† Rust å¥½å‡ å¹´äº†ï¼Œåˆ°ä»Šå¤©æ‰ç®—æ‰¾åˆ°ä¸€ç‚¹å„¿æ„Ÿè§‰ï¼Œåœ¨æ­¤å†™ä¸‹ä¸€ä¸ªæ€»ç»“æ€§çš„å¿ƒå¾—ä½“ä¼šã€‚</p>

<h2 id="ä¸¤ç§å¸¸è§„æ–¹æ³•">ä¸¤ç§å¸¸è§„æ–¹æ³•</h2>

<p>ä¸€èˆ¬åœ°è®²ï¼Œæœ‰ä¸¤ç§å¸¸è§„çš„æ–¹æ³•æ¥å®ç°è‡ªå¼•ç”¨ç»“æ„ï¼Œä¸€ç§æ˜¯ä½¿ç”¨<strong>â€œå®˜æ–¹æŒ‡å®šâ€</strong>çš„â€œä½œå¼Šå™¨â€ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<strong>â€œå®˜æ–¹ä½¿ç”¨â€</strong>çš„â€œä½œå¼Šå™¨â€ã€‚</p>

<h3 id="å®˜æ–¹æŒ‡å®š">å®˜æ–¹æŒ‡å®š</h3>

<p><strong>â€œå®˜æ–¹æŒ‡å®šâ€</strong>çš„ä½œå¼Šå™¨æŒ‡çš„æ˜¯å®˜æ–¹æ–‡æ¡£é‡Œæ¨èçš„ <code class="language-plaintext highlighter-rouge">Rc&lt;RefCell&lt;T&gt;&gt;</code> å¥—è£…ã€‚</p>

<p>è¿™ä¸ªå¥—è£…çš„ä¸¤ä¸ªç»„ä»¶ <code class="language-plaintext highlighter-rouge">RefCell</code> å’Œ <code class="language-plaintext highlighter-rouge">Rc</code> çš„è®¾è®¡å¯è°“â€œå§é¾™å‡¤é›â€ã€â€œä¸€æ—¶ç‘œäº®â€ã€‚</p>

<h4 id="refcell"><code class="language-plaintext highlighter-rouge">RefCell</code></h4>

<p><code class="language-plaintext highlighter-rouge">RefCell</code> æä¾›äº†ä¸€ç§é€šè¿‡ä¸å¯å˜å¼•ç”¨è¿›è¡Œå¯å˜ä¿®æ”¹çš„åŠæ³•ï¼ŒåŸç†æ˜¯ç›´æ¥è·³è¿‡å¯å˜æ€§æ£€æŸ¥ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">borrow</span><span class="p">:</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="n">BorrowFlag</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="c1">// Stores the location of the earliest currently active borrow.</span>
    <span class="c1">// This gets updated whenever we go from having zero borrows</span>
    <span class="c1">// to having a single borrow. When a borrow occurs, this gets included</span>
    <span class="c1">// in the generated `BorrowError`/`BorrowMutError`</span>
    <span class="nd">#[cfg(feature</span> <span class="nd">=</span> <span class="s">"debug_refcell"</span><span class="nd">)]</span>
    <span class="n">borrowed_at</span><span class="p">:</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="k">'static</span> <span class="k">crate</span><span class="p">::</span><span class="nn">panic</span><span class="p">::</span><span class="n">Location</span><span class="o">&lt;</span><span class="k">'static</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[rustc_never_returns_null_ptr]</span>
    <span class="k">pub</span> <span class="k">const</span> <span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="c1">// We can just cast the pointer from `UnsafeCell&lt;T&gt;` to `T` because of</span>
        <span class="c1">// #[repr(transparent)]. This exploits std's special status, there is</span>
        <span class="c1">// no guarantee for user code that this will work in future versions of the compiler!</span>
        <span class="k">self</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">T</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">T</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="o">!</span><span class="nb">Sync</span> <span class="k">for</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>

<span class="c1">// Positive values represent the number of `Ref` active. Negative values</span>
<span class="c1">// represent the number of `RefMut` active. Multiple `RefMut`s can only be</span>
<span class="c1">// active at a time if they refer to distinct, nonoverlapping components of a</span>
<span class="c1">// `RefCell` (e.g., different ranges of a slice).</span>
<span class="c1">//</span>
<span class="c1">// `Ref` and `RefMut` are both two words in size, and so there will likely never</span>
<span class="c1">// be enough `Ref`s or `RefMut`s in existence to overflow half of the `usize`</span>
<span class="c1">// range. Thus, a `BorrowFlag` will probably never overflow or underflow.</span>
<span class="c1">// However, this is not a guarantee, as a pathological program could repeatedly</span>
<span class="c1">// create and then mem::forget `Ref`s or `RefMut`s. Thus, all code must</span>
<span class="c1">// explicitly check for overflow and underflow in order to avoid unsafety, or at</span>
<span class="c1">// least behave correctly in the event that overflow or underflow happens (e.g.,</span>
<span class="c1">// see BorrowRef::new).</span>
<span class="k">type</span> <span class="n">BorrowFlag</span> <span class="o">=</span> <span class="nb">isize</span><span class="p">;</span>
<span class="k">const</span> <span class="n">UNUSED</span><span class="p">:</span> <span class="n">BorrowFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Location</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæˆç³»åˆ—çš„ <code class="language-plaintext highlighter-rouge">XXCell</code> ç»“æ„ä½“çš„è®¾è®¡è´¨é‡å¾ˆç³Ÿï¼Œæœ¬æ¥åƒè¿™æ ·æ—¢ä¸èƒ½ <code class="language-plaintext highlighter-rouge">Send</code> ä¹Ÿä¸èƒ½ <code class="language-plaintext highlighter-rouge">Sync</code> ï¼Œåªæ˜¯ä¸ºäº†ç»•è¿‡å¯å˜æ€§æ£€æŸ¥è€Œè®¾è®¡çš„ç»“æ„ä½“æ ¹æœ¬å°±æ²¡æœ‰è®¡åˆ’å¤–çš„ä½¿ç”¨é£é™©ï¼Œä¹Ÿä¸çŸ¥é“å®ƒåœ¨å¤–éƒ¨æ¥å£çš„è®¾è®¡ä¸ŠæŠ æŠ æœæœäº›ä»€ä¹ˆ ğŸ˜…ï¼Œè¿˜è¦åˆ†å¥½å‡ ä¸ªç»“æ„ä½“ï¼Œåƒè¿™ä¸ª <code class="language-plaintext highlighter-rouge">Cell</code> å’Œ <code class="language-plaintext highlighter-rouge">RefCell</code> å”¯ä¸€åŒºåˆ«å°±æ˜¯ <code class="language-plaintext highlighter-rouge">RefCell</code> å¯ä»¥ Borrowï¼ˆè€Œ <code class="language-plaintext highlighter-rouge">Cell</code> åªèƒ½ <code class="language-plaintext highlighter-rouge">replace</code> ï¼‰ã€‚</p>

<p>å†è¯´è¿™ä¸ª <code class="language-plaintext highlighter-rouge">BorrowFlag</code> ï¼Œå¯èƒ½å°±æ˜¯ä¸ºäº†è¿™ç‚¹å„¿é†‹æ‰åŒ…çš„é¥ºå­ï¼Œç®€ç›´æ˜äº†å¤´ï¼Œ æœ¬èº«è®¾è®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç»•è¿‡å¯å˜æ€§æ£€æŸ¥ï¼Œç»“æœåˆåœ¨è¿™é‡Œåš Borrow check ï¼Œä¸æ˜¯ä½ æ£€æŸ¥äº›ä»€ä¹ˆå‘€ ğŸ˜“ï¼Ÿ</p>

<p>ç‰¹åˆ«åœ°ï¼Œä¸ºäº†ç®€çŸ­ç¯‡å¹…è€Œæ²¡åœ¨ä»£ç é‡Œåˆ—å‡ºæ¥çš„ <code class="language-plaintext highlighter-rouge">RefCell</code> çš„ Borrow å®ç°ä¹Ÿæœ‰â€œå·§æ€â€ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸º Borrow çš„è¿”å›å€¼æ˜¯ <code class="language-plaintext highlighter-rouge">&amp;T</code> æˆ– <code class="language-plaintext highlighter-rouge">&amp;mut T</code> ï¼Œç»“æœå‘ç°æ˜¯ä¸€å±‚åŒ…è£…ï¼š <code class="language-plaintext highlighter-rouge">Ref</code> å’Œ <code class="language-plaintext highlighter-rouge">RefMut</code> ï¼Œå½“ç„¶æ ‡å‡†åº“çš„å®ç°ä¸€è´¯å¦‚æ­¤ï¼Œè¿™ä¹Ÿç½¢äº†ï¼Œé‚£ä¹ˆ <code class="language-plaintext highlighter-rouge">Rc</code>ï¼Œ<code class="language-plaintext highlighter-rouge">Ref</code>ï¼Œ<code class="language-plaintext highlighter-rouge">RefMut</code> éƒ½å®ç°äº†è‡ªåŠ¨è§£åŒ…ï¼ˆ<code class="language-plaintext highlighter-rouge">Deref</code> å’Œ <code class="language-plaintext highlighter-rouge">DerefMut</code> ï¼‰ï¼Œåå <code class="language-plaintext highlighter-rouge">RefCell</code> ä¸å®ç°åˆæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Œå–œæ¬¢å¤šå†™ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">.borrow()</code> ï¼Œè¡¨æ˜æ˜¾å¼ Borrow ğŸ¤“ï¼Ÿ</p>

<p>æ•´ä¸ªæ ‡å‡†åº“é‡Œæ²¡æœ‰ä»»ä½•åœ°æ–¹ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">RefCell</code> ï¼Œç›¸åå…¶ä»–åœ°æ–¹è¿˜è¦ä¸ºé€‚é…å®ƒå†™é¢å¤–çš„ä»£ç ã€‚</p>

<h4 id="rc"><code class="language-plaintext highlighter-rouge">Rc</code></h4>

<p><code class="language-plaintext highlighter-rouge">Rc</code> æ˜¯å¼•ç”¨è®¡æ•°å™¨ï¼ˆReference counterï¼‰ã€‚</p>

<p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">NonNull</code> æŠ€æœ¯ä¸Šçš„æ„ä¹‰æ˜¯ä¸ºé <code class="language-plaintext highlighter-rouge">null</code> æŒ‡é’ˆæä¾›æ™®é€šå¯¹è±¡çš„è¯­ä¹‰ï¼Œæ¯”å¦‚<a href="https://doc.rust-lang.org/reference/subtyping.html#variance">åå˜æ€§</a>ï¼Œæ¯”å¦‚æ´¾ç”Ÿ traitã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="nb">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">ptr</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">RcInner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Weak</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// This is a `NonNull` to allow optimizing the size of this type in enums,</span>
    <span class="c1">// but it is not necessarily a valid pointer.</span>
    <span class="c1">// `Weak::new` sets this to `usize::MAX` so that it doesnâ€™t need</span>
    <span class="c1">// to allocate space on the heap. That's not a value a real pointer</span>
    <span class="c1">// will ever have because RcInner has alignment at least 2.</span>
    <span class="c1">// This is only possible when `T: Sized`; unsized `T` never dangle.</span>
    <span class="n">ptr</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">RcInner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">pointer</span><span class="p">:</span> <span class="o">*</span><span class="k">const</span> <span class="n">T</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// This is repr(C) to future-proof against possible field-reordering, which</span>
<span class="c1">// would interfere with otherwise safe [into|from]_raw() of transmutable</span>
<span class="c1">// inner types.</span>
<span class="nd">#[repr(C)]</span>
<span class="k">struct</span> <span class="n">RcInner</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">strong</span><span class="p">:</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">weak</span><span class="p">:</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nb">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[cfg(not(no_global_oom_handling))]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// There is an implicit weak pointer owned by all the strong</span>
        <span class="c1">// pointers, which ensures that the weak destructor never frees</span>
        <span class="c1">// the allocation while the strong destructor is running, even</span>
        <span class="c1">// if the weak pointer is stored inside the strong one.</span>
        <span class="k">unsafe</span> <span class="p">{</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">from_inner</span><span class="p">(</span>
                <span class="c1">// get 'static lifetimes raw pointer</span>
                <span class="nn">Box</span><span class="p">::</span><span class="nf">leak</span><span class="p">(</span>
                    <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
                        <span class="n">RcInner</span> <span class="p">{</span> <span class="n">strong</span><span class="p">:</span> <span class="nn">Cell</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">weak</span><span class="p">:</span> <span class="nn">Cell</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">value</span> <span class="p">}))</span>
                    <span class="nf">.into</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">downgrade</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Weak</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">this</span><span class="nf">.inner</span><span class="p">()</span><span class="nf">.inc_weak</span><span class="p">();</span>
        <span class="n">Weak</span> <span class="p">{</span> <span class="n">ptr</span><span class="p">:</span> <span class="n">this</span><span class="py">.ptr</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
   
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline]</span>
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">from_inner</span><span class="p">(</span><span class="n">ptr</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">RcInner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span> <span class="n">ptr</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="nb">Rc</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.inner</span><span class="p">()</span><span class="nf">.dec_strong</span><span class="p">();</span>
            <span class="k">if</span> <span class="k">self</span><span class="nf">.inner</span><span class="p">()</span><span class="nf">.strong</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="nn">ptr</span><span class="p">::</span><span class="nf">drop_in_place</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="p">(</span><span class="o">*</span><span class="k">self</span><span class="py">.ptr</span><span class="nf">.as_ptr</span><span class="p">())</span><span class="py">.value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="n">Weak</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">inner</span> <span class="o">=</span> <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.inner</span><span class="p">()</span> <span class="p">{</span> <span class="n">inner</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">};</span>

        <span class="n">inner</span><span class="nf">.dec_weak</span><span class="p">();</span>
        <span class="c1">// the weak count starts at 1, and will only go to zero if all</span>
        <span class="c1">// the strong pointers have disappeared.</span>
        <span class="k">if</span> <span class="n">inner</span><span class="nf">.weak</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">unsafe</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.alloc</span><span class="nf">.deallocate</span><span class="p">(</span>
                    <span class="k">self</span><span class="py">.ptr</span><span class="nf">.cast</span><span class="p">(),</span> 
                    <span class="nn">Layout</span><span class="p">::</span><span class="nf">for_value_raw</span><span class="p">(</span><span class="k">self</span><span class="py">.ptr</span><span class="nf">.as_ptr</span><span class="p">()</span>
                <span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>çœ‹ä»£ç çš„æ—¶å€™æˆ‘å°±åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬æä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Weak</code> ï¼Œå®ƒä¸å°±æ˜¯ä¸â€œæ‹¥æœ‰â€å¯¹è±¡æ‰€æœ‰æƒçš„æ™®é€šæŒ‡é’ˆå—ï¼Œæ€ä¹ˆæœºåˆ¶æé‚£ä¹ˆå¤æ‚ï¼Œå…ˆè®© <code class="language-plaintext highlighter-rouge">Rc</code> æŒæœ‰æ•°æ® <code class="language-plaintext highlighter-rouge">T</code>ï¼Œå†è®© <code class="language-plaintext highlighter-rouge">Weak</code> æŒæœ‰<code class="language-plaintext highlighter-rouge">T</code> çš„å®¹å™¨ <code class="language-plaintext highlighter-rouge">RcInner</code> ï¼Ÿ</p>

<p>å…¶æ¬¡ï¼Œè¿™ä¸ªå¼•ç”¨è®¡æ•°å™¨åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Œè®¡æ•°çš„æœºåˆ¶æœ¬èº«è¿˜æ˜¯ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ç›´æ¥ç”¨ç”Ÿå‘½å‘¨æœŸçš„æœºåˆ¶ä¸å°±è¡Œäº†ï¼Ÿè¦çŸ¥é“å¼•ç”¨è®¡æ•°å™¨ï¼Œæ˜¯ç ´åäº†å•ä¸€æ‰€æœ‰æƒåŸåˆ™çš„ï¼Œå¹¶ä¸”ä¸ºäº†ç»™å¾ªç¯å¼•ç”¨æ‰“è¡¥ä¸ï¼Œæ‰å¼•å…¥å¼±å¼•ç”¨çš„æœºåˆ¶ï¼ˆè¡¥ä¸è¿˜ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼‰ã€‚</p>

<p>æŠŠè¿™ä¸ªé—®é¢˜å»¶å±•å¼€ï¼Œå› ä¸º Rust æ˜¯å•ä¸€æ‰€æœ‰æƒï¼Œæ‰€ä»¥å¯ä»¥é™æ€åˆ†æç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥å®é™…æ—¢ä¸éœ€è¦ Tracing æ–¹å¼çš„ GC ï¼Œä¹Ÿä¸éœ€è¦å¼•ç”¨è®¡æ•°å™¨è¿™ç§æ–¹å¼çš„ GC ã€‚</p>

<p>æ ‡å‡†åº“åœ¨ ThreadLocal çš„å®ç°é‡Œä»…æ­¤ä¸€å¤„çš„ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">Rc</code> ã€‚</p>

<h3 id="å®˜æ–¹ä½¿ç”¨">å®˜æ–¹ä½¿ç”¨</h3>

<p>æ ‡å‡†åº“é‡Œçš„è‡ªå¼•ç”¨æ•°æ®ç»“æ„éƒ½æ˜¯ç‰¹åŒ–ç±»å‹çš„æŒ‡é’ˆï¼Œæ¯”å¦‚ä»¥ä¸‹æ˜¯æ ‡å‡†åº“ <code class="language-plaintext highlighter-rouge">BTreeMap</code> é‡Œçš„â€œæ ‘èŠ‚ç‚¹â€ç±»å‹</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">LeafNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cd">/// We want to be covariant in `K` and `V`.</span>
    <span class="n">parent</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">NonNull</span><span class="o">&lt;</span><span class="n">InternalNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>

    <span class="cd">/// This node's index into the parent node's `edges` array.</span>
    <span class="cd">/// `*node.parent.edges[node.parent_idx]` should be the same thing as `node`.</span>
    <span class="cd">/// This is only guaranteed to be initialized when `parent` is non-null.</span>
    <span class="n">parent_idx</span><span class="p">:</span> <span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="nb">u16</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="cd">/// The number of keys and values this node stores.</span>
    <span class="n">len</span><span class="p">:</span> <span class="nb">u16</span><span class="p">,</span>

    <span class="cd">/// The arrays storing the actual data of the node. Only the first `len` elements of each</span>
    <span class="cd">/// array are initialized and valid.</span>
    <span class="n">keys</span><span class="p">:</span> <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">CAPACITY</span><span class="p">],</span>
    <span class="n">vals</span><span class="p">:</span> <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">CAPACITY</span><span class="p">],</span>
<span class="p">}</span>

<span class="nd">#[repr(C)]</span>
<span class="c1">// gdb_providers.py uses this type name for introspection.</span>
<span class="k">struct</span> <span class="n">InternalNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">LeafNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="cd">/// The pointers to the children of this node. `len + 1` of these are considered</span>
    <span class="cd">/// initialized and valid, except that near the end, while the tree is held</span>
    <span class="cd">/// through borrow type `Dying`, some of these pointers are dangling.</span>
    <span class="n">edges</span><span class="p">:</span> <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">NonNull</span><span class="o">&lt;</span><span class="n">LeafNode</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;&gt;&gt;</span><span class="p">;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æ›´å¥½çš„æ–¹æ³•">æ›´å¥½çš„æ–¹æ³•</h3>

<p>å¯ä»¥åˆå¹¶ <code class="language-plaintext highlighter-rouge">Rc</code> å’Œ <code class="language-plaintext highlighter-rouge">RefCell</code> çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å»æ‰å¯¹äº Rust æ¥è¯´è«åå¥‡å¦™çš„è®¡æ•°æŒ‡é’ˆï¼Œæ”¹ä¸ºå•ä¸€æ‰€æœ‰æƒçš„æŒ‡é’ˆå’Œç”±å®ƒè¡ç”Ÿå‡ºçš„æ™®é€šæŒ‡é’ˆã€‚</p>

<p>è¿™ç§è®¾è®¡å’Œå®ç°ä¼˜åŒ–äº†äººæœºäº¤äº’ï¼Œé‡æ–°ç¡®ç«‹äº†å•ä¸€æ‰€æœ‰æƒåŸåˆ™ï¼Œä»æ ¹æœ¬ä¸Šæ¶ˆé™¤äº†å¾ªç¯å¼•ç”¨å¸¦æ¥çš„å†…å­˜æ³„æ¼çš„å¯èƒ½æ€§ã€‚[^5]</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Debug,</span> <span class="nd">PartialEq,</span> <span class="nd">Eq,</span> <span class="nd">PartialOrd,</span> <span class="nd">Ord,</span> <span class="nd">Hash)]</span>
<span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[derive(Debug,</span> <span class="nd">PartialEq,</span> <span class="nd">Eq,</span> <span class="nd">PartialOrd,</span> <span class="nd">Ord,</span> <span class="nd">Hash)]</span>
<span class="nd">#[repr(transparent)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">NonNull</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="nn">NonNull</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">into_raw</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span><span class="nf">.unwrap</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_box</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="nn">NonNull</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">into_raw</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="nf">.unwrap</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">T</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span> <span class="k">self</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="k">self</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nb">Ptr</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="k">self</span><span class="py">.value</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="k">self</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">Deref</span> <span class="k">for</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Target</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">deref</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Target</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_ref</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">DerefMut</span> <span class="k">for</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">deref_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">Self</span><span class="p">::</span><span class="n">Target</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_mut</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">Borrow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_ref</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">BorrowMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">borrow_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_mut</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">T</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span> <span class="k">self</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">as_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="k">self</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">ptr_eq</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="nn">std</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nf">eq</span><span class="p">(</span><span class="n">this</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">(),</span> <span class="n">other</span><span class="py">.value</span><span class="nf">.as_ptr</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Clone</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="k">self</span><span class="py">.value</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="nb">Copy</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">Deref</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Target</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">deref</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">Self</span><span class="p">::</span><span class="n">Target</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_ref</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">DerefMut</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">deref_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">Self</span><span class="p">::</span><span class="n">Target</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_mut</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">Borrow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_ref</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="n">BorrowMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">for</span> <span class="nb">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">borrow_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.as_mut</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>å…¶ä¸­æœ‰å‡ ç‚¹éœ€è¦è§£é‡Šï¼š</p>

<ol>
  <li>è‡ªåŠ¨æ´¾ç”Ÿçš„é‚£äº› trait å®é™…ä¸Šå°±æ˜¯ <code class="language-plaintext highlighter-rouge">NonNull</code> è‡ªåŠ¨å®ç°çš„ trait ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„å‡ ä¸ªç”¨äºåªè¯»å±æ€§çš„ trait ï¼›</li>
  <li>ä¸º <code class="language-plaintext highlighter-rouge">Ptr</code> å®ç°äº† <code class="language-plaintext highlighter-rouge">Copy</code> trait ï¼Œå› ä¸ºå®ƒå¹¶ä¸æ‹¥æœ‰æ•°æ®ï¼Œæˆ‘ä»¬æŠŠå®ƒå½“ä¸€ä¸ªæ—¢ä¸ä¸º NULL ä¹Ÿä¸æ‚¬ç©ºçš„æœ‰æ•ˆæŒ‡é’ˆä¸€æ ·ä½¿ç”¨ï¼Œåè¿‡æ¥ <code class="language-plaintext highlighter-rouge">OwnedPtr</code> è¿ <code class="language-plaintext highlighter-rouge">Clong</code> trait éƒ½æ²¡æœ‰å®ç°ï¼Œå®ƒåº”è¯¥åƒä¸€ä¸ªæš´éœ²å‡ºæŒ‡é’ˆæ¥å£çš„ <code class="language-plaintext highlighter-rouge">Unique</code> æŒ‡é’ˆï¼Œå³ä½¿å®ç°å…‹éš†ä¹Ÿåº”è¯¥æ˜¯æ˜¯åœ¨å…‹éš†ä¸€ä¸ªæ–°çš„å€¼æ”¾åˆ°å †ä¸Šï¼›</li>
  <li>ä¸º <code class="language-plaintext highlighter-rouge">Ptr&lt;T&gt;</code> å’Œ <code class="language-plaintext highlighter-rouge">OwnedPtr&lt;T&gt;</code> å®ç°äº† <code class="language-plaintext highlighter-rouge">Deref</code> å’Œ <code class="language-plaintext highlighter-rouge">DerefMut</code> ï¼Œè¿™æ ·ä½¿ç”¨å®ƒä»¬å°±å¥½åƒç›´æ¥åœ¨ <code class="language-plaintext highlighter-rouge">T</code> ä¸Šä½¿ç”¨ä¸€æ ·ï¼›</li>
  <li>ä¸º <code class="language-plaintext highlighter-rouge">Ptr&lt;T&gt;</code> å®ç°äº† <code class="language-plaintext highlighter-rouge">Borrow</code> å’Œ <code class="language-plaintext highlighter-rouge">BorrowMut</code> ï¼Œå› ä¸ºæ ‡å‡†åº“çš„æ•°æ®ç»“æ„çš„ <code class="language-plaintext highlighter-rouge">get</code> ç±»æ–¹æ³•éœ€è¦å®ç°è¿™ç±» traitï¼›</li>
  <li>æˆ‘ä»¬æ²¡æœ‰å®ç° <code class="language-plaintext highlighter-rouge">Send</code> å’Œ <code class="language-plaintext highlighter-rouge">Sync</code>ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸ä¼šè¢«è·¨çº¿ç¨‹çš„ä½¿ç”¨ã€‚</li>
</ol>

<h4 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h4>

<p>è¿™æ ·æˆ‘ä»¬è‡ªå·±å®ç°çš„ B+ æ ‘å¯èƒ½å°±æ˜¯å¦‚ä¸‹è¿™æ ·ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="k">const</span> <span class="n">M</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">Leaf</span> <span class="p">{</span>
        <span class="n">entries</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">KVEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
        <span class="n">next</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Ptr</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;&gt;</span><span class="p">,</span>
        <span class="n">paren</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Ptr</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;&gt;</span><span class="p">,</span>
        <span class="n">_marker</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">[();</span> <span class="n">M</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="p">},</span>
    <span class="n">Internal</span> <span class="p">{</span>
        <span class="n">children</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">KVEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
        <span class="n">paren</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Ptr</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;&gt;</span><span class="p">,</span>
        <span class="n">_marker</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">[();</span> <span class="n">M</span><span class="p">]</span><span class="o">&gt;</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">BPT</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="k">const</span> <span class="n">M</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">32</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">OwnedPtr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç¬¬ä¸‰ç§æ–¹æ³•æ”¾å¼ƒæŒ‡é’ˆ">ç¬¬ä¸‰ç§æ–¹æ³•ï¼šæ”¾å¼ƒæŒ‡é’ˆ</h2>

<p>åœ¨ç°è¡Œç¼–ç¨‹æ¡†æ¶ä¸‹ä»ç„¶å¯ä»¥é¿å…ä½¿ç”¨æŒ‡é’ˆæ¥å®ç°è‡ªå¼•ç”¨ç»“æ„ï¼Œæ–¹æ³•æ˜¯åœ¨æ ¹éƒ¨æŒæœ‰æ‰€æœ‰èŠ‚ç‚¹ï¼Œä½¿ç”¨ç´¢å¼•ï¼ˆæ¯”å¦‚ä¸‹æ ‡ï¼‰ä½œä¸ºä¼ ç»ŸæŒ‡é’ˆçš„æ›¿ä»£ï¼Œä¸è¿‡è¿™æ ·æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯èŠ‚ç‚¹çš„ç´¢å¼•ä¸èƒ½å˜ã€‚</p>

<p>é¦–å…ˆå¦‚æœç´¢å¼•æ˜¯ä¸€ä¸ª Map ï¼Œæ¯”å¦‚ HashMap é‡Œ Keyï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿è§£å†³çš„é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨ Map å°±å¼•å…¥äº†é¢å¤–çš„ä¾èµ–ï¼Œè¿™æ˜¯æˆ‘ä»¬å¾ˆå¤šæ—¶å€™æƒ³è¦é¿å…çš„äº‹æƒ…ï¼ŒåŒæ—¶ä¹Ÿä¼šæŸå¤±ä¸€äº›æ€§èƒ½ï¼›</p>

<p>è¿™æ ·çš„è¯ï¼Œè€ƒè™‘ä¸€ä¸ªç®€å•çš„åŸºäºå‘é‡çš„å®ç°ï¼Œç”¨å®ƒçš„ä¸‹æ ‡ä½œä¸ºç´¢å¼•ï¼Œå¾—åˆ°ä¸€ä¸ªæƒ°æ€§åˆ é™¤å‘é‡ï¼Œè¿™æ ·å½“åˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ä¸ä¼šæ”¹å˜æ—¢æœ‰èŠ‚ç‚¹çš„ä½ç½®ï¼Œè€Œå½“æ’å…¥æ–°æ•°æ®æ—¶å¯ä»¥å¤ç”¨è¢«æ ‡è®°ä¸ºåˆ é™¤çš„ä½ç½®ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Default,</span> <span class="nd">Clone)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">LazyDeleteVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">deleted</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">LazyDeleteVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">const</span> <span class="k">fn</span> <span class="nf">len</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="k">self</span><span class="py">.deleted</span><span class="nf">.len</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">const</span> <span class="k">fn</span> <span class="nf">is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">with_capacity</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">:</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">with_capacity</span><span class="p">(</span><span class="n">capacity</span><span class="p">),</span>
            <span class="n">deleted</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[],</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_parts</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">deleted</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">Self</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">deleted</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">push</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="py">.deleted</span><span class="nf">.pop</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
            <span class="n">idx</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.data</span><span class="nf">.push</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
            <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">remove</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nd">debug_assert!</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">(),</span> <span class="s">"{idx} &gt; len {}"</span><span class="p">,</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.len</span><span class="p">());</span>

        <span class="k">let</span> <span class="n">old</span> <span class="o">=</span> <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="nf">.take</span><span class="p">();</span>

        <span class="k">if</span> <span class="n">old</span><span class="nf">.is_some</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.deleted</span><span class="nf">.push</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">old</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">iter</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">impl</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.data</span>
            <span class="nf">.iter</span><span class="p">()</span>
            <span class="nf">.filter</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span><span class="nf">.is_some</span><span class="p">())</span>
            <span class="nf">.map</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·çš„å®ç°è™½ç„¶å¤šäº†ä¸€å±‚é—´æ¥è®¿é—®ï¼Œä½†åœ¨ä¸€ä¸ªç»¼åˆäº†æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢çš„ç»¼åˆæµ‹è¯•çœ‹ï¼Œè¿™æ ·ç»“æ„çš„ä¸€ä¸ª B+ æ ‘å®ç°ä¸æ ‡å‡†åº“é‡Œçš„ <code class="language-plaintext highlighter-rouge">BTreeMap</code> çš„æ€§èƒ½å‡ ä¹ä¸€è‡´ã€‚</p>

<p><strong>æµ‹è¯•çš„é…ç½®</strong></p>

<p><em>å…ƒç»„ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯æ¦‚ç‡æƒé‡ï¼Œç¬¬äºŒä¸ªæ˜¯æ“ä½œå</em></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">mut</span> <span class="n">roller</span> <span class="o">=</span> <span class="nn">RandomRoller</span><span class="p">::</span><span class="nf">with_candicates</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
    <span class="c1">// get</span>
    <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nf">Q</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="c1">// range</span>
    <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="nf">R</span><span class="p">(</span><span class="n">Unbounded</span><span class="p">,</span> <span class="n">Unbounded</span><span class="p">)),</span>
    <span class="c1">// insert</span>
    <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nf">A</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="c1">// remove </span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nf">D</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
<span class="p">]);</span>
</code></pre></div></div>

<p><strong>ç¤ºä¾‹ç‰‡æ®µ</strong></p>

<p><a href="https://github.com/minghu6/rust-minghu6/blob/v0.1.12/coll_st/src/bt/flatbpt.rs">å®Œæ•´ä»£ç </a></p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Debug,</span> <span class="nd">Clone,</span> <span class="nd">Copy)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="k">const</span> <span class="n">M</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">Leaf</span> <span class="p">{</span>
        <span class="cd">/// (key, dataid)</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">PartialInitArray</span><span class="o">&lt;</span><span class="n">KVEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">next</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="cd">/// *NOTE:* For root node, `paren` is nonsense.</span>
        <span class="n">paren</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Internal</span> <span class="p">{</span>
        <span class="cd">/// (min-key of child, nodeid)</span>
        <span class="n">children</span><span class="p">:</span> <span class="n">PartialInitArray</span><span class="o">&lt;</span><span class="n">KVEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="nb">usize</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">paren</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="nd">#[derive(Clone)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">FlatBPT</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="k">const</span> <span class="n">M</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">32</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cd">/// uncouple data manage (avoid unnecessary mutability check)</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">LazyDeleteVec</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="n">V</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="cd">/// nodes[0] would be root and should always not to be deleted</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="n">LazyDeleteVec</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">#[derive(Debug)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PartialInitArray</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">C</span><span class="p">:</span> <span class="nb">usize</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">arr</span><span class="p">:</span> <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">C</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div>
</div>

    <div id="toc-wrapper" class="pl-0 pr-4 mb-5 post__toc">
      <span>
        <a href="/">
          <img src="/assets/img/icons/home.png" class="pl-4 pb-4">
        </a>
      </span>
      <nav id="toc" data-toggle="toc"></nav>
      <span>
        <a href="/lang/BT-3-Extra-FlatBPT.html#">
          <img src="/assets/img/icons/move-up.png" class="pl-0 pr-4 mb-5" >
        </a>
      </span>
    </div>
    <!-- <div id="toc-wrapper" class="pl-0 pr-4 mb-5">

    </div> -->
  </div>

</article>

    </main>

    <div class="page__comment">
        <script src="https://giscus.app/client.js"
            data-repo="minghu6/minghu6.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnkxMTI3NDIxOTA="
            data-category="Announcements"
            data-category-id="DIC_kwDOBrhPLs4CSYaE"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="1"
            data-input-position="top"
            data-theme="preferred_color_scheme"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
        </script>
    </div>
</div>

    <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">Â© minghu6</p>
                
                <span class="divider">Â·</span>
                
                <span class="footer__about__theme"><p>theme</p><a id="simplex-logo" href="https://github.com/andreondra/jekyll-theme-simplex" target="_blank"><img alt="Simplex theme logo" src="/assets/img/icons/simplex_logo.svg"/></a><p>by <a href="https://ondrej.golasowski.com/">golas</a></p></span>
        </section>
</footer>

    <script src="/assets/js/jquery.slim.min.js"></script>
<script src="/assets/js/lity.min.js"></script>
<script src="/assets/js/tools.js"></script>


<script type="text/javascript" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>


<!-- <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script> -->
<script>
  MathJax = {
  tex: {
    inlineMath: [
      ['$','$'],
      ['\\(','\\)']
    ],
    displayMath: [
      ['$$', '$$'],
      ['\\[', '\\]']
    ]
  }
}
</script>

<!-- <script>
var navSelector = "#toc";
// only show two levels
$("body").scrollspy({
  target: navSelector,
});
</script> -->


    <!--
Jekyll Simple Search loader
See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->



<script src="/assets/js/simple-jekyll-search.min.js"></script>

<script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: "/assets/search.json",
    searchResultTemplate: '  <div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0 justify-content-center">    <a href="{url}">{title}</a>    <div class="post__meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">      {categories}    </div>    <p>{snippet}</p>  </div>',
    noResultsText: '<p class="mt-5">No result</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }
    }
  });

  $(function() {
    const btnSearchTrigger = $("#search-trigger");
    const btnCancel = $("#search-cancel");
    const main = $(".main");
    const topbarTitle = $("#topbar-title");
    const searchWrapper = $("#search-wrapper");
    const resultWrapper = $("#search-result-wrapper");
    const results = $("#search-results");
    const input = $("#search-input");
    const hints = $("#search-hints");

    const scrollBlocker = (function() {
      let offset = 0;
      return {
        block() {
          offset = window.scrollY;
          $("html,body").scrollTop(0);
        },
        release() {
          $("html,body").scrollTop(offset);
        },
        getOffset() {
          return offset;
        }
      };
    }());

/*--- Actions in mobile screens (Sidebar hidden) ---*/

    const mobileSearchBar = (function() {
      return {
        on() {
          topbarTitle.addClass("unloaded");
          btnSearchTrigger.addClass("unloaded");
          searchWrapper.addClass("d-flex");
          btnCancel.addClass("loaded");
        },
        off() {
          btnCancel.removeClass("loaded");
          searchWrapper.removeClass("d-flex");
          topbarTitle.removeClass("unloaded");
          btnSearchTrigger.removeClass("unloaded");
        }
      };
    }());

    const resultSwitch = (function() {
      let visible = false;

      return {
        on() {
          if (! visible) {
            scrollBlocker.block();
            resultWrapper.removeClass("unloaded");
            main.addClass("unloaded");
            visible = true;
          }
        },
        off() {
          if (visible) {
            results.empty();
            if (hints.hasClass("unloaded")) {
              hints.removeClass("unloaded");
            }
            resultWrapper.addClass("unloaded");
            main.removeClass("unloaded");
            scrollBlocker.release();

            input.val("");
            visible = false;
          }
        },
        isVisible() {
          return visible;
        }
      };

    }());

    function isMobileView() {
      return btnCancel.hasClass("loaded");
    }

    btnSearchTrigger.click(function() {
      mobileSearchBar.on();
      resultSwitch.on();
      input.focus();
    });

    btnCancel.click(function() {
      mobileSearchBar.off();
      resultSwitch.off();
    });

    input.focus(function() {
      searchWrapper.addClass("input-focus");
    });

    input.focusout(function() {
      searchWrapper.removeClass("input-focus");
    });

    input.on("input", () => {
      if (input.val() === "") {
        if (isMobileView()) {
          hints.removeClass("unloaded");
        } else {
          resultSwitch.off();
        }

      } else {
        resultSwitch.on();
        if (isMobileView()) {
          hints.addClass("unloaded");
        }
      }
    });

  });
</script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">


</body>
</html>
