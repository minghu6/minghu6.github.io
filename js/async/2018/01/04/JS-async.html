<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="http://localhost:4000/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/style.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/js/lity.min.css"/>



<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="MINGHU6's Blog" />
<meta 
    property="og:title"
    content="
        
            JS Async Trap
        
    " 
/>

<meta property="og:url" content="http://localhost:4000//js/async/2018/01/04/JS-async.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        JS Async Trap
    
</title>
</head>
<body class="index">

    <header class="header">
    <section class="logo">
        <a href="http://localhost:4000/" class="logo__link">
            
                <h1 style="display: none;">MINGHU6's Blog</h1>
                <img class="logo__link__img" src="/minghu6.jpeg" />
            
        </a>
    </section>
    <button id="menuToggle">
        <div></div>
        <div></div>
        <div></div>
    </button>
    <nav class="menu">
        
<ul class="list primary">

    
</ul>
    </nav>
</header>

    <article class="post">

    <div class="post__title">
        <h1 class="post__title__text">JS Async Trap</h1>
    </div>
    <div class="post__meta"> 
        <div class="post__meta__category">
            
                <p class="post__meta__category__title" style="background: "></p>
            
                <p class="post__meta__category__title" style="background: "></p>
            
        </div>
        <p class="post__meta__divider">·</p>
        <div class="post__meta__date">
            January 04, 2018
        </div>
        
    </div>

    

    <div class="post__content">
        <ol>
  <li>到底什么时候控制台 I/O 会延迟，甚至是否能够被观察到，这都是游移不定的。如果在调试的过程中遇到对象在 console.log(..) 语句之后被修改，可你却看到了意料之外的结果，要意识到这可能是这种 I/O 的异步化造成的。</li>
</ol>

<p>　如果遇到这种少见的情况，最好的选择是在 JavaScript 调试器中使用断点，而不要依赖控制台输出。次优的方案是把对象序列化到一个字符串中，以强制执行一次“快照”，比如通过 JSON.stringify(..)。</p>

<p>将回调异步化</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">asyncify</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">orig_fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">,</span>
        <span class="nx">intv</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">intv</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="nx">fn</span><span class="p">();</span>
        <span class="p">},</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">;</span>

    <span class="nx">fn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 触发太快，在定时器intv触发指示异步转换发生之前？</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">intv</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">orig_fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span>
                <span class="nx">orig_fn</span><span class="p">,</span>
                 <span class="c1">// 把封装器的this添加到bind(..)调用的参数中，</span>
                 <span class="c1">// 以及克里化（currying）所有传入参数</span>
                 <span class="p">[</span><span class="k">this</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">arguments</span> <span class="p">)</span> <span class="p">)</span>
             <span class="p">);</span>
         <span class="p">}</span>
         <span class="c1">// 已经是异步</span>
         <span class="k">else</span> <span class="p">{</span>
             <span class="c1">// 调用原来的函数</span>
             <span class="nx">orig_fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
         <span class="p">}</span>
     <span class="p">};</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>使用</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">result</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">a</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nx">ajax</span><span class="p">(</span> <span class="dl">"</span><span class="s2">..pre-cached-url..</span><span class="dl">"</span><span class="p">,</span> <span class="nx">asyncify</span><span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">);</span>
<span class="nx">a</span><span class="o">++</span><span class="p">;</span>

<span class="c1">// result always 0</span>
</code></pre></div></div>

    </div>
</article>

    
    <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">© minghu6</p>
                
                <span class="divider">·</span>
                
                <span class="footer__about__theme"><p>theme</p><a id="simplex-logo" href="https://github.com/andreondra/jekyll-theme-simplex" target="_blank"><img alt="Simplex theme logo" src="http://localhost:4000/assets/img/icons/simplex_logo.svg"/></a><p>by <a href="https://ondrej.golasowski.com/">golas</a></p></span>
        </section>
</footer>
    
    <script src="http://localhost:4000/assets/js/jquery.slim.min.js"></script>
<script src="http://localhost:4000/assets/js/lity.min.js"></script>
<script src="http://localhost:4000/assets/js/tools.js"></script>


<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

</body>
</html>